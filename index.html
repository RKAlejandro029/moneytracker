<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover"/>
<meta name="mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="apple-mobile-web-app-title" content="Spendoodle"/>
<meta name="application-name" content="Spendoodle"/>
<meta name="description" content="Spendoodle — personal pay-cycle money tracker — income, expenses, savings & credit cards."/>
<meta name="theme-color" id="theme-color-meta" content="#080810"/>
<link rel="manifest" id="pwa-manifest-link"/>
<link rel="apple-touch-icon" id="pwa-apple-icon"/>
<title>Spendoodle</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,500;0,700;0,900;1,500&family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
<style>
/* ══════════════════════════════════════════
   THEMES
══════════════════════════════════════════ */
:root{
  --bg:#080810;--bg1:#0f0f1a;--bg2:#141420;--bg3:#1a1a28;
  --border:#1e1e30;--border2:#252538;
  --text:#ede8e0;--text2:#8a8598;--text3:#45435a;
  --accent:#d4a853;--accent2:#f0c878;--accent-dim:#d4a85322;
  --green:#4fd87c;--green-dim:#4fd87c18;
  --red:#f06464;--red-dim:#f0646418;
  --blue:#7b8fff;--blue-dim:#7b8fff18;
  --nav-h:74px;
  --grain:0.35;
}
body.theme-pink{
  --bg:#1a0a14;--bg1:#240f1c;--bg2:#2e1426;--bg3:#381929;
  --border:#4a1f38;--border2:#5c2846;
  --text:#ffe8f5;--text2:#c490b0;--text3:#7a4060;
  --accent:#f472b6;--accent2:#fb7cc6;--accent-dim:#f472b622;
  --green:#34d399;--green-dim:#34d39918;
  --red:#f87171;--red-dim:#f8717118;
  --blue:#a78bfa;--blue-dim:#a78bfa18;
}
body.theme-white{
  --bg:#f5f4f0;--bg1:#ffffff;--bg2:#f0ede8;--bg3:#e8e4de;
  --border:#ddd8d0;--border2:#ccc8c0;
  --text:#1a1814;--text2:#6b6560;--text3:#a09890;
  --accent:#b8860b;--accent2:#d4a020;--accent-dim:#b8860b15;
  --green:#16a34a;--green-dim:#16a34a15;
  --red:#dc2626;--red-dim:#dc262615;
  --blue:#2563eb;--blue-dim:#2563eb15;
  --grain:0.1;
}
/* Dark Blue — deep navy with electric blue accent */
body.theme-navy{
  --bg:#04080f;--bg1:#080f1c;--bg2:#0d1626;--bg3:#111d30;
  --border:#162040;--border2:#1d2d55;
  --text:#dce8ff;--text2:#7090c0;--text3:#334466;
  --accent:#3b82f6;--accent2:#60a5fa;--accent-dim:#3b82f622;
  --green:#22d3a5;--green-dim:#22d3a518;
  --red:#f87171;--red-dim:#f8717118;
  --blue:#818cf8;--blue-dim:#818cf818;
  --grain:0.3;
}
/* Cold Blue — icy steel with cyan accent */
body.theme-ice{
  --bg:#06111a;--bg1:#0b1d28;--bg2:#102535;--bg3:#152e40;
  --border:#1a3548;--border2:#234560;
  --text:#c8eaf8;--text2:#6090a8;--text3:#2d5068;
  --accent:#06b6d4;--accent2:#22d3ee;--accent-dim:#06b6d422;
  --green:#34d399;--green-dim:#34d39918;
  --red:#fb7185;--red-dim:#fb718518;
  --blue:#38bdf8;--blue-dim:#38bdf818;
  --grain:0.28;
}
/* Forest — deep emerald with mint accent */
body.theme-forest{
  --bg:#030f08;--bg1:#071510;--bg2:#0b1c15;--bg3:#10231a;
  --border:#152c1e;--border2:#1c3a28;
  --text:#d4f0de;--text2:#5a9070;--text3:#2a5038;
  --accent:#10b981;--accent2:#34d399;--accent-dim:#10b98122;
  --green:#4ade80;--green-dim:#4ade8018;
  --red:#f87171;--red-dim:#f8717118;
  --blue:#60a5fa;--blue-dim:#60a5fa18;
  --grain:0.32;
}
/* Sunset — warm amber with orange glow */
body.theme-sunset{
  --bg:#0f0800;--bg1:#1a0f00;--bg2:#221500;--bg3:#2a1c00;
  --border:#3d2800;--border2:#503400;
  --text:#ffe8c8;--text2:#c08040;--text3:#7a4e18;
  --accent:#f97316;--accent2:#fb923c;--accent-dim:#f9731622;
  --green:#4ade80;--green-dim:#4ade8018;
  --red:#f87171;--red-dim:#f8717118;
  --blue:#818cf8;--blue-dim:#818cf818;
  --grain:0.33;
}
/* Midnight — deep purple with violet accent */
body.theme-midnight{
  --bg:#060410;--bg1:#0d0820;--bg2:#120c2c;--bg3:#181238;
  --border:#221a48;--border2:#2e2460;
  --text:#e8d8ff;--text2:#8870b8;--text3:#453568;
  --accent:#a855f7;--accent2:#c084fc;--accent-dim:#a855f722;
  --green:#34d399;--green-dim:#34d39918;
  --red:#f87171;--red-dim:#f8717118;
  --blue:#818cf8;--blue-dim:#818cf818;
  --grain:0.3;
}

/* ══════════════════════════════════════════
   RESET & BASE
══════════════════════════════════════════ */
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;overflow:hidden;background:var(--bg);}
body{font-family:'Plus Jakarta Sans',sans-serif;color:var(--text);overscroll-behavior:none;transition:background .3s,color .3s;}
body::before{content:'';position:fixed;inset:0;z-index:9999;pointer-events:none;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
  opacity:var(--grain,0.35);}
#app{position:fixed;inset:0;display:flex;flex-direction:column;max-width:430px;margin:0 auto;}
.view{position:absolute;inset:0;bottom:var(--nav-h);overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;scrollbar-width:none;transition:opacity .25s,transform .25s;}
.view::-webkit-scrollbar{display:none;}
.view.hidden{opacity:0;pointer-events:none;transform:translateY(12px);}

/* ── TOPBAR ── */
.topbar{position:sticky;top:0;z-index:40;background:linear-gradient(to bottom,var(--bg) 82%,transparent);padding:calc(env(safe-area-inset-top,0px) + 16px) 20px 0;}
.top-row{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:12px;}
.top-title{font-family:'Playfair Display',serif;font-size:1.55rem;font-weight:900;letter-spacing:-.5px;line-height:1.1;}
.top-title span{color:var(--accent);}
.top-sub{font-size:.67rem;color:var(--text3);margin-top:4px;font-weight:500;letter-spacing:.5px;text-transform:uppercase;}
.top-date{font-size:.72rem;color:var(--text2);background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:5px 9px;font-weight:600;}
.icon-btn{background:var(--bg1);border:1.5px solid var(--border2);border-radius:10px;width:34px;height:34px;font-size:1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;color:var(--text2);transition:all .18s;}
.icon-btn:active{border-color:var(--accent);}

/* ── CYCLE NAV ── */
.cycle-nav{display:flex;align-items:center;gap:10px;padding:0 20px 10px;}
.mnav-btn{width:34px;height:34px;border-radius:10px;border:1.5px solid var(--border2);background:var(--bg1);color:var(--text2);font-size:1.1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .18s;}
.mnav-btn:active{background:var(--bg2);border-color:var(--accent);color:var(--accent);}
.mnav-btn:disabled{opacity:.2;pointer-events:none;}
.cycle-center{flex:1;text-align:center;}
.cycle-label{font-family:'Playfair Display',serif;font-size:1rem;font-weight:700;color:var(--text);}
.cycle-range{font-size:.62rem;color:var(--text3);font-weight:500;margin-top:2px;}



/* ── HERO ── */
.hero-card{margin:0 20px 12px;background:linear-gradient(135deg,var(--bg2),var(--bg3));border:1px solid var(--border2);border-radius:22px;padding:20px 22px 18px;position:relative;overflow:hidden;}
.hero-card::before{content:'';position:absolute;top:-40px;right:-40px;width:130px;height:130px;background:radial-gradient(circle,var(--accent-dim) 0%,transparent 70%);pointer-events:none;}
.hero-label{font-size:.62rem;text-transform:uppercase;letter-spacing:1.5px;color:var(--text3);font-weight:700;margin-bottom:5px;}
.hero-amount{font-family:'Playfair Display',serif;font-size:2.4rem;font-weight:900;letter-spacing:-1px;line-height:1;margin-bottom:14px;}
.hero-amount .sign{font-size:1.3rem;color:var(--text3);margin-right:2px;}
/* Amount remaining hint */
.amt-remaining{font-size:.68rem;font-weight:700;margin-top:5px;padding:0 2px;display:flex;align-items:center;gap:5px;}
.amt-remaining.ok{color:var(--green);}
.amt-remaining.warn{color:var(--accent);}
.amt-remaining.over{color:var(--red);}
.amt-err{background:var(--red-dim);color:var(--red);border:1px solid var(--border2);border-radius:9px;padding:7px 12px;font-size:.75rem;font-weight:700;margin-top:6px;display:none;}
.hero-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:7px;}
.hero-stat{background:var(--bg);border-radius:12px;padding:10px 12px;}
.hs-label{font-size:.58rem;text-transform:uppercase;letter-spacing:.8px;color:var(--text3);font-weight:700;margin-bottom:3px;}
.hs-val{font-size:.88rem;font-weight:700;font-family:'Playfair Display',serif;}
.c-inc{color:var(--green);}.c-exp{color:var(--red);}.c-sav{color:var(--accent);}
.c-pos{color:var(--green);}.c-neg{color:var(--red);}

/* ── FEED BALANCE BAR ── */
.feed-balance-bar{margin:0 20px 10px;background:linear-gradient(135deg,var(--bg2),var(--bg3));border:1px solid var(--border2);border-radius:16px;padding:12px 16px;display:flex;align-items:center;gap:12px;}
.fbb-left{flex:1;min-width:0;}
.fbb-label{font-size:.58rem;text-transform:uppercase;letter-spacing:1.2px;color:var(--text3);font-weight:700;margin-bottom:2px;}
.fbb-amount{font-family:'Playfair Display',serif;font-size:1.5rem;font-weight:900;letter-spacing:-.5px;line-height:1;}
.fbb-track{height:4px;background:var(--bg3);border-radius:99px;overflow:hidden;margin-top:6px;}
.fbb-fill{height:100%;border-radius:99px;transition:width .5s ease;}
.fbb-stats{display:flex;flex-direction:column;align-items:flex-end;gap:3px;flex-shrink:0;}
.fbb-stat{font-size:.65rem;font-weight:700;display:flex;align-items:center;gap:4px;}
.fbb-stat-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0;}
.streak-badge{display:inline-flex;align-items:center;gap:5px;background:var(--accent-dim);border:1px solid var(--border2);border-radius:99px;padding:4px 10px;font-size:.67rem;font-weight:700;color:var(--accent);margin-bottom:10px;}

/* ── BUDGET ── */
.budget-section{margin:0 20px 12px;}
.budget-label-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:7px;}
.budget-title{font-size:.67rem;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text3);}
.budget-edit{font-size:.67rem;color:var(--accent);cursor:pointer;font-weight:600;}
.budget-bar-row{margin-bottom:7px;}
.budget-bar-meta{display:flex;justify-content:space-between;margin-bottom:3px;}
.budget-bar-name{font-size:.72rem;font-weight:600;color:var(--text2);}
.budget-bar-nums{font-size:.67rem;color:var(--text3);}
.budget-track{height:5px;background:var(--bg3);border-radius:99px;overflow:hidden;}
.budget-fill{height:100%;border-radius:99px;transition:width .6s ease;}

/* ── SEARCH ── */
.search-wrap{padding:0 20px 8px;position:relative;}
.search-input{width:100%;background:var(--bg1);border:1.5px solid var(--border2);border-radius:12px;padding:10px 14px 10px 38px;color:var(--text);font-family:'Plus Jakarta Sans',sans-serif;font-size:.88rem;outline:none;transition:border-color .2s;}
.search-input:focus{border-color:var(--accent);}
.search-input::placeholder{color:var(--text3);}
.search-icon{position:absolute;left:33px;top:50%;transform:translateY(-50%);font-size:.9rem;pointer-events:none;line-height:1;display:flex;align-items:center;}
.search-clear{position:absolute;right:33px;top:50%;transform:translateY(-50%);font-size:.75rem;cursor:pointer;color:var(--text3);background:var(--bg3);border:none;border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;}

/* ── FILTER CHIPS ── */
.filter-wrap{display:flex;gap:6px;overflow-x:auto;padding:0 20px 10px;scrollbar-width:none;}
.filter-wrap::-webkit-scrollbar{display:none;}
.filter-chip{flex-shrink:0;padding:6px 13px;border-radius:99px;font-size:.7rem;font-weight:700;cursor:pointer;border:1.5px solid var(--border);background:transparent;color:var(--text3);white-space:nowrap;transition:all .18s;}
.fc-all{border-color:var(--accent)!important;color:var(--accent)!important;background:var(--accent-dim)!important;}
.fc-income{border-color:var(--green)!important;color:var(--green)!important;background:var(--green-dim)!important;}
.fc-expense{border-color:var(--red)!important;color:var(--red)!important;background:var(--red-dim)!important;}
.fc-savings{border-color:var(--accent)!important;color:var(--accent)!important;background:var(--accent-dim)!important;}
.fc-recurring{border-color:var(--blue)!important;color:var(--blue)!important;background:var(--blue-dim)!important;}

/* ── SWIPE TO DELETE ── */
.tx-wrap{position:relative;margin-bottom:8px;overflow:hidden;}
.tx-swipe-bg{position:absolute;right:0;top:0;bottom:0;width:80px;background:var(--red-dim);border-radius:18px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;z-index:0;opacity:0;transition:opacity .15s;}
.tx-wrap.swiping .tx-swipe-bg{opacity:1;}
/* ── QUICK ADD TEMPLATES ── */
.quick-add-row{display:flex;gap:7px;overflow-x:auto;padding:0 20px 10px;scrollbar-width:none;}
.quick-add-row::-webkit-scrollbar{display:none;}
.qa-chip{flex-shrink:0;background:var(--bg1);border:1.5px solid var(--blue);border-radius:12px;padding:7px 12px;cursor:pointer;display:flex;flex-direction:column;align-items:flex-start;gap:2px;transition:all .18s;min-width:100px;}
.qa-chip:active{background:var(--blue-dim);}
.qa-chip-label{font-size:.68rem;font-weight:700;color:var(--text2);white-space:nowrap;}
.qa-chip-amt{font-family:'Playfair Display',serif;font-size:.88rem;font-weight:700;color:var(--blue);}
.qa-chip-freq{font-size:.58rem;color:var(--text3);font-weight:600;}
/* ── PROJECTION INLINE ── */
.projection-inline{font-size:.67rem;font-weight:600;padding:4px 2px;display:flex;align-items:center;gap:5px;margin-top:4px;}
/* ── PIN MODAL ── */
.pin-overlay{position:fixed;inset:0;z-index:9000;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:32px 24px;}
.pin-overlay.hidden{display:none;}
.pin-title{font-family:'Playfair Display',serif;font-size:1.5rem;font-weight:900;margin-bottom:6px;text-align:center;}
.pin-sub{font-size:.78rem;color:var(--text3);text-align:center;margin-bottom:28px;}
.pin-dots{display:flex;gap:12px;margin-bottom:28px;}
.pin-dot{width:14px;height:14px;border-radius:50%;border:2px solid var(--border2);background:transparent;transition:all .15s;}
.pin-dot.filled{background:var(--accent);border-color:var(--accent);}
.pin-keypad{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;width:100%;max-width:280px;}
.pin-key{height:64px;border-radius:16px;border:1.5px solid var(--border2);background:var(--bg1);font-family:'Playfair Display',serif;font-size:1.5rem;font-weight:700;color:var(--text);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .12s;}
.pin-key:active{background:var(--bg2);border-color:var(--accent);transform:scale(.94);}
.pin-key.del{font-size:1rem;color:var(--text3);}
.pin-key.empty{border:none;background:transparent;pointer-events:none;}
.pin-error{color:var(--red);font-size:.78rem;font-weight:700;margin-top:-16px;margin-bottom:8px;height:20px;}
/* ── CUSTOM CONFIRM MODAL ── */
.confirm-overlay{position:fixed;inset:0;z-index:500;background:#00000085;display:flex;align-items:flex-end;justify-content:center;opacity:0;pointer-events:none;transition:opacity .25s;}
.confirm-overlay.open{opacity:1;pointer-events:all;}
.confirm-inner{width:100%;max-width:430px;background:var(--bg1);border-radius:22px 22px 0 0;padding:22px 22px calc(env(safe-area-inset-bottom,20px)+20px);transform:translateY(100%);transition:transform .3s cubic-bezier(.32,0,.67,0);}
.confirm-overlay.open .confirm-inner{transform:translateY(0);}
.confirm-icon{font-size:2rem;text-align:center;margin-bottom:8px;}
.confirm-title{font-family:'Playfair Display',serif;font-size:1.2rem;font-weight:900;text-align:center;margin-bottom:6px;}
.confirm-msg{font-size:.78rem;color:var(--text3);text-align:center;line-height:1.7;margin-bottom:20px;}
.confirm-btns{display:flex;gap:10px;}
.confirm-btn{flex:1;padding:14px;border:none;border-radius:13px;font-family:'Plus Jakarta Sans',sans-serif;font-size:.88rem;font-weight:700;cursor:pointer;transition:all .15s;}
.confirm-btn:active{transform:scale(.97);}
.confirm-btns{display:flex;flex-direction:column;gap:8px;}
.confirm-btn-row{display:flex;gap:10px;}
.confirm-cancel{background:var(--bg2);color:var(--text2);}
.confirm-ok{background:var(--red);color:#fff;}
.confirm-secondary{background:var(--bg2);color:var(--accent);border:1.5px solid var(--accent);}
.date-group{margin-bottom:4px;}
.date-hdr{display:flex;align-items:center;gap:10px;padding:12px 0 7px;}
.date-hdr-label{font-size:.67rem;font-weight:700;letter-spacing:1.2px;text-transform:uppercase;color:var(--text3);flex-shrink:0;}
.date-hdr-line{flex:1;height:1px;background:var(--border);}
.date-hdr-total{font-size:.67rem;font-weight:700;color:var(--text3);}
/* overflow:hidden handled per tx-wrap below */

.tx{display:flex;align-items:center;gap:12px;background:var(--bg1);border:1px solid var(--border);border-radius:18px;padding:13px 15px;cursor:pointer;transition:border-color .2s,background .15s;position:relative;overflow:hidden;z-index:1;will-change:transform;}
.tx.open{border-color:var(--border2);background:var(--bg2);}
.tx-glow{position:absolute;left:-20px;top:50%;transform:translateY(-50%);width:60px;height:60px;border-radius:50%;pointer-events:none;opacity:.35;}
.tx-icon{width:42px;height:42px;border-radius:13px;display:flex;align-items:center;justify-content:center;font-size:1.25rem;flex-shrink:0;position:relative;z-index:1;}
.tx-icon.income{background:var(--green-dim);}
.tx-icon.expense{background:var(--red-dim);}
.tx-icon.savings{background:var(--accent-dim);}
.tx-body{flex:1;min-width:0;z-index:1;}
.tx-name{font-size:.87rem;font-weight:600;color:var(--text);margin-bottom:2px;display:flex;align-items:center;gap:5px;}
.tx-note{font-size:.71rem;color:var(--text3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.tx-right{display:flex;flex-direction:column;align-items:flex-end;gap:3px;z-index:1;}
.tx-amt{font-family:'Playfair Display',serif;font-size:.98rem;font-weight:700;}
.recur-dot{display:inline-block;width:5px;height:5px;border-radius:50%;background:var(--blue);flex-shrink:0;}
.tx-recur-tag{font-size:.58rem;color:var(--blue);font-weight:700;}
/* ── RECUR FREQUENCY ── */
.recur-freq-wrap{display:flex;gap:7px;margin-top:10px;}
.recur-freq-btn{flex:1;padding:9px 6px;border-radius:11px;border:1.5px solid var(--border2);background:var(--bg2);color:var(--text3);font-family:'Plus Jakarta Sans',sans-serif;font-size:.78rem;font-weight:700;cursor:pointer;text-align:center;transition:all .18s;}
.recur-freq-btn.active{border-color:var(--blue);background:var(--blue-dim);color:var(--blue);}
.tx-actions{display:flex;gap:8px;padding:2px 0 10px;}
.act{flex:1;padding:10px;border-radius:12px;font-family:'Plus Jakarta Sans',sans-serif;font-size:.78rem;font-weight:700;cursor:pointer;border:1.5px solid;transition:all .15s;}
.act-edit{color:var(--accent);border-color:var(--accent-dim);background:var(--accent-dim);}
.act-del{color:var(--red);border-color:var(--red-dim);background:var(--red-dim);}
.act-cancel{color:var(--text3);border-color:var(--border);background:transparent;}
.act-confirm{color:var(--red);border-color:var(--red-dim);background:var(--red-dim);}
.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 30px;color:var(--text3);text-align:center;gap:12px;}
.empty-icon{font-size:2.8rem;}
.empty-txt{font-size:.84rem;line-height:1.7;}

/* ── DASHBOARD ── */
.dash-body{padding-bottom:20px;}
.section{padding:0 20px;margin-bottom:24px;}
.section-title{font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:700;margin-bottom:4px;}
.section-sub{font-size:.71rem;color:var(--text3);margin-bottom:12px;}

/* HIGHLIGHTS ROW */
.hl-row{display:flex;gap:8px;overflow-x:auto;scrollbar-width:none;padding-bottom:2px;}
.hl-row::-webkit-scrollbar{display:none;}
.hl-mini{flex-shrink:0;width:140px;background:var(--bg1);border:1px solid var(--border);border-radius:18px;padding:14px;}
.hl-mini-icon{font-size:1.3rem;margin-bottom:6px;}
.hl-mini-label{font-size:.6rem;text-transform:uppercase;letter-spacing:.8px;color:var(--text3);font-weight:700;margin-bottom:4px;}
.hl-mini-val{font-family:'Playfair Display',serif;font-size:.95rem;font-weight:700;margin-bottom:2px;}
.hl-mini-sub{font-size:.65rem;color:var(--text3);}

/* SIDE BY SIDE */
.sbs-card{background:var(--bg1);border:1px solid var(--border);border-radius:18px;overflow:hidden;}
.sbs-header{display:grid;grid-template-columns:100px 1fr 1fr 80px;background:var(--bg2);border-bottom:1px solid var(--border);padding:9px 14px;gap:4px;}
.sbs-th{font-size:.6rem;font-weight:700;text-transform:uppercase;letter-spacing:.7px;color:var(--text3);}
.sbs-th.right{text-align:right;}
.sbs-th.cur{color:var(--accent);}
.sbs-row{display:grid;grid-template-columns:100px 1fr 1fr 80px;padding:11px 14px;border-bottom:1px solid var(--border);gap:4px;align-items:center;}
.sbs-row:last-child{border-bottom:none;}
.sbs-label{font-size:.72rem;color:var(--text3);font-weight:600;}
.sbs-val{font-size:.82rem;font-weight:700;font-family:'Playfair Display',serif;text-align:right;}
.sbs-delta{font-size:.7rem;font-weight:700;text-align:right;white-space:nowrap;}
.d-up{color:var(--green);}
.d-dn{color:var(--red);}
.d-neu{color:var(--text3);}

/* TREND CHART */
.chart-card{background:var(--bg1);border:1px solid var(--border);border-radius:18px;padding:16px 12px 12px;overflow:hidden;}
.metric-tabs{display:flex;gap:5px;margin-bottom:14px;overflow-x:auto;scrollbar-width:none;}
.metric-tabs::-webkit-scrollbar{display:none;}
.metric-tab{flex-shrink:0;padding:6px 12px;border-radius:99px;font-size:.68rem;font-weight:700;cursor:pointer;border:1.5px solid var(--border);background:transparent;color:var(--text3);transition:all .18s;}
.mt-inc{border-color:var(--green)!important;color:var(--green)!important;background:var(--green-dim)!important;}
.mt-exp{border-color:var(--red)!important;color:var(--red)!important;background:var(--red-dim)!important;}
.mt-sav{border-color:var(--accent)!important;color:var(--accent)!important;background:var(--accent-dim)!important;}
.mt-net{border-color:var(--blue)!important;color:var(--blue)!important;background:var(--blue-dim)!important;}
.bars{display:flex;align-items:flex-end;gap:5px;height:110px;margin-bottom:6px;}
.bar-col{flex:1;display:flex;flex-direction:column;align-items:center;}
.bar-col-val{font-size:.52rem;font-weight:700;margin-bottom:3px;white-space:nowrap;text-align:center;}
.bar-col-track{flex:1;width:100%;display:flex;align-items:flex-end;}
.bar-rect{width:100%;border-radius:5px 5px 2px 2px;min-height:4px;transition:height .5s cubic-bezier(.34,1.56,.64,1);}
.bar-col-name{font-size:.52rem;font-weight:700;margin-top:5px;text-align:center;}
.bar-col.is-cur .bar-col-name{color:var(--accent);}

/* DONUT */
.donut-card{background:var(--bg1);border:1px solid var(--border);border-radius:18px;padding:16px;}
.donut-row{display:flex;align-items:center;gap:16px;}
.donut-legend{flex:1;}
.donut-item{display:flex;align-items:center;gap:7px;margin-bottom:8px;}
.donut-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.donut-name{font-size:.72rem;font-weight:600;color:var(--text2);flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.donut-val{font-size:.72rem;font-weight:700;}
.donut-pct{font-size:.6rem;color:var(--text3);}

/* SAVINGS RING */
.ring-card{display:flex;align-items:center;gap:18px;background:var(--bg1);border:1px solid var(--border);border-radius:18px;padding:16px 18px;}
.ring-label{font-size:.62rem;text-transform:uppercase;letter-spacing:1px;color:var(--text3);font-weight:700;margin-bottom:4px;}
.ring-pct{font-family:'Playfair Display',serif;font-size:1.7rem;font-weight:900;line-height:1;}
.ring-sub{font-size:.69rem;color:var(--text3);margin-top:4px;}

/* BOTTOM NAV */
.bottom-nav{position:absolute;bottom:0;left:0;right:0;height:var(--nav-h);background:linear-gradient(to top,var(--bg) 60%,transparent);border-top:1px solid var(--border);display:flex;align-items:flex-start;padding:10px 16px 0;gap:8px;z-index:50;}
.nav-btn{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;padding:8px 4px;border-radius:14px;cursor:pointer;border:none;background:transparent;transition:all .18s;}
.nav-btn.active{background:var(--bg2);}
.nav-icon{font-size:1.25rem;line-height:1;}
.nav-lbl{font-size:.57rem;font-weight:700;color:var(--text3);letter-spacing:.6px;text-transform:uppercase;}
.nav-btn.active .nav-lbl{color:var(--text);}
.fab-wrap{flex-shrink:0;display:flex;align-items:flex-start;position:relative;z-index:51;}
.fab{width:56px;height:56px;border-radius:18px;background:var(--accent);border:none;font-size:1.8rem;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 24px var(--accent-dim),0 8px 40px #00000050;transition:transform .2s;margin-top:-8px;color:var(--bg);font-weight:900;}
.fab:active{transform:scale(.92);}
/* Speed-dial — horizontal arc */
.fab-dial{position:absolute;bottom:calc(100% + 20px);left:50%;transform:translateX(-50%);width:210px;display:flex;flex-direction:row;align-items:flex-end;justify-content:center;gap:12px;pointer-events:none;}
.fab-dial.open{pointer-events:all;}
/* Each button starts collapsed at center and flies to its arc position */
.fab-dial-btn{width:56px;height:56px;border-radius:50%;border:none;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;box-shadow:0 4px 20px #00000060;
  opacity:0;transform:translateY(16px) scale(.7);transition:opacity .22s,transform .22s;}
.fab-dial.open .fab-dial-btn:nth-child(1){opacity:1;transform:translateY(10px) scale(1);transition-delay:.04s;}
.fab-dial.open .fab-dial-btn:nth-child(2){opacity:1;transform:translateY(0px) scale(1);transition-delay:.02s;}
.fab-dial.open .fab-dial-btn:nth-child(3){opacity:1;transform:translateY(10px) scale(1);transition-delay:.04s;}
.fab-dial-btn:active{opacity:.85;transform:scale(.9) translateY(var(--btn-y,0px))!important;}
.fab-dial-btn:nth-child(1){--btn-y:10px;}
.fab-dial-btn:nth-child(3){--btn-y:10px;}
.fab-dial-icon{font-size:1.25rem;line-height:1;}
.fab-dial-lbl{font-size:.46rem;font-weight:800;letter-spacing:.5px;text-transform:uppercase;}
.fab-dial-income{background:var(--green);}
.fab-dial-expense{background:var(--red);}
.fab-dial-savings{background:var(--accent);}
.fab-backdrop{position:fixed;inset:0;z-index:49;display:none;}
.fab-backdrop.open{display:block;}

/* SETTINGS */
.settings-card{background:var(--bg1);border:1px solid var(--border);border-radius:18px;padding:18px;margin-bottom:10px;display:flex;gap:14px;align-items:flex-start;}
.settings-icon{width:44px;height:44px;border-radius:13px;display:flex;align-items:center;justify-content:center;font-size:1.3rem;flex-shrink:0;}
.settings-body{flex:1;min-width:0;}
.settings-title{font-family:'Playfair Display',serif;font-size:.98rem;font-weight:700;margin-bottom:3px;}
.settings-desc{font-size:.74rem;color:var(--text3);line-height:1.6;margin-bottom:10px;}
.settings-btn{display:block;width:100%;padding:11px 14px;border-radius:11px;font-family:'Plus Jakarta Sans',sans-serif;font-size:.78rem;font-weight:700;cursor:pointer;border:none;text-align:center;transition:all .18s;}
.settings-btn:active{transform:scale(.97);}
.btn-accent{background:var(--accent-dim);color:var(--accent);border:1.5px solid var(--border2);}
.btn-green{background:var(--green-dim);color:var(--green);border:1.5px solid var(--border2);}
.btn-red{background:var(--red-dim);color:var(--red);border:1.5px solid var(--border2);}
.btn-blue{background:var(--blue-dim);color:var(--blue);border:1.5px solid var(--border2);}

/* THEME PICKER */
.theme-row{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:4px;}
.theme-btn{padding:10px 4px;border-radius:12px;font-size:.7rem;font-weight:700;cursor:pointer;border:2px solid transparent;transition:all .2s;text-align:center;line-height:1.3;}
.theme-btn.dark{background:#141420;color:#ede8e0;border-color:#252538;}
.theme-btn.pink{background:#2e1426;color:#f472b6;border-color:#5c2846;}
.theme-btn.white{background:#f0ede8;color:#1a1814;border-color:#ccc8c0;}
.theme-btn.navy{background:#0d1626;color:#60a5fa;border-color:#1d2d55;}
.theme-btn.ice{background:#102535;color:#06b6d4;border-color:#234560;}
.theme-btn.forest{background:#0b1c15;color:#10b981;border-color:#1c3a28;}
.theme-btn.sunset{background:#221500;color:#f97316;border-color:#503400;}
.theme-btn.midnight{background:#120c2c;color:#a855f7;border-color:#2e2460;}
.theme-btn.active-theme{border-color:var(--accent)!important;box-shadow:0 0 0 2px var(--accent-dim);}

/* CYCLE MODE SELECTOR */
.cycle-mode-row{display:flex;flex-direction:column;gap:8px;margin-top:4px;}
.cycle-mode-opt{display:flex;align-items:flex-start;gap:10px;padding:10px 12px;border-radius:12px;border:1.5px solid var(--border);cursor:pointer;transition:all .18s;}
.cycle-mode-opt.selected{border-color:var(--accent);background:var(--accent-dim);}
.cmo-radio{width:16px;height:16px;border-radius:50%;border:2px solid var(--text3);flex-shrink:0;margin-top:2px;display:flex;align-items:center;justify-content:center;transition:all .18s;}
.cycle-mode-opt.selected .cmo-radio{border-color:var(--accent);}
.cmo-radio-dot{width:7px;height:7px;border-radius:50%;background:var(--accent);display:none;}
.cycle-mode-opt.selected .cmo-radio-dot{display:block;}
.cmo-text{}
.cmo-title{font-size:.85rem;font-weight:700;color:var(--text);}
.cmo-sub{font-size:.7rem;color:var(--text3);margin-top:2px;}

/* CYCLE SETUP FIELDS */
.cycle-fields{background:var(--bg2);border-radius:12px;padding:12px;margin-top:8px;display:flex;flex-direction:column;gap:8px;}
.cf-row{display:flex;align-items:center;gap:8px;}
.cf-label{font-size:.75rem;font-weight:600;color:var(--text2);flex:1;}
.cf-input{background:var(--bg1);border:1.5px solid var(--border2);border-radius:9px;padding:7px 11px;color:var(--text);font-family:'Playfair Display',serif;font-size:.95rem;font-weight:700;outline:none;width:70px;text-align:center;}
.cf-input:focus{border-color:var(--accent);}
.cf-note{font-size:.68rem;color:var(--text3);line-height:1.5;}

/* BOTTOM SHEET */
.sheet-overlay{position:fixed;inset:0;background:#00000080;z-index:100;opacity:0;pointer-events:none;transition:opacity .25s;}
.sheet-overlay.active{opacity:1;pointer-events:all;}
.sheet{position:fixed;bottom:0;left:50%;transform:translateX(-50%) translateY(100%);width:100%;max-width:430px;background:var(--bg1);border-radius:24px 24px 0 0;z-index:101;transition:transform .3s cubic-bezier(.32,0,.67,0);max-height:92vh;overflow-y:auto;scrollbar-width:none;padding-bottom:env(safe-area-inset-bottom,20px);}
.sheet::-webkit-scrollbar{display:none;}
.sheet.open{transform:translateX(-50%) translateY(0);}
.sheet-handle{width:36px;height:4px;background:var(--border2);border-radius:99px;margin:12px auto 0;}
.sheet-header{padding:13px 20px 5px;display:flex;align-items:center;justify-content:space-between;}
.sheet-title{font-family:'Playfair Display',serif;font-size:1.3rem;font-weight:900;}
.sheet-title em{color:var(--accent);font-style:normal;}
.sheet-close{background:var(--bg2);border:1.5px solid var(--border2);border-radius:10px;width:31px;height:31px;font-size:.9rem;cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--text2);}
.add-body{padding:6px 20px 28px;}
.form-section{margin-bottom:16px;}
.form-lbl{font-size:.62rem;text-transform:uppercase;letter-spacing:1.2px;color:var(--text3);font-weight:700;margin-bottom:8px;display:flex;align-items:center;gap:6px;}
.form-lbl::after{content:'';flex:1;height:1px;background:var(--border);}
.date-field{width:100%;background:var(--bg2);border:1.5px solid var(--border2);border-radius:13px;padding:12px 15px;color:var(--text);font-family:'Plus Jakarta Sans',sans-serif;font-size:.93rem;font-weight:500;outline:none;-webkit-appearance:none;transition:border-color .2s;}
.date-field:focus{border-color:var(--accent);}
.cat-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:7px;}
.cat-tile{background:var(--bg2);border:1.5px solid var(--border);border-radius:14px;padding:10px 6px 8px;text-align:center;cursor:pointer;transition:all .18s;}
.cat-tile.sel-income{border-color:var(--green);background:var(--green-dim);box-shadow:0 0 14px var(--green-dim);}
.cat-tile.sel-expense{border-color:var(--red);background:var(--red-dim);box-shadow:0 0 14px var(--red-dim);}
.cat-tile.sel-savings{border-color:var(--accent);background:var(--accent-dim);box-shadow:0 0 14px var(--accent-dim);}
.cat-icon{font-size:1.25rem;display:block;margin-bottom:3px;}
.cat-name{font-size:.6rem;color:var(--text3);font-weight:600;}
.cat-tile.sel-income .cat-name{color:var(--green);}
.cat-tile.sel-expense .cat-name{color:var(--red);}
.cat-tile.sel-savings .cat-name{color:var(--accent);}
.amt-wrap{background:var(--bg2);border:1.5px solid var(--border2);border-radius:14px;padding:3px 16px;display:flex;align-items:center;transition:border-color .2s;}
.amt-wrap:focus-within{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-dim);}
.amt-sym{font-family:'Playfair Display',serif;font-size:1.7rem;color:var(--text3);padding-right:4px;padding-top:2px;}
.amt-input{flex:1;background:transparent;border:none;outline:none;font-family:'Playfair Display',serif;font-size:2.5rem;font-weight:900;color:var(--text);padding:11px 0;width:100%;}
.amt-input::placeholder{color:var(--border2);}
.note-field{width:100%;background:var(--bg2);border:1.5px solid var(--border2);border-radius:13px;padding:12px 15px;color:var(--text);font-family:'Plus Jakarta Sans',sans-serif;font-size:.88rem;outline:none;resize:none;transition:border-color .2s;}
.note-field:focus{border-color:var(--accent);}
.note-field::placeholder{color:var(--text3);}
.toggle-row{display:flex;align-items:center;justify-content:space-between;background:var(--bg2);border:1.5px solid var(--border2);border-radius:13px;padding:12px 15px;}
.toggle-label{font-size:.87rem;font-weight:600;color:var(--text);}
.toggle-sub{font-size:.69rem;color:var(--text3);}
.toggle{width:44px;height:25px;background:var(--bg3);border-radius:99px;position:relative;cursor:pointer;border:1.5px solid var(--border2);transition:background .2s;flex-shrink:0;}
.toggle.on{background:var(--blue);border-color:var(--blue);}
.toggle::after{content:'';position:absolute;width:17px;height:17px;background:#fff;border-radius:50%;top:2px;left:2px;transition:transform .2s;}
.toggle.on::after{transform:translateX(19px);}
.save-btn{width:100%;padding:16px;border:none;border-radius:14px;font-family:'Plus Jakarta Sans',sans-serif;font-size:.93rem;font-weight:700;cursor:pointer;transition:all .18s;letter-spacing:.3px;margin-top:6px;}
.save-btn:active{transform:scale(.98);}
.save-btn:disabled{opacity:.25;pointer-events:none;}
.btn-income{background:var(--green);color:#fff;}
.btn-expense{background:var(--red);color:#fff;}
.btn-savings{background:var(--accent);color:var(--bg);}
.toast{display:flex;align-items:center;justify-content:center;gap:8px;background:var(--green-dim);color:var(--green);border:1px solid var(--border2);border-radius:11px;padding:9px 16px;font-size:.8rem;font-weight:700;margin-bottom:12px;animation:fadeUp .3s ease;}
/* Undo delete toast */
.undo-toast{position:fixed;bottom:calc(var(--nav-h) + 14px);left:50%;transform:translateX(-50%);width:calc(100% - 32px);max-width:398px;z-index:400;background:var(--bg1);border:1.5px solid var(--border2);border-radius:16px;padding:13px 16px;display:flex;align-items:center;gap:12px;box-shadow:0 8px 32px #00000070;animation:slideUp .3s cubic-bezier(.34,1.56,.64,1);}
.undo-toast-text{flex:1;font-size:.83rem;font-weight:600;color:var(--text);}
.undo-toast-sub{font-size:.68rem;color:var(--text3);margin-top:1px;}
.undo-progress{position:absolute;bottom:0;left:0;height:3px;background:var(--red);border-radius:0 0 16px 16px;transition:width linear;}
.undo-btn{flex-shrink:0;padding:8px 16px;border-radius:10px;border:none;background:var(--accent);color:var(--bg);font-family:'Plus Jakarta Sans',sans-serif;font-size:.78rem;font-weight:800;cursor:pointer;transition:all .15s;}
.undo-btn:active{transform:scale(.95);}
@keyframes slideUp{from{opacity:0;transform:translateX(-50%) translateY(20px);}to{opacity:1;transform:translateX(-50%) translateY(0);}}

@keyframes fadeUp{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.date-err{background:var(--red-dim);color:var(--red);border:1px solid var(--border2);border-radius:11px;padding:9px 15px;font-size:.8rem;font-weight:600;margin-bottom:12px;display:none;}

/* BUDGET MODAL */
.budget-modal{display:none;position:fixed;inset:0;z-index:200;background:#00000090;align-items:flex-end;justify-content:center;}
.budget-modal.open{display:flex;}
.bm-inner{background:var(--bg1);border-radius:22px 22px 0 0;width:100%;max-width:430px;padding:18px 20px 40px;max-height:80vh;overflow-y:auto;scrollbar-width:none;}
.bm-inner::-webkit-scrollbar{display:none;}
.bm-title{font-family:'Playfair Display',serif;font-size:1.2rem;font-weight:700;margin-bottom:3px;}
.bm-sub{font-size:.72rem;color:var(--text3);margin-bottom:16px;}
.bm-row{display:flex;align-items:center;gap:10px;margin-bottom:9px;}
.bm-icon{width:28px;height:28px;border-radius:8px;background:var(--red-dim);display:flex;align-items:center;justify-content:center;font-size:.9rem;flex-shrink:0;}
.bm-name{font-size:.85rem;font-weight:600;flex:1;}
.bm-field{width:88px;background:var(--bg2);border:1.5px solid var(--border2);border-radius:9px;padding:7px 10px;color:var(--text);font-family:'Playfair Display',serif;font-size:.93rem;font-weight:700;outline:none;text-align:right;}
.bm-field:focus{border-color:var(--accent);}
.bm-save{width:100%;padding:13px;border:none;border-radius:13px;background:var(--accent);color:var(--bg);font-family:'Plus Jakarta Sans',sans-serif;font-size:.88rem;font-weight:700;cursor:pointer;margin-top:8px;}

/* SAVINGS GOAL FIELD */
.goal-wrap{position:relative;}
.goal-input{width:100%;background:var(--bg2);border:1.5px solid var(--accent-dim);border-radius:13px;padding:12px 15px;color:var(--text);font-family:'Plus Jakarta Sans',sans-serif;font-size:.88rem;outline:none;transition:border-color .2s;}
.goal-input:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-dim);}
.goal-input::placeholder{color:var(--text3);}
.goal-suggestions{position:absolute;top:calc(100% + 4px);left:0;right:0;background:var(--bg1);border:1.5px solid var(--border2);border-radius:13px;z-index:50;overflow:hidden;box-shadow:0 8px 24px #00000050;display:none;}
.goal-suggestions.open{display:block;}
.goal-sug-item{padding:10px 15px;font-size:.85rem;font-weight:600;color:var(--text);cursor:pointer;display:flex;align-items:center;gap:8px;transition:background .15s;}
.goal-sug-item:active,.goal-sug-item:hover{background:var(--bg2);}
.goal-sug-dot{width:8px;height:8px;border-radius:50%;background:var(--accent);flex-shrink:0;}
.goal-tag{display:inline-flex;align-items:center;gap:4px;background:var(--accent-dim);border:1px solid var(--border2);border-radius:6px;padding:2px 7px;font-size:.62rem;font-weight:700;color:var(--accent);margin-left:4px;}

/* SAVINGS GOALS DASHBOARD SECTION */
.goals-grid{display:flex;flex-direction:column;gap:8px;}
.goal-card{background:var(--bg1);border:1px solid var(--border);border-radius:16px;padding:14px 16px;display:flex;align-items:center;gap:14px;}
.goal-card-rank{font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:900;color:var(--text3);width:24px;text-align:center;flex-shrink:0;}
.goal-card-body{flex:1;min-width:0;}
.goal-card-name{font-size:.88rem;font-weight:700;color:var(--text);margin-bottom:3px;}
.goal-card-meta{font-size:.67rem;color:var(--text3);}
.goal-card-amt{font-family:'Playfair Display',serif;font-size:1rem;font-weight:900;color:var(--accent);text-align:right;flex-shrink:0;}
.goal-bar-track{height:4px;background:var(--bg3);border-radius:99px;overflow:hidden;margin-top:6px;}
.goal-bar-fill{height:100%;border-radius:99px;background:var(--accent);transition:width .6s ease;}

/* ══ CREDIT CARD ══ */
--purple:#a855f7;--purple-dim:#a855f718;
.cc-section{margin:10px 20px 12px;}
.cc-header-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
.cc-title{font-size:.62rem;text-transform:uppercase;letter-spacing:1.2px;color:var(--text3);font-weight:700;}
.cc-add-btn{font-size:.67rem;color:var(--accent);cursor:pointer;font-weight:700;background:var(--accent-dim);border:1px solid var(--border2);border-radius:7px;padding:4px 9px;}
.cc-card{background:var(--bg1);border:1px solid var(--border);border-radius:18px;padding:14px 15px;margin-bottom:7px;position:relative;overflow:hidden;}
.cc-card::before{content:'';position:absolute;top:-30px;right:-30px;width:100px;height:100px;background:radial-gradient(circle,#a855f718 0%,transparent 70%);pointer-events:none;}
.cc-card-top{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:10px;}
.cc-card-name{font-size:.88rem;font-weight:700;color:var(--text);display:flex;align-items:center;gap:6px;}
.cc-chip{font-size:.55rem;background:#a855f720;color:#a855f7;border:1px solid #a855f730;border-radius:5px;padding:2px 6px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;}
.cc-pay-btn{font-size:.67rem;font-weight:700;padding:5px 11px;border-radius:9px;border:1.5px solid var(--border2);background:var(--green-dim);color:var(--green);cursor:pointer;}
.cc-amounts{display:grid;grid-template-columns:1fr 1fr 1fr;gap:7px;margin-bottom:10px;}
.cc-amt-box{background:var(--bg2);border-radius:10px;padding:8px 10px;}
.cc-amt-lbl{font-size:.55rem;text-transform:uppercase;letter-spacing:.7px;color:var(--text3);font-weight:700;margin-bottom:3px;}
.cc-amt-val{font-family:'Playfair Display',serif;font-size:.88rem;font-weight:700;}
.cc-bar-row{display:flex;align-items:center;gap:8px;}
.cc-bar-track{flex:1;height:5px;background:var(--bg3);border-radius:99px;overflow:hidden;}
.cc-bar-fill{height:100%;border-radius:99px;transition:width .6s ease;}
.cc-bar-pct{font-size:.62rem;font-weight:700;color:var(--text3);flex-shrink:0;min-width:28px;text-align:right;}
.cc-del-btn{font-size:.65rem;color:var(--red);cursor:pointer;font-weight:600;padding:3px 7px;border-radius:6px;background:var(--red-dim);border:none;}
/* credit toggle in form */
.cc-picker-wrap{margin-top:10px;display:none;}
.cc-picker-wrap.open{display:block;}
.cc-picker{width:100%;background:var(--bg2);border:1.5px solid var(--border2);border-radius:13px;padding:12px 15px;color:var(--text);font-family:'Plus Jakarta Sans',sans-serif;font-size:.88rem;outline:none;}
.cc-picker:focus{border-color:#a855f7;}
.cc-hint{margin-top:6px;font-size:.7rem;color:#a855f7;font-weight:600;display:flex;align-items:center;gap:5px;}
/* Payment Method selector */
.pay-method-row{display:flex;gap:8px;margin-bottom:2px;}
.pay-method-btn{flex:1;display:flex;flex-direction:column;align-items:center;gap:5px;padding:13px 10px;border-radius:14px;border:1.5px solid var(--border2);background:var(--bg2);cursor:pointer;transition:all .18s;font-family:'Plus Jakarta Sans',sans-serif;}
.pay-method-btn.active{border-color:var(--red);background:var(--red-dim);box-shadow:0 0 14px var(--red-dim);}
.pay-method-icon{font-size:1.3rem;line-height:1;}
.pay-method-label{font-size:.72rem;font-weight:700;color:var(--text3);letter-spacing:.3px;}
.pay-method-btn.active .pay-method-label{color:var(--red);}
.pay-method-btn:active{transform:scale(.96);}
/* credit tag on transaction cards */
.cc-tag{display:inline-flex;align-items:center;gap:4px;background:#a855f718;border:1px solid #a855f730;border-radius:6px;padding:2px 7px;font-size:.58rem;font-weight:700;color:#a855f7;margin-left:4px;}
/* pay modal */
.pay-modal{display:none;position:fixed;inset:0;z-index:200;background:#00000090;align-items:flex-end;justify-content:center;}
.pay-modal.open{display:flex;}
.pay-inner{background:var(--bg1);border-radius:22px 22px 0 0;width:100%;max-width:430px;padding:20px 20px 40px;}
.pay-title{font-family:'Playfair Display',serif;font-size:1.15rem;font-weight:700;margin-bottom:3px;}
.pay-sub{font-size:.73rem;color:var(--text3);margin-bottom:16px;}
.pay-balance{background:var(--bg2);border-radius:13px;padding:12px 15px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center;}
.pay-balance-lbl{font-size:.72rem;color:var(--text3);}
.pay-balance-val{font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:700;color:#a855f7;}
.pay-save{width:100%;padding:14px;border:none;border-radius:13px;background:#a855f7;color:#fff;font-family:'Plus Jakarta Sans',sans-serif;font-size:.9rem;font-weight:700;cursor:pointer;margin-top:4px;}
/* ══ WHAT'S NEW MODAL ══ */
.wn-overlay{position:fixed;inset:0;z-index:800;background:#00000090;display:flex;align-items:flex-end;justify-content:center;opacity:0;pointer-events:none;transition:opacity .3s;}
.wn-overlay.active{opacity:1;pointer-events:all;}
.wn-sheet{width:100%;max-width:430px;background:var(--bg1);border-radius:24px 24px 0 0;padding:0 0 env(safe-area-inset-bottom,28px);max-height:82vh;overflow:hidden;display:flex;flex-direction:column;transform:translateY(100%);transition:transform .35s cubic-bezier(.32,0,.67,0);}
.wn-overlay.active .wn-sheet{transform:translateY(0);}
.wn-handle{width:36px;height:4px;background:var(--border2);border-radius:99px;margin:14px auto 10px;flex-shrink:0;}
.wn-header{padding:4px 20px 14px;flex-shrink:0;}
.wn-title{font-family:'Playfair Display',serif;font-size:1.25rem;font-weight:900;margin-bottom:3px;}
.wn-sub{font-size:.73rem;color:var(--text3);}
.wn-body{overflow-y:auto;padding:0 20px 20px;flex:1;scrollbar-width:none;}
.wn-body::-webkit-scrollbar{display:none;}
.wn-item{display:flex;gap:14px;align-items:flex-start;padding:14px 0;border-bottom:1px solid var(--border);}
.wn-item:last-child{border-bottom:none;}
.wn-icon{width:44px;height:44px;border-radius:13px;display:flex;align-items:center;justify-content:center;font-size:1.35rem;flex-shrink:0;}
.wn-info{flex:1;min-width:0;}
.wn-name{font-size:.9rem;font-weight:700;color:var(--text);margin-bottom:3px;}
.wn-desc{font-size:.75rem;color:var(--text3);line-height:1.6;}
.wn-new-pill{display:inline-block;font-size:.55rem;font-weight:800;text-transform:uppercase;letter-spacing:.8px;background:var(--accent);color:var(--bg);border-radius:99px;padding:2px 7px;margin-left:6px;vertical-align:middle;}
/* ══ ONBOARDING ══ */
.ob-overlay{position:fixed;inset:0;z-index:900;background:#00000090;display:flex;align-items:flex-end;justify-content:center;opacity:0;pointer-events:none;transition:opacity .3s;}
.ob-overlay.active{opacity:1;pointer-events:all;}
.ob-sheet{width:100%;max-width:430px;background:var(--bg1);border-radius:24px 24px 0 0;padding:0 0 env(safe-area-inset-bottom,24px);height:88vh;max-height:88vh;overflow:hidden;display:flex;flex-direction:column;transform:translateY(100%);transition:transform .35s cubic-bezier(.32,0,.67,0);box-sizing:border-box;}
.ob-overlay.active .ob-sheet{transform:translateY(0);}
.ob-handle{width:36px;height:4px;background:var(--border2);border-radius:99px;margin:14px auto 0;flex-shrink:0;}
.ob-pages{position:relative;flex:1;overflow:hidden;width:100%;min-height:0;}
.ob-page{position:absolute;inset:0;padding:20px 24px 10px;overflow-y:auto;scrollbar-width:none;display:flex;flex-direction:column;box-sizing:border-box;opacity:0;pointer-events:none;transition:opacity .3s ease,transform .3s ease;transform:translateX(40px);}
.ob-page::-webkit-scrollbar{display:none;}
.ob-page.active{opacity:1;pointer-events:all;transform:translateX(0);}
.ob-emoji{font-size:2.8rem;margin-bottom:12px;text-align:center;}
.ob-title{font-family:'Playfair Display',serif;font-size:1.45rem;font-weight:900;text-align:center;margin-bottom:6px;line-height:1.2;}
.ob-title em{color:var(--accent);font-style:normal;}
.ob-sub{font-size:.78rem;color:var(--text3);text-align:center;line-height:1.7;margin-bottom:18px;}
.ob-steps{display:flex;flex-direction:column;gap:10px;margin-bottom:18px;}
.ob-step{display:flex;align-items:flex-start;gap:12px;background:var(--bg2);border:1px solid var(--border);border-radius:16px;padding:13px 14px;}
.ob-step-icon{font-size:1.3rem;flex-shrink:0;width:34px;height:34px;border-radius:10px;display:flex;align-items:center;justify-content:center;}
.ob-step-icon.c-acc{background:var(--accent-dim);}
.ob-step-icon.c-grn{background:var(--green-dim);}
.ob-step-icon.c-red{background:var(--red-dim);}
.ob-step-icon.c-blu{background:var(--blue-dim);}
.ob-step-body{}
.ob-step-title{font-size:.85rem;font-weight:700;color:var(--text);margin-bottom:2px;}
.ob-step-desc{font-size:.72rem;color:var(--text3);line-height:1.6;}
.ob-step-desc strong{color:var(--text2);}
.ob-tip{background:var(--accent-dim);border:1px solid var(--border2);border-radius:13px;padding:11px 14px;font-size:.74rem;color:var(--text2);line-height:1.65;margin-bottom:16px;}
.ob-tip strong{color:var(--accent);}
/* footer */
.ob-footer{flex-shrink:0;padding:12px 24px 6px;display:flex;flex-direction:column;gap:10px;border-top:1px solid var(--border);}
.ob-dots{display:flex;justify-content:center;gap:6px;}
.ob-dot{width:7px;height:7px;border-radius:99px;background:var(--border2);transition:all .25s;}
.ob-dot.active{background:var(--accent);width:20px;}
.ob-btn-row{display:flex;gap:8px;}
.ob-btn{flex:1;padding:13px;border:none;border-radius:13px;font-family:'Plus Jakarta Sans',sans-serif;font-size:.85rem;font-weight:700;cursor:pointer;transition:all .18s;}
.ob-btn:active{transform:scale(.97);}
.ob-btn-primary{background:var(--accent);color:var(--bg);}
.ob-btn-secondary{background:var(--bg2);color:var(--text2);border:1.5px solid var(--border2);}
.ob-btn-ghost{background:transparent;color:var(--text3);font-size:.75rem;text-align:center;padding:6px;}
.ob-pin-key{padding:12px 8px;border-radius:12px;border:1.5px solid var(--border2);background:var(--bg2);color:var(--text);font-family:'Plus Jakarta Sans',sans-serif;font-size:1.1rem;font-weight:700;cursor:pointer;transition:all .15s;}
.ob-pin-key:active{background:var(--accent-dim);border-color:var(--accent);color:var(--accent);}

/* ── GUIDE: page tag ── */
.ob-page-tag{font-size:.65rem;text-transform:uppercase;letter-spacing:1.2px;color:var(--accent);font-weight:700;text-align:center;margin-bottom:8px;}

/* ── GUIDE: inline tip ── */
.ob-inline-tip{font-size:.7rem;color:var(--text3);text-align:center;line-height:1.6;padding:8px 12px;background:var(--bg2);border-radius:10px;border:1px solid var(--border);}
.ob-inline-tip strong{color:var(--text2);}

/* ── GUIDE: theme cards ── */
.ob-theme-cards{display:flex;gap:10px;}
.ob-theme-card{flex:1;background:var(--bg2);border:2px solid var(--border);border-radius:16px;padding:12px 8px 10px;cursor:pointer;transition:all .2s;text-align:center;}
.ob-theme-card.active-g{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-dim);}
.ob-theme-preview{border-radius:10px;border:1.5px solid;padding:10px 8px 8px;margin-bottom:8px;}
.ob-theme-prev-bar{height:6px;border-radius:99px;width:70%;}
.ob-theme-prev-dot{width:10px;height:10px;border-radius:50%;display:inline-block;}
.ob-theme-name{font-size:.75rem;font-weight:700;color:var(--text);margin-bottom:2px;}
.ob-theme-sub{font-size:.62rem;color:var(--text3);line-height:1.4;}

/* ── GUIDE: setup block ── */
.ob-setup-block{background:var(--bg2);border:1px solid var(--border);border-radius:16px;padding:14px 16px;margin-bottom:8px;}
.ob-setup-label{font-size:.75rem;font-weight:700;color:var(--text2);margin-bottom:10px;text-transform:uppercase;letter-spacing:.6px;}

/* ── GUIDE: history limit controls ── */
.ob-limit-row{display:flex;align-items:center;gap:12px;justify-content:center;}
.ob-limit-minus,.ob-limit-plus{width:38px;height:38px;border-radius:50%;border:2px solid var(--border2);background:var(--bg1);color:var(--text);font-size:1.3rem;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .18s;flex-shrink:0;}
.ob-limit-minus:active,.ob-limit-plus:active{border-color:var(--accent);color:var(--accent);}
.ob-limit-display{display:flex;align-items:baseline;gap:5px;}
.ob-limit-num{font-family:'Playfair Display',serif;font-size:2.2rem;font-weight:900;color:var(--accent);line-height:1;}
.ob-limit-unit{font-size:.72rem;font-weight:600;color:var(--text3);}
.ob-limit-hint{font-size:.7rem;color:var(--text3);line-height:1.6;text-align:center;}

/* ── GUIDE: preset chips ── */
.ob-limit-presets,.ob-goal-chips{display:flex;flex-wrap:wrap;gap:7px;justify-content:center;}
.ob-chip{padding:7px 14px;border-radius:99px;border:1.5px solid var(--border2);background:var(--bg1);color:var(--text3);font-size:.72rem;font-weight:700;cursor:pointer;transition:all .18s;white-space:nowrap;}
.ob-chip:active,.ob-chip-sel{border-color:var(--accent);color:var(--accent);background:var(--accent-dim);}

/* ── GUIDE: goal preview ── */
.ob-goal-preview{font-size:.78rem;color:var(--text2);line-height:1.5;}
/* ══ PWA INSTALL BANNER ══ */
.pwa-banner{position:fixed;bottom:calc(var(--nav-h) + 10px);left:50%;transform:translateX(-50%);width:calc(100% - 32px);max-width:398px;background:var(--bg1);border:1.5px solid var(--border2);border-radius:18px;padding:14px 16px;z-index:300;display:flex;align-items:center;gap:12px;box-shadow:0 8px 32px #00000060;animation:slideUp .35s cubic-bezier(.34,1.56,.64,1);}
@keyframes slideUp{from{opacity:0;transform:translateX(-50%) translateY(20px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
.pwa-banner-icon{width:46px;height:46px;border-radius:12px;flex-shrink:0;display:flex;align-items:center;justify-content:center;}
.pwa-banner-text{flex:1;min-width:0;}
.pwa-banner-title{font-size:.85rem;font-weight:700;color:var(--text);margin-bottom:2px;}
.pwa-banner-sub{font-size:.68rem;color:var(--text3);line-height:1.4;}
.pwa-banner-install{flex-shrink:0;padding:8px 14px;border-radius:10px;border:none;background:var(--accent);color:var(--bg);font-family:'Plus Jakarta Sans',sans-serif;font-size:.75rem;font-weight:700;cursor:pointer;transition:all .15s;}
.pwa-banner-install:active{transform:scale(.95);}
.pwa-banner-close{flex-shrink:0;width:24px;height:24px;border-radius:50%;border:none;background:var(--bg3);color:var(--text3);font-size:.65rem;cursor:pointer;display:flex;align-items:center;justify-content:center;}
/* ios install sheet */
.ios-install-sheet{position:fixed;inset:0;z-index:500;background:#00000085;display:flex;align-items:flex-end;justify-content:center;opacity:0;pointer-events:none;transition:opacity .25s;}
.ios-install-sheet.open{opacity:1;pointer-events:all;}
.ios-install-inner{width:100%;max-width:430px;background:var(--bg1);border-radius:24px 24px 0 0;padding:20px 22px calc(env(safe-area-inset-bottom,20px) + 20px);transform:translateY(100%);transition:transform .35s cubic-bezier(.32,0,.67,0);}
.ios-install-sheet.open .ios-install-inner{transform:translateY(0);}
.ios-step{display:flex;align-items:flex-start;gap:13px;margin-bottom:14px;}
.ios-step-num{width:26px;height:26px;border-radius:50%;background:var(--accent);color:var(--bg);font-size:.72rem;font-weight:900;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:1px;}
.ios-step-text{font-size:.83rem;color:var(--text2);line-height:1.55;}
.ios-step-text strong{color:var(--text);}

/* ── BACKUP REMINDER MODAL ── */
.backup-overlay{position:fixed;inset:0;z-index:600;background:#00000088;display:flex;align-items:flex-end;justify-content:center;opacity:0;pointer-events:none;transition:opacity .25s;}
.backup-overlay.open{opacity:1;pointer-events:all;}
.backup-sheet{width:100%;max-width:430px;background:var(--bg1);border-radius:24px 24px 0 0;padding:22px 22px calc(env(safe-area-inset-bottom,20px)+22px);transform:translateY(100%);transition:transform .32s cubic-bezier(.32,0,.67,0);}
.backup-overlay.open .backup-sheet{transform:translateY(0);}
.backup-icon{font-size:2.4rem;text-align:center;margin-bottom:8px;}
.backup-title{font-family:'Playfair Display',serif;font-size:1.25rem;font-weight:900;text-align:center;margin-bottom:6px;}
.backup-msg{font-size:.8rem;color:var(--text3);text-align:center;line-height:1.7;margin-bottom:20px;}
.backup-btn-row{display:flex;gap:8px;}
.backup-btn{flex:1;padding:14px;border:none;border-radius:13px;font-family:'Plus Jakarta Sans',sans-serif;font-size:.88rem;font-weight:700;cursor:pointer;transition:all .15s;}
.backup-btn:active{transform:scale(.97);}
.backup-btn-skip{background:var(--bg2);color:var(--text3);}
.backup-btn-now{background:var(--accent);color:var(--bg);}
/* Backup interval row in settings */
.backup-interval-row{display:flex;align-items:center;gap:8px;background:var(--bg2);border:1.5px solid var(--border2);border-radius:11px;padding:10px 13px;margin-top:8px;}
.bir-label{flex:1;font-size:.82rem;font-weight:600;color:var(--text2);}
.bir-input{width:54px;background:var(--bg1);border:1.5px solid var(--border2);border-radius:8px;padding:5px 8px;color:var(--text);font-family:'Playfair Display',serif;font-size:.95rem;font-weight:700;text-align:center;outline:none;}
.bir-input:focus{border-color:var(--accent);}
.bir-unit{font-size:.75rem;color:var(--text3);font-weight:600;}
</style>
</head>
<body>
<div id="app">

<!-- ══ FEED VIEW ══ -->
<div class="view" id="view-feed">
  <div class="topbar">
    <div class="top-row">
      <div>
        <div class="top-title">Spend<span>oodle</span> <span style="font-family:'Plus Jakarta Sans',sans-serif;font-size:.55rem;font-weight:700;color:var(--text3);background:var(--bg2);border:1px solid var(--border2);border-radius:6px;padding:2px 6px;vertical-align:middle;letter-spacing:.3px;">v1.3</span></div>
        <div class="top-sub" id="cycle-mode-label">Pay-cycle tracker</div>
      </div>
      <div style="display:flex;align-items:center;gap:7px;">
        <div class="top-date" id="top-date-label"></div>
        <button class="icon-btn" id="whats-new-btn" onclick="openWhatsNew()" title="What's New" style="position:relative;">✨<span id="new-badge" style="position:absolute;top:-4px;right:-4px;width:8px;height:8px;background:var(--accent);border-radius:50%;border:1.5px solid var(--bg);display:block;"></span></button>
        <button class="icon-btn" onclick="nav('settings')">⚙️</button>
      </div>
    </div>
    <div class="cycle-nav">
      <button class="mnav-btn" id="mnav-prev" onclick="shiftCycle(-1)">‹</button>
      <div class="cycle-center">
        <div class="cycle-label" id="cycle-label"></div>
        <div class="cycle-range" id="cycle-range"></div>
      </div>
      <button class="mnav-btn" id="mnav-next" onclick="shiftCycle(1)">›</button>
    </div>

  </div>

  <div class="feed-balance-bar" id="feed-balance-bar">
    <div class="fbb-left">
      <div class="fbb-label">Balance Remaining</div>
      <div class="fbb-amount" id="fbb-amount">—</div>
      <div class="fbb-track"><div class="fbb-fill" id="fbb-fill" style="width:0%;"></div></div>
    </div>
    <div class="fbb-stats">
      <div class="fbb-stat"><div class="fbb-stat-dot" style="background:var(--green);"></div><span id="fbb-income" style="color:var(--text2);">—</span></div>
      <div class="fbb-stat"><div class="fbb-stat-dot" style="background:var(--red);"></div><span id="fbb-expense" style="color:var(--text2);">—</span></div>
      <div class="fbb-stat"><div class="fbb-stat-dot" style="background:var(--accent);"></div><span id="fbb-savings" style="color:var(--text2);">—</span></div>
    </div>
  </div>

  <div id="budget-area"></div>
  <div class="search-wrap">
    <span class="search-icon">🔍</span>
    <input type="text" class="search-input" id="search-input" placeholder="Search transactions…" oninput="onSearch()"/>
    <button class="search-clear" id="search-clear" onclick="clearSearch()" style="display:none;">✕</button>
  </div>
  <div class="filter-wrap" id="filter-chips"></div>
  <div class="feed-body" id="feed-list"></div>
</div>

<!-- ══ DASHBOARD VIEW ══ -->
<div class="view hidden" id="view-dashboard">
  <div class="topbar">
    <div class="top-row">
      <div><div class="top-title">Dash<span>board</span></div><div class="top-sub">Trends & insights</div></div>
      <div style="display:flex;align-items:center;gap:7px;">
        <div class="top-date" id="dash-date-label"></div>
      </div>
    </div>
    <div class="cycle-nav">
      <button class="mnav-btn" id="dash-mnav-prev" onclick="shiftCycle(-1);renderDash()">‹</button>
      <div class="cycle-center">
        <div class="cycle-label" id="dash-cycle-label"></div>
        <div class="cycle-range" id="dash-cycle-range"></div>
      </div>
      <button class="mnav-btn" id="dash-mnav-next" onclick="shiftCycle(1);renderDash()">›</button>
    </div>
  </div>
  <div style="padding:0 20px 10px;">
    <div id="dash-streak-area"></div>
    <div class="hero-card">
      <div class="hero-label" id="hero-label">Remaining this cycle</div>
      <div class="hero-amount" id="hero-net">
        <span class="sign" id="hero-sign"></span><span id="hero-net-val">0</span>
      </div>
      <div class="hero-grid">
        <div class="hero-stat"><div class="hs-label">Income</div><div class="hs-val c-inc" id="hero-income">0</div></div>
        <div class="hero-stat"><div class="hs-label">Spent</div><div class="hs-val c-exp" id="hero-expense">0</div></div>
        <div class="hero-stat"><div class="hs-label">Saved</div><div class="hs-val c-sav" id="hero-savings">0</div></div>
      </div>
      <div id="projection-inline" style="display:none;" class="projection-inline"></div>
    </div>
  </div>
  <div class="dash-body" id="dash-content"></div>
</div>

<!-- ══ SETTINGS VIEW ══ -->
<div class="view hidden" id="view-settings">
  <div class="topbar" style="padding-bottom:14px;">
    <div class="top-row">
      <div><div class="top-title">Set<span>tings</span></div><div class="top-sub">Preferences & backup</div></div>
      <button class="icon-btn" onclick="nav('feed')">✕</button>
    </div>
  </div>
  <div style="padding:0 20px 100px;">

    <!-- SHOW GUIDE -->
    <div class="settings-card">
      <div class="settings-icon" style="background:var(--accent-dim)">📖</div>
      <div class="settings-body">
        <div class="settings-title">User Guide</div>
        <div class="settings-desc">New to Spendoodle? Revisit the setup guide anytime to learn how everything works and how to customise it for your situation.</div>
        <button class="settings-btn btn-accent" onclick="obOpen();nav('feed')">📖 Open Guide</button>
      </div>
    </div>

    <!-- THEME -->
    <div class="settings-card">
      <div class="settings-icon" style="background:var(--accent-dim)">🎨</div>
      <div class="settings-body">
        <div class="settings-title">Theme</div>
        <div class="settings-desc">Choose your app look.</div>
        <div class="theme-row">
          <button class="theme-btn dark" onclick="setTheme('dark')" id="theme-dark">🌑 Noir</button>
          <button class="theme-btn pink" onclick="setTheme('pink')" id="theme-pink">🌸 Rose</button>
          <button class="theme-btn white" onclick="setTheme('white')" id="theme-white">🤍 Pearl</button>
          <button class="theme-btn navy" onclick="setTheme('navy')" id="theme-navy">🌊 Navy</button>
          <button class="theme-btn ice" onclick="setTheme('ice')" id="theme-ice">🧊 Ice</button>
          <button class="theme-btn forest" onclick="setTheme('forest')" id="theme-forest">🌿 Forest</button>
          <button class="theme-btn sunset" onclick="setTheme('sunset')" id="theme-sunset">🌅 Sunset</button>
          <button class="theme-btn midnight" onclick="setTheme('midnight')" id="theme-midnight">🔮 Midnight</button>
        </div>
      </div>
    </div>

    <!-- PAY CYCLE -->
    <div class="settings-card">
      <div class="settings-icon" style="background:var(--accent-dim)">📅</div>
      <div class="settings-body">
        <div class="settings-title">Pay Cycle Setup</div>
        <div class="settings-desc">Choose how your pay cycle works. All data stays intact when you change this.</div>
        <div class="cycle-mode-row">
          <div class="cycle-mode-opt" id="cmo-monthly" onclick="selectCycleMode('monthly')">
            <div class="cmo-radio"><div class="cmo-radio-dot"></div></div>
            <div class="cmo-text"><div class="cmo-title">Once a month</div><div class="cmo-sub">e.g. every 25th → 24th of next month</div></div>
          </div>
          <div class="cycle-mode-opt" id="cmo-bimonthly" onclick="selectCycleMode('bimonthly')">
            <div class="cmo-radio"><div class="cmo-radio-dot"></div></div>
            <div class="cmo-text"><div class="cmo-title">Twice a month</div><div class="cmo-sub">e.g. 1st–15th and 16th–end of month</div></div>
          </div>
          <div class="cycle-mode-opt" id="cmo-custom" onclick="selectCycleMode('custom')">
            <div class="cmo-radio"><div class="cmo-radio-dot"></div></div>
            <div class="cmo-text"><div class="cmo-title">Custom days</div><div class="cmo-sub">Set any start and end day you want</div></div>
          </div>
          <div class="cycle-mode-opt" id="cmo-weekly" onclick="selectCycleMode('weekly')">
            <div class="cmo-radio"><div class="cmo-radio-dot"></div></div>
            <div class="cmo-text"><div class="cmo-title">Weekly</div><div class="cmo-sub">Paid every week — pick which day your week starts</div></div>
          </div>
        </div>

        <!-- Monthly fields -->
        <div class="cycle-fields" id="fields-monthly" style="display:none;">
          <div class="cf-row"><span class="cf-label">Pay day (day of month)</span><input class="cf-input" id="pay-day" type="number" min="1" max="28" value="25"/></div>
          <div class="cf-note">Cycle runs from your pay day to one day before next pay day.</div>
        </div>

        <!-- Bi-monthly fields -->
        <div class="cycle-fields" id="fields-bimonthly" style="display:none;">
          <div class="cf-note" style="margin-bottom:4px;">Works for same-month <em>and</em> cross-month splits (e.g. 25→10 next month).</div>
          <div class="cf-row"><span class="cf-label">Period A — start day</span><input class="cf-input" id="bi-s1" type="number" min="1" max="31" value="25" oninput="updateBiPreview()"/></div>
          <div class="cf-row"><span class="cf-label">Period A — end day</span><input class="cf-input" id="bi-e1" type="number" min="1" max="31" value="10" oninput="updateBiPreview()"/></div>
          <div class="cf-row"><span class="cf-label">Period B — start day</span><input class="cf-input" id="bi-s2" type="number" min="1" max="31" value="11" oninput="updateBiPreview()"/></div>
          <div class="cf-row"><span class="cf-label">Period B — end day</span><input class="cf-input" id="bi-e2" type="number" min="1" max="31" value="24" oninput="updateBiPreview()"/></div>
          <div class="cf-note" id="bi-preview" style="margin-top:4px;color:var(--accent);font-weight:600;"></div>
        </div>

        <!-- Custom fields -->
        <div class="cycle-fields" id="fields-custom" style="display:none;">
          <div class="cf-row"><span class="cf-label">Cycle start day</span><input class="cf-input" id="cust-start" type="number" min="1" max="28" value="1"/></div>
          <div class="cf-row"><span class="cf-label">Cycle length (days)</span><input class="cf-input" id="cust-len" type="number" min="7" max="90" value="30"/></div>
          <div class="cf-note">e.g. start=1, length=14 → fortnightly from 1st.</div>
        </div>

        <!-- Weekly fields -->
        <div class="cycle-fields" id="fields-weekly" style="display:none;">
          <div class="cf-row">
            <span class="cf-label">Which day do you get paid?</span>
            <select class="cf-input" id="pay-dow" style="font-family:'Plus Jakarta Sans',sans-serif;">
              <option value="0">Sunday</option>
              <option value="1" selected>Monday</option>
              <option value="2">Tuesday</option>
              <option value="3">Wednesday</option>
              <option value="4">Thursday</option>
              <option value="5">Friday</option>
              <option value="6">Saturday</option>
            </select>
          </div>
          <div class="cf-note">Your pay week runs 7 days starting from that day.</div>
        </div>

        <button class="settings-btn btn-accent" style="margin-top:10px;" onclick="saveCycleSettings()">Save Cycle Settings</button>
      </div>
    </div>

    <!-- CURRENCY -->
    <div class="settings-card">
      <div class="settings-icon" style="background:var(--blue-dim)">💱</div>
      <div class="settings-body">
        <div class="settings-title">Currency Symbol</div>
        <div class="settings-desc">Shown everywhere across the app.</div>
        <div style="display:flex;gap:8px;">
          <input class="cf-input" id="currency-input" type="text" maxlength="4" placeholder="₱" style="width:70px;"/>
          <button class="settings-btn btn-blue" style="flex:1;margin:0;" onclick="saveCurrency()">Apply</button>
        </div>
      </div>
    </div>

    <!-- CYCLE HISTORY LIMIT -->
    <div class="settings-card">
      <div class="settings-icon" style="background:var(--blue-dim)">🗂</div>
      <div class="settings-body">
        <div class="settings-title">Cycle History Limit</div>
        <div class="settings-desc">
          Max number of cycles to keep. Oldest cycles are <strong>automatically deleted</strong> when the limit is reached — the current cycle is always kept.<br/>
          <span style="color:var(--text3);font-size:.68rem;">Min: 3 · Max: 60 · Default: 24</span>
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          <input class="cf-input" id="cycle-limit-input" type="number" min="3" max="60" value="24" style="width:76px;"/>
          <span style="font-size:.75rem;color:var(--text3);flex:1;">cycles stored</span>
          <button class="settings-btn btn-blue" style="margin:0;padding:11px 16px;" onclick="saveCycleLimit()">Apply</button>
        </div>
        <div id="cycle-limit-preview" style="margin-top:8px;font-size:.7rem;color:var(--text3);line-height:1.6;"></div>
      </div>
    </div>

    <!-- EXPORT -->
    <div class="settings-card">
      <div class="settings-icon" style="background:var(--accent-dim)">📤</div>
      <div class="settings-body">
        <div class="settings-title">Export &amp; Backup</div>
        <div class="settings-desc">Exports <strong>everything</strong>: all transactions, budgets, currency, theme, and cycle settings — as a single <code>.json</code> backup file.<br/><br/>Your data auto-saves in the browser after every change. Use Export when switching devices or clearing your browser.</div>
        <button class="settings-btn btn-accent" onclick="exportData()">📤 Download Full Backup (.json)</button>
        <button class="settings-btn" style="background:var(--green-dim);color:var(--green);border:1.5px solid var(--green);margin-top:7px;" onclick="exportCSV()">📊 Export Transactions (.csv)</button>
        <div class="backup-interval-row">
          <span class="bir-label">🔔 Remind me to back up every</span>
          <input class="bir-input" type="number" id="backup-interval-input" min="1" max="365" value="30" onchange="saveBackupInterval(this.value)"/>
          <span class="bir-unit">days</span>
        </div>
        <div style="font-size:.68rem;color:var(--text3);margin-top:6px;" id="last-backup-label"></div>
      </div>
    </div>

    <!-- IMPORT -->
    <div class="settings-card">
      <div class="settings-icon" style="background:var(--green-dim)">📥</div>
      <div class="settings-body">
        <div class="settings-title">Import Data</div>
        <div class="settings-desc">Load a backup file. Merges with current data — no duplicates.</div>
        <label class="settings-btn btn-green" style="cursor:pointer;">
          Choose ledger-data.json
          <input type="file" accept=".json" style="display:none;" onchange="importData(event)"/>
        </label>
      </div>
    </div>

    <!-- PIN LOCK -->
    <div class="settings-card">
      <div class="settings-icon" style="background:var(--blue-dim)">🔐</div>
      <div class="settings-body">
        <div class="settings-title">PIN Lock</div>
        <div class="settings-desc" id="pin-settings-desc">Protect your data with a 4-digit PIN. Required every time you open the app.</div>
        <div id="pin-settings-btns"></div>
      </div>
    </div>

    <!-- CLEAR -->
    <div class="settings-card">
      <div class="settings-icon" style="background:var(--red-dim)">🗑</div>
      <div class="settings-body">
        <div class="settings-title">Clear All Data</div>
        <div class="settings-desc">Permanently delete everything. Export a backup first!</div>
        <button class="settings-btn btn-red" onclick="clearAllData()">Delete Everything</button>
      </div>
    </div>

    <!-- CREDIT CARDS -->
    <div class="settings-card">
      <div class="settings-icon" style="background:#a855f718">💳</div>
      <div class="settings-body">
        <div class="settings-title">Credit Cards</div>
        <div class="settings-desc">Add your credit cards. When adding an expense, you can choose to charge it to a card instead of your cash balance. Pay the bill later to restore the card's available credit.</div>
        <div id="cc-settings-list" style="margin-bottom:10px;"></div>
        <div style="display:flex;gap:8px;margin-bottom:8px;">
          <input class="cf-input" id="cc-name-input" type="text" maxlength="20" placeholder="Card name" style="flex:1;width:auto;text-align:left;font-family:'Plus Jakarta Sans',sans-serif;font-size:.82rem;"/>
          <input class="cf-input" id="cc-limit-input" type="number" min="1" placeholder="Limit" style="width:90px;"/>
        </div>
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
          <input class="cf-input" id="cc-interest-input" type="number" min="0" step="0.01" placeholder="Fixed billing fee e.g. 50 (optional)" style="flex:1;width:auto;text-align:left;font-family:'Plus Jakarta Sans',sans-serif;font-size:.82rem;"/>
          <div style="font-size:.65rem;color:var(--text3);line-height:1.4;flex-shrink:0;max-width:90px;">charged each billing cycle</div>
        </div>
        <button class="settings-btn btn-blue" style="background:#a855f718;color:#a855f7;border-color:#a855f730;" onclick="addCreditCard()">+ Add Card</button>
      </div>
    </div>

    <div id="settings-toast" style="display:none;margin-top:14px;" class="toast">✓ Done!</div>
    <div id="settings-err" style="display:none;margin-top:14px;" class="date-err">⚠️ Invalid file.</div>

    <div style="margin-top:10px;background:var(--bg1);border:1px solid var(--border);border-radius:16px;padding:15px 17px;">
      <div style="font-size:.62rem;text-transform:uppercase;letter-spacing:1px;color:var(--text3);font-weight:700;margin-bottom:8px;">Your data summary</div>
      <div id="settings-stats" style="font-size:.82rem;color:var(--text2);line-height:1.9;"></div>
    </div>
  </div>
</div>

<!-- ══ BOTTOM NAV ══ -->
<div class="bottom-nav">
  <button class="nav-btn active" id="nav-feed" onclick="nav('feed')">
    <span class="nav-icon">🏠</span><span class="nav-lbl">Feed</span>
  </button>
  <div class="fab-wrap">
    <div class="fab-dial" id="fab-dial">
      <button class="fab-dial-btn fab-dial-income" onclick="openSheetType('income')"><span class="fab-dial-icon">💼</span><span class="fab-dial-lbl" style="color:var(--bg)">Income</span></button>
      <button class="fab-dial-btn fab-dial-expense" onclick="openSheetType('expense')"><span class="fab-dial-icon">🛒</span><span class="fab-dial-lbl" style="color:#fff">Expense</span></button>
      <button class="fab-dial-btn fab-dial-savings" onclick="openSheetType('savings')"><span class="fab-dial-icon">🏦</span><span class="fab-dial-lbl" style="color:var(--bg)">Savings</span></button>
    </div>
    <button class="fab" id="fab-main" onclick="toggleFabDial()">＋</button>
  </div>
  <div class="fab-backdrop" id="fab-backdrop" onclick="closeFabDial()"></div>
  <button class="nav-btn" id="nav-dashboard" onclick="nav('dashboard')">
    <span class="nav-icon">📊</span><span class="nav-lbl">Dashboard</span>
  </button>
</div>

<!-- ══ PWA INSTALL BANNER ══ -->
<div class="pwa-banner" id="pwa-banner" style="display:none;">
  <div class="pwa-banner-icon" id="pwa-banner-icon"></div>
  <div class="pwa-banner-text">
    <div class="pwa-banner-title">Install Spendoodle</div>
    <div class="pwa-banner-sub" id="pwa-banner-sub">Add to home screen for the best experience</div>
  </div>
  <button class="pwa-banner-install" id="pwa-banner-btn" onclick="pwaInstall()">Install</button>
  <button class="pwa-banner-close" onclick="pwaDismiss()">✕</button>
</div>

<!-- ══ iOS INSTALL SHEET ══ -->
<div class="ios-install-sheet" id="ios-install-sheet" onclick="closeIosSheet(event)">
  <div class="ios-install-inner">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:18px;">
      <div id="ios-sheet-icon" style="width:52px;height:52px;border-radius:13px;flex-shrink:0;"></div>
      <div>
        <div style="font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:900;">Install Spendoodle</div>
        <div style="font-size:.72rem;color:var(--text3);margin-top:2px;">Add to your Home Screen</div>
      </div>
      <button style="margin-left:auto;background:var(--bg2);border:1.5px solid var(--border2);border-radius:8px;padding:5px 10px;font-size:.7rem;font-weight:700;color:var(--text3);cursor:pointer;" onclick="closeIosSheet()">Done</button>
    </div>
    <div class="ios-step">
      <div class="ios-step-num">1</div>
      <div class="ios-step-text">Tap the <strong>Share button</strong> <span style="font-size:1.1rem;">⬆️</span> at the bottom of your Safari browser bar</div>
    </div>
    <div class="ios-step">
      <div class="ios-step-num">2</div>
      <div class="ios-step-text">Scroll down and tap <strong>"Add to Home Screen"</strong> <span style="font-size:1rem;">➕</span></div>
    </div>
    <div class="ios-step">
      <div class="ios-step-num">3</div>
      <div class="ios-step-text">Tap <strong>"Add"</strong> in the top-right corner — Spendoodle will appear on your home screen like a native app ✅</div>
    </div>
    <div style="background:var(--accent-dim);border:1px solid var(--border2);border-radius:12px;padding:10px 14px;font-size:.72rem;color:var(--text2);margin-top:4px;line-height:1.6;">
      💡 <strong style="color:var(--accent)">Works offline</strong> — your data is stored on your device, not the cloud. No login needed.
    </div>
  </div>
</div>
</div>

<!-- ══ BACKUP REMINDER ══ -->
<div class="backup-overlay" id="backup-overlay" onclick="dismissBackupReminder(event)">
  <div class="backup-sheet" onclick="event.stopPropagation()">
    <div class="backup-icon">💾</div>
    <div class="backup-title">Time to Back Up</div>
    <div class="backup-msg" id="backup-msg">It's been a while since your last backup. Download a copy to keep your data safe in case you clear your browser or switch devices.</div>
    <div class="backup-btn-row">
      <button class="backup-btn backup-btn-skip" onclick="snoozeBackup()">Remind me later</button>
      <button class="backup-btn backup-btn-now" onclick="backupNow()">📤 Back Up Now</button>
    </div>
  </div>
</div>
<div class="ob-overlay" id="ob-overlay">
  <div class="ob-sheet">
    <div class="ob-handle"></div>
    <div class="ob-pages" id="ob-pages">

      <!-- ── SLIDE 1: Welcome / What the app does ── -->
      <div class="ob-page">
        <div style="height:4px;"></div>
        <div class="ob-emoji" style="font-size:3rem;">🤑</div>
        <div class="ob-title">Oh hey, <em>broke bestie.</em></div>
        <div class="ob-sub" style="margin-bottom:14px;">Spendoodle is a <strong style="color:var(--accent)">pay-cycle money tracker</strong> that actually makes sense — because it works around <em style="color:var(--accent)">your</em> payday, not some random calendar month.</div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px;">
          <div style="background:var(--bg2);border:1.5px solid var(--border2);border-radius:16px;padding:13px 12px;">
            <div style="font-size:1.4rem;margin-bottom:5px;">💸</div>
            <div style="font-size:.78rem;font-weight:800;color:var(--text);margin-bottom:3px;">Log it fast</div>
            <div style="font-size:.68rem;color:var(--text3);line-height:1.55;">Tap +, pick a category, type the amount. Done in 5 seconds. Yes, really.</div>
          </div>
          <div style="background:var(--bg2);border:1.5px solid var(--border2);border-radius:16px;padding:13px 12px;">
            <div style="font-size:1.4rem;margin-bottom:5px;">📅</div>
            <div style="font-size:.78rem;font-weight:800;color:var(--text);margin-bottom:3px;">Your payday, your rules</div>
            <div style="font-size:.68rem;color:var(--text3);line-height:1.55;">Set when you get paid and everything resets automatically. No more mental math.</div>
          </div>
          <div style="background:var(--bg2);border:1.5px solid var(--border2);border-radius:16px;padding:13px 12px;">
            <div style="font-size:1.4rem;margin-bottom:5px;">📊</div>
            <div style="font-size:.78rem;font-weight:800;color:var(--text);margin-bottom:3px;">See where it went</div>
            <div style="font-size:.68rem;color:var(--text3);line-height:1.55;">Charts, trends, and a forecast that tells you if you're about to go broke.</div>
          </div>
          <div style="background:var(--bg2);border:1.5px solid var(--border2);border-radius:16px;padding:13px 12px;">
            <div style="font-size:1.4rem;margin-bottom:5px;">🔒</div>
            <div style="font-size:.78rem;font-weight:800;color:var(--text);margin-bottom:3px;">100% offline & private</div>
            <div style="font-size:.68rem;color:var(--text3);line-height:1.55;">No account. No cloud. No one snooping. Your data lives on your phone, period.</div>
          </div>
        </div>

        <div class="ob-tip" style="margin-top:0;margin-bottom:0;">
          ⚡ <strong>4 quick steps and you're set:</strong> pick a vibe · set payday · name a savings goal · add a card (optional) — then go touch some grass 🌿
        </div>
      </div>

      <!-- ── SLIDE 2: Theme (interactive) ── -->
      <div class="ob-page">
        <div style="height:4px;"></div>
        <div class="ob-page-tag">Step 1 of 5 · Theme</div>
        <div class="ob-emoji">🎨</div>
        <div class="ob-title">Choose Your <em>Look</em></div>
        <div class="ob-sub">Tap any card below — the <strong style="color:var(--accent)">whole app changes instantly</strong>. Try them all before you decide.</div>
        <div class="ob-theme-cards" style="gap:8px;display:grid;grid-template-columns:repeat(4,1fr);">
          <div class="ob-theme-card" id="g-theme-dark" onclick="gSetTheme('dark')">
            <div class="ob-theme-preview" style="background:#141420;border-color:#252538;padding:11px 10px 9px;">
              <div class="ob-theme-prev-bar" style="background:#d4a853;margin-bottom:7px;"></div>
              <div style="display:flex;gap:5px;">
                <div class="ob-theme-prev-dot" style="background:#4fd87c;"></div>
                <div class="ob-theme-prev-dot" style="background:#f06464;"></div>
              </div>
            </div>
            <div class="ob-theme-name" style="font-size:.72rem;">🌑 Noir</div>
          </div>
          <div class="ob-theme-card" id="g-theme-pink" onclick="gSetTheme('pink')">
            <div class="ob-theme-preview" style="background:#2e1426;border-color:#5c2846;padding:11px 10px 9px;">
              <div class="ob-theme-prev-bar" style="background:#f472b6;margin-bottom:7px;"></div>
              <div style="display:flex;gap:5px;">
                <div class="ob-theme-prev-dot" style="background:#34d399;"></div>
                <div class="ob-theme-prev-dot" style="background:#f87171;"></div>
              </div>
            </div>
            <div class="ob-theme-name" style="font-size:.72rem;">🌸 Rose</div>
          </div>
          <div class="ob-theme-card" id="g-theme-white" onclick="gSetTheme('white')">
            <div class="ob-theme-preview" style="background:#f0ede8;border-color:#ccc8c0;padding:11px 10px 9px;">
              <div class="ob-theme-prev-bar" style="background:#b8860b;margin-bottom:7px;"></div>
              <div style="display:flex;gap:5px;">
                <div class="ob-theme-prev-dot" style="background:#16a34a;"></div>
                <div class="ob-theme-prev-dot" style="background:#dc2626;"></div>
              </div>
            </div>
            <div class="ob-theme-name" style="font-size:.72rem;">🤍 Pearl</div>
          </div>
          <div class="ob-theme-card" id="g-theme-navy" onclick="gSetTheme('navy')">
            <div class="ob-theme-preview" style="background:#0d1626;border-color:#1d2d55;padding:11px 10px 9px;">
              <div class="ob-theme-prev-bar" style="background:#3b82f6;margin-bottom:7px;"></div>
              <div style="display:flex;gap:5px;">
                <div class="ob-theme-prev-dot" style="background:#22d3a5;"></div>
                <div class="ob-theme-prev-dot" style="background:#f87171;"></div>
              </div>
            </div>
            <div class="ob-theme-name" style="font-size:.72rem;">🌊 Navy</div>
          </div>
          <div class="ob-theme-card" id="g-theme-ice" onclick="gSetTheme('ice')">
            <div class="ob-theme-preview" style="background:#102535;border-color:#234560;padding:11px 10px 9px;">
              <div class="ob-theme-prev-bar" style="background:#06b6d4;margin-bottom:7px;"></div>
              <div style="display:flex;gap:5px;">
                <div class="ob-theme-prev-dot" style="background:#34d399;"></div>
                <div class="ob-theme-prev-dot" style="background:#fb7185;"></div>
              </div>
            </div>
            <div class="ob-theme-name" style="font-size:.72rem;">🧊 Ice</div>
          </div>
          <div class="ob-theme-card" id="g-theme-forest" onclick="gSetTheme('forest')">
            <div class="ob-theme-preview" style="background:#0b1c15;border-color:#1c3a28;padding:11px 10px 9px;">
              <div class="ob-theme-prev-bar" style="background:#10b981;margin-bottom:7px;"></div>
              <div style="display:flex;gap:5px;">
                <div class="ob-theme-prev-dot" style="background:#4ade80;"></div>
                <div class="ob-theme-prev-dot" style="background:#f87171;"></div>
              </div>
            </div>
            <div class="ob-theme-name" style="font-size:.72rem;">🌿 Forest</div>
          </div>
          <div class="ob-theme-card" id="g-theme-sunset" onclick="gSetTheme('sunset')">
            <div class="ob-theme-preview" style="background:#221500;border-color:#503400;padding:11px 10px 9px;">
              <div class="ob-theme-prev-bar" style="background:#f97316;margin-bottom:7px;"></div>
              <div style="display:flex;gap:5px;">
                <div class="ob-theme-prev-dot" style="background:#4ade80;"></div>
                <div class="ob-theme-prev-dot" style="background:#f87171;"></div>
              </div>
            </div>
            <div class="ob-theme-name" style="font-size:.72rem;">🌅 Sunset</div>
          </div>
          <div class="ob-theme-card" id="g-theme-midnight" onclick="gSetTheme('midnight')">
            <div class="ob-theme-preview" style="background:#120c2c;border-color:#2e2460;padding:11px 10px 9px;">
              <div class="ob-theme-prev-bar" style="background:#a855f7;margin-bottom:7px;"></div>
              <div style="display:flex;gap:5px;">
                <div class="ob-theme-prev-dot" style="background:#34d399;"></div>
                <div class="ob-theme-prev-dot" style="background:#f87171;"></div>
              </div>
            </div>
            <div class="ob-theme-name" style="font-size:.72rem;">🔮 Midnight</div>
          </div>
        </div>
        <div class="ob-tip" style="margin-top:14px;">💡 <strong>Tip:</strong> You can change your theme anytime in <strong>⚙️ Settings</strong>.</div>
        <div class="ob-inline-tip" style="margin-top:8px;">Theme is saved when you tap <strong>Save &amp; Next →</strong></div>
      </div>

      <!-- ── SLIDE 3: Pay Cycle (interactive) ── -->
      <div class="ob-page">
        <div style="height:4px;"></div>
        <div class="ob-page-tag">Step 2 of 5 · Pay Cycle</div>
        <div class="ob-emoji">📅</div>
        <div class="ob-title">When Do You Get <em>Paid?</em></div>
        <div class="ob-sub">Transactions are grouped by <strong style="color:var(--accent)">pay period</strong>, not calendar month — so your balance always reflects your real financial cycle.</div>
        <div class="ob-setup-block">
          <div class="ob-setup-label">Select your pay frequency</div>
          <div class="cycle-mode-row" style="gap:7px;">
            <div class="cycle-mode-opt" id="g-cmo-monthly" onclick="gSelectCycleMode('monthly')">
              <div class="cmo-radio"><div class="cmo-radio-dot"></div></div>
              <div class="cmo-text">
                <div class="cmo-title">Once a month</div>
                <div class="cmo-sub">e.g. paid on the 25th every month</div>
              </div>
            </div>
            <div class="cycle-mode-opt" id="g-cmo-bimonthly" onclick="gSelectCycleMode('bimonthly')">
              <div class="cmo-radio"><div class="cmo-radio-dot"></div></div>
              <div class="cmo-text">
                <div class="cmo-title">Twice a month</div>
                <div class="cmo-sub">e.g. 25th–10th and 11th–24th</div>
              </div>
            </div>
            <div class="cycle-mode-opt" id="g-cmo-custom" onclick="gSelectCycleMode('custom')">
              <div class="cmo-radio"><div class="cmo-radio-dot"></div></div>
              <div class="cmo-text">
                <div class="cmo-title">Custom interval</div>
                <div class="cmo-sub">Weekly, fortnightly, any length</div>
              </div>
            </div>
            <div class="cycle-mode-opt" id="g-cmo-weekly" onclick="gSelectCycleMode('weekly')">
              <div class="cmo-radio"><div class="cmo-radio-dot"></div></div>
              <div class="cmo-text">
                <div class="cmo-title">Weekly</div>
                <div class="cmo-sub">Paid every week — pick your pay day</div>
              </div>
            </div>
          </div>
          <!-- Monthly fields -->
          <div class="cycle-fields" id="g-fields-monthly" style="display:none;">
            <div class="cf-row">
              <span class="cf-label">Which day of month do you get paid?</span>
              <input class="cf-input" id="g-pay-day" type="number" min="1" max="28" value="25"/>
            </div>
            <div class="cf-note">💡 e.g. enter 25 → cycle runs 25th → 24th of next month.</div>
          </div>
          <!-- Bi-monthly fields -->
          <div class="cycle-fields" id="g-fields-bimonthly" style="display:none;">
            <div class="cf-note" style="margin-bottom:6px;">💡 Supports cross-month splits (e.g. 25th → 10th next month).</div>
            <div class="cf-row"><span class="cf-label">Period A — starts on day</span><input class="cf-input" id="g-bi-s1" type="number" min="1" max="31" value="25"/></div>
            <div class="cf-row"><span class="cf-label">Period A — ends on day</span><input class="cf-input" id="g-bi-e1" type="number" min="1" max="31" value="10"/></div>
            <div class="cf-row"><span class="cf-label">Period B — starts on day</span><input class="cf-input" id="g-bi-s2" type="number" min="1" max="31" value="11"/></div>
            <div class="cf-row"><span class="cf-label">Period B — ends on day</span><input class="cf-input" id="g-bi-e2" type="number" min="1" max="31" value="24"/></div>
          </div>
          <!-- Custom fields -->
          <div class="cycle-fields" id="g-fields-custom" style="display:none;">
            <div class="cf-note" style="margin-bottom:6px;">💡 e.g. start = 1, length = 14 → fortnightly from the 1st.</div>
            <div class="cf-row"><span class="cf-label">Cycle starts on which day of month?</span><input class="cf-input" id="g-cust-start" type="number" min="1" max="28" value="1"/></div>
            <div class="cf-row"><span class="cf-label">How many days in each cycle?</span><input class="cf-input" id="g-cust-len" type="number" min="7" max="90" value="30"/></div>
          </div>
          <!-- Weekly fields -->
          <div class="cycle-fields" id="g-fields-weekly" style="display:none;">
            <div class="cf-note" style="margin-bottom:6px;">💡 Your pay week will run 7 days starting from your pay day.</div>
            <div class="cf-row">
              <span class="cf-label">Which day do you get paid?</span>
              <select class="cf-input" id="g-pay-dow" style="font-family:'Plus Jakarta Sans',sans-serif;">
                <option value="0">Sunday</option>
                <option value="1" selected>Monday</option>
                <option value="2">Tuesday</option>
                <option value="3">Wednesday</option>
                <option value="4">Thursday</option>
                <option value="5">Friday</option>
                <option value="6">Saturday</option>
              </select>
            </div>
          </div>
        </div>
        <div class="ob-inline-tip" style="margin-top:10px;">Saved when you tap <strong>Save &amp; Next →</strong> · Changeable anytime in ⚙️ Settings.</div>
      </div>

      <!-- ── SLIDE 4: History Limit + Savings Goal (combined) ── -->
      <div class="ob-page">
        <div style="height:4px;"></div>
        <div class="ob-page-tag">Step 3 of 5 · History &amp; Goal</div>
        <div class="ob-emoji">🎯</div>
        <div class="ob-title">History &amp; Your <em>First Goal</em></div>
        <div class="ob-sub">Two quick picks — how far back to store cycles, and what you're saving for.</div>
        <!-- History limit -->
        <div class="ob-setup-block" style="margin-bottom:12px;">
          <div class="ob-setup-label">🗂 How many past cycles to keep?</div>
          <div class="ob-limit-row" style="margin:8px 0 8px;">
            <button class="ob-limit-minus" onclick="gAdjLimit(-1)">−</button>
            <div class="ob-limit-display">
              <span class="ob-limit-num" id="g-limit-num">24</span>
              <span class="ob-limit-unit">cycles</span>
            </div>
            <button class="ob-limit-plus" onclick="gAdjLimit(1)">+</button>
          </div>
          <div class="ob-limit-presets" style="justify-content:center;">
            <button class="ob-chip" onclick="gSetLimit(6)">6 mo</button>
            <button class="ob-chip" onclick="gSetLimit(12)">1 yr</button>
            <button class="ob-chip ob-chip-sel" onclick="gSetLimit(24)">2 yrs ⭐</button>
            <button class="ob-chip" onclick="gSetLimit(36)">3 yrs</button>
          </div>
          <div class="ob-limit-hint" id="g-limit-hint" style="margin-top:7px;"></div>
        </div>
        <!-- Savings goal -->
        <div class="ob-setup-block">
          <div class="ob-setup-label">🎯 What's your #1 savings goal right now?</div>
          <div class="ob-goal-chips" style="margin-bottom:8px;gap:6px;">
            <button class="ob-chip" onclick="gPickGoal('Emergency Fund')">🛡 Emergency</button>
            <button class="ob-chip" onclick="gPickGoal('Vacation')">✈️ Vacation</button>
            <button class="ob-chip" onclick="gPickGoal('New Phone')">📱 Phone</button>
            <button class="ob-chip" onclick="gPickGoal('Car')">🚗 Car</button>
            <button class="ob-chip" onclick="gPickGoal('House')">🏠 House</button>
            <button class="ob-chip" onclick="gPickGoal('Education')">🎓 Education</button>
          </div>
          <input class="goal-input" id="g-savings-goal-input"
            type="text" maxlength="40"
            placeholder="Or type your own goal…"
            oninput="gOnGoalType()"
            style="width:100%;"/>
          <!-- Target amount — slides in after goal is chosen -->
          <div id="g-goal-target-wrap" style="display:none;margin-top:10px;transition:all .3s;">
            <div style="font-size:.62rem;text-transform:uppercase;letter-spacing:.8px;color:var(--text3);font-weight:700;margin-bottom:6px;">💰 Target amount to reach</div>
            <div style="position:relative;">
              <span style="position:absolute;left:13px;top:50%;transform:translateY(-50%);font-size:.9rem;font-weight:700;color:var(--text3);pointer-events:none;" id="g-goal-currency-sym"></span>
              <input class="goal-input" id="g-savings-goal-target"
                type="number" min="1" placeholder="e.g. 50000"
                oninput="gOnGoalTargetType()"
                style="width:100%;padding-left:28px;"/>
            </div>
            <div id="g-goal-target-hint" style="margin-top:6px;font-size:.72rem;color:var(--text3);line-height:1.5;"></div>
          </div>
          <div class="ob-goal-preview" id="g-goal-preview" style="margin-top:8px;font-size:.78rem;">🛡 Defaults to "Emergency Fund" if left blank</div>
        </div>
        <div class="ob-inline-tip" style="margin-top:10px;">Saved when you tap <strong>Save &amp; Next →</strong></div>
      </div>

      <!-- ── SLIDE 5: Credit Cards (optional) ── -->
      <div class="ob-page">
        <div style="height:4px;"></div>
        <div class="ob-page-tag">Step 4 of 5 · Credit Cards <span style="color:var(--text3);font-weight:400;">(optional)</span></div>
        <div class="ob-emoji">💳</div>
        <div class="ob-title">Do You Have <em>Credit Cards?</em></div>
        <div class="ob-sub">Add your cards so the app can track your <strong style="color:var(--accent)">credit limit</strong> and <strong style="color:var(--accent)">outstanding balance</strong>. Charge expenses to a card instead of your cash, then pay the bill when you're ready.</div>

        <!-- How it works steps -->
        <div class="ob-steps" style="gap:7px;margin-bottom:14px;">
          <div class="ob-step">
            <div class="ob-step-icon" style="background:#a855f718;font-size:1rem;">💳</div>
            <div class="ob-step-body">
              <div class="ob-step-title">Set your credit limit</div>
              <div class="ob-step-desc">Enter your card's total credit limit — e.g. ₱10,000. The app tracks how much of it you've used.</div>
            </div>
          </div>
          <div class="ob-step">
            <div class="ob-step-icon" style="background:#a855f718;font-size:1rem;">📊</div>
            <div class="ob-step-body">
              <div class="ob-step-title">Enter what you owe today</div>
              <div class="ob-step-desc">Already have a balance? Enter it so your available credit is accurate from day one. Leave it 0 if the card is clear.</div>
            </div>
          </div>
          <div class="ob-step">
            <div class="ob-step-icon" style="background:var(--green-dim);font-size:1rem;">✅</div>
            <div class="ob-step-body">
              <div class="ob-step-title">Pay the bill to restore credit</div>
              <div class="ob-step-desc">When you pay your bill, tap <strong>Pay Bill</strong> — it deducts from your cash and restores your available credit automatically.</div>
            </div>
          </div>
        </div>

        <!-- Add card form -->
        <div class="ob-setup-block">
          <div class="ob-setup-label">Add a card</div>
          <div style="display:flex;flex-direction:column;gap:8px;">
            <input class="cf-input" id="g-cc-name" type="text" maxlength="20"
              placeholder="Card name  (e.g. BDO Visa, GCash)"
              style="width:100%;text-align:left;font-family:'Plus Jakarta Sans',sans-serif;font-size:.83rem;padding:10px 13px;"/>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
              <div>
                <div style="font-size:.6rem;text-transform:uppercase;letter-spacing:.8px;color:var(--text3);font-weight:700;margin-bottom:5px;">Credit Limit</div>
                <input class="cf-input" id="g-cc-limit" type="number" min="1" placeholder="e.g. 10000"
                  style="width:100%;text-align:left;font-family:'Plus Jakarta Sans',sans-serif;font-size:.85rem;" oninput="gUpdateCCHint()"/>
              </div>
              <div>
                <div style="font-size:.6rem;text-transform:uppercase;letter-spacing:.8px;color:var(--text3);font-weight:700;margin-bottom:5px;">Owe Right Now</div>
                <input class="cf-input" id="g-cc-balance" type="number" min="0" placeholder="0 if clear"
                  style="width:100%;text-align:left;font-family:'Plus Jakarta Sans',sans-serif;font-size:.85rem;" oninput="gUpdateCCHint()"/>
              </div>
            </div>
            <div>
              <div style="font-size:.6rem;text-transform:uppercase;letter-spacing:.8px;color:var(--text3);font-weight:700;margin-bottom:5px;">Billing Fee per Cycle <span style="color:var(--text3);font-weight:400;">(optional)</span></div>
              <input class="cf-input" id="g-cc-interest" type="number" min="0" step="0.01" placeholder="e.g. 50 flat billing fee (optional)"
                style="width:100%;text-align:left;font-family:'Plus Jakarta Sans',sans-serif;font-size:.85rem;"/>
            </div>
            <div id="g-cc-form-hint" style="font-size:.68rem;color:var(--text3);line-height:1.5;display:none;padding:7px 10px;background:var(--bg2);border-radius:9px;border:1px solid var(--border);"></div>
            <button style="width:100%;padding:12px;border-radius:11px;border:1.5px solid #a855f730;background:#a855f718;color:#a855f7;font-family:'Plus Jakarta Sans',sans-serif;font-size:.83rem;font-weight:700;cursor:pointer;transition:all .18s;" onclick="gAddCreditCard()">+ Add This Card</button>
          </div>
        </div>

        <!-- Added cards list -->
        <div id="g-cc-list" style="margin-top:10px;display:flex;flex-direction:column;gap:7px;"></div>

        <div class="ob-inline-tip" style="margin-top:10px;">
          <strong>Optional</strong> — you can skip and add cards anytime in <strong>⚙️ Settings → Credit Cards</strong>.
        </div>
      </div>


      <!-- ── PIN SLIDE — Step 5 of 5 ── -->
      <div class="ob-page" id="ob-page-pin">
        <div style="height:4px;"></div>
        <div class="ob-page-tag">Step 5 of 5 · PIN Lock <span style="color:var(--text3);font-weight:400;">(optional)</span></div>
        <div class="ob-emoji">🔐</div>
        <div class="ob-title">Protect Your <em>Ledger</em></div>
        <div class="ob-sub">Add a 4-digit PIN so only you can open the app. Great if others use your phone.</div>

        <div class="ob-steps" style="gap:7px;margin-bottom:16px;">
          <div class="ob-step">
            <div class="ob-step-icon c-acc">🔒</div>
            <div class="ob-step-body">
              <div class="ob-step-title">Lock on every open</div>
              <div class="ob-step-desc">The PIN screen appears every time you launch Spendoodle, keeping your finances private.</div>
            </div>
          </div>
          <div class="ob-step">
            <div class="ob-step-icon c-grn">🔑</div>
            <div class="ob-step-body">
              <div class="ob-step-title">Easy to change or remove</div>
              <div class="ob-step-desc">Head to <strong>⚙️ Settings → PIN Lock</strong> anytime to update or remove your PIN.</div>
            </div>
          </div>
          <div class="ob-step">
            <div class="ob-step-icon c-blu">🛡️</div>
            <div class="ob-step-body">
              <div class="ob-step-title">Stored securely</div>
              <div class="ob-step-desc">Your PIN is hashed with SHA-256 — it's never stored in plain text on your device.</div>
            </div>
          </div>
        </div>

        <!-- PIN setup inline -->
        <div class="ob-setup-block" id="ob-pin-block">
          <div class="ob-setup-label">Set your PIN</div>
          <div id="ob-pin-status" style="font-size:.78rem;color:var(--text3);text-align:center;margin-bottom:12px;">Enter a 4-digit PIN to activate lock</div>
          <!-- dots -->
          <div style="display:flex;justify-content:center;gap:12px;margin-bottom:16px;">
            <div class="pin-dot" id="ob-pin-d0" style="width:14px;height:14px;border-radius:50%;border:2px solid var(--border2);background:transparent;transition:background .15s;"></div>
            <div class="pin-dot" id="ob-pin-d1" style="width:14px;height:14px;border-radius:50%;border:2px solid var(--border2);background:transparent;transition:background .15s;"></div>
            <div class="pin-dot" id="ob-pin-d2" style="width:14px;height:14px;border-radius:50%;border:2px solid var(--border2);background:transparent;transition:background .15s;"></div>
            <div class="pin-dot" id="ob-pin-d3" style="width:14px;height:14px;border-radius:50%;border:2px solid var(--border2);background:transparent;transition:background .15s;"></div>
          </div>
          <!-- numpad -->
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;max-width:220px;margin:0 auto;">
            <button onclick="obPinKey('1')" class="ob-pin-key">1</button>
            <button onclick="obPinKey('2')" class="ob-pin-key">2</button>
            <button onclick="obPinKey('3')" class="ob-pin-key">3</button>
            <button onclick="obPinKey('4')" class="ob-pin-key">4</button>
            <button onclick="obPinKey('5')" class="ob-pin-key">5</button>
            <button onclick="obPinKey('6')" class="ob-pin-key">6</button>
            <button onclick="obPinKey('7')" class="ob-pin-key">7</button>
            <button onclick="obPinKey('8')" class="ob-pin-key">8</button>
            <button onclick="obPinKey('9')" class="ob-pin-key">9</button>
            <div></div>
            <button onclick="obPinKey('0')" class="ob-pin-key">0</button>
            <button onclick="obPinDel()" class="ob-pin-key" style="font-size:.85rem;">⌫</button>
          </div>
          <div id="ob-pin-set-msg" style="margin-top:12px;text-align:center;font-size:.75rem;font-weight:700;color:var(--green);min-height:18px;"></div>
        </div>

        <div class="ob-inline-tip" style="margin-top:12px;">
          <strong>Optional</strong> — tap "Finish" to skip and set a PIN later via <strong>⚙️ Settings → PIN Lock</strong>.
        </div>
      </div>

    </div><!-- end ob-pages -->

    <div class="ob-footer">
      <div class="ob-dots" id="ob-dots"></div>
      <div class="ob-btn-row">
        <button class="ob-btn ob-btn-secondary" id="ob-back" onclick="obNav(-1)" style="display:none;">← Back</button>
        <button class="ob-btn ob-btn-primary" id="ob-next" onclick="obNav(1)">Let's Go →</button>
      </div>
      <button class="ob-btn ob-btn-ghost" id="ob-skip" onclick="obClose()">Skip · come back anytime via ⚙️ Settings</button>
    </div>
  </div>
</div>

<!-- ══ PIN LOCK OVERLAY ══ -->
<div class="pin-overlay hidden" id="pin-overlay">
  <div style="font-size:3rem;margin-bottom:16px;">🔐</div>
  <div class="pin-title">Spend<span style="color:var(--accent)">oodle</span></div>
  <div class="pin-sub" id="pin-sub">Enter your PIN to unlock</div>
  <div class="pin-dots" id="pin-dots">
    <div class="pin-dot" id="pd0"></div>
    <div class="pin-dot" id="pd1"></div>
    <div class="pin-dot" id="pd2"></div>
    <div class="pin-dot" id="pd3"></div>
  </div>
  <div class="pin-error" id="pin-error"></div>
  <div class="pin-keypad">
    <button class="pin-key" onclick="pinKey('1')">1</button>
    <button class="pin-key" onclick="pinKey('2')">2</button>
    <button class="pin-key" onclick="pinKey('3')">3</button>
    <button class="pin-key" onclick="pinKey('4')">4</button>
    <button class="pin-key" onclick="pinKey('5')">5</button>
    <button class="pin-key" onclick="pinKey('6')">6</button>
    <button class="pin-key" onclick="pinKey('7')">7</button>
    <button class="pin-key" onclick="pinKey('8')">8</button>
    <button class="pin-key" onclick="pinKey('9')">9</button>
    <button class="pin-key empty"></button>
    <button class="pin-key" onclick="pinKey('0')">0</button>
    <button class="pin-key del" onclick="pinDel()">⌫</button>
  </div>
  <button id="pin-skip-btn" style="margin-top:24px;background:transparent;border:none;font-size:.78rem;color:var(--text3);cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;" onclick="pinSkip()">Forgot PIN? Reset App</button>
</div>

<!-- ══ CUSTOM CONFIRM MODAL ══ -->
<div class="confirm-overlay" id="confirm-overlay">
  <div class="confirm-inner">
    <div class="confirm-icon" id="confirm-icon">🗑</div>
    <div class="confirm-title" id="confirm-title">Are you sure?</div>
    <div class="confirm-msg" id="confirm-msg">This action cannot be undone.</div>
    <div class="confirm-btns" id="confirm-btns">
      <button class="confirm-btn confirm-cancel" id="confirm-cancel-btn" onclick="cancelConfirm()">Cancel</button>
      <button class="confirm-btn confirm-ok" id="confirm-ok-btn" onclick="confirmOk()">Delete</button>
    </div>
  </div>
</div>

<!-- ══ WHAT'S NEW SHEET ══ -->
<div class="wn-overlay" id="wn-overlay" onclick="closeWhatsNew()">
  <div class="wn-sheet" id="wn-sheet" onclick="event.stopPropagation()">
    <div class="wn-handle" id="wn-handle" style="cursor:grab;touch-action:none;"></div>
    <div class="wn-header">
      <div class="wn-title">What's New ✨</div>
      <div class="wn-sub">Latest features added to Spendoodle</div>
    </div>
    <div class="wn-body">
      <div class="wn-item">
        <div class="wn-icon" style="background:var(--accent-dim)">➕</div>
        <div class="wn-info">
          <div class="wn-name">Circular FAB Speed-Dial <span class="wn-new-pill">v1.3</span></div>
          <div class="wn-desc">Income, Expense, Savings buttons are now circular and float higher above the nav bar.</div>
        </div>
      </div>
      <div class="wn-item">
        <div class="wn-icon" style="background:var(--red-dim)">💳</div>
        <div class="wn-info">
          <div class="wn-name">Payment Method Selector <span class="wn-new-pill">v1.3</span></div>
          <div class="wn-desc">Cash or Credit Card pill selector when logging expenses — replaces the old toggle.</div>
        </div>
      </div>
      <div class="wn-item">
        <div class="wn-icon" style="background:var(--green-dim)">🎯</div>
        <div class="wn-info">
          <div class="wn-name">Smarter Defaults & 8 Themes <span class="wn-new-pill">v1.3</span></div>
          <div class="wn-desc">Income opens with Salary pre-selected. Savings skips the category picker. Plus 5 new themes: Navy, Ice, Forest, Sunset, Midnight.</div>
        </div>
      </div>
      <div style="padding:10px 0 6px;font-size:.58rem;text-transform:uppercase;letter-spacing:1.2px;color:var(--text3);font-weight:700;">Earlier</div>
      <div class="wn-item" style="padding:10px 0;">
        <div class="wn-info" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
          <div style="display:flex;gap:8px;align-items:flex-start;"><span style="font-size:1rem;">👆</span><div><div style="font-size:.78rem;font-weight:700;color:var(--text);margin-bottom:1px;">Swipe to Delete</div><div style="font-size:.68rem;color:var(--text3);">Swipe left on any transaction.</div></div></div>
          <div style="display:flex;gap:8px;align-items:flex-start;"><span style="font-size:1rem;">⚡</span><div><div style="font-size:.78rem;font-weight:700;color:var(--text);margin-bottom:1px;">Quick Add</div><div style="font-size:.68rem;color:var(--text3);">One-tap recurring templates.</div></div></div>
          <div style="display:flex;gap:8px;align-items:flex-start;"><span style="font-size:1rem;">🔁</span><div><div style="font-size:.78rem;font-weight:700;color:var(--text);margin-bottom:1px;">Recurring</div><div style="font-size:.68rem;color:var(--text3);">Weekly or monthly, auto-logged.</div></div></div>
          <div style="display:flex;gap:8px;align-items:flex-start;"><span style="font-size:1rem;">📈</span><div><div style="font-size:.78rem;font-weight:700;color:var(--text);margin-bottom:1px;">Cash Flow Forecast</div><div style="font-size:.68rem;color:var(--text3);">Projected balance by end of cycle.</div></div></div>
          <div style="display:flex;gap:8px;align-items:flex-start;"><span style="font-size:1rem;">🎯</span><div><div style="font-size:.78rem;font-weight:700;color:var(--text);margin-bottom:1px;">Savings Goals</div><div style="font-size:.68rem;color:var(--text3);">Set targets, track progress.</div></div></div>
          <div style="display:flex;gap:8px;align-items:flex-start;"><span style="font-size:1rem;">🔐</span><div><div style="font-size:.78rem;font-weight:700;color:var(--text);margin-bottom:1px;">PIN Lock</div><div style="font-size:.68rem;color:var(--text3);">SHA-256 secured, set in Settings.</div></div></div>
          <div style="display:flex;gap:8px;align-items:flex-start;"><span style="font-size:1rem;">💾</span><div><div style="font-size:.78rem;font-weight:700;color:var(--text);margin-bottom:1px;">Backup Reminder</div><div style="font-size:.68rem;color:var(--text3);">Prompts you every 30 days.</div></div></div>
          <div style="display:flex;gap:8px;align-items:flex-start;"><span style="font-size:1rem;">💬</span><div><div style="font-size:.78rem;font-weight:700;color:var(--text);margin-bottom:1px;">Undo Delete</div><div style="font-size:.68rem;color:var(--text3);">5-second undo toast on delete.</div></div></div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="sheet-overlay" id="sheet-overlay" onclick="closeSheet()"></div>
<div class="sheet" id="add-sheet">
  <div class="sheet-handle"></div>
  <div class="sheet-header">
    <div class="sheet-title" id="sheet-title">Log a <em>Transaction</em></div>
    <button class="sheet-close" onclick="closeSheet()">✕</button>
  </div>
  <div class="add-body">
    <div id="add-toast" class="toast" style="display:none;">✓ Saved!</div>
    <div id="date-err" class="date-err">⛔ Future dates not allowed.</div>
    <div class="form-section"><div class="form-lbl">Date</div><input type="date" class="date-field" id="f-date" onchange="const ck=getCycleKey(this.value||todayStr());_sheetAvailable=getCycleAvailable(ck,editingId||null);updateRemainingHint();updateSaveBtn();"/></div>
    <div class="form-section"><div class="form-lbl">Category</div><div class="cat-grid" id="cat-grid"></div></div>
    <div class="form-section"><div class="form-lbl">Amount</div>
      <div class="amt-wrap"><span class="amt-sym" id="amt-sym">₱</span><input type="number" inputmode="decimal" class="amt-input" id="f-amount" placeholder="0" min="0" oninput="this.value=this.value.replace(/[^0-9.]/g,'');if(parseFloat(this.value)<0)this.value='';onAmountInput()"/></div>
      <div class="amt-remaining" id="amt-remaining" style="display:none;"></div>
      <div class="amt-err" id="amt-err">⛔ Not enough remaining balance.</div>
    </div>
    <div class="form-section"><div class="form-lbl">Note <span style="color:var(--text3);font-size:.6rem;font-weight:400;text-transform:none;letter-spacing:0;">(optional)</span></div>
      <textarea class="note-field" id="f-note" rows="2" placeholder="e.g. Grab to work, groceries…"></textarea>
    </div>
    <!-- SAVINGS GOAL — shown only when Savings category is selected -->
    <div class="form-section" id="savings-goal-section" style="display:none;">
      <div class="form-lbl">Savings Goal <span id="goal-lbl-hint" style="color:var(--accent);font-size:.6rem;font-weight:600;text-transform:none;letter-spacing:0;">What are you saving for?</span></div>
      <div class="goal-wrap">
        <input type="text" class="goal-input" id="f-savings-goal" placeholder="Defaults to Emergency Fund if left blank"
          autocomplete="off"
          oninput="onGoalInput()"
          onfocus="onGoalFocus()"
          onblur="onGoalBlur()"/>
        <div class="goal-suggestions" id="goal-suggestions"></div>
      </div>
      <div id="goal-first-hint" style="display:none;margin-top:6px;font-size:.72rem;color:var(--accent);font-weight:600;">
        🎯 First savings entry! Give it a goal name or leave blank for "Emergency Fund".
      </div>
      <!-- Target amount -->
      <div style="margin-top:8px;display:flex;align-items:center;gap:8px;">
        <div style="flex:1;background:var(--bg2);border:1.5px solid var(--border2);border-radius:11px;padding:8px 12px;display:flex;align-items:center;gap:6px;transition:border-color .2s;" id="goal-target-wrap">
          <span style="font-size:.72rem;color:var(--text3);white-space:nowrap;">🎯 Target:</span>
          <span style="font-size:.85rem;color:var(--text3);" id="goal-target-sym"></span>
          <input type="number" id="f-goal-target" placeholder="optional"
            style="flex:1;background:transparent;border:none;outline:none;font-family:'Playfair Display',serif;font-size:.95rem;font-weight:700;color:var(--text);width:100%;"
            oninput="onGoalTargetInput()" min="0"/>
        </div>
      </div>
      <div id="goal-progress-hint" style="display:none;margin-top:5px;font-size:.7rem;color:var(--text3);line-height:1.5;"></div>
    </div>
    <div class="form-section">
      <div class="toggle-row">
        <div><div class="toggle-label">🔄 Recurring</div><div class="toggle-sub" id="recur-sub">Repeats every cycle</div></div>
        <div class="toggle" id="recur-toggle" onclick="toggleRecur()"></div>
      </div>
      <div class="recur-freq-wrap" id="recur-freq-wrap" style="display:none;">
        <button class="recur-freq-btn active" id="recur-freq-weekly" onclick="setRecurFreq('weekly')">📅 Weekly</button>
        <button class="recur-freq-btn" id="recur-freq-monthly" onclick="setRecurFreq('monthly')">🗓 Monthly</button>
      </div>
    </div>
    <div class="form-section" id="credit-toggle-section" style="display:none;">
      <div class="form-lbl">Payment Method</div>
      <div class="pay-method-row">
        <button class="pay-method-btn active" id="pay-method-cash" onclick="setPayMethod('cash')">
          <span class="pay-method-icon">💵</span>
          <span class="pay-method-label">Cash</span>
        </button>
        <button class="pay-method-btn" id="pay-method-credit" onclick="setPayMethod('credit')">
          <span class="pay-method-icon">💳</span>
          <span class="pay-method-label">Credit Card</span>
        </button>
      </div>
      <div class="cc-picker-wrap" id="cc-picker-wrap">
        <select class="cc-picker" id="f-credit-card"></select>
        <div class="cc-hint" id="cc-hint"></div>
      </div>
    </div>
    <button class="save-btn" id="save-btn" onclick="saveTransaction()">Save</button>
  </div>
</div>

<!-- ══ BUDGET MODAL ══ -->
<div class="budget-modal" id="budget-modal" onclick="closeBudgetModal(event)">
  <div class="bm-inner" onclick="e=>e.stopPropagation()">
    <div class="sheet-handle" style="margin:0 auto 14px;"></div>
    <div class="bm-title">Budget per Cycle</div>
    <div class="bm-sub">Set spending limits per category (0 = no limit)</div>
    <div id="budget-inputs"></div>
    <button class="bm-save" onclick="saveBudgets()">Save Budgets ✓</button>
  </div>
</div>

<!-- ══ CREDIT PAY MODAL ══ -->
<div class="pay-modal" id="pay-modal" onclick="closePayModal(event)">
  <div class="pay-inner" onclick="e=>e.stopPropagation()">
    <div class="sheet-handle" style="margin:0 auto 14px;"></div>
    <div class="pay-title">💳 Pay Credit Card Bill</div>
    <div class="pay-sub" id="pay-modal-sub">Paying this will deduct from your balance and restore your card's available credit.</div>
    <div class="pay-balance">
      <span class="pay-balance-lbl">Card Outstanding</span>
      <span class="pay-balance-val" id="pay-modal-owed">₱0</span>
    </div>
    <div class="pay-balance" style="border:1.5px solid var(--green);background:var(--green-dim);margin-top:-4px;">
      <span class="pay-balance-lbl" style="color:var(--green);">Your Cash Available</span>
      <span class="pay-balance-val" style="color:var(--green);" id="pay-cash-avail">₱0</span>
    </div>
    <div style="margin-bottom:8px;">
      <div class="form-lbl" style="margin-bottom:8px;">Payment Amount <span style="font-size:.65rem;color:var(--text3);font-weight:400;">(principal only)</span></div>
      <div class="amt-wrap"><span class="amt-sym" id="pay-sym">₱</span><input type="number" inputmode="decimal" class="amt-input" id="pay-amount" placeholder="0" min="0" style="font-size:2rem;padding:8px 0;" oninput="updatePayHint()"/></div>
      <div style="display:flex;gap:7px;margin-top:8px;">
        <button style="flex:1;padding:7px;border-radius:9px;font-size:.7rem;font-weight:700;cursor:pointer;border:1.5px solid var(--border2);background:var(--bg2);color:var(--text2);" onclick="setPayQuick('full')">Pay Full Bill</button>
        <button style="flex:1;padding:7px;border-radius:9px;font-size:.7rem;font-weight:700;cursor:pointer;border:1.5px solid var(--green);background:var(--green-dim);color:var(--green);" onclick="setPayQuick('max')">Max I Can Pay</button>
      </div>
    </div>
    <!-- Billing fee section -->
    <div style="background:var(--bg2);border:1px solid #a855f730;border-radius:13px;padding:12px 13px;margin-bottom:12px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <span style="font-size:.75rem;font-weight:700;color:#a855f7;">📊 Billing Fee / Interest</span>
        <span id="pay-fee-hint-lbl" style="font-size:.62rem;color:var(--text3);">added as separate expense</span>
      </div>
      <div class="amt-wrap" style="border-color:#a855f730;background:var(--bg1);">
        <span class="amt-sym" id="pay-fee-sym" style="color:#a855f7;">₱</span>
        <input type="number" inputmode="decimal" class="amt-input" id="pay-fee-amount" placeholder="0" min="0"
          style="font-size:1.6rem;padding:6px 0;color:#a855f7;" oninput="updatePayHint()"/>
      </div>
      <div id="pay-fee-prefill-row" style="display:none;margin-top:7px;">
        <button id="pay-fee-prefill-btn" style="width:100%;padding:7px;border-radius:9px;font-size:.7rem;font-weight:700;cursor:pointer;border:1.5px solid #a855f750;background:#a855f712;color:#a855f7;" onclick="prefillBillingFee()"></button>
      </div>
      <div style="margin-top:6px;font-size:.68rem;color:var(--text3);line-height:1.5;">Leave at 0 if no fee this cycle. Fee logs as an expense in your feed.</div>
    </div>
    <!-- Summary row -->
    <div id="pay-summary-row" style="display:none;background:var(--bg2);border:1px solid var(--border2);border-radius:11px;padding:9px 13px;margin-bottom:10px;">
      <div style="display:flex;justify-content:space-between;font-size:.72rem;color:var(--text3);margin-bottom:3px;">
        <span>Principal payment</span><span id="pay-sum-principal" style="font-weight:700;color:var(--text);">₱0</span>
      </div>
      <div style="display:flex;justify-content:space-between;font-size:.72rem;color:var(--text3);margin-bottom:5px;">
        <span>Billing fee</span><span id="pay-sum-fee" style="font-weight:700;color:#a855f7;">₱0</span>
      </div>
      <div style="height:1px;background:var(--border);margin-bottom:5px;"></div>
      <div style="display:flex;justify-content:space-between;font-size:.8rem;font-weight:700;">
        <span style="color:var(--text);">Total out of pocket</span><span id="pay-sum-total" style="color:var(--accent);">₱0</span>
      </div>
    </div>
    <div id="pay-hint" style="margin-bottom:8px;font-size:.7rem;color:var(--text3);line-height:1.5;"></div>
    <div id="pay-error-toast" style="display:none;background:var(--red-dim);color:var(--red);border:1px solid var(--red);border-radius:10px;padding:9px 13px;font-size:.78rem;font-weight:700;margin-bottom:10px;text-align:center;"></div>
    <input type="hidden" id="pay-card-id"/>
    <button class="pay-save" onclick="submitCreditPayment()">Pay Now ✓</button>
  </div>
</div>

<script>
// ════════════════════════════════════════════════════════════
//  CONSTANTS
// ════════════════════════════════════════════════════════════
const CATS = [
  {k:'salary',      l:'Salary',      i:'💼', t:'income'},
  {k:'freelance',   l:'Freelance',   i:'🛠️', t:'income'},
  {k:'side_income', l:'Side Income', i:'✨',  t:'income'},
  {k:'gift',        l:'Gift/Bonus',  i:'🎁', t:'income'},
  {k:'transport',   l:'Transport',   i:'🚌', t:'expense'},
  {k:'food',        l:'Food',        i:'🍜', t:'expense'},
  {k:'shopping',    l:'Shopping',    i:'🛍️', t:'expense'},
  {k:'rent',        l:'Rent',        i:'🏠', t:'expense'},
  {k:'utilities',   l:'Bills',       i:'💡', t:'expense'},
  {k:'health',      l:'Health',      i:'💊', t:'expense'},
  {k:'entertain',   l:'Fun',         i:'🎬', t:'expense'},
  {k:'savings',     l:'Savings',     i:'🏦', t:'savings'},
  {k:'other',       l:'Other',       i:'📦', t:'expense'},
];
const EXPENSE_CATS = CATS.filter(c=>c.t==='expense');
const FULL_M  = ['January','February','March','April','May','June','July','August','September','October','November','December'];
const SHORT_M = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
const DONUT_COLORS = ['#f06464','#d4a853','#7b8fff','#4fd87c','#f0a864','#c084fc','#64c8f0','#f0d464','#84f064'];

// ════════════════════════════════════════════════════════════
//  LOAD STATE — everything persists to localStorage
// ════════════════════════════════════════════════════════════
let transactions   = JSON.parse(localStorage.getItem('ledger_txs')     || '[]');
let budgets        = JSON.parse(localStorage.getItem('ledger_budgets')  || '{}');
let currencySymbol = localStorage.getItem('ledger_currency')            || '₱';
let activeTheme    = localStorage.getItem('ledger_theme')               || 'dark';
let creditCards    = JSON.parse(localStorage.getItem('ledger_cc')       || '[]');
let goalTargets    = JSON.parse(localStorage.getItem('ledger_goalTargets') || '{}'); // {goalName: amount}
let pinHash        = localStorage.getItem('ledger_pin')                 || '';  // SHA-256 hex of PIN

// Cycle config
let cycleMode      = localStorage.getItem('ledger_cycleMode')           || 'monthly';
let cycleConfig    = JSON.parse(localStorage.getItem('ledger_cycleConfig') || JSON.stringify({
  monthly:   { payDay: 25 },
  bimonthly: { s1:25, e1:10, s2:11, e2:24 },
  weekly:    { payDow: 1 },
  custom:    { start:1, len:30 }
}));
// Ensure weekly key exists for old saves
if(!cycleConfig.weekly) cycleConfig.weekly = { payDow: 1 };
let cycleLimit     = Math.max(3, parseInt(localStorage.getItem('ledger_cycleLimit') || '24'));

// UI state
let currentView  = 'feed';
let activeCycleKey = null;
let selectedCat  = 'transport';
let editingId    = null;
let expandedTx   = null;
let deleteConfirm= null;
let dashMetric   = 'income';
let searchQuery  = '';
let activeFilter = 'all';
let isRecurring  = false;
let recurFreq    = 'weekly'; // 'weekly' | 'monthly'
let isCreditPay  = false;
let sheetOpen    = false;

// ════════════════════════════════════════════════════════════
//  PERSIST HELPERS — called after every mutation
// ════════════════════════════════════════════════════════════
function persist(){
  localStorage.setItem('ledger_txs',        JSON.stringify(transactions));
  localStorage.setItem('ledger_budgets',     JSON.stringify(budgets));
  localStorage.setItem('ledger_currency',    currencySymbol);
  localStorage.setItem('ledger_theme',       activeTheme);
  localStorage.setItem('ledger_cycleMode',   cycleMode);
  localStorage.setItem('ledger_cycleConfig', JSON.stringify(cycleConfig));
  localStorage.setItem('ledger_cycleLimit',  String(cycleLimit));
  localStorage.setItem('ledger_cc',          JSON.stringify(creditCards));
  localStorage.setItem('ledger_goalTargets', JSON.stringify(goalTargets));
}

// ════════════════════════════════════════════════════════════
//  CYCLE LIMIT — trim oldest cycles, keep newest N
// ════════════════════════════════════════════════════════════
function enforceCycleLimit(){
  const cycleKeys = [...new Set(transactions.map(t => getCycleKey(t.date)))]
    .sort((a,b) => cycleRange(b).start.localeCompare(cycleRange(a).start)); // newest first by start date

  if(cycleKeys.length <= cycleLimit) return 0;

  const curKey = currentCycleKey();
  const keepSet = new Set(cycleKeys.slice(0, cycleLimit));
  keepSet.add(curKey);

  const before = transactions.length;
  transactions = transactions.filter(t => keepSet.has(getCycleKey(t.date)));
  return before - transactions.length;
}
// ════════════════════════════════════════════════════════════
function ymd(y,m,d){ return `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`; }
function todayStr(){ const d=new Date(); return ymd(d.getFullYear(),d.getMonth()+1,d.getDate()); }
function daysInMonth(y,m){ return new Date(y,m,0).getDate(); }

// ════════════════════════════════════════════════════════════
//  CYCLE ENGINE
//  A cycle key is an arbitrary string that uniquely identifies
//  one pay period. We use different formats per mode:
//   monthly:   "YYYY-MM"        (the month the cycle starts)
//   bimonthly: "YYYY-MM-A"/"YYYY-MM-B"  (A=first half, B=second)
//   custom:    "YYYY-MM-DD"     (the start date of the custom cycle)
// ════════════════════════════════════════════════════════════

/** Returns {start:"YYYY-MM-DD", end:"YYYY-MM-DD"} for a given cycle key */
function cycleRange(ck){
  if(cycleMode==='monthly'){
    const [y,m]  = ck.split('-').map(Number);
    const pd     = cycleConfig.monthly.payDay;
    const nm     = m===12?1:m+1, ny=m===12?y+1:y;
    return { start: ymd(y,m,pd), end: ymd(ny,nm,pd-1) };
  }
  if(cycleMode==='bimonthly'){
    const parts = ck.split('-');
    const y=parseInt(parts[0]), m=parseInt(parts[1]), half=parts[2];
    const {s1,e1,s2,e2} = cycleConfig.bimonthly;
    if(half==='A'){
      // Cross-month when start > end (e.g. 25->10 next month)
      const crossMonth = s1 > e1;
      const endM = crossMonth ? (m===12?1:m+1) : m;
      const endY = (crossMonth && m===12) ? y+1 : y;
      return { start:ymd(y,m,s1), end:ymd(endY,endM,e1) };
    }
    // Period B: same month, explicit end day
    return { start:ymd(y,m,s2), end:ymd(y,m,e2||daysInMonth(y,m)) };
  }
  if(cycleMode==='weekly'){
    // ck is "YYYY-MM-DD" — the Monday (or configured dow) start of the week
    const startD = new Date(ck+'T00:00:00');
    const endD   = new Date(startD); endD.setDate(startD.getDate()+6);
    return { start:ck, end:ymd(endD.getFullYear(),endD.getMonth()+1,endD.getDate()) };
  }
  // custom: ck is start date "YYYY-MM-DD"
  const {len} = cycleConfig.custom;
  const startD = new Date(ck+'T00:00:00');
  const endD   = new Date(startD); endD.setDate(startD.getDate()+len-1);
  return { start:ck, end:ymd(endD.getFullYear(),endD.getMonth()+1,endD.getDate()) };
}

/** Return cycle key for a given date string */
function getCycleKey(dateStr){
  const [y,m,d] = dateStr.split('-').map(Number);
  if(cycleMode==='monthly'){
    const pd = cycleConfig.monthly.payDay;
    if(d>=pd) return `${y}-${String(m).padStart(2,'0')}`;
    const pm=m===1?12:m-1, py=m===1?y-1:y;
    return `${py}-${String(pm).padStart(2,'0')}`;
  }
  if(cycleMode==='bimonthly'){
    const {s1,e1,s2,e2} = cycleConfig.bimonthly;
    const crossMonth = s1 > e1; // e.g. 25->10
    if(crossMonth){
      // Period A spans two months: starts on s1, ends on e1 of NEXT month
      // A date belongs to period A if:
      //   day >= s1  (in the start month)  → key = that month
      //   day <= e1  (in the end month)    → key = previous month
      // Period B: s2..e2 within same month
      if(d >= s2 && d <= e2) return `${y}-${String(m).padStart(2,'0')}-B`;
      if(d >= s1) return `${y}-${String(m).padStart(2,'0')}-A`;
      // day < s2 and day <= e1 → belongs to prev month's period A
      const pm=m===1?12:m-1, py=m===1?y-1:y;
      return `${py}-${String(pm).padStart(2,'0')}-A`;
    } else {
      // Same-month split (e.g. 1-15, 16-31)
      const half = d >= s2 ? 'B' : 'A';
      return `${y}-${String(m).padStart(2,'0')}-${half}`;
    }
  }
  if(cycleMode==='weekly'){
    // Find the start of the week (payDow) that contains this date
    const dow = cycleConfig.weekly.payDow; // 0=Sun … 6=Sat
    const target = new Date(dateStr+'T00:00:00');
    let dayOfWeek = target.getDay();
    // Days since last payDow
    let diff = (dayOfWeek - dow + 7) % 7;
    const weekStart = new Date(target);
    weekStart.setDate(target.getDate() - diff);
    return ymd(weekStart.getFullYear(), weekStart.getMonth()+1, weekStart.getDate());
  }
  // custom: find which cycle start this date falls in
  const {start,len} = cycleConfig.custom;
  const epoch = new Date('2020-01-01T00:00:00');
  const target= new Date(dateStr+'T00:00:00');
  const diff  = Math.floor((target-epoch)/(86400000));
  const cycleN= Math.floor(diff/len);
  const cs    = new Date(epoch); cs.setDate(epoch.getDate()+cycleN*len);
  return ymd(cs.getFullYear(),cs.getMonth()+1,cs.getDate());
}

/** Current cycle key (where today falls) */
function currentCycleKey(){ return getCycleKey(todayStr()); }

/** Shift a cycle key by delta (-1=prev, +1=next) */
function shiftKey(ck, delta){
  if(cycleMode==='monthly'){
    const [y,m]=ck.split('-').map(Number);
    let nm=m+delta, ny=y;
    if(nm>12){nm-=12;ny++;} if(nm<1){nm+=12;ny--;}
    return `${ny}-${String(nm).padStart(2,'0')}`;
  }
  if(cycleMode==='bimonthly'){
    const parts=ck.split('-'), y=parseInt(parts[0]),m=parseInt(parts[1]),half=parts[2];
    const crossMonth = cycleConfig.bimonthly.s1 > cycleConfig.bimonthly.e1;
    if(delta===1){
      if(half==='B'){
        // B(m) → A(m) for both modes
        return `${y}-${String(m).padStart(2,'0')}-A`;
      } else {
        // A(m) → B(m+1) cross-month | A(m) → B(m) same-month
        if(crossMonth){ const nm=m===12?1:m+1, ny=m===12?y+1:y; return `${ny}-${String(nm).padStart(2,'0')}-B`; }
        return `${y}-${String(m).padStart(2,'0')}-B`;
      }
    } else {
      if(half==='A'){
        // A(m) → B(m) cross-month | A(m) → B(m-1) same-month
        if(crossMonth) return `${y}-${String(m).padStart(2,'0')}-B`;
        const pm=m===1?12:m-1, py=m===1?y-1:y; return `${py}-${String(pm).padStart(2,'0')}-B`;
      } else {
        // B(m) → A(m-1) cross-month | B(m) → A(m) same-month
        if(crossMonth){ const pm=m===1?12:m-1, py=m===1?y-1:y; return `${py}-${String(pm).padStart(2,'0')}-A`; }
        return `${y}-${String(m).padStart(2,'0')}-A`;
      }
    }
  }
  // weekly: ck is "YYYY-MM-DD" start of week — shift by 7*delta days
  if(cycleMode==='weekly'){
    const wd=new Date(ck+'T00:00:00'); wd.setDate(wd.getDate()+delta*7);
    return ymd(wd.getFullYear(),wd.getMonth()+1,wd.getDate());
  }
  // custom
  const {len}=cycleConfig.custom;
  const d=new Date(ck+'T00:00:00'); d.setDate(d.getDate()+delta*len);
  return ymd(d.getFullYear(),d.getMonth()+1,d.getDate());
}
function cycleLabel(ck, short=false){
  if(cycleMode==='monthly'){
    const [y,m]=ck.split('-').map(Number);
    return `${(short?SHORT_M:FULL_M)[m-1]} ${y}`;
  }
  if(cycleMode==='bimonthly'){
    // Use the actual start/end dates from cycleRange for a clear label
    const r=cycleRange(ck);
    const [sy,sm,sd]=r.start.split('-').map(Number);
    const [ey,em,ed]=r.end.split('-').map(Number);
    if(short){
      // e.g. "Dec 25–Jan 10" or "Jan 11–24"
      const sameMonth=sm===em&&sy===ey;
      return sameMonth
        ? `${SHORT_M[sm-1]} ${sd}–${ed}`
        : `${SHORT_M[sm-1]} ${sd}–${SHORT_M[em-1]} ${ed}`;
    }
    return `${SHORT_M[sm-1]} ${sd} – ${SHORT_M[em-1]} ${ed}, ${ey}`;
  }
  if(cycleMode==='weekly'){
    const r=cycleRange(ck);
    const [sy,sm,sd]=r.start.split('-').map(Number);
    const [ey,em,ed]=r.end.split('-').map(Number);
    if(short) return `${SHORT_M[sm-1]} ${sd}`;
    const sameMonth=sm===em&&sy===ey;
    return sameMonth
      ? `Week of ${SHORT_M[sm-1]} ${sd}–${ed}, ${sy}`
      : `Week of ${SHORT_M[sm-1]} ${sd}–${SHORT_M[em-1]} ${ed}, ${ey}`;
  }
  const r=cycleRange(ck);
  const [,sm,sd]=r.start.split('-').map(Number);
  const [,em,ed]=r.end.split('-').map(Number);
  return `${SHORT_M[sm-1]} ${sd}–${SHORT_M[em-1]} ${ed}`;
}

/** Range string shown under the cycle label */
function cycleRangeStr(ck){
  const r=cycleRange(ck);
  const [sy,sm,sd]=r.start.split('-').map(Number);
  const [ey,em,ed]=r.end.split('-').map(Number);
  return `${SHORT_M[sm-1]} ${sd}, ${sy} → ${SHORT_M[em-1]} ${ed}, ${ey}`;
}

/** All unique cycle keys from stored transactions — only cycles with data, capped by cycleLimit */
function allCycleKeys(){
  const keys=[...new Set(transactions.map(t=>getCycleKey(t.date)))];
  const cur=currentCycleKey();
  if(!keys.includes(cur)) keys.push(cur);
  // Sort by actual start date (newest first), NOT by key string
  const sorted = keys.sort((a,b)=>cycleRange(b).start.localeCompare(cycleRange(a).start));
  const limited = sorted.slice(0, cycleLimit);
  if(!limited.includes(cur)) limited[limited.length-1] = cur;
  return limited;
}

/** Transactions belonging to a specific cycle */
function cycleTxs(ck){
  const {start,end}=cycleRange(ck);
  return transactions.filter(t=>t.date>=start&&t.date<=end);
}

// ════════════════════════════════════════════════════════════
//  STATS
// ════════════════════════════════════════════════════════════
function cycleStats(ck){
  const txs=cycleTxs(ck);
  const income  = txs.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
  // Cash expenses = regular non-credit expenses + credit bill payments
  const expense = txs.filter(t=>(t.type==='expense' && !t.creditCardId) || t.type==='credit_payment').reduce((s,t)=>s+t.amount,0);
  const creditExp = txs.filter(t=>t.type==='expense' && t.creditCardId).reduce((s,t)=>s+t.amount,0);
  const savings = txs.filter(t=>t.type==='savings').reduce((s,t)=>s+t.amount,0);
  return {income,expense,creditExp,savings,net:income-expense-savings,rate:income>0?(savings/income)*100:0};
}

/** Available balance for current cycle — used to cap new entries */
function getCycleAvailable(ck, excludeId=null){
  const txs = cycleTxs(ck).filter(t => excludeId ? t.id !== excludeId : true);
  const income  = txs.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
  // Cash expenses: regular expenses NOT paid by credit card + credit card bill payments
  const expense = txs.filter(t=>(t.type==='expense' && !t.creditCardId) || t.type==='credit_payment').reduce((s,t)=>s+t.amount,0);
  const savings = txs.filter(t=>t.type==='savings').reduce((s,t)=>s+t.amount,0);
  return income - expense - savings;
}

// ════════════════════════════════════════════════════════════
//  FORMATTERS
// ════════════════════════════════════════════════════════════
function fmt(n,dec=2){ return Math.abs(n).toLocaleString('en-US',{minimumFractionDigits:dec,maximumFractionDigits:dec}); }
function fmtS(n){ return Math.abs(n)>=1000?`${currencySymbol}${(Math.abs(n)/1000).toFixed(1)}k`:`${currencySymbol}${fmt(n,0)}`; }
function c$(n){ return `${currencySymbol}${fmt(n,0)}`; }
function formatDate(ds){
  const [y,m,d]=ds.split('-').map(Number);
  const dt=new Date(y,m-1,d),tod=new Date(); tod.setHours(0,0,0,0);
  const yes=new Date(tod); yes.setDate(tod.getDate()-1);
  if(dt.getTime()===tod.getTime()) return 'Today';
  if(dt.getTime()===yes.getTime()) return 'Yesterday';
  return `${SHORT_M[m-1]} ${d}`;
}

// ════════════════════════════════════════════════════════════
//  SAVINGS GOALS
// ════════════════════════════════════════════════════════════
/** Normalize goal name: trim + Title Case */
function normGoal(s){
  return s.trim().toLowerCase().replace(/\b\w/g,c=>c.toUpperCase());
}

/** All unique goal names across all transactions + any goal with a set target (case-insensitive deduped) */
function getSavingsGoals(){
  const seen=new Map();
  transactions.filter(t=>t.type==='savings'&&t.savingsGoal)
    .forEach(t=>{ const k=t.savingsGoal.toLowerCase(); if(!seen.has(k)) seen.set(k,t.savingsGoal); });
  // Also include goals that have a target set but no deposits yet
  Object.keys(goalTargets).forEach(k=>{ if(!seen.has(k)) seen.set(k, k.replace(/\b\w/g,c=>c.toUpperCase())); });
  return [...seen.values()].sort((a,b)=>a.localeCompare(b));
}

/** Goals data: total saved per goal across ALL stored transactions, including target-only goals */
function goalsData(){
  const map=new Map();
  transactions.filter(t=>t.type==='savings'&&t.savingsGoal).forEach(t=>{
    const k=t.savingsGoal.toLowerCase();
    if(!map.has(k)) map.set(k,{name:t.savingsGoal,total:0,count:0,last:t.date});
    const g=map.get(k);
    g.total+=t.amount;
    g.count++;
    if(t.date>g.last) g.last=t.date;
  });
  // Add goals that have a target but no deposits yet
  Object.keys(goalTargets).forEach(k=>{
    if(!map.has(k)){
      // Try to get a nicely-capitalised display name from ledger_defaultGoal or title-case the key
      const stored=localStorage.getItem('ledger_defaultGoal')||'';
      const displayName = stored.toLowerCase()===k ? stored : k.replace(/\b\w/g,c=>c.toUpperCase());
      map.set(k,{name:displayName,total:0,count:0,last:''});
    }
  });
  return [...map.values()].sort((a,b)=>b.total-a.total);
}

/** Generate missed recurring transactions for the current cycle */
function autoGenerateRecurring(){
  const curKey=currentCycleKey();
  const {start:cStart, end:cEnd}=cycleRange(curKey);
  const today=todayStr();
  // Get all unique recurring templates (use the latest version of each unique label+category)
  const templates=new Map();
  [...transactions].sort((a,b)=>a.date.localeCompare(b.date)).filter(t=>t.recurring).forEach(t=>{
    const key=`${t.category}::${t.label}::${t.recurFreq||'monthly'}`;
    templates.set(key,t);
  });
  let added=0;
  templates.forEach(tmpl=>{
    // Only auto-generate monthly recurring into this cycle if none exists yet
    if((tmpl.recurFreq||'monthly')!=='monthly') return; // only monthly auto-generate (weekly is too frequent)
    const alreadyExists=cycleTxs(curKey).some(t=>
      t.category===tmpl.category && t.label===tmpl.label && t.recurring && t.id!==tmpl.id
    );
    if(!alreadyExists){
      const newTx={
        ...tmpl,
        id:Date.now()+Math.random(),
        date: cStart<=today ? (cStart>today?cStart:today) : cStart,
        autoGenerated:true
      };
      // Don't auto-generate into future
      if(newTx.date<=today){
        transactions.push(newTx);
        added++;
      }
    }
  });
  if(added>0){
    transactions.sort((a,b)=>b.date.localeCompare(a.date)||b.id-a.id);
    persist();
  }
  return added;
}

/** Get recurring transaction templates for quick-add */
function getRecurringTemplates(){
  const seen=new Map();
  [...transactions].filter(t=>t.recurring).forEach(t=>{
    const key=`${t.category}::${t.amount}::${t.recurFreq||'monthly'}`;
    if(!seen.has(key)) seen.set(key,{...t});
  });
  return [...seen.values()].sort((a,b)=>b.amount-a.amount).slice(0,6);
}
function onGoalInput(){
  const q=document.getElementById('f-savings-goal').value.toLowerCase();
  const all=getSavingsGoals();
  const filtered=q ? all.filter(g=>g.toLowerCase().includes(q)) : all;
  renderGoalSuggestions(filtered);
  // Update target field with stored target for this goal
  setTimeout(refreshGoalTarget, 50);
}
function refreshGoalTarget(){
  const goalName=normGoal(document.getElementById('f-savings-goal').value||'Emergency Fund');
  const sym=document.getElementById('goal-target-sym');
  if(sym) sym.textContent=currencySymbol;
  const inp=document.getElementById('f-goal-target');
  if(!inp) return;
  const stored=goalTargets[goalName.toLowerCase()];
  if(stored && !inp.value) inp.value=stored;
  onGoalTargetInput();
}
function onGoalTargetInput(){
  const goalName=normGoal(document.getElementById('f-savings-goal').value||'Emergency Fund');
  const target=parseFloat(document.getElementById('f-goal-target').value)||0;
  const wrap=document.getElementById('goal-target-wrap');
  const hint=document.getElementById('goal-progress-hint');
  if(wrap) wrap.style.borderColor=target>0?'var(--accent)':'var(--border2)';
  if(!hint) return;
  if(target>0){
    const gd=goalsData();
    const gEntry=gd.find(g=>g.name.toLowerCase()===goalName.toLowerCase());
    const saved=gEntry?gEntry.total:0;
    const pct=Math.min(Math.round((saved/target)*100),100);
    const left=Math.max(target-saved,0);
    hint.style.display='block';
    hint.innerHTML=`<span style="color:var(--accent);font-weight:700;">${pct}% reached</span> · ${c$(saved)} of ${c$(target)} · <span style="color:var(--green);">${c$(left)} to go</span>`;
  } else {
    hint.style.display='none';
  }
}
function onGoalFocus(){
  const all=getSavingsGoals();
  renderGoalSuggestions(all);
  refreshGoalTarget();
}
function onGoalBlur(){
  // delay so click on suggestion registers first
  _goalBlurTimer=setTimeout(()=>closeGoalSuggestions(),200);
}
function renderGoalSuggestions(goals){
  const box=document.getElementById('goal-suggestions');
  if(!goals.length){ box.classList.remove('open'); return; }
  box.innerHTML=goals.map(g=>`
    <div class="goal-sug-item" onmousedown="pickGoal('${g.replace(/'/g,"\\'")}')">
      <div class="goal-sug-dot"></div>${g}
    </div>`).join('');
  box.classList.add('open');
}
function pickGoal(g){
  clearTimeout(_goalBlurTimer);
  document.getElementById('f-savings-goal').value=g;
  closeGoalSuggestions();
  refreshGoalTarget();
}
function closeGoalSuggestions(){
  document.getElementById('goal-suggestions')?.classList.remove('open');
}
// ════════════════════════════════════════════════════════════
function calcStreak(){
  if(!transactions.length) return 0;
  const dates=new Set(transactions.map(t=>t.date));
  let streak=0, check=new Date();
  if(!dates.has(todayStr())) check.setDate(check.getDate()-1);
  while(true){
    const d=ymd(check.getFullYear(),check.getMonth()+1,check.getDate());
    if(dates.has(d)){streak++;check.setDate(check.getDate()-1);}else break;
  }
  return streak;
}

// ════════════════════════════════════════════════════════════
//  THEME
// ════════════════════════════════════════════════════════════
function setTheme(t){
  activeTheme=t;
  document.body.className=[...document.body.classList].filter(c=>!c.startsWith('theme-')).concat('theme-'+t).join(' ');
  const allThemes=['dark','pink','white','navy','ice','forest','sunset','midnight'];
  allThemes.forEach(x=>{
    document.getElementById('theme-'+x)?.classList.toggle('active-theme',x===t);
  });
  const tc={
    'dark':'#080810','pink':'#1a0a14','white':'#f5f4f0',
    'navy':'#04080f','ice':'#06111a','forest':'#030f08',
    'sunset':'#0f0800','midnight':'#060410'
  };
  document.getElementById('theme-color-meta').content=tc[t]||'#080810';
  persist();
}

// ════════════════════════════════════════════════════════════
//  CYCLE SETTINGS UI
// ════════════════════════════════════════════════════════════
function selectCycleMode(mode){
  ['monthly','bimonthly','custom','weekly'].forEach(m=>{
    document.getElementById('cmo-'+m)?.classList.toggle('selected',m===mode);
    const f=document.getElementById('fields-'+m);
    if(f){ f.style.display=m===mode?'flex':'none'; f.style.flexDirection='column'; }
  });
  if(mode==='bimonthly') updateBiPreview();
}
/** Live preview of bi-monthly cycle dates shown in settings */
function updateBiPreview(){
  const s1=parseInt(document.getElementById('bi-s1')?.value)||25;
  const e1=parseInt(document.getElementById('bi-e1')?.value)||10;
  const s2=parseInt(document.getElementById('bi-s2')?.value)||11;
  const e2=parseInt(document.getElementById('bi-e2')?.value)||24;
  const cross=s1>e1;
  const preview=document.getElementById('bi-preview');
  if(!preview) return;
  const aRange=cross
    ? `Period A: ${s1}th → ${e1}th of next month`
    : `Period A: ${s1}th → ${e1}th (same month)`;
  const bRange=`Period B: ${s2}th → ${e2}th (same month)`;
  preview.innerHTML=`📅 ${aRange}<br/>📅 ${bRange}`;
}
function saveCycleSettings(){
  const prevMode=cycleMode;
  cycleMode=document.querySelector('.cycle-mode-opt.selected')?.id.replace('cmo-','')||'monthly';
  if(cycleMode==='monthly'){
    cycleConfig.monthly.payDay=Math.min(28,Math.max(1,parseInt(document.getElementById('pay-day').value)||25));
  } else if(cycleMode==='bimonthly'){
    cycleConfig.bimonthly.s1=parseInt(document.getElementById('bi-s1').value)||25;
    cycleConfig.bimonthly.e1=parseInt(document.getElementById('bi-e1').value)||10;
    cycleConfig.bimonthly.s2=parseInt(document.getElementById('bi-s2').value)||11;
    cycleConfig.bimonthly.e2=parseInt(document.getElementById('bi-e2').value)||24;
  } else if(cycleMode==='weekly'){
    cycleConfig.weekly.payDow=parseInt(document.getElementById('pay-dow').value)||1;
  } else {
    cycleConfig.custom.start=parseInt(document.getElementById('cust-start').value)||1;
    cycleConfig.custom.len  =Math.max(7,parseInt(document.getElementById('cust-len').value)||30);
  }
  persist();
  activeCycleKey=currentCycleKey();
  showSettingsToast('📅 Cycle settings saved!');
  renderFeed();
}
function renderSettingsInputs(){
  // restore fields
  selectCycleMode(cycleMode);
  document.getElementById('pay-day').value   = cycleConfig.monthly.payDay;
  document.getElementById('bi-s1').value     = cycleConfig.bimonthly.s1;
  document.getElementById('bi-e1').value     = cycleConfig.bimonthly.e1;
  document.getElementById('bi-s2').value     = cycleConfig.bimonthly.s2;
  document.getElementById('bi-e2').value     = cycleConfig.bimonthly.e2||24;
  updateBiPreview();
  document.getElementById('cust-start').value= cycleConfig.custom.start;
  document.getElementById('cust-len').value  = cycleConfig.custom.len;
  document.getElementById('pay-dow').value   = cycleConfig.weekly?.payDow ?? 1;
  document.getElementById('currency-input').value = currencySymbol;
  document.getElementById('cycle-limit-input').value = cycleLimit;
  updateCycleLimitPreview();
  const inp = document.getElementById('cycle-limit-input');
  inp.oninput = updateCycleLimitPreview;
  ['dark','pink','white'].forEach(x=>{
    document.getElementById('theme-'+x)?.classList.toggle('active-theme',x===activeTheme);
  });
}
function updateCycleLimitPreview(){
  const raw = parseInt(document.getElementById('cycle-limit-input')?.value);
  const val = isNaN(raw)?cycleLimit:Math.max(3,Math.min(60,raw));
  const existingKeys = [...new Set(transactions.map(t=>getCycleKey(t.date)))]
    .sort((a,b)=>cycleRange(b).start.localeCompare(cycleRange(a).start));
  const existing = existingKeys.length;
  const curKey = currentCycleKey();
  const preview = document.getElementById('cycle-limit-preview');
  if(!preview) return;
  if(existing === 0){
    preview.innerHTML = `Currently no cycles stored.`;
    return;
  }
  if(existing <= val){
    preview.innerHTML = `You have <strong>${existing}</strong> cycle${existing!==1?'s':''} stored — all will be kept.`;
    return;
  }
  const willDelete = existing - val;
  const oldestKept = existingKeys[val-1] ? cycleLabel(existingKeys[val-1]) : '—';
  const willRemove = existingKeys.slice(val).filter(k=>k!==curKey);
  preview.innerHTML = `⚠️ <strong>${willDelete}</strong> oldest cycle${willDelete!==1?'s':''} will be deleted. Oldest kept: <strong>${oldestKept}</strong>.`;
  preview.style.color = 'var(--red)';
  if(existing <= val) preview.style.color = 'var(--text3)';
}

// ════════════════════════════════════════════════════════════
//  NAV
// ════════════════════════════════════════════════════════════
function nav(v){
  currentView=v;
  document.querySelectorAll('.view').forEach(el=>el.classList.add('hidden'));
  document.querySelectorAll('.nav-btn').forEach(el=>el.classList.remove('active'));
  document.getElementById(`view-${v}`).classList.remove('hidden');
  if(v!=='settings'){ const nb=document.getElementById(`nav-${v}`); if(nb)nb.classList.add('active'); }
  if(v==='feed')      renderFeed();
  if(v==='dashboard') renderDash();
  if(v==='settings')  renderSettings();
}

// ════════════════════════════════════════════════════════════
//  BOTTOM SHEET
// ════════════════════════════════════════════════════════════
// ════════════════════════════════════════════════════════════
//  SPEED-DIAL FAB
// ════════════════════════════════════════════════════════════
function toggleFabDial(){
  const dial=document.getElementById('fab-dial');
  const backdrop=document.getElementById('fab-backdrop');
  const fab=document.getElementById('fab-main');
  const isOpen=dial.classList.contains('open');
  if(isOpen){ closeFabDial(); }
  else { dial.classList.add('open'); backdrop.classList.add('open'); fab.style.transform='rotate(45deg) scale(.92)'; fab.style.boxShadow='0 4px 24px var(--accent-dim)'; }
}
function closeFabDial(){
  const dial=document.getElementById('fab-dial');
  const backdrop=document.getElementById('fab-backdrop');
  const fab=document.getElementById('fab-main');
  dial.classList.remove('open'); backdrop.classList.remove('open'); fab.style.transform=''; fab.style.boxShadow='';
}
let sheetTypeFilter = null; // set when opening from FAB dial — null = show all
function openSheetType(type){
  closeFabDial();
  sheetTypeFilter = type;
  const cat = CATS.find(c=>c.t===type);
  if(cat){ selectedCat = cat.k; }
  openSheet();
}

function openSheet(tx=null){
  editingId=null; isRecurring=false; isCreditPay=false; recurFreq='weekly';
  // Clear type filter unless we just set it via openSheetType
  if(!tx) { /* keep sheetTypeFilter if set by openSheetType */ }
  if(tx) sheetTypeFilter=null; // editing: always show all categories
  const df=document.getElementById('f-date');

  // Set date bounds based on which cycle we're adding to
  const targetCk = tx ? getCycleKey(tx.date) : activeCycleKey;
  const curKey   = currentCycleKey();
  const isCurCycle = targetCk === curKey;
  const {start:cStart, end:cEnd} = cycleRange(targetCk);

  if(isCurCycle){
    // Current cycle: min = cycle start, max = today
    df.min = cStart;
    df.max = todayStr();
    df.value = tx ? tx.date : todayStr();
  } else {
    // Past cycle: locked to cycle's start → end only
    df.min = cStart;
    df.max = cEnd;
    df.value = tx ? tx.date : cEnd; // default to last day of that cycle
  }

  document.getElementById('f-amount').value='';
  document.getElementById('f-note').value='';
  document.getElementById('f-savings-goal').value='';
  if(document.getElementById('f-goal-target')) document.getElementById('f-goal-target').value='';
  if(document.getElementById('goal-target-sym')) document.getElementById('goal-target-sym').textContent=currencySymbol;
  if(document.getElementById('goal-progress-hint')) document.getElementById('goal-progress-hint').style.display='none';
  document.getElementById('savings-goal-section').style.display = (sheetTypeFilter==='savings') ? 'block' : 'none';
  document.getElementById('add-toast').style.display='none';
  document.getElementById('date-err').style.display='none';
  if(sheetTypeFilter){
    const defaultCat=CATS.find(c=>c.t===sheetTypeFilter);
    selectedCat=defaultCat?defaultCat.k:'transport';
  } else {
    selectedCat='transport';
  }
  if(tx){
    editingId=tx.id; df.value=tx.date;
    document.getElementById('f-amount').value=tx.amount;
    document.getElementById('f-note').value=tx.note||'';
    document.getElementById('f-savings-goal').value=tx.savingsGoal||'';
    selectedCat=tx.category; isRecurring=!!tx.recurring; recurFreq=tx.recurFreq||'weekly';
    if(tx.category==='savings'){
      document.getElementById('savings-goal-section').style.display='block';
      const goalKey=(tx.savingsGoal||'Emergency Fund').toLowerCase();
      const storedTarget=goalTargets[goalKey]||'';
      if(document.getElementById('f-goal-target')) document.getElementById('f-goal-target').value=storedTarget||'';
      setTimeout(onGoalTargetInput,50);
    }
    document.getElementById('sheet-title').innerHTML='Edit <em>Transaction</em>';
  } else { document.getElementById('sheet-title').innerHTML='Log a <em>Transaction</em>'; }
  document.getElementById('amt-remaining').style.display='none';
  document.getElementById('amt-err').style.display='none';
  document.getElementById('amt-sym').textContent=currencySymbol;
  document.getElementById('recur-toggle').className='toggle'+(isRecurring?' on':'');
  document.getElementById('recur-freq-wrap').style.display=isRecurring?'flex':'none';
  updateRecurFreqUI();
  // Credit toggle
  document.getElementById('credit-toggle')&&(document.getElementById('credit-toggle').className='toggle');
  document.getElementById('cc-picker-wrap').classList.remove('open');
  // Reset payment method buttons
  const cashBtn=document.getElementById('pay-method-cash');
  const creditBtn=document.getElementById('pay-method-credit');
  if(cashBtn) cashBtn.classList.add('active');
  if(creditBtn) creditBtn.classList.remove('active');
  // Show credit toggle section only for expenses and if cards exist
  const hasCCs = creditCards.length > 0;
  // Compute available balance for the cycle
  _sheetAvailable = getCycleAvailable(targetCk, editingId||null);
  buildCatGrid(); updateSaveBtn(); updateRemainingHint();
  updateCreditToggleVisibility();
  populateCardPicker();
  document.getElementById('sheet-overlay').classList.add('active');
  document.getElementById('add-sheet').classList.add('open');
  sheetOpen=true;
}
function closeSheet(){
  document.getElementById('sheet-overlay').classList.remove('active');
  document.getElementById('add-sheet').classList.remove('open');
  sheetOpen=false; expandedTx=null; sheetTypeFilter=null;
}
function toggleRecur(){
  isRecurring=!isRecurring;
  document.getElementById('recur-toggle').className='toggle'+(isRecurring?' on':'');
  const wrap=document.getElementById('recur-freq-wrap');
  wrap.style.display=isRecurring?'flex':'none';
  if(isRecurring) updateRecurFreqUI();
}
function setRecurFreq(freq){
  recurFreq=freq;
  updateRecurFreqUI();
}
function updateRecurFreqUI(){
  ['weekly','monthly'].forEach(f=>{
    const btn=document.getElementById('recur-freq-'+f);
    if(btn) btn.classList.toggle('active', f===recurFreq);
  });
  const sub=document.getElementById('recur-sub');
  if(sub) sub.textContent=recurFreq==='weekly'?'Repeats every week':'Repeats every month';
}
function toggleCredit(){
  isCreditPay=!isCreditPay;
  document.getElementById('credit-toggle')&&(document.getElementById('credit-toggle').className='toggle'+(isCreditPay?' on':''));
  const wrap=document.getElementById('cc-picker-wrap');
  if(isCreditPay){ wrap.classList.add('open'); populateCardPicker(); }
  else { wrap.classList.remove('open'); }
  updateRemainingHint(); updateSaveBtn();
}
function setPayMethod(method){
  isCreditPay = (method==='credit');
  // Update button styles
  const cashBtn=document.getElementById('pay-method-cash');
  const creditBtn=document.getElementById('pay-method-credit');
  if(cashBtn) cashBtn.classList.toggle('active', !isCreditPay);
  if(creditBtn) creditBtn.classList.toggle('active', isCreditPay);
  const wrap=document.getElementById('cc-picker-wrap');
  if(isCreditPay){ wrap.classList.add('open'); populateCardPicker(); }
  else { wrap.classList.remove('open'); }
  updateRemainingHint(); updateSaveBtn();
}
function updateCreditToggleVisibility(){
  const cat=CATS.find(c=>c.k===selectedCat);
  const isExp = cat && cat.t==='expense';
  const sec=document.getElementById('credit-toggle-section');
  if(isExp && creditCards.length>0){
    sec.style.display='block';
    // Reset to cash method when showing
    if(!isCreditPay){
      const cashBtn=document.getElementById('pay-method-cash');
      const creditBtn=document.getElementById('pay-method-credit');
      if(cashBtn) cashBtn.classList.add('active');
      if(creditBtn) creditBtn.classList.remove('active');
    }
  }
  else {
    sec.style.display='none'; isCreditPay=false;
    document.getElementById('credit-toggle')&&(document.getElementById('credit-toggle').className='toggle');
    document.getElementById('cc-picker-wrap').classList.remove('open');
  }
}
function populateCardPicker(){
  const sel=document.getElementById('f-credit-card');
  sel.innerHTML=creditCards.map(c=>{
    const info=getCardInfo(c.id);
    return `<option value="${c.id}">${c.name} — ${currencySymbol}${fmt(info.available,0)} available</option>`;
  }).join('');
  updateCCHint();
}
function updateCCHint(){
  if(!isCreditPay) return;
  const cardId=document.getElementById('f-credit-card')?.value;
  if(!cardId) return;
  const info=getCardInfo(cardId);
  const hint=document.getElementById('cc-hint');
  const amt=parseFloat(document.getElementById('f-amount').value)||0;
  const after=info.available-amt;
  if(after<0){
    hint.textContent=`⛔ Exceeds available credit by ${currencySymbol}${fmt(Math.abs(after),0)}`;
    hint.style.color='var(--red)';
  } else {
    hint.textContent=`💳 ${currencySymbol}${fmt(after,0)} will remain available on this card`;
    hint.style.color='#a855f7';
  }
}

// ════════════════════════════════════════════════════════════
//  CATEGORIES
// ════════════════════════════════════════════════════════════
function buildCatGrid(){
  const catSection = document.getElementById('cat-grid')?.closest('.form-section');
  if(sheetTypeFilter==='savings'){
    if(catSection) catSection.style.display='none';
    return;
  }
  if(catSection) catSection.style.display='';
  const cats = sheetTypeFilter ? CATS.filter(c=>c.t===sheetTypeFilter) : CATS;
  document.getElementById('cat-grid').innerHTML=cats.map(c=>`
    <div class="cat-tile ${selectedCat===c.k?`sel-${c.t}`:''}\" onclick=\"selectCat('${c.k}')">
      <span class="cat-icon">${c.i}</span><span class="cat-name">${c.l}</span>
    </div>`).join('');
  updateSaveBtn();
}
let _sheetAvailable = Infinity; // available balance when sheet opens

function onAmountInput(){
  updateSaveBtn();
  updateRemainingHint();
}

function updateRemainingHint(){
  const cat = CATS.find(c=>c.k===selectedCat);
  const hintEl = document.getElementById('amt-remaining');
  const errEl  = document.getElementById('amt-err');
  // Income has no cap; credit card expense has no balance cap
  if(!cat || cat.t==='income' || isCreditPay){
    hintEl.style.display='none';
    errEl.style.display='none';
    if(isCreditPay) updateCCHint();
    return;
  }
  const val = parseFloat(document.getElementById('f-amount').value)||0;
  const avail = _sheetAvailable;
  const left = avail - val;
  hintEl.style.display = 'flex';
  if(val <= 0){
    hintEl.className='amt-remaining ok';
    hintEl.textContent = `Available: ${c$(avail)}`;
  } else if(left >= 0){
    const cls = left < avail*0.2 ? 'warn' : 'ok';
    hintEl.className=`amt-remaining ${cls}`;
    hintEl.textContent = `${c$(left)} remaining after this`;
    errEl.style.display='none';
  } else {
    hintEl.className='amt-remaining over';
    hintEl.textContent = `Exceeds available balance by ${c$(Math.abs(left))}`;
    errEl.style.display='block';
  }
}
function selectCat(k){
  selectedCat=k;
  buildCatGrid();
  const goalSection=document.getElementById('savings-goal-section');
  if(goalSection) goalSection.style.display = k==='savings' ? 'block' : 'none';
  if(k==='savings'){
    const firstHint=document.getElementById('goal-first-hint');
    if(firstHint) firstHint.style.display = getSavingsGoals().length===0 ? 'block':'none';
  }
  updateCreditToggleVisibility();
  updateRemainingHint();
}
function updateSaveBtn(){
  const cat=CATS.find(c=>c.k===selectedCat);
  const btn=document.getElementById('save-btn');
  btn.className=`save-btn btn-${cat?.t||'expense'}`;
  btn.textContent=editingId?'Update Entry':`Save ${cat?.i||''} ${cat?.l||''}`;
  const amt=parseFloat(document.getElementById('f-amount').value);
  // Over-balance check is skipped if paying with credit card
  const overBudget = cat && cat.t!=='income' && !isCreditPay && amt > 0 && amt > _sheetAvailable;
  // Check credit limit if paying with credit
  let overCredit=false;
  if(isCreditPay && amt>0){
    const cardId=document.getElementById('f-credit-card')?.value;
    if(cardId){ const info=getCardInfo(cardId); overCredit=amt>info.available; }
  }
  btn.disabled=!amt||isNaN(amt)||amt<=0||overBudget||overCredit;
}

// ════════════════════════════════════════════════════════════
//  SAVE / DELETE
// ════════════════════════════════════════════════════════════
function saveTransaction(){
  const amount=parseFloat(document.getElementById('f-amount').value);
  if(!amount||isNaN(amount)||amount<=0) return;
  const chosenDate=document.getElementById('f-date').value;
  const errEl=document.getElementById('date-err');
  if(chosenDate>todayStr()){errEl.style.display='block';setTimeout(()=>errEl.style.display='none',3000);return;}
  errEl.style.display='none';
  const cat=CATS.find(c=>c.k===selectedCat);
  // Hard guard: block going negative for expense/savings (unless using credit card)
  if(cat.t!=='income' && !isCreditPay && amount > _sheetAvailable){
    document.getElementById('amt-err').style.display='block';
    return;
  }
  const id=editingId||Date.now();
  const rawGoal=document.getElementById('f-savings-goal').value.trim();
  // Default savings goal: "Emergency Fund" if none typed and no prior goals exist
  let savingsGoal='';
  if(cat.t==='savings'){
    if(rawGoal){
      savingsGoal=normGoal(rawGoal);
    } else {
      const existingGoals=getSavingsGoals();
      savingsGoal=existingGoals.length>0?'Emergency Fund':'Emergency Fund';
    }
    // Save target if provided
    const targetAmt=parseFloat(document.getElementById('f-goal-target')?.value)||0;
    if(targetAmt>0) goalTargets[savingsGoal.toLowerCase()]=targetAmt;
  }
  // Credit card
  let creditCardId=null;
  if(isCreditPay && cat.t==='expense'){
    creditCardId=document.getElementById('f-credit-card')?.value||null;
  }
  const tx={id,date:chosenDate,category:selectedCat,label:cat.l,icon:cat.i,type:cat.t,amount,note:document.getElementById('f-note').value.trim(),recurring:isRecurring,recurFreq:isRecurring?recurFreq:null,savingsGoal,creditCardId};
  if(editingId) transactions=transactions.filter(t=>t.id!==editingId);
  transactions.push(tx);
  transactions.sort((a,b)=>b.date.localeCompare(a.date)||b.id-a.id);
  enforceCycleLimit(); // auto-trim oldest cycles if over the limit
  persist(); // auto-save everything
  activeCycleKey=getCycleKey(tx.date);
  expandedTx=null; deleteConfirm=null;
  if(navigator.vibrate) navigator.vibrate(30);
  document.getElementById('add-toast').style.display='flex';
  setTimeout(()=>{closeSheet();renderFeed();renderDash();},900);
}
let _undoTimer = null;
let _undoTx = null;

function deleteTx(id){
  const tx = transactions.find(t => t.id === id);
  if(!tx) return;

  // Remove from array immediately
  transactions = transactions.filter(t => t.id !== id);
  persist(); deleteConfirm=null; expandedTx=null;
  if(navigator.vibrate) navigator.vibrate([20,10,20]);
  renderFeed(); renderDash();

  // Clear any existing undo toast
  if(_undoTimer){ clearTimeout(_undoTimer); _undoTimer=null; }
  const existing = document.getElementById('undo-toast');
  if(existing) existing.remove();

  // Store for undo
  _undoTx = tx;

  // Build toast
  const toast = document.createElement('div');
  toast.id = 'undo-toast';
  toast.className = 'undo-toast';
  toast.innerHTML = `
    <div style="font-size:1.3rem;">${tx.icon}</div>
    <div class="undo-toast-text">
      <div>${tx.label} deleted</div>
      <div class="undo-toast-sub">${tx.type.charAt(0).toUpperCase()+tx.type.slice(1)} · ${currencySymbol}${fmt(tx.amount,2)}</div>
    </div>
    <button class="undo-btn" onclick="undoDelete()">Undo</button>
    <div class="undo-progress" id="undo-progress" style="width:100%;"></div>
  `;
  document.getElementById('app').appendChild(toast);

  // Animate progress bar shrinking over 5s
  const bar = document.getElementById('undo-progress');
  requestAnimationFrame(()=>{
    requestAnimationFrame(()=>{
      if(bar){ bar.style.transitionDuration='5000ms'; bar.style.width='0%'; }
    });
  });

  // Auto-dismiss after 5s
  _undoTimer = setTimeout(()=>{ dismissUndoToast(); }, 5000);
}

function undoDelete(){
  if(!_undoTx) return;
  clearTimeout(_undoTimer); _undoTimer=null;
  transactions.push(_undoTx);
  transactions.sort((a,b)=>b.date.localeCompare(a.date)||b.id-a.id);
  _undoTx=null;
  persist();
  if(navigator.vibrate) navigator.vibrate(30);
  dismissUndoToast();
  renderFeed(); renderDash();
}

function dismissUndoToast(){
  const toast=document.getElementById('undo-toast');
  if(toast){
    toast.style.transition='opacity .25s, transform .25s';
    toast.style.opacity='0';
    toast.style.transform='translateX(-50%) translateY(16px)';
    setTimeout(()=>toast.remove(), 260);
  }
  _undoTx=null;
}

// ════════════════════════════════════════════════════════════
//  SEARCH & FILTER
// ════════════════════════════════════════════════════════════
function onSearch(){ searchQuery=document.getElementById('search-input').value.toLowerCase(); document.getElementById('search-clear').style.display=searchQuery?'flex':'none'; renderFeed(); }
function clearSearch(){ document.getElementById('search-input').value=''; searchQuery=''; document.getElementById('search-clear').style.display='none'; renderFeed(); }
function setFilter(f){ activeFilter=f; renderFilterChips(); renderFeed(); }
function renderFilterChips(){
  const fs=[{k:'all',l:'All'},{k:'income',l:'💼 Income'},{k:'expense',l:'💸 Spent'},{k:'savings',l:'🏦 Saved'},{k:'recurring',l:'🔄 Recurring'}];
  document.getElementById('filter-chips').innerHTML=fs.map(f=>`<button class="filter-chip ${activeFilter===f.k?`fc-${f.k}`:''}\" onclick=\"setFilter('${f.k}')">${f.l}</button>`).join('');
}

// ════════════════════════════════════════════════════════════
//  BUDGET
// ════════════════════════════════════════════════════════════
function openBudgetModal(){
  document.getElementById('budget-inputs').innerHTML=EXPENSE_CATS.map(c=>`
    <div class="bm-row"><div class="bm-icon">${c.i}</div><div class="bm-name">${c.l}</div>
    <input class="bm-field" type="number" id="bud-${c.k}" placeholder="0" value="${budgets[c.k]||''}"/></div>`).join('');
  document.getElementById('budget-modal').classList.add('open');
}
function closeBudgetModal(e){ if(e&&e.target!==document.getElementById('budget-modal'))return; document.getElementById('budget-modal').classList.remove('open'); }
function saveBudgets(){
  EXPENSE_CATS.forEach(c=>{ const v=parseFloat(document.getElementById(`bud-${c.k}`)?.value)||0; if(v>0)budgets[c.k]=v; else delete budgets[c.k]; });
  persist(); document.getElementById('budget-modal').classList.remove('open'); renderFeed();
}
function renderBudgets(){
  const txs=cycleTxs(activeCycleKey).filter(t=>t.type==='expense');
  const active=EXPENSE_CATS.filter(c=>budgets[c.k]);
  if(!active.length){document.getElementById('budget-area').innerHTML='';return;}
  const rows=active.map(c=>{
    const spent=txs.filter(t=>t.category===c.k).reduce((s,t)=>s+t.amount,0);
    const limit=budgets[c.k], pct=Math.min((spent/limit)*100,100);
    const color=pct>=100?'var(--red)':pct>=80?'var(--accent)':'var(--green)';
    return `<div class="budget-bar-row">
      <div class="budget-bar-meta"><span class="budget-bar-name">${c.i} ${c.l}</span><span class="budget-bar-nums" style="color:${color}">${c$(spent)} / ${c$(limit)}</span></div>
      <div class="budget-track"><div class="budget-fill" style="width:${pct}%;background:${color};"></div></div>
    </div>`;
  }).join('');
  document.getElementById('budget-area').innerHTML=`<div class="budget-section">
    <div class="budget-label-row"><span class="budget-title">Budget Tracker</span><span class="budget-edit" onclick="openBudgetModal()">✏️ Edit</span></div>${rows}</div>`;
}

// ════════════════════════════════════════════════════════════
//  CREDIT CARD HELPERS
// ════════════════════════════════════════════════════════════
/** Returns {limit, used, available, pct} for a card */
function getCardInfo(cardId){
  const card = creditCards.find(c=>c.id===cardId);
  if(!card) return {limit:0,used:0,available:0,pct:0};
  // Used = sum of all credit card expenses for this card
  const used = transactions
    .filter(t=>t.creditCardId===cardId && t.type==='expense')
    .reduce((s,t)=>s+t.amount,0);
  // Restored = sum of all credit payments for this card
  const paid = transactions
    .filter(t=>t.creditCardId===cardId && t.type==='credit_payment')
    .reduce((s,t)=>s+t.amount,0);
  const net = Math.max(0, used - paid);
  const available = Math.max(0, card.limit - net);
  const pct = card.limit > 0 ? Math.min((net/card.limit)*100,100) : 0;
  return {limit:card.limit, used:net, available, pct};
}
function addCreditCard(){
  const name=(document.getElementById('cc-name-input').value||'').trim();
  const limit=parseFloat(document.getElementById('cc-limit-input').value)||0;
  const interest=parseFloat(document.getElementById('cc-interest-input').value)||0;
  if(!name||limit<=0){ showSettingsToast('⚠️ Enter a card name and limit.'); return; }
  creditCards.push({id:String(Date.now()), name, limit, billingFee: interest||0});
  document.getElementById('cc-name-input').value='';
  document.getElementById('cc-limit-input').value='';
  document.getElementById('cc-interest-input').value='';
  persist(); renderSettingsCCList(); showSettingsToast('💳 Card added!');
}
function removeCreditCard(id){
  const info=getCardInfo(id);
  const card=creditCards.find(c=>c.id===id);
  if(!card) return;

  const hasBalance=info.used>0;
  showConfirm({
    icon: hasBalance ? '⚠️' : '💳',
    title: hasBalance ? `${card.name} has unpaid balance!` : `Remove ${card.name}?`,
    msg: hasBalance
      ? `There's still ${currencySymbol}${fmt(info.used,2)} outstanding. Delete the card and all its transactions, or just remove the card and keep transaction history?`
      : `Delete the card and all its transactions, or just remove the card and keep the transaction history?`,
    okLabel: 'Delete Card + Transactions',
    secondaryLabel: 'Remove Card Only',
    cancelLabel: 'Cancel',
    onOk:()=>{
      creditCards=creditCards.filter(c=>c.id!==id);
      transactions=transactions.filter(t=>t.creditCardId!==id);
      persist(); renderSettingsCCList(); renderFeed(); renderDash();
      showSettingsToast('Card and all transactions removed.');
    },
    onSecondary:()=>{
      creditCards=creditCards.filter(c=>c.id!==id);
      transactions=transactions.map(t=>t.creditCardId===id?{...t,creditCardId:null}:t);
      persist(); renderSettingsCCList(); renderFeed(); renderDash();
      showSettingsToast('Card removed. Transactions kept.');
    }
  });
}
function renderSettingsCCList(){
  const el=document.getElementById('cc-settings-list');
  if(!el) return;
  if(!creditCards.length){ el.innerHTML='<div style="font-size:.75rem;color:var(--text3);margin-bottom:6px;">No cards added yet.</div>'; return; }
  el.innerHTML=creditCards.map(c=>{
    const info=getCardInfo(c.id);
    const color=info.pct>=90?'var(--red)':info.pct>=70?'var(--accent)':'var(--green)';
    return `<div style="background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:10px 12px;margin-bottom:6px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
        <span style="font-size:.85rem;font-weight:700;color:var(--text);">💳 ${c.name}</span>
        <div style="display:flex;align-items:center;gap:7px;">
          ${c.billingFee>0?`<span style="font-size:.65rem;font-weight:700;color:#a855f7;background:#a855f718;border:1px solid #a855f730;border-radius:6px;padding:2px 7px;">+${currencySymbol}${fmt(c.billingFee,0)} fee</span>`:''}
          <button class="cc-del-btn" onclick="removeCreditCard('${c.id}')">Remove</button>
        </div>
      </div>
      <div style="display:flex;justify-content:space-between;font-size:.7rem;color:var(--text3);margin-bottom:4px;">
        <span>Used: <strong style="color:${color}">${currencySymbol}${fmt(info.used,0)}</strong></span>
        <span>Available: <strong style="color:var(--green)">${currencySymbol}${fmt(info.available,0)}</strong></span>
        <span>Limit: <strong style="color:var(--text2)">${currencySymbol}${fmt(info.limit,0)}</strong></span>
      </div>
      <div style="height:4px;background:var(--bg3);border-radius:99px;overflow:hidden;">
        <div style="height:100%;width:${info.pct}%;background:${color};border-radius:99px;transition:width .6s;"></div>
      </div>
    </div>`;
  }).join('');
}
function openPayModal(cardId){
  const card=creditCards.find(c=>c.id===cardId); if(!card) return;
  const info=getCardInfo(cardId);
  const curKey=currentCycleKey();
  const cashAvail=Math.max(0, getCycleAvailable(curKey));

  document.getElementById('pay-card-id').value=cardId;
  document.getElementById('pay-modal-sub').textContent=`Payment deducts from your cash balance and restores ${card.name}'s credit.`;
  document.getElementById('pay-modal-owed').textContent=`${currencySymbol}${fmt(info.used,0)}`;
  document.getElementById('pay-cash-avail').textContent=`${currencySymbol}${fmt(cashAvail,0)}`;
  document.getElementById('pay-sym').textContent=currencySymbol;
  document.getElementById('pay-fee-sym').textContent=currencySymbol;

  // Pre-fill billing fee button if card has a default fee set
  const feeRow=document.getElementById('pay-fee-prefill-row');
  const feeBtn=document.getElementById('pay-fee-prefill-btn');
  if(card.billingFee>0){
    feeRow.style.display='block';
    feeBtn.textContent=`Use default fee: ${currencySymbol}${fmt(card.billingFee,0)}`;
  } else {
    feeRow.style.display='none';
  }

  const inp=document.getElementById('pay-amount');
  inp.value='';
  inp.max=String(info.used); // hard cap at outstanding balance
  document.getElementById('pay-fee-amount').value='';
  document.getElementById('pay-hint').textContent=cashAvail<=0?'⛔ No cash available this cycle to make a payment.':'';
  document.getElementById('pay-summary-row').style.display='none';
  const btn=document.querySelector('.pay-save');
  if(btn){ btn.disabled=cashAvail<=0||info.used<=0; btn.style.opacity=cashAvail<=0||info.used<=0?'0.3':'1'; }
  document.getElementById('pay-modal').classList.add('open');
  const errT=document.getElementById('pay-error-toast');
  if(errT) errT.style.display='none';
}
function closePayModal(e){ if(e&&e.target!==document.getElementById('pay-modal'))return; document.getElementById('pay-modal').classList.remove('open'); }
function showPayError(msg){
  const t=document.getElementById('pay-error-toast');
  if(!t) return;
  t.textContent=msg; t.style.display='block';
  setTimeout(()=>t.style.display='none', 3500);
}
function prefillBillingFee(){
  const cardId=document.getElementById('pay-card-id').value;
  const card=creditCards.find(c=>c.id===cardId);
  if(card?.billingFee>0){
    document.getElementById('pay-fee-amount').value=card.billingFee;
    updatePayHint();
  }
}
function setPayQuick(mode){
  const cardId=document.getElementById('pay-card-id').value;
  const info=getCardInfo(cardId);
  const curKey=currentCycleKey();
  const cashAvail=Math.max(0, getCycleAvailable(curKey));
  let val;
  if(mode==='full') val=info.used;
  else val=Math.min(info.used, cashAvail);
  document.getElementById('pay-amount').value=val>0?String(Math.round(val*100)/100):'';
  updatePayHint();
}
function updatePayHint(){
  const cardId=document.getElementById('pay-card-id').value;
  const info=getCardInfo(cardId);
  const curKey=currentCycleKey();
  const cashAvail=Math.max(0, getCycleAvailable(curKey));
  const principal=parseFloat(document.getElementById('pay-amount').value)||0;
  const fee=parseFloat(document.getElementById('pay-fee-amount').value)||0;
  const totalOut=principal+fee;
  const hint=document.getElementById('pay-hint');
  const btn=document.querySelector('.pay-save');
  const sumRow=document.getElementById('pay-summary-row');

  // Update summary if either field has a value
  if(principal>0||fee>0){
    sumRow.style.display='block';
    document.getElementById('pay-sum-principal').textContent=`${currencySymbol}${fmt(principal,2)}`;
    document.getElementById('pay-sum-fee').textContent=fee>0?`${currencySymbol}${fmt(fee,2)}`:'—';
    document.getElementById('pay-sum-total').textContent=`${currencySymbol}${fmt(totalOut,2)}`;
  } else {
    sumRow.style.display='none';
  }

  if(principal<=0 && fee<=0){ hint.textContent=''; if(btn){btn.disabled=false;btn.style.opacity='1';}return; }
  if(totalOut>cashAvail){
    hint.textContent=`⛔ Total (${currencySymbol}${fmt(totalOut,2)}) exceeds cash available (${currencySymbol}${fmt(cashAvail,2)})`;
    hint.style.color='var(--red)';
    if(btn){btn.disabled=true;btn.style.opacity='0.3';}
  } else if(principal>info.used){
    hint.textContent=`⛔ Payment exceeds outstanding balance by ${currencySymbol}${fmt(principal-info.used,2)}`;
    hint.style.color='var(--red)';
    if(btn){btn.disabled=true;btn.style.opacity='0.3';}
  } else {
    const newAvail=info.available+Math.min(principal,info.used);
    const cashLeft=cashAvail-totalOut;
    hint.textContent=`Card credit → ${currencySymbol}${fmt(newAvail,0)} · Cash left: ${currencySymbol}${fmt(cashLeft,0)}${fee>0?' · Fee logged as expense':''}`;
    hint.style.color='#a855f7';
    if(btn){btn.disabled=false;btn.style.opacity='1';}
  }
}
function submitCreditPayment(){
  const cardId=document.getElementById('pay-card-id').value;
  const principal=parseFloat(document.getElementById('pay-amount').value)||0;
  const fee=parseFloat(document.getElementById('pay-fee-amount').value)||0;
  if(principal<=0 && fee<=0) return;
  const card=creditCards.find(c=>c.id===cardId); if(!card) return;
  const info=getCardInfo(cardId);
  const curKey=currentCycleKey();
  const cashAvail=Math.max(0, getCycleAvailable(curKey));
  const totalOut=principal+fee;

  // Hard guards — never allow overpayment
  if(info.used<=0 && principal>0){
    showPayError('⚠️ No outstanding balance on this card.');
    return;
  }
  if(principal>info.used){
    showPayError(`⚠️ Max payable is ${currencySymbol}${fmt(info.used,2)} — amount corrected.`);
    document.getElementById('pay-amount').value=String(Math.round(info.used*100)/100);
    updatePayHint();
    return;
  }
  if(totalOut>cashAvail){
    showPayError(`⚠️ Not enough cash available (${currencySymbol}${fmt(cashAvail,2)})`);
    return;
  }

  const now=Date.now();

  // 1. Principal payment — restores card credit
  if(principal>0){
    transactions.push({
      id:now,
      date:todayStr(),
      category:'credit_payment',
      label:`${card.name} Payment`,
      icon:'💳',
      type:'credit_payment',
      amount:principal,
      note:`Credit card payment — ${card.name}`,
      recurring:false,
      savingsGoal:'',
      creditCardId:cardId
    });
  }

  // 2. Billing fee — logged as a separate expense (does NOT restore credit)
  if(fee>0){
    transactions.push({
      id:now+1,
      date:todayStr(),
      category:'other',
      label:`${card.name} Billing Fee`,
      icon:'📊',
      type:'expense',
      amount:fee,
      note:`Billing fee / interest — ${card.name}`,
      recurring:false,
      savingsGoal:'',
      creditCardId:null
    });
  }

  transactions.sort((a,b)=>b.date.localeCompare(a.date)||b.id-a.id);
  persist();
  document.getElementById('pay-modal').classList.remove('open');
  renderFeed();
  renderDash();
}
function renderCreditSection(){
  const el=document.getElementById('credit-area');
  if(!el||!creditCards.length){if(el)el.innerHTML='';return;}
  const pills=creditCards.map(c=>{
    const info=getCardInfo(c.id);
    const color=info.pct>=90?'var(--red)':info.pct>=70?'var(--accent)':'#a855f7';
    const hasDebt=info.used>0;
    return `<div style="flex-shrink:0;background:var(--bg1);border:1.5px solid ${hasDebt?color:'var(--border)'};border-radius:14px;padding:8px 12px;cursor:pointer;min-width:130px;" onclick="openPayModal('${c.id}')">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:5px;">
        <span style="font-size:.7rem;font-weight:700;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:80px;">&#x1F4B3; ${c.name}</span>
        ${hasDebt?`<span style="font-size:.58rem;font-weight:700;background:${color}20;color:${color};border-radius:5px;padding:1px 5px;">Pay</span>`:'<span style="font-size:.58rem;color:var(--green);font-weight:700;">&#x2713; Clear</span>'}
      </div>
      <div style="height:3px;background:var(--bg3);border-radius:99px;overflow:hidden;margin-bottom:4px;">
        <div style="height:100%;width:${info.pct}%;background:${color};border-radius:99px;"></div>
      </div>
      <div style="display:flex;justify-content:space-between;font-size:.62rem;">
        <span style="color:${color};font-weight:700;">${fmtS(info.used)} used</span>
        <span style="color:var(--text3);">${fmtS(info.available)} left</span>
      </div>
    </div>`;
  }).join('');
  el.innerHTML=`<div style="padding:0 20px 10px;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:7px;">
      <span style="font-size:.62rem;text-transform:uppercase;letter-spacing:1.2px;color:var(--text3);font-weight:700;">&#x1F4B3; Credit Cards</span>
      <span style="font-size:.67rem;color:var(--accent);cursor:pointer;font-weight:700;" onclick="nav('settings')">Manage</span>
    </div>
    <div style="display:flex;gap:8px;overflow-x:auto;scrollbar-width:none;padding-bottom:2px;-webkit-overflow-scrolling:touch;">${pills}</div>
  </div>`;
}

// ════════════════════════════════════════════════════════════
//  RENDER FEED
// ════════════════════════════════════════════════════════════
function renderFeed(){
  const now=new Date();
  document.getElementById('top-date-label').textContent=`${SHORT_M[now.getMonth()]} ${now.getDate()}, ${now.getFullYear()}`;
  const modeLabels={monthly:'Pay-cycle tracker',bimonthly:'Bi-monthly tracker',weekly:'Weekly pay tracker',custom:'Custom cycle tracker'};
  document.getElementById('cycle-mode-label').textContent=modeLabels[cycleMode]||'Pay-cycle tracker';

  const curKey=currentCycleKey();
  if(!activeCycleKey) activeCycleKey=curKey;

  const allKeys=allCycleKeys();
  const idx=allKeys.indexOf(activeCycleKey);
  document.getElementById('mnav-prev').disabled=idx>=allKeys.length-1;
  document.getElementById('mnav-next').disabled=idx<=0||cycleRange(allKeys[idx-1]).start>cycleRange(curKey).start;
  document.getElementById('cycle-label').textContent=cycleLabel(activeCycleKey);
  document.getElementById('cycle-range').textContent=cycleRangeStr(activeCycleKey);

  // ── Balance bar ──
  const bs = cycleStats(activeCycleKey);
  const balAvail = getCycleAvailable(activeCycleKey);
  const balPct = bs.income > 0 ? Math.min(100, Math.max(0, (balAvail / bs.income) * 100)) : 0;
  const balColor = balPct > 40 ? 'var(--green)' : balPct > 15 ? 'var(--accent)' : 'var(--red)';
  const amtEl = document.getElementById('fbb-amount');
  const fillEl = document.getElementById('fbb-fill');
  if(amtEl){
    amtEl.textContent = c$(Math.max(0, balAvail));
    amtEl.style.color = balColor;
  }
  if(fillEl){ fillEl.style.width = balPct+'%'; fillEl.style.background = balColor; }
  const incEl=document.getElementById('fbb-income');
  const expEl=document.getElementById('fbb-expense');
  const savEl=document.getElementById('fbb-savings');
  if(incEl) incEl.textContent = c$(bs.income);
  if(expEl) expEl.textContent = c$(bs.expense);
  if(savEl) savEl.textContent = c$(bs.savings);

  renderBudgets(); renderFilterChips();

  let txs=[...cycleTxs(activeCycleKey)];
  // When searching, expand to ALL transactions across all stored cycles
  if(searchQuery){
    txs=[...transactions];
  }
  if(searchQuery) txs=txs.filter(t=>(t.label+' '+(t.note||'')+' '+(t.savingsGoal||'')).toLowerCase().includes(searchQuery));
  if(activeFilter==='income')    txs=txs.filter(t=>t.type==='income');
  else if(activeFilter==='expense')  txs=txs.filter(t=>t.type==='expense');
  else if(activeFilter==='savings')  txs=txs.filter(t=>t.type==='savings');
  else if(activeFilter==='recurring') txs=txs.filter(t=>t.recurring);

  const grouped={};
  txs.forEach(t=>{(grouped[t.date]||(grouped[t.date]=[])).push(t);});
  const dates=Object.keys(grouped).sort((a,b)=>b.localeCompare(a));
  // Show "Searching all cycles" badge when global search active
  const feedList=document.getElementById('feed-list');
  const searchBanner=document.getElementById('search-all-banner');
  if(searchQuery){
    if(!searchBanner){
      const b=document.createElement('div');
      b.id='search-all-banner';
      b.style.cssText='margin:0 20px 8px;padding:7px 12px;background:var(--blue-dim);border:1px solid var(--blue);border-radius:10px;font-size:.72rem;color:var(--blue);font-weight:700;display:flex;align-items:center;gap:6px;';
      b.innerHTML=`🌐 <span id="search-all-count"></span>`;
      feedList.parentElement.insertBefore(b, feedList);
    }
    document.getElementById('search-all-count').textContent=`Searching all cycles · ${txs.length} result${txs.length!==1?'s':''}`;
  } else if(searchBanner){ searchBanner.remove(); }

  const list=feedList;

  if(!dates.length){
    list.innerHTML=`<div class="empty"><div class="empty-icon">${searchQuery?'🔍':'📭'}</div>
      <div class="empty-txt">${searchQuery?`No results for "<strong>${searchQuery}</strong>"<br/><span style="font-size:.72rem;color:var(--text3);">Searched all cycles</span>`:`Nothing logged yet for<br/><strong>${cycleLabel(activeCycleKey)}</strong>.<br/>Tap + to add your first entry!`}</div></div>`;
    return;
  }

  list.innerHTML = dates.map(date=>{
    const dt=grouped[date];
    const dn=dt.reduce((s,t)=>s+(t.type==='income'?t.amount:-t.amount),0);
    return `<div class="date-group">
      <div class="date-hdr">
        <span class="date-hdr-label">${formatDate(date)}</span>
        <span class="date-hdr-line"></span>
        <span class="date-hdr-total" style="color:${dn>=0?'var(--green)':'var(--red)'}">${dn>=0?'+':'-'}${currencySymbol}${fmt(Math.abs(dn),0)}</span>
      </div>
      ${dt.map(tx=>renderTxCard(tx)).join('')}
    </div>`;
  }).join('');
  list.querySelectorAll('.tx[data-id]').forEach(el=>{ /* tap-to-expand only */ });
}

function renderTxCard(tx){
  const isOpen=expandedTx===tx.id, isDel=deleteConfirm===tx.id;
  const glowC=tx.type==='income'?'var(--green-dim)':tx.type==='savings'?'var(--accent-dim)':tx.type==='credit_payment'?'#a855f718':'var(--red-dim)';
  const amtC=tx.type==='income'?'var(--green)':tx.type==='savings'?'var(--accent)':tx.type==='credit_payment'?'#a855f7':'var(--red)';
  const sign=tx.type==='income'?'+':'-';
  // Credit card tag
  let ccTag='';
  if(tx.creditCardId){
    const card=creditCards.find(c=>c.id===tx.creditCardId);
    if(card) ccTag=`<span class="cc-tag">💳 ${card.name}</span>`;
  }
  if(tx.type==='credit_payment'){
    const card=creditCards.find(c=>c.id===tx.creditCardId);
    ccTag=`<span class="cc-tag">💳 ${card?card.name:'Card'} Payment</span>`;
  }
  let actions='';
  if(isOpen) actions=`<div class="tx-actions"><button class="act act-edit" onclick="openSheet(getTx(${tx.id}))">✏️ Edit</button><button class="act act-del" onclick="deleteTx(${tx.id})">🗑 Delete</button></div>`;
  return `<div class="tx-wrap" data-id="${tx.id}">
    <div class="tx-swipe-bg">🗑</div>
    <div class="tx ${isOpen?'open':''}" data-id="${tx.id}" onclick="toggleTx(${tx.id})">
      <div class="tx-glow" style="background:radial-gradient(circle,${glowC},transparent 70%)"></div>
      <div class="tx-icon ${tx.type==='credit_payment'?'expense':tx.type}">${tx.icon}</div>
      <div class="tx-body">
        <div class="tx-name">${tx.recurring?'<span class="recur-dot"></span>':''} ${tx.label}${tx.savingsGoal?`<span class="goal-tag">🎯 ${tx.savingsGoal}</span>`:''}${ccTag}</div>
        ${tx.note?`<div class="tx-note">${tx.note}</div>`:''}
      </div>
      <div class="tx-right">
        <div class="tx-amt" style="color:${amtC}">${sign}${currencySymbol}${fmt(tx.amount)}</div>
        ${tx.recurring?`<div class="tx-recur-tag">🔄 ${tx.recurFreq==='monthly'?'monthly':'weekly'}</div>`:''}
      </div>
    </div>
    ${actions}
  </div>`;
}

function getTx(id){ return transactions.find(t=>t.id===id); }
function toggleTx(id){
  if(deleteConfirm) return;
  expandedTx = expandedTx===id ? null : id;
  // Update only the affected card for performance
  const wrap=document.querySelector(`.tx-wrap[data-id="${id}"]`);
  if(wrap){ const tx=getTx(id); if(tx){ wrap.outerHTML=renderTxCard(tx); return; } }
  renderFeed();
}
function setDel(id){
  deleteConfirm=id;
  // Update only the affected card for performance
  if(id){
    const wrap=document.querySelector(`.tx-wrap[data-id="${id}"]`);
    if(wrap){ const tx=getTx(id); if(tx){ wrap.outerHTML=renderTxCard(tx); return; } }
  } else {
    // Cancel — find any card in delete state and re-render it
    const prev=document.querySelector('.tx-wrap .act-confirm');
    if(prev){ const wrap=prev.closest('.tx-wrap'); if(wrap){ const tx=getTx(parseInt(wrap.dataset.id)); if(tx){ wrap.outerHTML=renderTxCard(tx); return; } } }
  }
  renderFeed();
}
function setCycle(ck){ 
  activeCycleKey=ck; expandedTx=null; deleteConfirm=null; 
  if(ck===currentCycleKey()) autoGenerateRecurring();
  renderFeed(); 
}

function shiftCycle(dir){
  const all=allCycleKeys(), idx=all.indexOf(activeCycleKey);
  const nidx=idx-dir;
  if(nidx>=0&&nidx<all.length&&cycleRange(all[nidx]).start<=cycleRange(currentCycleKey()).start){ setCycle(all[nidx]); return; }
  if(dir===-1){ const p=shiftKey(activeCycleKey,-1); if(cycleRange(p).start>='2020-01-01') setCycle(p); }
}



// ════════════════════════════════════════════════════════════
//  RENDER DASHBOARD
// ════════════════════════════════════════════════════════════
function renderDash(){
  const dash=document.getElementById('dash-content');
  const curKey=currentCycleKey();
  const now=new Date();

  // ── Update hero (now lives on dashboard) ──
  const s=cycleStats(activeCycleKey);
  const isCur=activeCycleKey===curKey;
  document.getElementById('dash-date-label').textContent=`${SHORT_M[now.getMonth()]} ${now.getDate()}, ${now.getFullYear()}`;
  document.getElementById('dash-cycle-label').textContent=cycleLabel(activeCycleKey);
  document.getElementById('dash-cycle-range').textContent=cycleRangeStr(activeCycleKey);
  const allKeys=allCycleKeys(), idx=allKeys.indexOf(activeCycleKey);
  const dashPrev=document.getElementById('dash-mnav-prev'), dashNext=document.getElementById('dash-mnav-next');
  if(dashPrev) dashPrev.disabled=idx>=allKeys.length-1;
  if(dashNext) dashNext.disabled=idx<=0||cycleRange(allKeys[idx-1]).start>cycleRange(curKey).start;
  document.getElementById('hero-label').textContent=isCur?'Remaining this cycle':`Total for ${cycleLabel(activeCycleKey,true)}`;
  document.getElementById('hero-sign').textContent=currencySymbol;
  document.getElementById('hero-net-val').textContent=fmt(s.net,0);
  document.getElementById('hero-net').style.color=s.net>=0?'var(--green)':'var(--red)';
  document.getElementById('hero-income').textContent=c$(s.income);
  document.getElementById('hero-expense').textContent=c$(s.expense);
  document.getElementById('hero-savings').textContent=c$(s.savings);
  const streak=calcStreak();
  document.getElementById('dash-streak-area').innerHTML=streak>=2?`<div class="streak-badge">🔥 ${streak}-day streak</div>`:'';
  renderProjection();

  if(!transactions.length){
    dash.innerHTML=`<div class="empty" style="padding-top:80px;"><div class="empty-icon">📊</div><div class="empty-txt">No data yet.<br/>Add transactions first!</div></div>`;
    return;
  }

  const prevKey=shiftKey(curKey,-1);
  const curS=cycleStats(curKey), prevS=cycleStats(prevKey);

  // ── Collect only cycles that have actual transaction data ──
  const dataKeys=allCycleKeys().filter(ck=>{
    const {start,end}=cycleRange(ck);
    return transactions.some(t=>t.date>=start&&t.date<=end);
  });
  // For trend: up to 12, sorted oldest→newest
  const trendKeys=dataKeys.slice().sort((a,b)=>cycleRange(a).start.localeCompare(cycleRange(b).start)).slice(-12);
  const trendData=trendKeys.map(ck=>({ck,...cycleStats(ck)}));

  // ── HIGHLIGHTS row (horizontal scroll cards) ──
  const nonEmpty=trendData.filter(d=>d.income>0||d.expense>0||d.savings>0);
  let hlHtml='';
  if(nonEmpty.length>=1){
    const best    =[...nonEmpty].sort((a,b)=>b.savings-a.savings)[0];
    const lowest  =[...nonEmpty].filter(d=>d.expense>0).sort((a,b)=>a.expense-b.expense)[0]||nonEmpty[0];
    const topInc  =[...nonEmpty].sort((a,b)=>b.income-a.income)[0];
    const bestRate=[...nonEmpty].filter(d=>d.income>0).sort((a,b)=>b.rate-a.rate)[0]||nonEmpty[0];
    const avgIncome =nonEmpty.reduce((s,d)=>s+d.income,0)/nonEmpty.length;
    const avgExpense=nonEmpty.reduce((s,d)=>s+d.expense,0)/nonEmpty.length;
    const avgSavings=nonEmpty.reduce((s,d)=>s+d.savings,0)/nonEmpty.length;
    hlHtml=`<div class="section">
      <div class="section-title">🏆 Highlights</div>
      <div class="section-sub">Personal bests · ${nonEmpty.length} cycle${nonEmpty.length!==1?'s':''} with data</div>
      <div class="hl-row">
        ${[
          {icon:'🏆',label:'Best Savings',val:fmtS(best.savings),          sub:cycleLabel(best.ck,true),       c:'var(--accent)'},
          {icon:'📈',label:'Best Income', val:fmtS(topInc.income),          sub:cycleLabel(topInc.ck,true),     c:'var(--green)'},
          {icon:'🎯',label:'Low Spend',   val:fmtS(lowest.expense),         sub:cycleLabel(lowest.ck,true),     c:'var(--blue)'},
          {icon:'💡',label:'Best Rate',   val:bestRate.rate.toFixed(0)+'%', sub:cycleLabel(bestRate.ck,true),   c:'var(--accent)'},
        ].map(h=>`<div class="hl-mini">
          <div class="hl-mini-icon">${h.icon}</div>
          <div class="hl-mini-label">${h.label}</div>
          <div class="hl-mini-val" style="color:${h.c}">${h.val}</div>
          <div class="hl-mini-sub">${h.sub}</div>
        </div>`).join('')}
      </div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-top:8px;">
        ${[
          {l:'Avg Income',v:avgIncome, c:'var(--green)'},
          {l:'Avg Spent', v:avgExpense,c:'var(--red)'},
          {l:'Avg Saved', v:avgSavings,c:'var(--accent)'},
        ].map(a=>`<div style="background:var(--bg2);border-radius:10px;padding:8px 6px;text-align:center;">
          <div style="font-size:.54rem;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);font-weight:700;margin-bottom:3px;">${a.l}</div>
          <div style="font-family:'Playfair Display',serif;font-size:.85rem;font-weight:700;color:${a.c};">${fmtS(a.v)}</div>
        </div>`).join('')}
      </div>
    </div>`;
  }

  // ── CREDIT CARDS — horizontal pill scroll (same style as feed) ──
  let creditHtml='';
  if(creditCards.length){
    const totalUsed =creditCards.reduce((s,c)=>s+getCardInfo(c.id).used,0);
    const totalLimit=creditCards.reduce((s,c)=>s+c.limit,0);
    const totalPct  =totalLimit>0?Math.min((totalUsed/totalLimit)*100,100):0;
    const totalColor=totalPct>=90?'var(--red)':totalPct>=70?'var(--accent)':'var(--green)';
    const pills=creditCards.map(c=>{
      const info=getCardInfo(c.id);
      const col=info.pct>=90?'var(--red)':info.pct>=70?'var(--accent)':'var(--blue)';
      const hasDebt=info.used>0;
      return `<div onclick="openPayModal('${c.id}')" style="flex-shrink:0;min-width:140px;background:var(--bg2);border:1.5px solid ${hasDebt?col:'var(--border)'};border-radius:14px;padding:10px 12px;cursor:pointer;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
          <span style="font-size:.72rem;font-weight:700;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:85px;">💳 ${c.name}</span>
          <span style="font-size:.58rem;font-weight:700;padding:2px 6px;border-radius:5px;background:${hasDebt?col+'20':'var(--green-dim)'};color:${hasDebt?col:'var(--green)'};">${hasDebt?'Pay':'✓ Clear'}</span>
        </div>
        <div style="height:3px;background:var(--bg3);border-radius:99px;overflow:hidden;margin-bottom:5px;">
          <div style="height:100%;width:${info.pct}%;background:${col};border-radius:99px;"></div>
        </div>
        <div style="display:flex;justify-content:space-between;font-size:.62rem;">
          <span style="color:${col};font-weight:700;">${fmtS(info.used)} used</span>
          <span style="color:var(--text3);">${fmtS(info.available)} left</span>
        </div>
      </div>`;
    }).join('');
    creditHtml=`<div class="section">
      <div style="display:flex;align-items:baseline;justify-content:space-between;margin-bottom:4px;">
        <div class="section-title" style="margin-bottom:0;">💳 Credit Cards</div>
        <div style="font-size:.65rem;color:${totalColor};font-weight:700;">${Math.round(totalPct)}% used · ${totalPct<30?'Healthy':totalPct<70?'Moderate':'High'}</div>
      </div>
      <div class="section-sub" style="margin-bottom:8px;">${fmtS(totalUsed)} of ${fmtS(totalLimit)} limit</div>
      <div style="display:flex;gap:8px;overflow-x:auto;scrollbar-width:none;padding-bottom:2px;-webkit-overflow-scrolling:touch;">${pills}</div>
    </div>`;
  }

  // ── LAST vs THIS — compact pill comparison ──
  const sbsRows2=[
    {label:'Income', cur:curS.income,  prev:prevS.income,  col:'var(--green)',  low:false},
    {label:'Spent',  cur:curS.expense, prev:prevS.expense, col:'var(--red)',    low:true},
    {label:'Saved',  cur:curS.savings, prev:prevS.savings, col:'var(--accent)', low:false},
    {label:'Rate',   cur:curS.rate,    prev:prevS.rate,    col:'var(--blue)',   low:false, isPct:true},
    {label:'Left',   cur:curS.net,     prev:prevS.net,     col:curS.net>=0?'var(--green)':'var(--red)', isNet:true},
  ];
  const fmtV2=(v,r)=>r.isPct?v.toFixed(0)+'%':r.isNet?(v<0?'–':'')+fmtS(Math.abs(v)):fmtS(v);
  const arrow=(cur,prev,low=false)=>{ const d=cur-prev; if(!d) return ''; const good=low?d<0:d>0; return `<span style="color:${good?'var(--green)':'var(--red)'};">${d>0?'↑':'↓'}</span>`; };
  const sbsHtml=`<div class="section">
    <div style="display:flex;align-items:baseline;justify-content:space-between;margin-bottom:2px;">
      <div class="section-title" style="margin-bottom:0;">Last vs This</div>
      <div style="font-size:.65rem;color:var(--text3);">${cycleLabel(prevKey,true)} → <span style="color:var(--accent);">${cycleLabel(curKey,true)}</span></div>
    </div>
    <div class="section-sub" style="margin-bottom:8px;">How this cycle compares</div>
    <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:5px;">
      ${sbsRows2.map(r=>`<div style="background:var(--bg2);border-radius:10px;padding:8px 5px;text-align:center;">
        <div style="font-size:.54rem;text-transform:uppercase;letter-spacing:.4px;color:var(--text3);font-weight:700;margin-bottom:3px;">${r.label}</div>
        <div style="font-family:'Playfair Display',serif;font-size:.75rem;font-weight:700;color:${r.col};line-height:1.2;">${fmtV2(r.cur,r)} ${arrow(r.cur,r.prev,r.low)}</div>
        <div style="font-size:.58rem;color:var(--text3);margin-top:2px;">${fmtV2(r.prev,r)}</div>
      </div>`).join('')}
    </div>
  </div>`;

  // ── SAVINGS RING (compact) ──
  const rate=Math.min(curS.rate,100), r2=34, circ2=2*Math.PI*r2;
  const ringHtml=`<div class="section">
    <div class="section-title">Savings Rate</div>
    <div class="section-sub">${cycleLabel(curKey,true)} · ${c$(curS.savings)} of ${c$(curS.income)}</div>
    <div class="ring-card">
      <svg width="84" height="84" viewBox="0 0 100 100" style="flex-shrink:0;">
        <circle cx="50" cy="50" r="${r2}" fill="none" stroke="var(--bg3)" stroke-width="10"/>
        <circle cx="50" cy="50" r="${r2}" fill="none" stroke="var(--accent)" stroke-width="10"
          stroke-dasharray="${circ2*(rate/100)} ${circ2}" stroke-dashoffset="${circ2/4}" stroke-linecap="round"/>
        <text x="50" y="50" text-anchor="middle" dominant-baseline="central"
          style="font-family:'Playfair Display',serif;font-size:15px;font-weight:900;fill:var(--accent)">${Math.round(rate)}%</text>
      </svg>
      <div>
        <div class="ring-label">Saved this cycle</div>
        <div class="ring-pct" style="color:var(--accent);font-size:1.3rem;">${curS.rate.toFixed(1)}%</div>
        <div class="ring-sub">${c$(curS.savings)} saved<br/>${c$(curS.income)} earned</div>
      </div>
    </div>
  </div>`;

  // ── SAVINGS GOALS ──
  const gData=goalsData();
  let goalsHtml='';
  if(gData.length){
    const topTotal=gData[0].total||1;
    const rows=gData.map((g,i)=>{
      const barPct=Math.round((g.total/topTotal)*100);
      const medals=['🥇','🥈','🥉'];
      const rank=i<3?medals[i]:`${i+1}`;
      const target=goalTargets[g.name.toLowerCase()]||0;
      const targetPct=target>0?Math.min(Math.round((g.total/target)*100),100):0;
      const targetBar=target>0?`<div style="margin-top:5px;">
        <div style="display:flex;justify-content:space-between;font-size:.6rem;color:var(--text3);margin-bottom:2px;">
          <span>Target: ${c$(target)}</span><span style="color:${targetPct>=100?'var(--green)':'var(--accent)'};">${targetPct}%</span>
        </div>
        <div style="height:4px;background:var(--bg3);border-radius:99px;overflow:hidden;">
          <div style="height:100%;width:${targetPct}%;background:${targetPct>=100?'var(--green)':'var(--accent)'};border-radius:99px;transition:width .6s;"></div>
        </div>
        ${targetPct>=100?'<div style="font-size:.6rem;color:var(--green);font-weight:700;margin-top:2px;">🎉 Goal reached!</div>':''}
      </div>`:'';
      const metaLine = g.count>0
        ? `${g.count} deposit${g.count!==1?'s':''} · last ${formatDate(g.last)}`
        : `<span style="color:var(--text3);font-style:italic;">No deposits yet — start saving!</span>`;
      return `<div class="goal-card">
        <div class="goal-card-rank">${rank}</div>
        <div class="goal-card-body">
          <div class="goal-card-name">🎯 ${g.name}</div>
          <div class="goal-card-meta">${metaLine}</div>
          <div class="goal-bar-track"><div class="goal-bar-fill" style="width:${barPct}%"></div></div>
          ${targetBar}
        </div>
        <div class="goal-card-amt">${g.total>0?c$(g.total):`<span style="color:var(--text3);font-size:.8rem;">${c$(0)}</span>`}</div>
      </div>`;
    }).join('');
    const grandTotal=gData.reduce((s,g)=>s+g.total,0);
    const totalGoalsWithTarget=gData.filter(g=>goalTargets[g.name.toLowerCase()]>0).length;
    goalsHtml=`<div class="section">
      <div class="section-title">🎯 Savings Goals</div>
      <div class="section-sub">All-time · ${gData.length} goal${gData.length!==1?'s':''}${grandTotal>0?' · '+c$(grandTotal)+' total':''}</div>
      <div class="goals-grid">${rows}</div>
    </div>`;
  }

  // ── DONUT ──
  const expTxs=cycleTxs(curKey).filter(t=>t.type==='expense');
  const catSpend={};
  expTxs.forEach(t=>{catSpend[t.category]=(catSpend[t.category]||0)+t.amount;});
  const totalSpend=Object.values(catSpend).reduce((a,b)=>a+b,0)||1;
  const catEntries=Object.entries(catSpend).sort((a,b)=>b[1]-a[1]).slice(0,8);
  let donutHtml='';
  if(catEntries.length){
    const r=40,cx=50,cy=50; let off=0; const circ=2*Math.PI*r;
    const paths=catEntries.map(([k,v],i)=>{ const d=circ*(v/totalSpend),g=circ-d; const p=`<circle cx="${cx}" cy="${cy}" r="${r}" fill="none" stroke="${DONUT_COLORS[i]}" stroke-width="18" stroke-dasharray="${d} ${g}" stroke-dashoffset="${-off}" transform="rotate(-90 ${cx} ${cy})" opacity=".85"/>`; off+=d; return p; }).join('');
    const catMap=Object.fromEntries(CATS.map(c=>[c.k,c]));
    const items=catEntries.slice(0,5).map(([k,v],i)=>`
      <div class="donut-item"><div class="donut-dot" style="background:${DONUT_COLORS[i]}"></div>
        <span class="donut-name">${catMap[k]?.i||''} ${catMap[k]?.l||k}</span>
        <span class="donut-val" style="color:${DONUT_COLORS[i]}">${fmtS(v)}</span>
        <span class="donut-pct">${Math.round((v/totalSpend)*100)}%</span>
      </div>`).join('');
    donutHtml=`<div class="section">
      <div class="section-title">Spending Breakdown</div>
      <div class="section-sub">${cycleLabel(curKey,true)} · Where the money went</div>
      <div class="donut-card">
        <div class="donut-row">
          <svg width="88" height="88" viewBox="0 0 100 100" style="flex-shrink:0;">
            <circle cx="50" cy="50" r="40" fill="none" stroke="var(--bg3)" stroke-width="18"/>
            ${paths}
            <text x="50" y="50" text-anchor="middle" dominant-baseline="central" style="font-family:'Playfair Display',serif;font-size:10px;font-weight:900;fill:var(--red)">${fmtS(totalSpend)}</text>
          </svg>
          <div class="donut-legend">${items}</div>
        </div>
      </div>
    </div>`;
  }

  // ── TREND ──
  const metricColor={income:'var(--green)',expense:'var(--red)',savings:'var(--accent)',net:'var(--blue)'};
  const metricClass={income:'mt-inc',expense:'mt-exp',savings:'mt-sav',net:'mt-net'};
  const maxVal=Math.max(...trendData.map(d=>Math.abs(d[dashMetric])),1);
  const barsHtml=trendData.length?trendData.map(d=>{
    const val=d[dashMetric], pct=Math.max((Math.abs(val)/maxVal)*100,3);
    const col=metricColor[dashMetric], isCur=d.ck===curKey;
    return `<div class="bar-col ${isCur?'is-cur':''}">
      <div class="bar-col-val" style="color:${isCur?'var(--accent)':col}">${fmtS(val)}</div>
      <div class="bar-col-track"><div class="bar-rect" style="height:${pct}%;background:${isCur?'var(--accent)':col};opacity:${isCur?1:.7};${isCur?'box-shadow:0 0 8px var(--accent-dim)':''}"></div></div>
      <div class="bar-col-name" style="color:${isCur?'var(--accent)':col};opacity:${isCur?1:.65};">${cycleLabel(d.ck,true).split(' ')[0]}</div>
    </div>`;
  }).join(''):'<div style="color:var(--text3);font-size:.8rem;padding:20px;text-align:center;">Log more cycles to see the trend</div>';
  const trendHtml=`<div class="section">
    <div class="section-title">${trendData.length}-Cycle Trend</div>
    <div class="section-sub">Only cycles with data · <span style="color:var(--accent)">★ current</span></div>
    <div class="metric-tabs">
      ${[{k:'income',l:'💼 Income'},{k:'expense',l:'💸 Spent'},{k:'savings',l:'🏦 Saved'},{k:'net',l:'📊 Net'}]
        .map(m=>`<button class="metric-tab ${dashMetric===m.k?metricClass[m.k]:''}" onclick="setMetric('${m.k}')">${m.l}</button>`).join('')}
    </div>
    <div class="chart-card"><div class="bars">${barsHtml}</div></div>
  </div>`;

  dash.innerHTML=`<div style="height:8px;"></div>
  ${creditHtml}
  ${hlHtml}
  ${sbsHtml}
  ${ringHtml}
  ${goalsHtml}
  ${donutHtml}
  ${trendHtml}
  <div style="height:20px;"></div>`;
}

// ════════════════════════════════════════════════════════════
//  SETTINGS RENDER
// ════════════════════════════════════════════════════════════
function setMetric(m){ dashMetric=m; renderDash(); }
function renderSettings(){
  renderSettingsInputs();
  renderSettingsCCList();
  document.getElementById('cycle-limit-input').value = cycleLimit;
  // Backup interval
  const bii=document.getElementById('backup-interval-input');
  if(bii) bii.value=getBackupInterval();
  updateLastBackupLabel();
  const cycleKeys=[...new Set(transactions.map(t=>getCycleKey(t.date)))];
  const cycleCount=cycleKeys.length;
  const recur=transactions.filter(t=>t.recurring).length;
  const size=new Blob([JSON.stringify(transactions)]).size;
  const limitNote = cycleCount >= cycleLimit
    ? `<span style="color:var(--accent)">⚠️ At limit (${cycleLimit})</span>`
    : `<span style="color:var(--text3)">${cycleCount}/${cycleLimit}</span>`;
  document.getElementById('settings-stats').innerHTML=
    `📊 <strong>${transactions.length}</strong> transactions<br/>
     🔄 <strong>${recur}</strong> recurring<br/>
     📅 <strong>${cycleCount}</strong> cycles stored ${limitNote}<br/>
     💾 <strong>${(size/1024).toFixed(1)} KB</strong> stored in browser`;
  // PIN card
  const pinBtns=document.getElementById('pin-settings-btns');
  if(pinBtns){
    if(pinHash){
      pinBtns.innerHTML=`<div style="display:flex;gap:8px;">
        <button class="settings-btn btn-blue" style="flex:1;margin:0;" onclick="openPinSetup(()=>renderSettings())">🔄 Change PIN</button>
        <button class="settings-btn btn-red" style="flex:1;margin:0;" onclick="removePin()">🔓 Remove PIN</button>
      </div>`;
      document.getElementById('pin-settings-desc').textContent='PIN is active. Your data is protected on app open.';
    } else {
      pinBtns.innerHTML=`<button class="settings-btn btn-blue" onclick="openPinSetup(()=>renderSettings())">🔐 Set PIN Lock</button>`;
      document.getElementById('pin-settings-desc').textContent='No PIN set. Add a 4-digit PIN to protect your data.';
    }
  }
}
function saveCurrency(){
  const v=document.getElementById('currency-input').value.trim(); if(!v)return;
  currencySymbol=v; persist(); showSettingsToast('💱 Currency updated!'); renderFeed();
}
function saveCycleLimit(){
  const raw = parseInt(document.getElementById('cycle-limit-input').value);
  const val = Math.max(3, Math.min(60, isNaN(raw)?24:raw));
  document.getElementById('cycle-limit-input').value = val;
  cycleLimit = val;
  const removed = enforceCycleLimit();
  persist();
  activeCycleKey = currentCycleKey();
  renderSettings(); renderFeed();
  if(removed > 0){
    showSettingsToast(`🗂 Limit set to ${val} cycles · ${removed} old transaction${removed!==1?'s':''} removed`);
  } else {
    showSettingsToast(`🗂 Cycle history limited to ${val} cycles`);
  }
}

// ════════════════════════════════════════════════════════════
//  EXPORT / IMPORT — saves EVERYTHING
// ════════════════════════════════════════════════════════════
function exportData(){
  const data={
    version:8, exportedAt:new Date().toISOString(),
    transactions, budgets, currencySymbol, activeTheme,
    cycleMode, cycleConfig, cycleLimit, creditCards, goalTargets,
    pinHash: pinHash || '',
    defaultGoal: localStorage.getItem('ledger_defaultGoal') || ''
  };
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  const dateStr=new Date().toISOString().slice(0,10);
  a.href=url; a.download=`spendoodle-backup-${dateStr}.json`; a.click();
  URL.revokeObjectURL(url);
  // Stamp last backup time
  localStorage.setItem('ledger_lastBackup', Date.now().toString());
  updateLastBackupLabel();
  showSettingsToast('📤 Full backup exported!');
}
function exportCSV(){
  const headers=['Date','Label','Type','Category','Amount','Currency','Note','Recurring','Savings Goal','Cycle'];
  const rows=transactions.map(t=>{
    const ck=getCycleKey(t.date);
    return [
      t.date,
      `"${(t.label||'').replace(/"/g,'""')}"`,
      t.type,
      t.category||'',
      t.amount,
      currencySymbol,
      `"${(t.note||'').replace(/"/g,'""')}"`,
      t.recurring?'yes':'no',
      `"${(t.savingsGoal||'').replace(/"/g,'""')}"`,
      cycleLabel(ck,true)
    ].join(',');
  });
  const csv=[headers.join(','),...rows].join('\n');
  const blob=new Blob([csv],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  const dateStr=new Date().toISOString().slice(0,10);
  a.href=url; a.download=`spendoodle-transactions-${dateStr}.csv`; a.click();
  URL.revokeObjectURL(url);
  showSettingsToast('📊 CSV exported!');
}
function importData(e){
  const file=e.target.files[0]; if(!file)return;
  const reader=new FileReader();
  reader.onload=ev=>{
    try{
      const data=JSON.parse(ev.target.result);
      let imported=[];
      if(Array.isArray(data)) imported=data;
      else if(data.transactions&&Array.isArray(data.transactions)) imported=data.transactions;
      else throw new Error('bad');
      // ── Merge settings (don't overwrite if local has value) ──
      if(data.budgets&&typeof data.budgets==='object')
        budgets={...data.budgets,...budgets}; // local takes priority on overlap
      if(data.currencySymbol) currencySymbol=data.currencySymbol;
      if(data.activeTheme)    { activeTheme=data.activeTheme; setTheme(activeTheme); }
      if(data.cycleMode)      cycleMode=data.cycleMode;
      if(data.cycleConfig)    cycleConfig={...cycleConfig,...data.cycleConfig};
      if(data.cycleLimit)     cycleLimit=Math.max(3,parseInt(data.cycleLimit)||24);
      // Merge credit cards by ID — don't duplicate
      if(data.creditCards&&Array.isArray(data.creditCards)){
        const existingCCIds=new Set(creditCards.map(c=>c.id));
        const newCCs=data.creditCards.filter(c=>c.id&&!existingCCIds.has(c.id));
        creditCards=[...creditCards,...newCCs];
      }
      // Merge goal targets — local takes priority on overlap
      if(data.goalTargets&&typeof data.goalTargets==='object')
        goalTargets={...data.goalTargets,...goalTargets};
      if(data.pinHash!==undefined&&!pinHash){ pinHash=data.pinHash; if(pinHash) localStorage.setItem('ledger_pin',pinHash); }
      if(data.defaultGoal&&!localStorage.getItem('ledger_defaultGoal'))
        localStorage.setItem('ledger_defaultGoal', data.defaultGoal);
      // ── Merge transactions by ID — no duplicates ──
      const existing=new Set(transactions.map(t=>t.id));
      const newOnes=imported.filter(t=>t.id&&t.date&&t.amount&&!existing.has(t.id));
      transactions=[...transactions,...newOnes];
      transactions.sort((a,b)=>b.date.localeCompare(a.date)||b.id-a.id);
      persist(); activeCycleKey=currentCycleKey();
      renderSettings(); renderFeed(); renderDash();
      showSettingsToast(`✅ Merged ${newOnes.length} new transaction${newOnes.length!==1?'s':''}!`);
    }catch{
      document.getElementById('settings-err').style.display='block';
      setTimeout(()=>document.getElementById('settings-err').style.display='none',3500);
    }
    e.target.value='';
  };
  reader.readAsText(file);
}

// ════════════════════════════════════════════════════════════
//  BACKUP REMINDER
// ════════════════════════════════════════════════════════════
function getBackupInterval(){
  return Math.max(1, parseInt(localStorage.getItem('ledger_backupInterval')||'30'));
}
function saveBackupInterval(val){
  const days=Math.max(1,Math.min(365,parseInt(val)||30));
  localStorage.setItem('ledger_backupInterval', days.toString());
  const inp=document.getElementById('backup-interval-input');
  if(inp) inp.value=days;
  showSettingsToast(`🔔 Backup reminder set to every ${days} days`);
}
function updateLastBackupLabel(){
  const el=document.getElementById('last-backup-label');
  if(!el) return;
  const last=localStorage.getItem('ledger_lastBackup');
  if(!last){ el.textContent='⚠️ No backup recorded yet'; return; }
  const days=Math.floor((Date.now()-parseInt(last))/(86400000));
  el.textContent = days===0 ? '✅ Last backup: today' : `📅 Last backup: ${days} day${days!==1?'s':''} ago`;
}
function checkBackupReminder(){
  // Don't nag on first use (no transactions yet)
  if(!transactions.length) return;
  const interval=getBackupInterval();
  const last=parseInt(localStorage.getItem('ledger_lastBackup')||'0');
  const snoozed=parseInt(localStorage.getItem('ledger_backupSnoozed')||'0');
  const now=Date.now();
  // Check snooze (1 day)
  if(snoozed && now - snoozed < 86400000) return;
  const daysSince=last ? Math.floor((now-last)/86400000) : Infinity;
  if(daysSince >= interval){
    // Delay slightly so app renders first
    setTimeout(()=>openBackupReminder(daysSince), 1500);
  }
}
function openBackupReminder(days){
  const msg=document.getElementById('backup-msg');
  if(msg){
    if(days===Infinity)
      msg.textContent="You haven't backed up yet! Download a copy to keep your data safe in case you clear your browser or switch devices.";
    else
      msg.textContent=`It's been ${days} day${days!==1?'s':''} since your last backup. Download a copy to keep your data safe.`;
  }
  document.getElementById('backup-overlay').classList.add('open');
}
function dismissBackupReminder(e){
  if(e&&e.target!==document.getElementById('backup-overlay')) return;
  document.getElementById('backup-overlay').classList.remove('open');
}
function snoozeBackup(){
  localStorage.setItem('ledger_backupSnoozed', Date.now().toString());
  document.getElementById('backup-overlay').classList.remove('open');
}
function backupNow(){
  document.getElementById('backup-overlay').classList.remove('open');
  exportData();
}
function clearAllData(){
  showConfirm({
    icon:'🗑',
    title:'Delete Everything?',
    msg:'All transactions, budgets, credit cards and settings will be permanently deleted. Export a backup first!',
    okLabel:'Delete Everything',
    onOk:()=>{
      transactions=[]; budgets={}; creditCards=[]; goalTargets={};
      persist(); activeCycleKey=currentCycleKey();
      renderSettings(); renderFeed();
      showSettingsToast('🗑 All data cleared.');
    }
  });
}
function showSettingsToast(msg){
  const t=document.getElementById('settings-toast');
  t.textContent=msg; t.style.display='flex';
  setTimeout(()=>t.style.display='none',3000);
}

// ════════════════════════════════════════════════════════════
//  ONBOARDING — 5 slides: Welcome · Theme · Pay Cycle · History+Goal · Done
// ════════════════════════════════════════════════════════════
const OB_TOTAL = 6;
let obPage = 0;
let gCycleMode = cycleMode;
let gLimitVal  = cycleLimit;

function obOpen(){
  obPage = 0;
  obRender();
  gSyncGuideState();
  document.getElementById('ob-overlay').classList.add('active');
}
function obClose(){
  document.getElementById('ob-overlay').classList.remove('active');
  localStorage.setItem('ledger_onboarded','1');
}
function obNav(dir){
  if(dir > 0) obSaveCurrentPage(); // save before advancing
  obPage = Math.max(0, Math.min(OB_TOTAL-1, obPage+dir));
  obRender();
  // scroll page back to top
  const pages = document.getElementById('ob-pages');
  if(pages) pages.querySelectorAll('.ob-page')[obPage]?.scrollTo(0,0);
}
function obRender(){
  document.querySelectorAll('.ob-page').forEach((p,i)=>p.classList.toggle('active', i===obPage));
  document.getElementById('ob-dots').innerHTML=[...Array(OB_TOTAL)].map((_,i)=>
    `<div class="ob-dot ${i===obPage?'active':''}"></div>`).join('');
  document.getElementById('ob-back').style.display = obPage>0 ? 'block':'none';
  const nextBtn = document.getElementById('ob-next');
  if(obPage===OB_TOTAL-1){
    nextBtn.textContent = "Save & Finish 🎉";
    nextBtn.onclick = ()=>{ obSaveCurrentPage(); obClose(); };
  } else if(obPage===0){
    nextBtn.textContent = 'Begin Setup →';
    nextBtn.onclick = ()=>obNav(1);
  } else {
    nextBtn.textContent = 'Save & Next →';
    nextBtn.onclick = ()=>obNav(1);
  }
  document.getElementById('ob-skip').style.display = obPage===OB_TOTAL-1 ? 'none':'block';
  // Reset PIN pad when entering PIN slide
  if(obPage===5){
    _obPinBuf=''; _obPinFirst=''; _obPinStep='set';
    obUpdatePinDots();
    document.querySelectorAll('.ob-pin-key').forEach(b=>b.disabled=false);
    document.getElementById('ob-pin-set-msg').textContent='';
    if(pinHash){
      document.getElementById('ob-pin-status').textContent='✅ PIN already set — you\'re protected!';
      document.getElementById('ob-pin-set-msg').textContent='Tap keys below to change it.';
    } else {
      document.getElementById('ob-pin-status').textContent='Enter a 4-digit PIN to activate lock';
    }
  }
}

/* Save settings for the page we're leaving */
function obSaveCurrentPage(){
  switch(obPage){
    case 1: // Theme — already applied live; persist
      persist();
      break;
    case 2: // Pay Cycle
      cycleMode = gCycleMode;
      if(cycleMode==='monthly'){
        const pd = parseInt(document.getElementById('g-pay-day')?.value)||25;
        cycleConfig.monthly.payDay = Math.min(28,Math.max(1,pd));
        const si=document.getElementById('pay-day'); if(si) si.value=cycleConfig.monthly.payDay;
      } else if(cycleMode==='bimonthly'){
        const f=k=>parseInt(document.getElementById(`g-bi-${k}`)?.value)||0;
        cycleConfig.bimonthly={s1:f('s1')||25, e1:f('e1')||10, s2:f('s2')||11, e2:f('e2')||24};
        ['s1','e1','s2','e2'].forEach(k=>{const e=document.getElementById(`bi-${k}`);if(e)e.value=cycleConfig.bimonthly[k];});
      } else if(cycleMode==='weekly'){
        const dow=parseInt(document.getElementById('g-pay-dow')?.value)||1;
        cycleConfig.weekly={payDow:dow};
        const pdow=document.getElementById('pay-dow');if(pdow)pdow.value=dow;
      } else {
        const st=parseInt(document.getElementById('g-cust-start')?.value)||1;
        const ln=parseInt(document.getElementById('g-cust-len')?.value)||30;
        cycleConfig.custom={start:Math.min(28,Math.max(1,st)),len:Math.min(90,Math.max(7,ln))};
        const s2=document.getElementById('cust-start');if(s2)s2.value=cycleConfig.custom.start;
        const l2=document.getElementById('cust-len');if(l2)l2.value=cycleConfig.custom.len;
      }
      const pdS=document.getElementById('pay-day');if(pdS)pdS.value=cycleConfig.monthly.payDay;
      persist(); activeCycleKey=currentCycleKey(); renderFeed(); renderSettings();
      break;
    case 3: // History limit + Savings goal
      cycleLimit = gLimitVal;
      enforceCycleLimit();
      const li=document.getElementById('cycle-limit-input');if(li)li.value=cycleLimit;
      const raw=(document.getElementById('g-savings-goal-input')?.value||'').trim();
      const goalName = raw ? normGoal(raw) : 'Emergency Fund';
      if(raw) localStorage.setItem('ledger_defaultGoal', goalName);
      else     localStorage.setItem('ledger_defaultGoal','Emergency Fund');
      // Save target amount if provided
      const targetAmt=parseFloat(document.getElementById('g-savings-goal-target')?.value)||0;
      if(targetAmt>0) goalTargets[goalName.toLowerCase()]=targetAmt;
      persist(); activeCycleKey=currentCycleKey(); renderFeed(); renderSettings();
      break;
    case 4: // Credit Cards — already saved live when added; just persist & refresh
      persist(); renderSettingsCCList(); renderFeed(); renderCreditSection();
      break;
    case 5: // PIN — saved live via obPinKey; nothing extra needed
      break;
  }
}

/* Guide helpers */
function gSelectCycleMode(mode){
  gCycleMode = mode;
  ['monthly','bimonthly','custom','weekly'].forEach(m=>{
    const el=document.getElementById(`g-cmo-${m}`);
    if(el) el.classList.toggle('selected', m===mode);
    const f=document.getElementById(`g-fields-${m}`);
    if(f){ f.style.display = m===mode ? 'flex':'none'; f.style.flexDirection='column'; }
  });
}
function gSetTheme(t){
  setTheme(t); persist();
  ['dark','pink','white','navy','ice','forest','sunset','midnight'].forEach(n=>{
    const c=document.getElementById(`g-theme-${n}`);
    if(c) c.classList.toggle('active-g', n===t);
  });
}
function gAdjLimit(delta){
  gLimitVal = Math.min(60, Math.max(3, gLimitVal+delta));
  gUpdateLimitDisplay();
}
function gSetLimit(val){
  gLimitVal = val;
  document.querySelectorAll('.ob-limit-presets .ob-chip').forEach(b=>{
    const match = b.textContent.includes(val === 6 ? '6' : val === 12 ? '1 yr' : val === 24 ? '2' : '3');
    b.classList.toggle('ob-chip-sel', b.onclick && b.onclick.toString().includes(String(val)));
  });
  gUpdateLimitDisplay();
}
function gUpdateLimitDisplay(){
  const el=document.getElementById('g-limit-num'); if(el) el.textContent=gLimitVal;
  const hint=document.getElementById('g-limit-hint');
  if(!hint) return;
  const perYear = cycleMode==='bimonthly' ? 24 : cycleMode==='monthly' ? 12
    : cycleMode==='weekly' ? 52
    : Math.round(365/Math.max(7, cycleConfig.custom.len||30));
  const years = (gLimitVal/perYear).toFixed(1);
  hint.textContent = `≈ ${years} year${parseFloat(years)!==1?'s':''} of history — enough to spot trends and seasonal patterns.`;
}
function gPickGoal(name){
  const inp=document.getElementById('g-savings-goal-input');
  if(inp) inp.value=name;
  document.querySelectorAll('.ob-goal-chips .ob-chip').forEach(b=>{
    b.classList.toggle('ob-chip-sel', b.textContent.trim().replace(/^[^\w]+/,'').toLowerCase().startsWith(name.split(' ')[0].toLowerCase()));
  });
  gOnGoalType();
}
function gOnGoalType(){
  const v=(document.getElementById('g-savings-goal-input')?.value||'').trim();
  const preview=document.getElementById('g-goal-preview');
  const targetWrap=document.getElementById('g-goal-target-wrap');
  const symEl=document.getElementById('g-goal-currency-sym');
  if(symEl) symEl.textContent=currencySymbol;
  if(targetWrap) targetWrap.style.display = v ? 'block' : 'none';
  if(preview) preview.textContent = v
    ? `🎯 "${v}" will be your first savings goal`
    : '🛡 Defaults to "Emergency Fund" if left blank';
  gOnGoalTargetType();
}
function gOnGoalTargetType(){
  const v=(document.getElementById('g-savings-goal-input')?.value||'').trim();
  const amt=parseFloat(document.getElementById('g-savings-goal-target')?.value)||0;
  const hint=document.getElementById('g-goal-target-hint');
  if(!hint) return;
  if(!v||amt<=0){ hint.textContent=''; return; }
  hint.textContent=`✓ You'll aim to save ${currencySymbol}${fmt(amt,0)} for "${v}"`;
  hint.style.color='var(--green)';
}
function gUpdateCCHint(){
  const limit=parseFloat(document.getElementById('g-cc-limit')?.value)||0;
  const owe=parseFloat(document.getElementById('g-cc-balance')?.value)||0;
  const hint=document.getElementById('g-cc-form-hint');
  if(!hint) return;
  if(limit<=0){ hint.style.display='none'; return; }
  const avail=limit-owe;
  if(owe>limit){
    hint.textContent='\u26a0\ufe0f Outstanding balance can\'t exceed the credit limit.';
    hint.style.color='var(--red)'; hint.style.display='block'; return;
  }
  hint.style.color='#a855f7';
  hint.style.display='block';
  hint.textContent=`\u2713 Limit: ${currencySymbol}${fmt(limit,0)} \u00b7 Owe: ${currencySymbol}${fmt(owe,0)} \u00b7 Available from day one: ${currencySymbol}${fmt(avail,0)}`;
}
/* ── Guide: credit card step ── */
function gAddCreditCard(){
  const name=(document.getElementById('g-cc-name')?.value||'').trim();
  const limit=parseFloat(document.getElementById('g-cc-limit')?.value)||0;
  const owe=parseFloat(document.getElementById('g-cc-balance')?.value)||0;
  const interest=parseFloat(document.getElementById('g-cc-interest')?.value)||0;
  const hint=document.getElementById('g-cc-form-hint');

  if(!name){
    hint.textContent='⚠️ Please enter a card name.';
    hint.style.color='var(--red)'; hint.style.display='block'; return;
  }
  if(limit<=0){
    hint.textContent='⚠️ Please enter a valid credit limit.';
    hint.style.color='var(--red)'; hint.style.display='block'; return;
  }
  if(owe>limit){
    hint.textContent=`⚠️ Outstanding balance can't exceed the credit limit (${currencySymbol}${fmt(limit,0)}).`;
    hint.style.color='var(--red)'; hint.style.display='block'; return;
  }

  const cardId=String(Date.now());
  creditCards.push({id:cardId, name, limit, billingFee: interest||0});

  // If they already owe money, create an "opening balance" expense transaction
  if(owe>0){
    const openingTx={
      id:Date.now()+1,
      date:todayStr(),
      category:'other',
      label:`${name} — Opening Balance`,
      icon:'💳',
      type:'expense',
      amount:owe,
      note:`Opening balance on ${name} — set during setup`,
      recurring:false,
      savingsGoal:'',
      creditCardId:cardId
    };
    transactions.push(openingTx);
    transactions.sort((a,b)=>b.date.localeCompare(a.date)||b.id-a.id);
  }

  persist();

  // Clear form
  document.getElementById('g-cc-name').value='';
  document.getElementById('g-cc-limit').value='';
  document.getElementById('g-cc-balance').value='';
  if(document.getElementById('g-cc-interest')) document.getElementById('g-cc-interest').value='';
  hint.style.display='none';

  gRenderGuideCards();
}
function gRenderGuideCards(){
  const el=document.getElementById('g-cc-list'); if(!el) return;
  if(!creditCards.length){ el.innerHTML=''; return; }
  el.innerHTML=creditCards.map(c=>{
    const info=getCardInfo(c.id);
    const pct=Math.round(info.pct);
    const color=info.pct>=90?'var(--red)':info.pct>=70?'var(--accent)':'#a855f7';
    const avail=info.available;
    return `<div style="background:var(--bg1);border:1.5px solid #a855f730;border-radius:14px;padding:12px 14px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
        <div style="display:flex;align-items:center;gap:7px;">
          <span style="font-size:1.1rem;">💳</span>
          <div>
            <div style="font-size:.85rem;font-weight:700;color:var(--text);">${c.name}</div>
            <div style="font-size:.62rem;color:var(--text3);">Limit: ${currencySymbol}${fmt(c.limit,0)}</div>
          </div>
        </div>
        <button style="font-size:.65rem;color:var(--red);cursor:pointer;font-weight:600;padding:4px 9px;border-radius:7px;background:var(--red-dim);border:none;" onclick="gRemoveGuideCard('${c.id}')">Remove</button>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:8px;">
        <div style="background:var(--bg2);border-radius:9px;padding:7px 10px;">
          <div style="font-size:.55rem;text-transform:uppercase;letter-spacing:.7px;color:var(--text3);font-weight:700;margin-bottom:2px;">Owe Now</div>
          <div style="font-family:'Playfair Display',serif;font-size:.9rem;font-weight:700;color:${color};">${currencySymbol}${fmt(info.used,0)}</div>
        </div>
        <div style="background:var(--bg2);border-radius:9px;padding:7px 10px;">
          <div style="font-size:.55rem;text-transform:uppercase;letter-spacing:.7px;color:var(--text3);font-weight:700;margin-bottom:2px;">Available</div>
          <div style="font-family:'Playfair Display',serif;font-size:.9rem;font-weight:700;color:var(--green);">${currencySymbol}${fmt(avail,0)}</div>
        </div>
      </div>
      <div style="height:4px;background:var(--bg3);border-radius:99px;overflow:hidden;">
        <div style="height:100%;width:${pct}%;background:${color};border-radius:99px;transition:width .5s;"></div>
      </div>
      <div style="display:flex;justify-content:space-between;margin-top:4px;font-size:.62rem;color:var(--text3);">
        <span>${pct}% used</span>
        <span style="color:${info.used>0?color:'var(--green)'}">${info.used>0?'Has outstanding balance':'✓ Clear'}</span>
      </div>
    </div>`;
  }).join('');
}
function gRemoveGuideCard(id){
  // Also remove any opening balance transactions for this card
  transactions=transactions.filter(t=>!(t.creditCardId===id && t.note && t.note.includes('Opening balance')));
  creditCards=creditCards.filter(c=>c.id!==id);
  persist(); gRenderGuideCards();
}

function gSyncGuideState(){
  gCycleMode = cycleMode;
  gLimitVal  = cycleLimit;
  // Theme highlight
  ['dark','pink','white','navy','ice','forest','sunset','midnight'].forEach(n=>{
    const c=document.getElementById(`g-theme-${n}`);
    if(c) c.classList.toggle('active-g', n===activeTheme);
  });
  // Cycle mode + fields
  gSelectCycleMode(cycleMode);
  if(cycleMode==='monthly'){const e=document.getElementById('g-pay-day');if(e)e.value=cycleConfig.monthly.payDay;}
  if(cycleMode==='bimonthly'){['s1','e1','s2','e2'].forEach(k=>{const e=document.getElementById(`g-bi-${k}`);if(e)e.value=cycleConfig.bimonthly[k];});}
  if(cycleMode==='custom'){
    const s=document.getElementById('g-cust-start');if(s)s.value=cycleConfig.custom.start;
    const l=document.getElementById('g-cust-len');if(l)l.value=cycleConfig.custom.len;
  }
  if(cycleMode==='weekly'){const e=document.getElementById('g-pay-dow');if(e)e.value=cycleConfig.weekly?.payDow??1;}
  gUpdateLimitDisplay();
  const stored=localStorage.getItem('ledger_defaultGoal')||'';
  const inp=document.getElementById('g-savings-goal-input');
  if(inp) inp.value=stored;
  // Restore target amount if already set for this goal
  if(stored){
    const existingTarget=goalTargets[stored.toLowerCase()]||0;
    const tInp=document.getElementById('g-savings-goal-target');
    if(tInp && existingTarget>0) tInp.value=existingTarget;
  }
  gOnGoalType();
  // Render any already-added credit cards in the guide list
  gRenderGuideCards();
}

// ════════════════════════════════════════════════════════════
//  INIT
// ════════════════════════════════════════════════════════════
window.addEventListener('DOMContentLoaded',()=>{
  setTheme(activeTheme);
  activeCycleKey = currentCycleKey();
  const df=document.getElementById('f-date'); df.value=todayStr(); df.max=todayStr();
  document.getElementById('f-amount').addEventListener('input',updateSaveBtn);
  buildCatGrid();
  autoGenerateRecurring(); // populate recurring txs into current cycle on load
  renderFeed();
  setupSwipeToDelete();
  checkPinOnLoad();
  // Hide what's new badge if already seen
  if(localStorage.getItem('ledger_wn_seen')){
    const badge=document.getElementById('new-badge');
    if(badge) badge.style.display='none';
  }
  // Show onboarding for first-time users
  if(!localStorage.getItem('ledger_onboarded')){
    setTimeout(()=>obOpen(), 400);
  }
  // PWA setup
  pwaInit();
  // Backup reminder check
  checkBackupReminder();
});

// ════════════════════════════════════════════════════════════
//  PWA — manifest · service worker · install prompt
// ════════════════════════════════════════════════════════════
let _pwaPrompt = null;

function pwaGenIcon(size=512){
  const c=document.createElement('canvas');
  c.width=c.height=size; const ctx=c.getContext('2d');
  const r=size*0.18;
  // Background rounded rect
  ctx.beginPath();
  ctx.moveTo(r,0); ctx.lineTo(size-r,0); ctx.quadraticCurveTo(size,0,size,r);
  ctx.lineTo(size,size-r); ctx.quadraticCurveTo(size,size,size-r,size);
  ctx.lineTo(r,size); ctx.quadraticCurveTo(0,size,0,size-r);
  ctx.lineTo(0,r); ctx.quadraticCurveTo(0,0,r,0); ctx.closePath();
  ctx.fillStyle='#080810'; ctx.fill();
  // Book spine
  const sx=size*0.19, sy=size*0.18, sw=size*0.09, sh=size*0.64;
  ctx.beginPath(); ctx.roundRect(sx,sy,sw,sh,size*0.04);
  ctx.fillStyle='#d4a853'; ctx.fill();
  // Book body
  const bx=sx+sw*0.6, by=sy, bw=size*0.55, bh=sh;
  ctx.beginPath(); ctx.roundRect(bx,by,bw,bh,size*0.04);
  ctx.fillStyle='#1a1a28'; ctx.fill();
  ctx.strokeStyle='#d4a853'; ctx.lineWidth=size*0.018; ctx.stroke();
  // Lines
  const lx=bx+bw*0.15, lw=bw*0.72;
  [[0.26,'#d4a853',0.04],[0.40,'#8a8598',0.032],[0.52,'#8a8598',0.032],[0.64,'#8a8598',0.032],[0.76,'#8a8598',0.032]].forEach(([yp,col,lh])=>{
    ctx.beginPath(); ctx.roundRect(lx, sy+sh*yp, lw*(yp===0.26?1:0.82), size*lh, size*0.016);
    ctx.fillStyle=col; ctx.fill();
  });
  // Gold dot accent
  ctx.beginPath(); ctx.arc(size*0.72, size*0.78, size*0.055, 0, Math.PI*2);
  ctx.fillStyle='#d4a853'; ctx.fill();
  return c.toDataURL('image/png');
}

function pwaInit(){
  // Generate icon
  const icon512 = pwaGenIcon(512);
  const icon192 = pwaGenIcon(192);

  // Apple touch icon
  const appleLink = document.getElementById('pwa-apple-icon');
  if(appleLink) appleLink.href = icon192;

  // Render icon in banners
  ['pwa-banner-icon','ios-sheet-icon'].forEach(id=>{
    const el=document.getElementById(id);
    if(el){ const img=document.createElement('img'); img.src=icon192; img.style.cssText='width:100%;height:100%;border-radius:inherit;'; el.appendChild(img); }
  });

  // Build & inject manifest
  const manifest={
    name:'Spendoodle',
    short_name:'Spendoodle',
    description:'Spendoodle — personal pay-cycle money tracker — income, expenses, savings & credit cards.',
    start_url:location.href,
    scope:location.href,
    display:'standalone',
    orientation:'portrait',
    background_color:'#080810',
    theme_color:'#080810',
    categories:['finance','productivity'],
    icons:[
      {src:icon192,sizes:'192x192',type:'image/png',purpose:'any maskable'},
      {src:icon512,sizes:'512x512',type:'image/png',purpose:'any maskable'}
    ]
  };
  const manifestLink=document.getElementById('pwa-manifest-link');
  if(manifestLink){
    const blob=new Blob([JSON.stringify(manifest)],{type:'application/json'});
    manifestLink.href=URL.createObjectURL(blob);
  }

  // Register real service worker (sw.js must be at root)
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('/sw.js', {scope: '/'})
      .then(reg => {
        console.log('[PWA] Service worker registered ✓', reg.scope);
        // Tell SW to update if a new version is available
        reg.addEventListener('updatefound', () => {
          const newSW = reg.installing;
          newSW.addEventListener('statechange', () => {
            if(newSW.state === 'installed' && navigator.serviceWorker.controller){
              console.log('[PWA] New version cached — reload to update');
            }
          });
        });
      })
      .catch(e => console.warn('[PWA] SW registration failed:', e));
  }

  // Install prompt — Android Chrome
  const dismissed = localStorage.getItem('pwa_dismissed');
  const isInstalled = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
  if(isInstalled){ document.getElementById('pwa-banner').style.display='none'; return; }

  window.addEventListener('beforeinstallprompt', e=>{
    e.preventDefault();
    _pwaPrompt = e;
    if(!dismissed){
      setTimeout(()=>{
        document.getElementById('pwa-banner').style.display='flex';
        document.getElementById('pwa-banner-sub').textContent='Tap Install — works offline, no app store needed';
      }, 3000);
    }
  });

  // iOS Safari — show manual instructions banner
  const isIos = /iphone|ipad|ipod/i.test(navigator.userAgent);
  const isSafari = /safari/i.test(navigator.userAgent) && !/chrome|crios|fxios/i.test(navigator.userAgent);
  if(isIos && isSafari && !dismissed){
    setTimeout(()=>{
      const banner=document.getElementById('pwa-banner');
      banner.style.display='flex';
      document.getElementById('pwa-banner-sub').textContent='Tap to see how to add to Home Screen';
      document.getElementById('pwa-banner-btn').textContent='How to Install';
    }, 3000);
  }
}

function pwaInstall(){
  const isIos = /iphone|ipad|ipod/i.test(navigator.userAgent);
  if(_pwaPrompt){
    _pwaPrompt.prompt();
    _pwaPrompt.userChoice.then(r=>{
      if(r.outcome==='accepted') pwaDismiss();
      _pwaPrompt=null;
    });
  } else if(isIos){
    document.getElementById('pwa-banner').style.display='none';
    document.getElementById('ios-install-sheet').classList.add('open');
  }
}
function pwaDismiss(){
  document.getElementById('pwa-banner').style.display='none';
  localStorage.setItem('pwa_dismissed','1');
}
function closeIosSheet(e){
  if(e && e.target!==document.getElementById('ios-install-sheet')) return;
  document.getElementById('ios-install-sheet').classList.remove('open');
}

// ════════════════════════════════════════════════════════════
let _pinBuffer='';
let _pinMode='unlock'; // 'unlock' | 'set' | 'confirm'
let _pinFirst='';
let _pinCallback=null;

async function sha256(str){
  const buf=await crypto.subtle.digest('SHA-256',new TextEncoder().encode(str));
  return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
}
function pinKey(d){
  if(_pinBuffer.length>=4) return;
  _pinBuffer+=d;
  updatePinDots();
  if(_pinBuffer.length===4) setTimeout(pinSubmit,120);
}
function pinDel(){ if(_pinBuffer.length) { _pinBuffer=_pinBuffer.slice(0,-1); updatePinDots(); } }
function updatePinDots(){
  for(let i=0;i<4;i++){
    document.getElementById('pd'+i)?.classList.toggle('filled',i<_pinBuffer.length);
  }
}
async function pinSubmit(){
  const hash=await sha256(_pinBuffer);
  if(_pinMode==='unlock'){
    if(hash===pinHash){ pinUnlock(); }
    else { document.getElementById('pin-error').textContent='Wrong PIN. Try again.'; _pinBuffer=''; updatePinDots(); setTimeout(()=>{ const e=document.getElementById('pin-error');if(e)e.textContent=''; },1500); }
  } else if(_pinMode==='set'){
    _pinFirst=_pinBuffer; _pinBuffer='';
    _pinMode='confirm';
    document.getElementById('pin-sub').textContent='Confirm your PIN';
    updatePinDots();
  } else if(_pinMode==='confirm'){
    if(_pinBuffer===_pinFirst){
      pinHash=hash;
      localStorage.setItem('ledger_pin',hash);
      _pinBuffer=''; _pinFirst=''; _pinMode='unlock';
      document.getElementById('pin-overlay').classList.add('hidden');
      showSettingsToast('🔐 PIN set successfully!');
      if(_pinCallback){ _pinCallback(); _pinCallback=null; }
    } else {
      document.getElementById('pin-error').textContent='PINs don\'t match. Start again.';
      _pinBuffer=''; _pinFirst=''; _pinMode='set';
      document.getElementById('pin-sub').textContent='Choose a 4-digit PIN';
      updatePinDots();
      setTimeout(()=>{ const e=document.getElementById('pin-error');if(e)e.textContent=''; },1800);
    }
  }
}
function pinUnlock(){
  _pinBuffer=''; updatePinDots();
  document.getElementById('pin-overlay').classList.add('hidden');
  document.getElementById('pin-error').textContent='';
}
function pinSkip(){
  showConfirm({
    icon:'⚠️',
    title:'Reset & Clear All Data?',
    msg:'This will erase ALL transactions and settings to remove the PIN. This cannot be undone.',
    okLabel:'Clear Everything',
    onOk:()=>{
      pinHash=''; localStorage.removeItem('ledger_pin');
      transactions=[]; budgets={}; creditCards=[]; goalTargets=[];
      persist(); activeCycleKey=currentCycleKey();
      document.getElementById('pin-overlay').classList.add('hidden');
      renderFeed();
    }
  });
}
function openPinSetup(cb){
  _pinBuffer=''; _pinFirst=''; _pinMode='set'; _pinCallback=cb||null;
  updatePinDots();
  document.getElementById('pin-sub').textContent='Choose a 4-digit PIN';
  document.getElementById('pin-error').textContent='';
  document.getElementById('pin-skip-btn').style.display='none';
  document.getElementById('pin-overlay').classList.remove('hidden');
}
/* ── Guide inline PIN pad ── */
let _obPinBuf='', _obPinFirst='', _obPinStep='set'; // 'set' | 'confirm'
function obPinKey(d){
  if(_obPinBuf.length>=4) return;
  _obPinBuf+=d;
  obUpdatePinDots();
  if(_obPinBuf.length===4){
    setTimeout(async()=>{
      const h=await sha256(_obPinBuf);
      if(_obPinStep==='set'){
        _obPinFirst=h; _obPinBuf=''; _obPinStep='confirm';
        document.getElementById('ob-pin-status').textContent='Confirm your PIN';
        obUpdatePinDots();
      } else {
        if(h===_obPinFirst){
          pinHash=h; localStorage.setItem('ledger_pin',h);
          document.getElementById('ob-pin-set-msg').textContent='✅ PIN set! Your ledger is protected.';
          document.getElementById('ob-pin-status').textContent='PIN confirmed ✓';
          _obPinBuf=''; _obPinFirst=''; _obPinStep='set';
          obUpdatePinDots();
          // grey out the pad to show done
          document.querySelectorAll('.ob-pin-key').forEach(b=>b.disabled=true);
        } else {
          document.getElementById('ob-pin-set-msg').textContent='❌ PINs didn\'t match. Try again.';
          _obPinBuf=''; _obPinFirst=''; _obPinStep='set';
          document.getElementById('ob-pin-status').textContent='Enter a 4-digit PIN to activate lock';
          obUpdatePinDots();
        }
      }
    },80);
  }
}
function obPinDel(){
  _obPinBuf=_obPinBuf.slice(0,-1);
  obUpdatePinDots();
}
function obUpdatePinDots(){
  for(let i=0;i<4;i++){
    const d=document.getElementById(`ob-pin-d${i}`);
    if(d){ d.style.background=i<_obPinBuf.length?'var(--accent)':'transparent';
           d.style.borderColor=i<_obPinBuf.length?'var(--accent)':'var(--border2)'; }
  }
}

function removePin(){
  pinHash=''; localStorage.removeItem('ledger_pin');
  showSettingsToast('🔓 PIN removed.');
  renderSettings();
}
function checkPinOnLoad(){
  if(pinHash){
    _pinMode='unlock'; _pinBuffer=''; updatePinDots();
    document.getElementById('pin-sub').textContent='Enter your PIN to unlock';
    document.getElementById('pin-skip-btn').style.display='block';
    document.getElementById('pin-overlay').classList.remove('hidden');
  }
}

// ════════════════════════════════════════════════════════════
//  CUSTOM CONFIRM MODAL
// ════════════════════════════════════════════════════════════
function openWhatsNew(){
  document.getElementById('wn-overlay').classList.add('active');
  const badge=document.getElementById('new-badge');
  if(badge) badge.style.display='none';
  localStorage.setItem('ledger_wn_seen','1');
}
function closeWhatsNew(){
  const sheet=document.getElementById('wn-sheet');
  if(sheet){ sheet.style.transition='transform .3s cubic-bezier(.32,0,.67,0)'; sheet.style.transform=''; }
  document.getElementById('wn-overlay').classList.remove('active');
}

// ── Drag-to-dismiss for What's New ──
(function(){
  let startY=0, currentY=0, dragging=false;
  function onStart(e){
    dragging=true;
    startY=e.touches?e.touches[0].clientY:e.clientY;
    const sheet=document.getElementById('wn-sheet');
    if(sheet) sheet.style.transition='none';
  }
  function onMove(e){
    if(!dragging) return;
    currentY=e.touches?e.touches[0].clientY:e.clientY;
    const dy=Math.max(0, currentY-startY);
    const sheet=document.getElementById('wn-sheet');
    if(sheet) sheet.style.transform=`translateY(${dy}px)`;
    if(e.cancelable) e.preventDefault();
  }
  function onEnd(){
    if(!dragging) return;
    dragging=false;
    const dy=Math.max(0, currentY-startY);
    const sheet=document.getElementById('wn-sheet');
    if(dy>80){
      closeWhatsNew();
    } else {
      if(sheet){ sheet.style.transition='transform .3s cubic-bezier(.34,1.56,.64,1)'; sheet.style.transform='translateY(0)'; }
    }
  }
  window.addEventListener('DOMContentLoaded',()=>{
    const handle=document.getElementById('wn-handle');
    if(!handle) return;
    handle.addEventListener('touchstart', onStart, {passive:true});
    handle.addEventListener('touchmove', onMove, {passive:false});
    handle.addEventListener('touchend', onEnd, {passive:true});
    handle.addEventListener('mousedown', onStart);
    window.addEventListener('mousemove', onMove);
    window.addEventListener('mouseup', onEnd);
  });
})();

let _confirmCallback=null, _confirmCancelCallback=null, _confirmSecondaryCallback=null;
function showConfirm({icon='⚠️',title='Are you sure?',msg='This cannot be undone.',okLabel='Confirm',cancelLabel='Cancel',secondaryLabel=null,onOk,onCancel,onSecondary}={}){
  document.getElementById('confirm-icon').textContent=icon;
  document.getElementById('confirm-title').textContent=title;
  document.getElementById('confirm-msg').textContent=msg;
  document.getElementById('confirm-ok-btn').textContent=okLabel;
  document.getElementById('confirm-cancel-btn').textContent=cancelLabel;
  _confirmCallback=onOk||null;
  _confirmCancelCallback=onCancel||null;
  _confirmSecondaryCallback=onSecondary||null;

  // Build buttons layout
  const btnsEl=document.getElementById('confirm-btns');
  if(secondaryLabel){
    // Three-button layout: [OK full width] [Secondary full width] [Cancel full width]
    btnsEl.innerHTML=`
      <button class="confirm-btn confirm-ok" id="confirm-ok-btn" onclick="confirmOk()">${okLabel}</button>
      <button class="confirm-btn confirm-secondary" id="confirm-secondary-btn" onclick="confirmSecondary()">${secondaryLabel}</button>
      <button class="confirm-btn confirm-cancel" id="confirm-cancel-btn" onclick="cancelConfirm()">${cancelLabel}</button>`;
  } else {
    // Standard two-button layout side by side
    btnsEl.innerHTML=`
      <div class="confirm-btn-row">
        <button class="confirm-btn confirm-cancel" id="confirm-cancel-btn" onclick="cancelConfirm()">${cancelLabel}</button>
        <button class="confirm-btn confirm-ok" id="confirm-ok-btn" onclick="confirmOk()">${okLabel}</button>
      </div>`;
  }
  document.getElementById('confirm-overlay').classList.add('open');
}
function closeConfirm(){ document.getElementById('confirm-overlay').classList.remove('open'); _confirmCallback=null; _confirmCancelCallback=null; _confirmSecondaryCallback=null; }
function confirmOk(){ const cb=_confirmCallback; closeConfirm(); if(cb) cb(); }
function cancelConfirm(){ const cb=_confirmCancelCallback; closeConfirm(); if(cb) cb(); }
function confirmSecondary(){ const cb=_confirmSecondaryCallback; closeConfirm(); if(cb) cb(); }

// ════════════════════════════════════════════════════════════
//  QUICK-ADD RECURRING TEMPLATES
// ════════════════════════════════════════════════════════════
function renderQuickAddRow(){
  const templates=getRecurringTemplates();
  const area=document.getElementById('quick-add-area');
  if(!area) return;
  if(!templates.length){ area.innerHTML=''; return; }
  area.innerHTML=`<div style="padding:0 20px 4px;font-size:.6rem;text-transform:uppercase;letter-spacing:1px;color:var(--text3);font-weight:700;">⚡ Quick Add Recurring</div>
  <div class="quick-add-row">${templates.map(t=>`
    <div class="qa-chip" onclick="quickAdd(${t.id})">
      <span style="font-size:1rem;">${t.icon}</span>
      <span class="qa-chip-label">${t.label}</span>
      <span class="qa-chip-amt">${currencySymbol}${fmt(t.amount,0)}</span>
      <span class="qa-chip-freq">${t.recurFreq==='weekly'?'weekly':'monthly'}</span>
    </div>`).join('')}
  </div>`;
}
function quickAdd(templateId){
  const tmpl=transactions.find(t=>t.id===templateId); if(!tmpl) return;
  const newTx={...tmpl,id:Date.now(),date:todayStr(),autoGenerated:false};
  transactions.push(newTx);
  transactions.sort((a,b)=>b.date.localeCompare(a.date)||b.id-a.id);
  enforceCycleLimit(); persist();
  if(navigator.vibrate) navigator.vibrate(30);
  // Show brief toast
  const list=document.getElementById('feed-list');
  const toast=document.createElement('div');
  toast.className='toast'; toast.textContent=`✓ ${tmpl.label} added!`;
  toast.style.cssText='margin:0 20px 10px;animation:fadeUp .3s ease;';
  list.parentElement.insertBefore(toast, list);
  setTimeout(()=>{ toast.remove(); renderFeed(); },1200);
}

// ════════════════════════════════════════════════════════════
//  CASH FLOW PROJECTION
// ════════════════════════════════════════════════════════════
function renderProjection(){
  const el=document.getElementById('projection-inline');
  if(!el) return;
  const curKey=currentCycleKey();
  if(activeCycleKey!==curKey){ el.style.display='none'; return; }
  const {start,end}=cycleRange(curKey);
  const today=todayStr();
  const s=cycleStats(curKey);
  const startD=new Date(start+'T00:00:00'), endD=new Date(end+'T00:00:00'), todayD=new Date(today+'T00:00:00');
  const totalDays=Math.round((endD-startD)/86400000)+1;
  const elapsedDays=Math.min(Math.round((todayD-startD)/86400000)+1, totalDays);
  const remainingDays=totalDays-elapsedDays;
  if(elapsedDays<2||s.income===0){ el.style.display='none'; return; }
  const dailySpend=s.expense/elapsedDays;
  const projectedSpend=dailySpend*totalDays;
  const projectedLeft=s.income - projectedSpend - s.savings;
  let icon, color, msg;
  if(projectedLeft<0){ icon='⚠️'; color='var(--red)'; msg=`On track to overspend by ${c$(Math.abs(projectedLeft))}`; }
  else if(projectedLeft<s.income*0.1){ icon='😬'; color='var(--accent)'; msg=`Tight — ${c$(projectedLeft)} projected left`; }
  else { icon='📈'; color='var(--green)'; msg=`${c$(projectedLeft)} projected remaining`; }
  el.style.display='flex';
  el.style.color=color;
  el.innerHTML=`<span>${icon}</span><span>${msg} · ${remainingDays}d left</span>`;
}

// ════════════════════════════════════════════════════════════
//  SWIPE TO DELETE
// ════════════════════════════════════════════════════════════
function setupSwipeToDelete(){
  const list=document.getElementById('feed-list');
  let startX=0, startY=0, activeWrap=null, swipeDist=0, dirLocked=false;

  list.addEventListener('touchstart',e=>{
    const wrap=e.target.closest('.tx-wrap');
    if(!wrap) return;
    startX=e.touches[0].clientX;
    startY=e.touches[0].clientY;
    activeWrap=wrap; swipeDist=0; dirLocked=false;
  },{passive:true});

  list.addEventListener('touchmove',e=>{
    if(!activeWrap) return;
    const dx=e.touches[0].clientX-startX;
    const dy=e.touches[0].clientY-startY;

    // Lock direction on first significant move
    if(!dirLocked){
      if(Math.abs(dx)<4&&Math.abs(dy)<4) return; // too small, wait
      if(Math.abs(dy)>Math.abs(dx)){
        // Vertical — cancel swipe tracking, let scroll happen
        activeWrap=null; return;
      }
      dirLocked=true; // horizontal locked
    }

    swipeDist=dx;
    if(dx<0){
      const clamped=Math.max(dx,-82);
      activeWrap.classList.add('swiping');
      const txEl=activeWrap.querySelector('.tx');
      if(txEl) txEl.style.transform=`translateX(${clamped}px)`;
      e.preventDefault(); // block scroll only once direction confirmed horizontal
    }
  },{passive:false});

  list.addEventListener('touchend',()=>{
    if(!activeWrap) return;
    const txEl=activeWrap.querySelector('.tx');
    if(swipeDist<-65){
      const id=parseInt(activeWrap.dataset.id);
      if(txEl) txEl.style.transform='';
      activeWrap.classList.remove('swiping');
      if(id) deleteTx(id);
    } else {
      if(txEl){ txEl.style.transition='transform .2s ease'; txEl.style.transform=''; setTimeout(()=>{ if(txEl) txEl.style.transition=''; },200); }
      activeWrap.classList.remove('swiping');
    }
    activeWrap=null; swipeDist=0; dirLocked=false;
  },{passive:true});
}


</script>
</body>
</html>
