<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover"/>
<meta name="mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="apple-mobile-web-app-title" content="Spendoodle"/>
<meta name="application-name" content="Spendoodle"/>
<meta name="description" content="Spendoodle — personal pay-cycle money tracker — income, expenses, savings & credit cards."/>
<meta name="theme-color" id="theme-color-meta" content="#080810"/>
<link rel="manifest" id="pwa-manifest-link"/>
<link rel="apple-touch-icon" id="pwa-apple-icon"/>
<title>Spendoodle</title>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,500;0,700;0,900;1,500&family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
<style>
/* ══════════════════════════════════════════
   THEMES
══════════════════════════════════════════ */
:root{
  --vh:1vh;--sab:env(safe-area-inset-bottom,0px);
  --bg:#080810;--bg1:#0f0f1a;--bg2:#141420;--bg3:#1a1a28;
  --border:#1e1e30;--border2:#252538;
  --text:#ede8e0;--text2:#8a8598;--text3:#45435a;
  --accent:#d4a853;--accent2:#f0c878;--accent-dim:#d4a85322;
  --green:#4fd87c;--green-dim:#4fd87c18;
  --red:#f06464;--red-dim:#f0646418;
  --blue:#7b8fff;--blue-dim:#7b8fff18;
  --nav-h:74px;
  --grain:0.35;
}
body.theme-pink{
  --bg:#1a0a14;--bg1:#240f1c;--bg2:#2e1426;--bg3:#381929;
  --border:#4a1f38;--border2:#5c2846;
  --text:#ffe8f5;--text2:#c490b0;--text3:#7a4060;
  --accent:#f472b6;--accent2:#fb7cc6;--accent-dim:#f472b622;
  --green:#34d399;--green-dim:#34d39918;
  --red:#f87171;--red-dim:#f8717118;
  --blue:#a78bfa;--blue-dim:#a78bfa18;
}
body.theme-white{
  --bg:#f5f4f0;--bg1:#ffffff;--bg2:#f0ede8;--bg3:#e8e4de;
  --border:#ddd8d0;--border2:#ccc8c0;
  --text:#1a1814;--text2:#6b6560;--text3:#a09890;
  --accent:#b8860b;--accent2:#d4a020;--accent-dim:#b8860b15;
  --green:#16a34a;--green-dim:#16a34a15;
  --red:#dc2626;--red-dim:#dc262615;
  --blue:#2563eb;--blue-dim:#2563eb15;
  --grain:0.1;
}
/* Dark Blue — deep navy with electric blue accent */
body.theme-navy{
  --bg:#04080f;--bg1:#080f1c;--bg2:#0d1626;--bg3:#111d30;
  --border:#162040;--border2:#1d2d55;
  --text:#dce8ff;--text2:#7090c0;--text3:#334466;
  --accent:#3b82f6;--accent2:#60a5fa;--accent-dim:#3b82f622;
  --green:#22d3a5;--green-dim:#22d3a518;
  --red:#f87171;--red-dim:#f8717118;
  --blue:#818cf8;--blue-dim:#818cf818;
  --grain:0.3;
}
/* Cold Blue — icy steel with cyan accent */
body.theme-ice{
  --bg:#06111a;--bg1:#0b1d28;--bg2:#102535;--bg3:#152e40;
  --border:#1a3548;--border2:#234560;
  --text:#c8eaf8;--text2:#6090a8;--text3:#2d5068;
  --accent:#06b6d4;--accent2:#22d3ee;--accent-dim:#06b6d422;
  --green:#34d399;--green-dim:#34d39918;
  --red:#fb7185;--red-dim:#fb718518;
  --blue:#38bdf8;--blue-dim:#38bdf818;
  --grain:0.28;
}
/* Forest — deep emerald with mint accent */
body.theme-forest{
  --bg:#030f08;--bg1:#071510;--bg2:#0b1c15;--bg3:#10231a;
  --border:#152c1e;--border2:#1c3a28;
  --text:#d4f0de;--text2:#5a9070;--text3:#2a5038;
  --accent:#10b981;--accent2:#34d399;--accent-dim:#10b98122;
  --green:#4ade80;--green-dim:#4ade8018;
  --red:#f87171;--red-dim:#f8717118;
  --blue:#60a5fa;--blue-dim:#60a5fa18;
  --grain:0.32;
}
/* Sunset — warm amber with orange glow */
body.theme-sunset{
  --bg:#0f0800;--bg1:#1a0f00;--bg2:#221500;--bg3:#2a1c00;
  --border:#3d2800;--border2:#503400;
  --text:#ffe8c8;--text2:#c08040;--text3:#7a4e18;
  --accent:#f97316;--accent2:#fb923c;--accent-dim:#f9731622;
  --green:#4ade80;--green-dim:#4ade8018;
  --red:#f87171;--red-dim:#f8717118;
  --blue:#818cf8;--blue-dim:#818cf818;
  --grain:0.33;
}
/* Midnight — deep purple with violet accent */
body.theme-midnight{
  --bg:#060410;--bg1:#0d0820;--bg2:#120c2c;--bg3:#181238;
  --border:#221a48;--border2:#2e2460;
  --text:#e8d8ff;--text2:#8870b8;--text3:#453568;
  --accent:#a855f7;--accent2:#c084fc;--accent-dim:#a855f722;
  --green:#34d399;--green-dim:#34d39918;
  --red:#f87171;--red-dim:#f8717118;
  --blue:#818cf8;--blue-dim:#818cf818;
  --grain:0.3;
}

/* ══════════════════════════════════════════
   RESET & BASE
══════════════════════════════════════════ */
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;height:calc(var(--vh,1vh)*100);overflow:hidden;background:var(--bg);}@supports(height:100dvh){html,body{height:100dvh;}}
body{font-family:'Plus Jakarta Sans',sans-serif;color:var(--text);overscroll-behavior:none;transition:background .3s,color .3s;}
body::before{content:'';position:fixed;inset:0;z-index:9999;pointer-events:none;
  background-image:url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
  opacity:var(--grain,0.35);}
#app{position:fixed;inset:0;display:flex;flex-direction:column;width:100%;max-width:430px;margin:0 auto;}
.view{position:absolute;inset:0;bottom:var(--nav-h);overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;scrollbar-width:none;transition:opacity .25s,transform .25s;}
.view::-webkit-scrollbar{display:none;}
.view.hidden{opacity:0;pointer-events:none;transform:translateY(12px);}

/* ── TOPBAR ── */
.topbar{position:sticky;top:0;z-index:40;background:linear-gradient(to bottom,var(--bg) 82%,transparent);padding:calc(env(safe-area-inset-top,0px) + 16px) 20px 0;}
.top-row{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:12px;}
.top-title{font-family:'Playfair Display',serif;font-size:1.55rem;font-weight:900;letter-spacing:-.5px;line-height:1.1;}
.top-title span{color:var(--accent);}
.top-sub{font-size:.67rem;color:var(--text3);margin-top:4px;font-weight:500;letter-spacing:.5px;text-transform:uppercase;}
.top-date{font-size:.72rem;color:var(--text2);background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:5px 9px;font-weight:600;}
.icon-btn{background:var(--bg1);border:1.5px solid var(--border2);border-radius:10px;width:34px;height:34px;font-size:1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;color:var(--text2);transition:all .18s;}
.icon-btn:active{border-color:var(--accent);}

/* ── CYCLE NAV ── */
.cycle-nav{display:flex;align-items:center;gap:10px;padding:0 20px 10px;}
.mnav-btn{width:34px;height:34px;border-radius:10px;border:1.5px solid var(--border2);background:var(--bg1);color:var(--text2);font-size:1.1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .18s;}
.mnav-btn:active{background:var(--bg2);border-color:var(--accent);color:var(--accent);}
.mnav-btn:disabled{opacity:.2;pointer-events:none;}
.cycle-center{flex:1;text-align:center;}
.cycle-label{font-family:'Playfair Display',serif;font-size:1rem;font-weight:700;color:var(--text);}
.cycle-range{font-size:.62rem;color:var(--text3);font-weight:500;margin-top:2px;}



/* ── HERO ── */
.hero-card{margin:0 20px 12px;background:linear-gradient(135deg,var(--bg2),var(--bg3));border:1px solid var(--border2);border-radius:22px;padding:20px 22px 18px;position:relative;overflow:hidden;}
.hero-card::before{content:'';position:absolute;top:-40px;right:-40px;width:130px;height:130px;background:radial-gradient(circle,var(--accent-dim) 0%,transparent 70%);pointer-events:none;}
.hero-label{font-size:.62rem;text-transform:uppercase;letter-spacing:1.5px;color:var(--text3);font-weight:700;margin-bottom:5px;}
.hero-amount{font-family:'Playfair Display',serif;font-size:2.4rem;font-weight:900;letter-spacing:-1px;line-height:1;margin-bottom:14px;}
.hero-amount .sign{font-size:1.3rem;color:var(--text3);margin-right:2px;}
/* Amount remaining hint */
.amt-remaining{font-size:.68rem;font-weight:700;margin-top:5px;padding:0 2px;display:flex;align-items:center;gap:5px;}
.amt-remaining.ok{color:var(--green);}
.amt-remaining.warn{color:var(--accent);}
.amt-remaining.over{color:var(--red);}
.amt-err{background:var(--red-dim);color:var(--red);border:1px solid var(--border2);border-radius:9px;padding:7px 12px;font-size:.75rem;font-weight:700;margin-top:6px;display:none;}
.hero-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:7px;}
.hero-stat{background:var(--bg);border-radius:12px;padding:10px 12px;}
.hs-label{font-size:.58rem;text-transform:uppercase;letter-spacing:.8px;color:var(--text3);font-weight:700;margin-bottom:3px;}
.hs-val{font-size:.88rem;font-weight:700;font-family:'Playfair Display',serif;}
.c-inc{color:var(--green);}.c-exp{color:var(--red);}.c-sav{color:var(--accent);}
.c-pos{color:var(--green);}.c-neg{color:var(--red);}

/* ── FEED BALANCE BAR ── */
.feed-balance-bar{margin:0 20px 10px;background:linear-gradient(135deg,var(--bg2),var(--bg3));border:1px solid var(--border2);border-radius:16px;padding:12px 16px;display:flex;align-items:center;gap:12px;}
.fbb-left{flex:1;min-width:0;}
.fbb-label{font-size:.58rem;text-transform:uppercase;letter-spacing:1.2px;color:var(--text3);font-weight:700;margin-bottom:2px;}
.fbb-amount{font-family:'Playfair Display',serif;font-size:1.5rem;font-weight:900;letter-spacing:-.5px;line-height:1;}
.fbb-track{height:4px;background:var(--bg3);border-radius:99px;overflow:hidden;margin-top:6px;}
.fbb-fill{height:100%;border-radius:99px;transition:width .5s ease;}
.fbb-stats{display:flex;flex-direction:column;align-items:flex-end;gap:3px;flex-shrink:0;}
.fbb-stat{font-size:.65rem;font-weight:700;display:flex;align-items:center;gap:4px;}
.fbb-stat-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0;}
.streak-badge{display:inline-flex;align-items:center;gap:5px;background:var(--accent-dim);border:1px solid var(--border2);border-radius:99px;padding:4px 10px;font-size:.67rem;font-weight:700;color:var(--accent);margin-bottom:10px;}

/* ── BUDGET ── */
/* ── BUDGET SECTION (collapsible) ── */
.budget-section{margin:0 20px 12px;}
.budget-header{display:flex;align-items:center;gap:8px;padding:11px 14px;background:var(--bg1);border:1px solid var(--border);border-radius:16px;cursor:pointer;transition:border-color .2s;user-select:none;}
.budget-header:active{border-color:var(--accent);}
.budget-header.has-over{border-color:var(--red)!important;}
.budget-header-icon{font-size:1.1rem;flex-shrink:0;}
.budget-header-body{flex:1;min-width:0;}
.budget-header-title{font-size:.8rem;font-weight:700;color:var(--text);display:flex;align-items:center;gap:6px;}
.budget-header-sub{font-size:.62rem;color:var(--text3);margin-top:1px;}
.budget-header-right{display:flex;align-items:center;gap:7px;flex-shrink:0;}
.budget-overall-pill{font-size:.62rem;font-weight:700;padding:3px 8px;border-radius:99px;white-space:nowrap;}
.budget-chevron{font-size:.75rem;color:var(--text3);transition:transform .25s;}
.budget-chevron.open{transform:rotate(180deg);}
.budget-body{overflow:hidden;max-height:0;transition:max-height .35s cubic-bezier(.4,0,.2,1);}
.budget-body.open{max-height:1200px;}
.budget-cards{display:flex;flex-direction:column;gap:7px;padding-top:8px;}
.budget-card{background:var(--bg2);border:1.5px solid var(--border2);border-radius:14px;padding:12px 14px;cursor:pointer;transition:border-color .18s;}
.budget-card:active{border-color:var(--accent);}
.budget-card.over{border-color:var(--red)!important;background:var(--red-dim);}
.budget-card.warn{border-color:var(--accent)!important;}
.bc-top{display:flex;align-items:center;gap:10px;margin-bottom:8px;}
.bc-icon{width:34px;height:34px;border-radius:10px;background:var(--red-dim);display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0;}
.bc-info{flex:1;min-width:0;}
.bc-name{font-size:.82rem;font-weight:700;color:var(--text);}
.bc-meta{font-size:.62rem;color:var(--text3);margin-top:1px;}
.bc-right{text-align:right;flex-shrink:0;}
.bc-spent{font-family:'Playfair Display',serif;font-size:.92rem;font-weight:700;}
.bc-limit{font-size:.6rem;color:var(--text3);}
.bc-bar-track{height:6px;background:var(--bg3);border-radius:99px;overflow:hidden;margin-bottom:5px;}
.bc-bar-fill{height:100%;border-radius:99px;transition:width .6s ease;}
.bc-bottom{display:flex;justify-content:space-between;align-items:center;}
.bc-remaining{font-size:.67rem;font-weight:700;}
.bc-daily{font-size:.62rem;color:var(--text3);}
.budget-empty{padding:16px 4px 10px;text-align:center;}
.budget-empty-icon{font-size:2rem;margin-bottom:6px;}
.budget-empty-txt{font-size:.78rem;color:var(--text3);line-height:1.6;margin-bottom:12px;}
.budget-set-btn{display:inline-flex;align-items:center;gap:6px;padding:10px 20px;border-radius:11px;background:var(--accent-dim);color:var(--accent);border:1.5px solid var(--border2);font-family:'Plus Jakarta Sans',sans-serif;font-size:.78rem;font-weight:700;cursor:pointer;transition:all .18s;}
.budget-set-btn:active{transform:scale(.96);}
/* improved budget modal */
.bm-inner{background:var(--bg1);border-radius:22px 22px 0 0;width:100%;max-width:430px;padding:18px 20px 40px;max-height:85vh;overflow-y:auto;scrollbar-width:none;}
.bm-inner::-webkit-scrollbar{display:none;}
.bm-title{font-family:'Playfair Display',serif;font-size:1.2rem;font-weight:700;margin-bottom:3px;}
.bm-sub{font-size:.72rem;color:var(--text3);margin-bottom:16px;line-height:1.6;}
.bm-cat-card{display:flex;align-items:center;gap:10px;background:var(--bg2);border:1.5px solid var(--border2);border-radius:13px;padding:10px 12px;margin-bottom:8px;transition:border-color .18s;}
.bm-cat-card:focus-within{border-color:var(--accent);}
.bm-icon{width:32px;height:32px;border-radius:9px;background:var(--red-dim);display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0;}
.bm-name{font-size:.83rem;font-weight:600;flex:1;}
.bm-field-wrap{display:flex;align-items:center;gap:4px;background:var(--bg1);border:1.5px solid var(--border);border-radius:9px;padding:5px 9px;transition:border-color .2s;}
.bm-field-wrap:focus-within{border-color:var(--accent);}
.bm-sym{font-size:.75rem;color:var(--text3);font-weight:700;}
.bm-field{width:78px;background:transparent;border:none;outline:none;font-family:'Playfair Display',serif;font-size:.9rem;font-weight:700;color:var(--text);text-align:right;}
.bm-clear{background:none;border:none;color:var(--text3);cursor:pointer;font-size:.8rem;padding:2px 5px;line-height:1;flex-shrink:0;border-radius:4px;}
.bm-clear:hover{color:var(--red);}
.bm-save{width:100%;padding:13px;border:none;border-radius:13px;background:var(--accent);color:var(--bg);font-family:'Plus Jakarta Sans',sans-serif;font-size:.88rem;font-weight:700;cursor:pointer;margin-top:8px;}
.bm-section-label{font-size:.6rem;text-transform:uppercase;letter-spacing:1.2px;color:var(--text3);font-weight:700;margin:12px 0 8px;display:flex;align-items:center;gap:8px;}
.bm-section-label::after{content:'';flex:1;height:1px;background:var(--border);}

/* ── SEARCH ── */
.search-wrap{padding:0 20px 8px;position:relative;}
.search-input{width:100%;background:var(--bg1);border:1.5px solid var(--border2);border-radius:12px;padding:10px 14px 10px 38px;color:var(--text);font-family:'Plus Jakarta Sans',sans-serif;font-size:.88rem;outline:none;transition:border-color .2s;}
.search-input:focus{border-color:var(--accent);}
.search-input::placeholder{color:var(--text3);}
.search-icon{position:absolute;left:33px;top:50%;transform:translateY(-50%);font-size:.9rem;pointer-events:none;line-height:1;display:flex;align-items:center;}
.search-clear{position:absolute;right:33px;top:50%;transform:translateY(-50%);font-size:.75rem;cursor:pointer;color:var(--text3);background:var(--bg3);border:none;border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;}

/* ── FILTER CHIPS ── */
.filter-wrap{display:flex;gap:6px;overflow-x:auto;padding:0 20px 10px;scrollbar-width:none;}
.filter-wrap::-webkit-scrollbar{display:none;}
.filter-chip{flex-shrink:0;padding:6px 13px;border-radius:99px;font-size:.7rem;font-weight:700;cursor:pointer;border:1.5px solid var(--border);background:transparent;color:var(--text3);white-space:nowrap;transition:all .18s;}
.fc-all{border-color:var(--accent)!important;color:var(--accent)!important;background:var(--accent-dim)!important;}
.fc-income{border-color:var(--green)!important;color:var(--green)!important;background:var(--green-dim)!important;}
.fc-expense{border-color:var(--red)!important;color:var(--red)!important;background:var(--red-dim)!important;}
.fc-savings{border-color:var(--accent)!important;color:var(--accent)!important;background:var(--accent-dim)!important;}
.fc-recurring{border-color:var(--blue)!important;color:var(--blue)!important;background:var(--blue-dim)!important;}

/* ── SWIPE TO DELETE ── */
.tx-wrap{position:relative;margin-bottom:8px;overflow:hidden;}
.tx-swipe-bg-left{position:absolute;right:0;top:0;bottom:0;width:82px;background:var(--red-dim);border-radius:18px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;z-index:0;opacity:0;transition:opacity .15s;}
.tx-swipe-bg-right{position:absolute;left:0;top:0;bottom:0;width:82px;background:var(--accent-dim);border-radius:18px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;z-index:0;opacity:0;transition:opacity .15s;}
.tx-wrap.swiping .tx-swipe-bg-left{opacity:1;}
.tx-wrap.swiping-edit .tx-swipe-bg-right{opacity:1;}
/* ── QUICK ADD TEMPLATES ── */
.quick-add-row{display:flex;gap:7px;overflow-x:auto;padding:0 20px 10px;scrollbar-width:none;}
.quick-add-row::-webkit-scrollbar{display:none;}
.qa-chip{flex-shrink:0;background:var(--bg1);border:1.5px solid var(--blue);border-radius:12px;padding:7px 12px;cursor:pointer;display:flex;flex-direction:column;align-items:flex-start;gap:2px;transition:all .18s;min-width:100px;}
.qa-chip:active{background:var(--blue-dim);}
.qa-chip-label{font-size:.68rem;font-weight:700;color:var(--text2);white-space:nowrap;}
.qa-chip-amt{font-family:'Playfair Display',serif;font-size:.88rem;font-weight:700;color:var(--blue);}
.qa-chip-freq{font-size:.58rem;color:var(--text3);font-weight:600;}
/* ── PROJECTION INLINE ── */
.projection-inline{font-size:.67rem;font-weight:600;padding:4px 2px;display:block;margin-top:4px;}
.spend-alerts{}
/* ── PIN MODAL ── */
.pin-overlay{position:fixed;inset:0;z-index:9000;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:32px 24px;}
.pin-overlay.hidden{display:none;}
.pin-title{font-family:'Playfair Display',serif;font-size:1.5rem;font-weight:900;margin-bottom:6px;text-align:center;}
.pin-sub{font-size:.78rem;color:var(--text3);text-align:center;margin-bottom:28px;}
.pin-dots{display:flex;gap:12px;margin-bottom:28px;}
.pin-dot{width:14px;height:14px;border-radius:50%;border:2px solid var(--border2);background:transparent;transition:all .15s;}
.pin-dot.filled{background:var(--accent);border-color:var(--accent);}
.pin-keypad{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;width:100%;max-width:280px;}
.pin-key{height:64px;border-radius:16px;border:1.5px solid var(--border2);background:var(--bg1);font-family:'Playfair Display',serif;font-size:1.5rem;font-weight:700;color:var(--text);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .12s;}
.pin-key:active{background:var(--bg2);border-color:var(--accent);transform:scale(.94);}
.pin-key.del{font-size:1rem;color:var(--text3);}
.pin-key.empty{border:none;background:transparent;pointer-events:none;}
.pin-error{color:var(--red);font-size:.78rem;font-weight:700;margin-top:-16px;margin-bottom:8px;height:20px;}
/* ── CUSTOM CONFIRM MODAL ── */
.confirm-overlay{position:fixed;inset:0;z-index:500;background:#00000085;display:flex;align-items:flex-end;justify-content:center;opacity:0;pointer-events:none;transition:opacity .25s;}
.confirm-overlay.open{opacity:1;pointer-events:all;}
.confirm-inner{width:100%;max-width:430px;background:var(--bg1);border-radius:22px 22px 0 0;padding:22px 22px calc(env(safe-area-inset-bottom,20px)+20px);transform:translateY(100%);transition:transform .3s cubic-bezier(.32,0,.67,0);}
.confirm-overlay.open .confirm-inner{transform:translateY(0);}
.confirm-icon{font-size:2rem;text-align:center;margin-bottom:8px;}
.confirm-title{font-family:'Playfair Display',serif;font-size:1.2rem;font-weight:900;text-align:center;margin-bottom:6px;}
.confirm-msg{font-size:.78rem;color:var(--text3);text-align:center;line-height:1.7;margin-bottom:20px;}
.confirm-btns{display:flex;gap:10px;}
.confirm-btn{flex:1;padding:14px;border:none;border-radius:13px;font-family:'Plus Jakarta Sans',sans-serif;font-size:.88rem;font-weight:700;cursor:pointer;transition:all .15s;}
.confirm-btn:active{transform:scale(.97);}
.confirm-btns{display:flex;flex-direction:column;gap:8px;}
.confirm-btn-row{display:flex;gap:10px;}
.confirm-cancel{background:var(--bg2);color:var(--text2);}
.confirm-ok{background:var(--red);color:#fff;}
.confirm-secondary{background:var(--bg2);color:var(--accent);border:1.5px solid var(--accent);}
.date-group{margin-bottom:4px;}
.date-hdr{display:flex;align-items:center;gap:10px;padding:12px 0 7px;}
.date-hdr-label{font-size:.67rem;font-weight:700;letter-spacing:1.2px;text-transform:uppercase;color:var(--text3);flex-shrink:0;}
.date-hdr-line{flex:1;height:1px;background:var(--border);}
.date-hdr-total{font-size:.67rem;font-weight:700;color:var(--text3);}
/* overflow:hidden handled per tx-wrap below */

.tx{display:flex;align-items:center;gap:12px;background:var(--bg1);border:1px solid var(--border);border-radius:18px;padding:13px 15px;cursor:pointer;transition:border-color .2s,background .15s;position:relative;overflow:hidden;z-index:1;will-change:transform;}
.tx.open{border-color:var(--border2);background:var(--bg2);}
.tx-glow{position:absolute;left:-20px;top:50%;transform:translateY(-50%);width:60px;height:60px;border-radius:50%;pointer-events:none;opacity:.35;}
.tx-icon{width:42px;height:42px;border-radius:13px;display:flex;align-items:center;justify-content:center;font-size:1.25rem;flex-shrink:0;position:relative;z-index:1;}
.tx-icon.income{background:var(--green-dim);}
.tx-icon.expense{background:var(--red-dim);}
.tx-icon.savings{background:var(--accent-dim);}
.tx-body{flex:1;min-width:0;z-index:1;}
.tx-name{font-size:.87rem;font-weight:600;color:var(--text);margin-bottom:2px;display:flex;align-items:center;gap:5px;}
.tx-note{font-size:.71rem;color:var(--text3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.tx-right{display:flex;flex-direction:column;align-items:flex-end;gap:3px;z-index:1;}
.tx-amt{font-family:'Playfair Display',serif;font-size:.98rem;font-weight:700;}
.recur-dot{display:inline-block;width:5px;height:5px;border-radius:50%;background:var(--blue);flex-shrink:0;}
.tx-recur-tag{font-size:.58rem;color:var(--blue);font-weight:700;}
/* ── RECUR FREQUENCY ── */
.recur-freq-wrap{display:flex;gap:7px;margin-top:10px;}
.recur-freq-btn{flex:1;padding:9px 6px;border-radius:11px;border:1.5px solid var(--border2);background:var(--bg2);color:var(--text3);font-family:'Plus Jakarta Sans',sans-serif;font-size:.78rem;font-weight:700;cursor:pointer;text-align:center;transition:all .18s;}
.recur-freq-btn.active{border-color:var(--blue);background:var(--blue-dim);color:var(--blue);}
.tx-actions{display:flex;gap:8px;padding:2px 0 10px;}
.act{flex:1;padding:10px;border-radius:12px;font-family:'Plus Jakarta Sans',sans-serif;font-size:.78rem;font-weight:700;cursor:pointer;border:1.5px solid;transition:all .15s;}
.act-edit{color:var(--accent);border-color:var(--accent-dim);background:var(--accent-dim);}
.act-del{color:var(--red);border-color:var(--red-dim);background:var(--red-dim);}
.act-cancel{color:var(--text3);border-color:var(--border);background:transparent;}
.act-confirm{color:var(--red);border-color:var(--red-dim);background:var(--red-dim);}
.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:60px 30px;color:var(--text3);text-align:center;gap:12px;}
.empty-icon{font-size:2.8rem;}
.empty-txt{font-size:.84rem;line-height:1.7;}

/* ── DASHBOARD ── */
.dash-body{padding-bottom:20px;}
.section{padding:0 20px;margin-bottom:24px;}
.section-title{font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:700;margin-bottom:4px;}
.section-sub{font-size:.71rem;color:var(--text3);margin-bottom:12px;}

/* HIGHLIGHTS ROW */
.hl-row{display:flex;gap:8px;overflow-x:auto;scrollbar-width:none;padding-bottom:2px;}
.hl-row::-webkit-scrollbar{display:none;}
.hl-mini{flex-shrink:0;width:140px;background:var(--bg1);border:1px solid var(--border);border-radius:18px;padding:14px;}
.hl-mini-icon{font-size:1.3rem;margin-bottom:6px;}
.hl-mini-label{font-size:.6rem;text-transform:uppercase;letter-spacing:.8px;color:var(--text3);font-weight:700;margin-bottom:4px;}
.hl-mini-val{font-family:'Playfair Display',serif;font-size:.95rem;font-weight:700;margin-bottom:2px;}
.hl-mini-sub{font-size:.65rem;color:var(--text3);}

/* SIDE BY SIDE */
.sbs-card{background:var(--bg1);border:1px solid var(--border);border-radius:18px;overflow:hidden;}
.sbs-header{display:grid;grid-template-columns:100px 1fr 1fr 80px;background:var(--bg2);border-bottom:1px solid var(--border);padding:9px 14px;gap:4px;}
.sbs-th{font-size:.6rem;font-weight:700;text-transform:uppercase;letter-spacing:.7px;color:var(--text3);}
.sbs-th.right{text-align:right;}
.sbs-th.cur{color:var(--accent);}
.sbs-row{display:grid;grid-template-columns:100px 1fr 1fr 80px;padding:11px 14px;border-bottom:1px solid var(--border);gap:4px;align-items:center;}
.sbs-row:last-child{border-bottom:none;}
.sbs-label{font-size:.72rem;color:var(--text3);font-weight:600;}
.sbs-val{font-size:.82rem;font-weight:700;font-family:'Playfair Display',serif;text-align:right;}
.sbs-delta{font-size:.7rem;font-weight:700;text-align:right;white-space:nowrap;}
.d-up{color:var(--green);}
.d-dn{color:var(--red);}
.d-neu{color:var(--text3);}

/* TREND CHART */
.chart-card{background:var(--bg1);border:1px solid var(--border);border-radius:18px;padding:16px 12px 12px;overflow:hidden;}
.metric-tabs{display:flex;gap:5px;margin-bottom:14px;overflow-x:auto;scrollbar-width:none;}
.metric-tabs::-webkit-scrollbar{display:none;}
.metric-tab{flex-shrink:0;padding:6px 12px;border-radius:99px;font-size:.68rem;font-weight:700;cursor:pointer;border:1.5px solid var(--border);background:transparent;color:var(--text3);transition:all .18s;}
.mt-inc{border-color:var(--green)!important;color:var(--green)!important;background:var(--green-dim)!important;}
.mt-exp{border-color:var(--red)!important;color:var(--red)!important;background:var(--red-dim)!important;}
.mt-sav{border-color:var(--accent)!important;color:var(--accent)!important;background:var(--accent-dim)!important;}
.mt-net{border-color:var(--blue)!important;color:var(--blue)!important;background:var(--blue-dim)!important;}
.bars{display:flex;align-items:flex-end;gap:5px;height:110px;margin-bottom:6px;}
.bar-col{flex:1;display:flex;flex-direction:column;align-items:center;}
.bar-col-val{font-size:.52rem;font-weight:700;margin-bottom:3px;white-space:nowrap;text-align:center;}
.bar-col-track{height:68px;width:100%;display:flex;align-items:flex-end;flex-shrink:0;}
.bar-rect{width:100%;border-radius:5px 5px 2px 2px;min-height:4px;transition:height .5s cubic-bezier(.34,1.56,.64,1);}
.bar-col-name{font-size:.52rem;font-weight:700;margin-top:5px;text-align:center;}
.bar-col.is-cur .bar-col-name{color:var(--accent);}

/* DONUT */
.donut-card{background:var(--bg1);border:1px solid var(--border);border-radius:18px;padding:16px;}
.donut-row{display:flex;align-items:center;gap:16px;}
.donut-legend{flex:1;}
.donut-item{display:flex;align-items:center;gap:7px;margin-bottom:8px;}
.donut-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.donut-name{font-size:.72rem;font-weight:600;color:var(--text2);flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.donut-val{font-size:.72rem;font-weight:700;}
.donut-pct{font-size:.6rem;color:var(--text3);}

/* SAVINGS RING */
.ring-card{display:flex;align-items:center;gap:18px;background:var(--bg1);border:1px solid var(--border);border-radius:18px;padding:16px 18px;}
.ring-label{font-size:.62rem;text-transform:uppercase;letter-spacing:1px;color:var(--text3);font-weight:700;margin-bottom:4px;}
.ring-pct{font-family:'Playfair Display',serif;font-size:1.7rem;font-weight:900;line-height:1;}
.ring-sub{font-size:.69rem;color:var(--text3);margin-top:4px;}

/* ── BILL CALENDAR ── */
.cal-header{display:flex;align-items:center;justify-content:space-between;padding:0 20px 14px;}
.cal-month-label{font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:900;}
.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:3px;padding:0 14px 10px;}
.cal-dow{text-align:center;font-size:.55rem;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;padding-bottom:4px;}
.cal-day{aspect-ratio:1;border-radius:10px;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;padding-top:5px;gap:2px;cursor:pointer;position:relative;transition:background .15s;}
.cal-day:active{background:var(--bg3);}
.cal-day.today .cal-day-num{background:var(--accent);color:var(--bg);border-radius:50%;width:22px;height:22px;display:flex;align-items:center;justify-content:center;}
.cal-day.other-month{opacity:.25;}
.cal-day.future{opacity:.38;}
.cal-day-num{font-size:.72rem;font-weight:700;line-height:1;width:22px;height:22px;display:flex;align-items:center;justify-content:center;}
.cal-dots{display:flex;gap:2px;flex-wrap:wrap;justify-content:center;max-width:90%;}
.cal-dot{width:5px;height:5px;border-radius:50%;flex-shrink:0;}
.cal-legend{padding:0 20px 10px;display:flex;flex-wrap:wrap;gap:8px;}
.cal-legend-item{display:flex;align-items:center;gap:5px;font-size:.65rem;font-weight:600;color:var(--text2);}
.cal-bill-list{padding:0 20px;margin-bottom:16px;}
.cal-bill-day-header{font-size:.65rem;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--text3);margin:12px 0 6px;}
.cal-bill-row{display:flex;align-items:center;gap:10px;background:var(--bg1);border:1px solid var(--border);border-radius:13px;padding:10px 13px;margin-bottom:6px;}
.cal-bill-icon{width:34px;height:34px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0;}
.cal-bill-info{flex:1;min-width:0;}
.cal-bill-name{font-size:.82rem;font-weight:700;color:var(--text);}
.cal-bill-meta{font-size:.63rem;color:var(--text3);margin-top:1px;}
.cal-bill-amt{font-family:'Playfair Display',serif;font-size:.92rem;font-weight:700;}
.cal-bill-badge{font-size:.58rem;font-weight:700;padding:2px 7px;border-radius:99px;white-space:nowrap;}
.cal-empty{text-align:center;padding:40px 20px;color:var(--text3);font-size:.82rem;line-height:1.7;}

/* BOTTOM NAV */
.bottom-nav{position:absolute;bottom:0;left:0;right:0;height:var(--nav-h);background:linear-gradient(to top,var(--bg) 60%,transparent);border-top:1px solid var(--border);display:flex;align-items:flex-start;padding:10px 16px 0;gap:8px;z-index:50;}
.nav-btn{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;padding:8px 4px;border-radius:14px;cursor:pointer;border:none;background:transparent;transition:all .18s;}
.nav-btn.active{background:var(--bg2);}
.nav-icon{font-size:1.25rem;line-height:1;}
.nav-lbl{font-size:.57rem;font-weight:700;color:var(--text3);letter-spacing:.6px;text-transform:uppercase;}
.nav-btn.active .nav-lbl{color:var(--text);}
/* ── NAV BADGE ── */
.nav-icon-wrap{position:relative;display:inline-flex;}
.nav-badge{
  position:absolute;top:-5px;right:-9px;
  min-width:16px;height:16px;
  background:var(--red);color:#fff;
  font-size:.55rem;font-weight:800;
  border-radius:99px;padding:0 4px;
  display:flex;align-items:center;justify-content:center;
  border:2px solid var(--bg);
  line-height:1;
  opacity:0;transform:scale(0);
  transition:opacity .2s,transform .25s cubic-bezier(.34,1.56,.64,1);
  pointer-events:none;
}
.nav-badge.visible{opacity:1;transform:scale(1);}
.fab-wrap{flex-shrink:0;display:flex;align-items:flex-start;position:relative;z-index:51;}
.fab{width:56px;height:56px;border-radius:18px;background:var(--accent);border:none;font-size:1.8rem;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 24px var(--accent-dim),0 8px 40px #00000050;transition:transform .2s;margin-top:-8px;color:var(--bg);font-weight:900;}
.fab:active{transform:scale(.92);}
/* Speed-dial — horizontal arc */
.fab-dial{position:absolute;bottom:calc(100% + 20px);left:50%;transform:translateX(-50%);width:210px;display:flex;flex-direction:row;align-items:flex-end;justify-content:center;gap:12px;pointer-events:none;}
.fab-dial.open{pointer-events:all;}
/* Each button starts collapsed at center and flies to its arc position */
.fab-dial-btn{width:56px;height:56px;border-radius:50%;border:none;cursor:pointer;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;box-shadow:0 4px 20px #00000060;
  opacity:0;transform:translateY(16px) scale(.7);transition:opacity .22s,transform .22s;}
.fab-dial.open .fab-dial-btn:nth-child(1){opacity:1;transform:translateY(10px) scale(1);transition-delay:.04s;}
.fab-dial.open .fab-dial-btn:nth-child(2){opacity:1;transform:translateY(0px) scale(1);transition-delay:.02s;}
.fab-dial.open .fab-dial-btn:nth-child(3){opacity:1;transform:translateY(10px) scale(1);transition-delay:.04s;}
.fab-dial-btn:active{opacity:.85;transform:scale(.9) translateY(var(--btn-y,0px))!important;}
.fab-dial-btn:nth-child(1){--btn-y:10px;}
.fab-dial-btn:nth-child(3){--btn-y:10px;}
.fab-dial-icon{font-size:1.25rem;line-height:1;}
.fab-dial-lbl{font-size:.46rem;font-weight:800;letter-spacing:.5px;text-transform:uppercase;}
.fab-dial-income{background:var(--green);}
.fab-dial-expense{background:var(--red);}
.fab-dial-savings{background:var(--accent);}
.fab-backdrop{position:fixed;inset:0;z-index:49;display:none;}
.fab-backdrop.open{display:block;}

/* SETTINGS */
.settings-card{background:var(--bg1);border:1px solid var(--border);border-radius:18px;padding:18px;margin-bottom:10px;display:flex;gap:14px;align-items:flex-start;}
.settings-icon{width:44px;height:44px;border-radius:13px;display:flex;align-items:center;justify-content:center;font-size:1.3rem;flex-shrink:0;}
.settings-body{flex:1;min-width:0;}
.settings-title{font-family:'Playfair Display',serif;font-size:.98rem;font-weight:700;margin-bottom:3px;}
.settings-desc{font-size:.74rem;color:var(--text3);line-height:1.6;margin-bottom:10px;}
.settings-btn{display:block;width:100%;padding:11px 14px;border-radius:11px;font-family:'Plus Jakarta Sans',sans-serif;font-size:.78rem;font-weight:700;cursor:pointer;border:none;text-align:center;transition:all .18s;}
.settings-btn:active{transform:scale(.97);}
.btn-accent{background:var(--accent-dim);color:var(--accent);border:1.5px solid var(--border2);}
.btn-green{background:var(--green-dim);color:var(--green);border:1.5px solid var(--border2);}
.btn-red{background:var(--red-dim);color:var(--red);border:1.5px solid var(--border2);}
.btn-blue{background:var(--blue-dim);color:var(--blue);border:1.5px solid var(--border2);}

/* THEME PICKER */
.theme-row{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:4px;}
.theme-btn{padding:10px 4px;border-radius:12px;font-size:.7rem;font-weight:700;cursor:pointer;border:2px solid transparent;transition:all .2s;text-align:center;line-height:1.3;}
.theme-btn.dark{background:#141420;color:#ede8e0;border-color:#252538;}
.theme-btn.pink{background:#2e1426;color:#f472b6;border-color:#5c2846;}
.theme-btn.white{background:#f0ede8;color:#1a1814;border-color:#ccc8c0;}
.theme-btn.navy{background:#0d1626;color:#60a5fa;border-color:#1d2d55;}
.theme-btn.ice{background:#102535;color:#06b6d4;border-color:#234560;}
.theme-btn.forest{background:#0b1c15;color:#10b981;border-color:#1c3a28;}
.theme-btn.sunset{background:#221500;color:#f97316;border-color:#503400;}
.theme-btn.midnight{background:#120c2c;color:#a855f7;border-color:#2e2460;}
.theme-btn.active-theme{border-color:var(--accent)!important;box-shadow:0 0 0 2px var(--accent-dim);}

/* CYCLE MODE SELECTOR */
.cycle-mode-row{display:flex;flex-direction:column;gap:8px;margin-top:4px;}
.cycle-mode-opt{display:flex;align-items:flex-start;gap:10px;padding:10px 12px;border-radius:12px;border:1.5px solid var(--border);cursor:pointer;transition:all .18s;}
.cycle-mode-opt.selected{border-color:var(--accent);background:var(--accent-dim);}
.cmo-radio{width:16px;height:16px;border-radius:50%;border:2px solid var(--text3);flex-shrink:0;margin-top:2px;display:flex;align-items:center;justify-content:center;transition:all .18s;}
.cycle-mode-opt.selected .cmo-radio{border-color:var(--accent);}
.cmo-radio-dot{width:7px;height:7px;border-radius:50%;background:var(--accent);display:none;}
.cycle-mode-opt.selected .cmo-radio-dot{display:block;}
.cmo-text{}
.cmo-title{font-size:.85rem;font-weight:700;color:var(--text);}
.cmo-sub{font-size:.7rem;color:var(--text3);margin-top:2px;}

/* CYCLE SETUP FIELDS */
.cycle-fields{background:var(--bg2);border-radius:12px;padding:12px;margin-top:8px;display:flex;flex-direction:column;gap:8px;}
.cf-row{display:flex;align-items:center;gap:8px;}
.cf-label{font-size:.75rem;font-weight:600;color:var(--text2);flex:1;}
.cf-input{background:var(--bg1);border:1.5px solid var(--border2);border-radius:9px;padding:7px 11px;color:var(--text);font-family:'Playfair Display',serif;font-size:.95rem;font-weight:700;outline:none;width:70px;text-align:center;}
.cf-input:focus{border-color:var(--accent);}
.cf-note{font-size:.68rem;color:var(--text3);line-height:1.5;}

/* BOTTOM SHEET */
.sheet-overlay{position:fixed;inset:0;background:#00000080;z-index:100;opacity:0;pointer-events:none;transition:opacity .25s;}
.sheet-overlay.active{opacity:1;pointer-events:all;}
.sheet{position:fixed;bottom:0;left:50%;transform:translateX(-50%) translateY(100%);width:100%;max-width:430px;background:var(--bg1);border-radius:24px 24px 0 0;z-index:101;transition:transform .3s cubic-bezier(.32,0,.67,0);max-height:92vh;overflow-y:auto;scrollbar-width:none;padding-bottom:env(safe-area-inset-bottom,20px);}
.sheet::-webkit-scrollbar{display:none;}
.sheet.open{transform:translateX(-50%) translateY(0);}
.sheet-handle{width:36px;height:4px;background:var(--border2);border-radius:99px;margin:12px auto 0;}
.sheet-header{padding:13px 20px 5px;display:flex;align-items:center;justify-content:space-between;}
.sheet-title{font-family:'Playfair Display',serif;font-size:1.3rem;font-weight:900;}
.sheet-title em{color:var(--accent);font-style:normal;}
.sheet-close{background:var(--bg2);border:1.5px solid var(--border2);border-radius:10px;width:31px;height:31px;font-size:.9rem;cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--text2);}
.add-body{padding:6px 20px 28px;}
.form-section{margin-bottom:16px;}
.form-lbl{font-size:.62rem;text-transform:uppercase;letter-spacing:1.2px;color:var(--text3);font-weight:700;margin-bottom:8px;display:flex;align-items:center;gap:6px;}
.form-lbl::after{content:'';flex:1;height:1px;background:var(--border);}
.date-field{width:100%;background:var(--bg2);border:1.5px solid var(--border2);border-radius:13px;padding:12px 15px;color:var(--text);font-family:'Plus Jakarta Sans',sans-serif;font-size:.93rem;font-weight:500;outline:none;-webkit-appearance:none;transition:border-color .2s;}
.date-field:focus{border-color:var(--accent);}
.cat-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:7px;}
.cat-tile{background:var(--bg2);border:1.5px solid var(--border);border-radius:14px;padding:10px 6px 8px;text-align:center;cursor:pointer;transition:all .18s;}
.cat-tile.sel-income{border-color:var(--green);background:var(--green-dim);box-shadow:0 0 14px var(--green-dim);}
.cat-tile.sel-expense{border-color:var(--red);background:var(--red-dim);box-shadow:0 0 14px var(--red-dim);}
.cat-tile.sel-savings{border-color:var(--accent);background:var(--accent-dim);box-shadow:0 0 14px var(--accent-dim);}
.cat-icon{font-size:1.25rem;display:block;margin-bottom:3px;}
.cat-name{font-size:.6rem;color:var(--text3);font-weight:600;}
.cat-tile.sel-income .cat-name{color:var(--green);}
.cat-tile.sel-expense .cat-name{color:var(--red);}
.cat-tile.sel-savings .cat-name{color:var(--accent);}
.amt-wrap{background:var(--bg2);border:1.5px solid var(--border2);border-radius:14px;padding:3px 16px;display:flex;align-items:center;transition:border-color .2s;}
.amt-wrap:focus-within{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-dim);}
.amt-sym{font-family:'Playfair Display',serif;font-size:1.7rem;color:var(--text3);padding-right:4px;padding-top:2px;}
.amt-input{flex:1;background:transparent;border:none;outline:none;font-family:'Playfair Display',serif;font-size:2.5rem;font-weight:900;color:var(--text);padding:11px 0;width:100%;}
.amt-input::placeholder{color:var(--border2);}
.note-field{width:100%;background:var(--bg2);border:1.5px solid var(--border2);border-radius:13px;padding:12px 15px;color:var(--text);font-family:'Plus Jakarta Sans',sans-serif;font-size:.88rem;outline:none;resize:none;transition:border-color .2s;}
.note-field:focus{border-color:var(--accent);}
.note-field::placeholder{color:var(--text3);}
.toggle-row{display:flex;align-items:center;justify-content:space-between;background:var(--bg2);border:1.5px solid var(--border2);border-radius:13px;padding:12px 15px;}
.toggle-label{font-size:.87rem;font-weight:600;color:var(--text);}
.toggle-sub{font-size:.69rem;color:var(--text3);}
.toggle{width:44px;height:25px;background:var(--bg3);border-radius:99px;position:relative;cursor:pointer;border:1.5px solid var(--border2);transition:background .2s;flex-shrink:0;}
.toggle.on{background:var(--blue);border-color:var(--blue);}
.toggle::after{content:'';position:absolute;width:17px;height:17px;background:#fff;border-radius:50%;top:2px;left:2px;transition:transform .2s;}
.toggle.on::after{transform:translateX(19px);}
.save-btn{width:100%;padding:16px;border:none;border-radius:14px;font-family:'Plus Jakarta Sans',sans-serif;font-size:.93rem;font-weight:700;cursor:pointer;transition:all .18s;letter-spacing:.3px;margin-top:6px;}
.save-btn:active{transform:scale(.98);}
.save-btn:disabled{opacity:.25;pointer-events:none;}
.btn-income{background:var(--green);color:#fff;}
.btn-expense{background:var(--red);color:#fff;}
.btn-savings{background:var(--accent);color:var(--bg);}
.toast{display:flex;align-items:center;justify-content:center;gap:8px;background:var(--green-dim);color:var(--green);border:1px solid var(--border2);border-radius:11px;padding:9px 16px;font-size:.8rem;font-weight:700;margin-bottom:12px;animation:fadeUp .3s ease;}
.sc-inline-toast{border-radius:10px;padding:9px 13px;font-size:.78rem;font-weight:700;margin-top:10px;text-align:center;animation:fadeUp .25s ease;}
.sc-inline-toast.ok{background:var(--green-dim);color:var(--green);border:1px solid var(--border2);}
.sc-inline-toast.err{background:var(--red-dim);color:var(--red);border:1px solid var(--red);}
/* Undo delete toast */
.undo-toast{position:fixed;bottom:calc(var(--nav-h) + 14px);left:50%;transform:translateX(-50%);width:calc(100% - 32px);max-width:398px;z-index:400;background:var(--bg1);border:1.5px solid var(--border2);border-radius:16px;padding:13px 16px;display:flex;align-items:center;gap:12px;box-shadow:0 8px 32px #00000070;animation:slideUp .3s cubic-bezier(.34,1.56,.64,1);}
.undo-toast-text{flex:1;font-size:.83rem;font-weight:600;color:var(--text);}
.undo-toast-sub{font-size:.68rem;color:var(--text3);margin-top:1px;}
.undo-progress{position:absolute;bottom:0;left:0;height:3px;background:var(--red);border-radius:0 0 16px 16px;transition:width linear;}
.undo-btn{flex-shrink:0;padding:8px 16px;border-radius:10px;border:none;background:var(--accent);color:var(--bg);font-family:'Plus Jakarta Sans',sans-serif;font-size:.78rem;font-weight:800;cursor:pointer;transition:all .15s;}
.undo-btn:active{transform:scale(.95);}
@keyframes slideUp{from{opacity:0;transform:translateX(-50%) translateY(20px);}to{opacity:1;transform:translateX(-50%) translateY(0);}}

@keyframes fadeUp{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.date-err{background:var(--red-dim);color:var(--red);border:1px solid var(--border2);border-radius:11px;padding:9px 15px;font-size:.8rem;font-weight:600;margin-bottom:12px;display:none;}

/* BUDGET MODAL */
.budget-modal{display:none;position:fixed;inset:0;z-index:200;background:#00000090;align-items:flex-end;justify-content:center;}
.budget-modal.open{display:flex;}

/* SAVINGS GOAL FIELD */
.goal-wrap{position:relative;}
.goal-input{width:100%;background:var(--bg2);border:1.5px solid var(--accent-dim);border-radius:13px;padding:12px 15px;color:var(--text);font-family:'Plus Jakarta Sans',sans-serif;font-size:.88rem;outline:none;transition:border-color .2s;}
.goal-input:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-dim);}
.goal-input::placeholder{color:var(--text3);}
.goal-suggestions{position:absolute;top:calc(100% + 4px);left:0;right:0;background:var(--bg1);border:1.5px solid var(--border2);border-radius:13px;z-index:50;overflow:hidden;box-shadow:0 8px 24px #00000050;display:none;}
.goal-suggestions.open{display:block;}
.goal-sug-item{padding:10px 15px;font-size:.85rem;font-weight:600;color:var(--text);cursor:pointer;display:flex;align-items:center;gap:8px;transition:background .15s;}
.goal-sug-item:active,.goal-sug-item:hover{background:var(--bg2);}
.goal-sug-dot{width:8px;height:8px;border-radius:50%;background:var(--accent);flex-shrink:0;}
.goal-tag{display:inline-flex;align-items:center;gap:4px;background:var(--accent-dim);border:1px solid var(--border2);border-radius:6px;padding:2px 7px;font-size:.62rem;font-weight:700;color:var(--accent);margin-left:4px;}

/* SAVINGS GOALS DASHBOARD SECTION */
.goals-grid{display:flex;flex-direction:column;gap:8px;}
.goal-card{background:var(--bg1);border:1px solid var(--border);border-radius:16px;padding:14px 16px;display:flex;align-items:center;gap:14px;}
.goal-card-rank{font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:900;color:var(--text3);width:24px;text-align:center;flex-shrink:0;}
.goal-card-body{flex:1;min-width:0;}
.goal-card-name{font-size:.88rem;font-weight:700;color:var(--text);margin-bottom:3px;}
.goal-card-meta{font-size:.67rem;color:var(--text3);}
.goal-card-amt{font-family:'Playfair Display',serif;font-size:1rem;font-weight:900;color:var(--accent);text-align:right;flex-shrink:0;}
.goal-bar-track{height:4px;background:var(--bg3);border-radius:99px;overflow:hidden;margin-top:6px;}
.goal-bar-fill{height:100%;border-radius:99px;background:var(--accent);transition:width .6s ease;}

/* ══ CREDIT CARD ══ */
--purple:#a855f7;--purple-dim:#a855f718;
.cc-section{margin:10px 20px 12px;}
.cc-header-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
.cc-title{font-size:.62rem;text-transform:uppercase;letter-spacing:1.2px;color:var(--text3);font-weight:700;}
.cc-add-btn{font-size:.67rem;color:var(--accent);cursor:pointer;font-weight:700;background:var(--accent-dim);border:1px solid var(--border2);border-radius:7px;padding:4px 9px;}
.cc-card{background:var(--bg1);border:1px solid var(--border);border-radius:18px;padding:14px 15px;margin-bottom:7px;position:relative;overflow:hidden;}
.cc-card::before{content:'';position:absolute;top:-30px;right:-30px;width:100px;height:100px;background:radial-gradient(circle,#a855f718 0%,transparent 70%);pointer-events:none;}
.cc-card-top{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:10px;}
.cc-card-name{font-size:.88rem;font-weight:700;color:var(--text);display:flex;align-items:center;gap:6px;}
.cc-chip{font-size:.55rem;background:#a855f720;color:#a855f7;border:1px solid #a855f730;border-radius:5px;padding:2px 6px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;}
.cc-pay-btn{font-size:.67rem;font-weight:700;padding:5px 11px;border-radius:9px;border:1.5px solid var(--border2);background:var(--green-dim);color:var(--green);cursor:pointer;}
.cc-amounts{display:grid;grid-template-columns:1fr 1fr 1fr;gap:7px;margin-bottom:10px;}
.cc-amt-box{background:var(--bg2);border-radius:10px;padding:8px 10px;}
.cc-amt-lbl{font-size:.55rem;text-transform:uppercase;letter-spacing:.7px;color:var(--text3);font-weight:700;margin-bottom:3px;}
.cc-amt-val{font-family:'Playfair Display',serif;font-size:.88rem;font-weight:700;}
.cc-bar-row{display:flex;align-items:center;gap:8px;}
.cc-bar-track{flex:1;height:5px;background:var(--bg3);border-radius:99px;overflow:hidden;}
.cc-bar-fill{height:100%;border-radius:99px;transition:width .6s ease;}
.cc-bar-pct{font-size:.62rem;font-weight:700;color:var(--text3);flex-shrink:0;min-width:28px;text-align:right;}
.cc-del-btn{font-size:.65rem;color:var(--red);cursor:pointer;font-weight:600;padding:3px 7px;border-radius:6px;background:var(--red-dim);border:none;}
/* credit toggle in form */
.cc-picker-wrap{margin-top:10px;display:none;}
.cc-picker-wrap.open{display:block;}
.cc-picker{width:100%;background:var(--bg2);border:1.5px solid var(--border2);border-radius:13px;padding:12px 15px;color:var(--text);font-family:'Plus Jakarta Sans',sans-serif;font-size:.88rem;outline:none;}
.cc-picker:focus{border-color:#a855f7;}
.cc-hint{margin-top:6px;font-size:.7rem;color:#a855f7;font-weight:600;display:flex;align-items:center;gap:5px;}
/* Payment Method selector */
.pay-method-row{display:flex;gap:8px;margin-bottom:2px;}
.pay-method-btn{flex:1;display:flex;flex-direction:column;align-items:center;gap:5px;padding:13px 10px;border-radius:14px;border:1.5px solid var(--border2);background:var(--bg2);cursor:pointer;transition:all .18s;font-family:'Plus Jakarta Sans',sans-serif;}
.pay-method-btn.active{border-color:var(--red);background:var(--red-dim);box-shadow:0 0 14px var(--red-dim);}
.pay-method-icon{font-size:1.3rem;line-height:1;}
.pay-method-label{font-size:.72rem;font-weight:700;color:var(--text3);letter-spacing:.3px;}
.pay-method-btn.active .pay-method-label{color:var(--red);}
.pay-method-btn:active{transform:scale(.96);}
/* credit tag on transaction cards */
.cc-tag{display:inline-flex;align-items:center;gap:4px;background:#a855f718;border:1px solid #a855f730;border-radius:6px;padding:2px 7px;font-size:.58rem;font-weight:700;color:#a855f7;margin-left:4px;}
/* pay modal */
.pay-modal{display:none;position:fixed;inset:0;z-index:200;background:#00000090;align-items:flex-end;justify-content:center;}
.pay-modal.open{display:flex;}
.pay-inner{background:var(--bg1);border-radius:22px 22px 0 0;width:100%;max-width:430px;padding:20px 20px 40px;}
.pay-title{font-family:'Playfair Display',serif;font-size:1.15rem;font-weight:700;margin-bottom:3px;}
.pay-sub{font-size:.73rem;color:var(--text3);margin-bottom:16px;}
.pay-balance{background:var(--bg2);border-radius:13px;padding:12px 15px;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center;}
.pay-balance-lbl{font-size:.72rem;color:var(--text3);}
.pay-balance-val{font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:700;color:#a855f7;}
.pay-save{width:100%;padding:14px;border:none;border-radius:13px;background:#a855f7;color:#fff;font-family:'Plus Jakarta Sans',sans-serif;font-size:.9rem;font-weight:700;cursor:pointer;margin-top:4px;}
/* ══ WHAT'S NEW MODAL ══ */
.wn-overlay{position:fixed;inset:0;z-index:800;background:#00000090;display:flex;align-items:flex-end;justify-content:center;opacity:0;pointer-events:none;transition:opacity .3s;}
.wn-overlay.active{opacity:1;pointer-events:all;}
.wn-sheet{width:100%;max-width:430px;background:var(--bg1);border-radius:24px 24px 0 0;padding:0 0 env(safe-area-inset-bottom,28px);max-height:82vh;overflow:hidden;display:flex;flex-direction:column;transform:translateY(100%);transition:transform .35s cubic-bezier(.32,0,.67,0);}
.wn-overlay.active .wn-sheet{transform:translateY(0);}
.wn-handle{width:36px;height:4px;background:var(--border2);border-radius:99px;margin:14px auto 10px;flex-shrink:0;}
.wn-header{padding:4px 20px 14px;flex-shrink:0;}
.wn-title{font-family:'Playfair Display',serif;font-size:1.25rem;font-weight:900;margin-bottom:3px;}
.wn-sub{font-size:.73rem;color:var(--text3);}
.wn-body{overflow-y:auto;padding:0 20px 20px;flex:1;scrollbar-width:none;}
.wn-body::-webkit-scrollbar{display:none;}
.wn-item{display:flex;gap:14px;align-items:flex-start;padding:14px 0;border-bottom:1px solid var(--border);}
.wn-item:last-child{border-bottom:none;}
.wn-icon{width:44px;height:44px;border-radius:13px;display:flex;align-items:center;justify-content:center;font-size:1.35rem;flex-shrink:0;}
.wn-info{flex:1;min-width:0;}
.wn-name{font-size:.9rem;font-weight:700;color:var(--text);margin-bottom:3px;}
.wn-desc{font-size:.75rem;color:var(--text3);line-height:1.6;}
.wn-new-pill{display:inline-block;font-size:.55rem;font-weight:800;text-transform:uppercase;letter-spacing:.8px;background:var(--accent);color:var(--bg);border-radius:99px;padding:2px 7px;margin-left:6px;vertical-align:middle;}
/* ══ ONBOARDING ══ */
.ob-overlay{position:fixed;inset:0;z-index:900;background:#00000090;display:flex;align-items:flex-end;justify-content:center;opacity:0;pointer-events:none;transition:opacity .3s;}
.ob-overlay.active{opacity:1;pointer-events:all;}
.ob-sheet{width:100%;max-width:430px;background:var(--bg1);border-radius:24px 24px 0 0;padding:0 0 env(safe-area-inset-bottom,24px);height:88vh;max-height:88vh;overflow:hidden;display:flex;flex-direction:column;transform:translateY(100%);transition:transform .35s cubic-bezier(.32,0,.67,0);box-sizing:border-box;}
.ob-overlay.active .ob-sheet{transform:translateY(0);}
.ob-handle{width:36px;height:4px;background:var(--border2);border-radius:99px;margin:14px auto 0;flex-shrink:0;}
.ob-pages{position:relative;flex:1;overflow:hidden;width:100%;min-height:0;}
.ob-page{position:absolute;inset:0;padding:20px 24px 10px;overflow-y:auto;scrollbar-width:none;display:flex;flex-direction:column;box-sizing:border-box;opacity:0;pointer-events:none;transition:opacity .3s ease,transform .3s ease;transform:translateX(40px);}
.ob-page::-webkit-scrollbar{display:none;}
.ob-page.active{opacity:1;pointer-events:all;transform:translateX(0);}
.ob-emoji{font-size:2.8rem;margin-bottom:12px;text-align:center;}
.ob-title{font-family:'Playfair Display',serif;font-size:1.45rem;font-weight:900;text-align:center;margin-bottom:6px;line-height:1.2;}
.ob-title em{color:var(--accent);font-style:normal;}
.ob-sub{font-size:.78rem;color:var(--text3);text-align:center;line-height:1.7;margin-bottom:18px;}
.ob-steps{display:flex;flex-direction:column;gap:10px;margin-bottom:18px;}
.ob-step{display:flex;align-items:flex-start;gap:12px;background:var(--bg2);border:1px solid var(--border);border-radius:16px;padding:13px 14px;}
.ob-step-icon{font-size:1.3rem;flex-shrink:0;width:34px;height:34px;border-radius:10px;display:flex;align-items:center;justify-content:center;}
.ob-step-icon.c-acc{background:var(--accent-dim);}
.ob-step-icon.c-grn{background:var(--green-dim);}
.ob-step-icon.c-red{background:var(--red-dim);}
.ob-step-icon.c-blu{background:var(--blue-dim);}
.ob-step-body{}
.ob-step-title{font-size:.85rem;font-weight:700;color:var(--text);margin-bottom:2px;}
.ob-step-desc{font-size:.72rem;color:var(--text3);line-height:1.6;}
.ob-step-desc strong{color:var(--text2);}
.ob-tip{background:var(--accent-dim);border:1px solid var(--border2);border-radius:13px;padding:11px 14px;font-size:.74rem;color:var(--text2);line-height:1.65;margin-bottom:16px;}
.ob-tip strong{color:var(--accent);}
/* footer */
.ob-footer{flex-shrink:0;padding:12px 24px 6px;display:flex;flex-direction:column;gap:10px;border-top:1px solid var(--border);}
.ob-dots{display:flex;justify-content:center;gap:6px;}
.ob-dot{width:7px;height:7px;border-radius:99px;background:var(--border2);transition:all .25s;}
.ob-dot.active{background:var(--accent);width:20px;}
.ob-btn-row{display:flex;gap:8px;}
.ob-btn{flex:1;padding:13px;border:none;border-radius:13px;font-family:'Plus Jakarta Sans',sans-serif;font-size:.85rem;font-weight:700;cursor:pointer;transition:all .18s;}
.ob-btn:active{transform:scale(.97);}
.ob-btn-primary{background:var(--accent);color:var(--bg);}
.ob-btn-secondary{background:var(--bg2);color:var(--text2);border:1.5px solid var(--border2);}
.ob-btn-ghost{background:transparent;color:var(--text3);font-size:.75rem;text-align:center;padding:6px;}
.ob-currency-btn{background:var(--bg2);border:1.5px solid var(--border2);border-radius:12px;padding:11px 4px 9px;font-family:'Playfair Display',serif;font-size:1.15rem;font-weight:700;color:var(--text);cursor:pointer;text-align:center;transition:all .18s;display:flex;flex-direction:column;align-items:center;}
.ob-currency-btn.active-cur{border-color:var(--accent);background:var(--accent-dim);color:var(--accent);}
.ob-currency-btn:active{transform:scale(.93);}
.ob-pin-key{padding:12px 8px;border-radius:12px;border:1.5px solid var(--border2);background:var(--bg2);color:var(--text);font-family:'Plus Jakarta Sans',sans-serif;font-size:1.1rem;font-weight:700;cursor:pointer;transition:all .15s;}
.ob-pin-key:active{background:var(--accent-dim);border-color:var(--accent);color:var(--accent);}

/* ── GUIDE: progress bar ── */
.ob-progress-track{height:3px;background:var(--border);border-radius:99px;margin:10px 24px 0;flex-shrink:0;overflow:hidden;}
.ob-progress-fill{height:100%;background:var(--accent);border-radius:99px;transition:width .4s cubic-bezier(.34,1.56,.64,1);}

/* ── GUIDE: staggered intro cards ── */
.ob-intro-card{opacity:0;transform:translateY(16px);transition:opacity .35s ease, transform .35s ease;}
.ob-intro-card.visible{opacity:1;transform:translateY(0);}

/* ── GUIDE: currency quip ── */
.ob-currency-quip{font-size:.72rem;font-weight:700;color:var(--accent);text-align:center;min-height:20px;margin-top:4px;transition:opacity .2s;animation:quipPop .3s cubic-bezier(.34,1.56,.64,1);}
@keyframes quipPop{from{opacity:0;transform:scale(.85);}to{opacity:1;transform:scale(1);}}
.ob-currency-btn.active-cur{border-color:var(--accent);background:var(--accent-dim);color:var(--accent);animation:btnBounce .3s cubic-bezier(.34,1.56,.64,1);}
@keyframes btnBounce{0%{transform:scale(1);}40%{transform:scale(1.18);}100%{transform:scale(1);}}

/* ── GUIDE: confetti ── */
.ob-confetti-wrap{position:absolute;inset:0;pointer-events:none;overflow:hidden;z-index:10;}
.ob-confetti-piece{position:absolute;width:8px;height:8px;border-radius:2px;opacity:0;animation:confettiFall 1.8s ease-in forwards;}
@keyframes confettiFall{0%{opacity:1;transform:translateY(-10px) rotate(0deg);}100%{opacity:0;transform:translateY(600px) rotate(720deg);}}

/* ── GUIDE: page tag ── */
.ob-page-tag{font-size:.65rem;text-transform:uppercase;letter-spacing:1.2px;color:var(--accent);font-weight:700;text-align:center;margin-bottom:8px;}

/* ── GUIDE: inline tip ── */
.ob-inline-tip{font-size:.7rem;color:var(--text3);text-align:center;line-height:1.6;padding:8px 12px;background:var(--bg2);border-radius:10px;border:1px solid var(--border);}
.ob-inline-tip strong{color:var(--text2);}

/* ── GUIDE: theme cards ── */
.ob-theme-cards{display:flex;gap:10px;}
.ob-theme-card{flex:1;background:var(--bg2);border:2px solid var(--border);border-radius:16px;padding:12px 8px 10px;cursor:pointer;transition:all .2s;text-align:center;}
.ob-theme-card.active-g{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-dim);}
.ob-theme-preview{border-radius:10px;border:1.5px solid;padding:10px 8px 8px;margin-bottom:8px;}
.ob-theme-prev-bar{height:6px;border-radius:99px;width:70%;}
.ob-theme-prev-dot{width:10px;height:10px;border-radius:50%;display:inline-block;}
.ob-theme-name{font-size:.75rem;font-weight:700;color:var(--text);margin-bottom:2px;}
.ob-theme-sub{font-size:.62rem;color:var(--text3);line-height:1.4;}

/* ── GUIDE: setup block ── */
.ob-setup-block{background:var(--bg2);border:1px solid var(--border);border-radius:16px;padding:14px 16px;margin-bottom:8px;}
.ob-setup-label{font-size:.75rem;font-weight:700;color:var(--text2);margin-bottom:10px;text-transform:uppercase;letter-spacing:.6px;}

/* ── GUIDE: history limit controls ── */
.ob-limit-row{display:flex;align-items:center;gap:12px;justify-content:center;}
.ob-limit-minus,.ob-limit-plus{width:38px;height:38px;border-radius:50%;border:2px solid var(--border2);background:var(--bg1);color:var(--text);font-size:1.3rem;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .18s;flex-shrink:0;}
.ob-limit-minus:active,.ob-limit-plus:active{border-color:var(--accent);color:var(--accent);}
.ob-limit-display{display:flex;align-items:baseline;gap:5px;}
.ob-limit-num{font-family:'Playfair Display',serif;font-size:2.2rem;font-weight:900;color:var(--accent);line-height:1;}
.ob-limit-unit{font-size:.72rem;font-weight:600;color:var(--text3);}
.ob-limit-hint{font-size:.7rem;color:var(--text3);line-height:1.6;text-align:center;}

/* ── GUIDE: preset chips ── */
.ob-limit-presets,.ob-goal-chips{display:flex;flex-wrap:wrap;gap:7px;justify-content:center;}
.ob-chip{padding:7px 14px;border-radius:99px;border:1.5px solid var(--border2);background:var(--bg1);color:var(--text3);font-size:.72rem;font-weight:700;cursor:pointer;transition:all .18s;white-space:nowrap;}
.ob-chip:active,.ob-chip-sel{border-color:var(--accent);color:var(--accent);background:var(--accent-dim);}

/* ── GUIDE: goal preview ── */
.ob-goal-preview{font-size:.78rem;color:var(--text2);line-height:1.5;}
/* ══ PWA INSTALL BANNER ══ */
.pwa-banner{position:fixed;bottom:calc(var(--nav-h) + 10px);left:50%;transform:translateX(-50%);width:calc(100% - 32px);max-width:398px;background:var(--bg1);border:1.5px solid var(--border2);border-radius:18px;padding:14px 16px;z-index:300;display:flex;align-items:center;gap:12px;box-shadow:0 8px 32px #00000060;animation:slideUp .35s cubic-bezier(.34,1.56,.64,1);}
@keyframes slideUp{from{opacity:0;transform:translateX(-50%) translateY(20px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
.pwa-banner-icon{width:46px;height:46px;border-radius:12px;flex-shrink:0;display:flex;align-items:center;justify-content:center;}
.pwa-banner-text{flex:1;min-width:0;}
.pwa-banner-title{font-size:.85rem;font-weight:700;color:var(--text);margin-bottom:2px;}
.pwa-banner-sub{font-size:.68rem;color:var(--text3);line-height:1.4;}
.pwa-banner-install{flex-shrink:0;padding:8px 14px;border-radius:10px;border:none;background:var(--accent);color:var(--bg);font-family:'Plus Jakarta Sans',sans-serif;font-size:.75rem;font-weight:700;cursor:pointer;transition:all .15s;}
.pwa-banner-install:active{transform:scale(.95);}
.pwa-banner-close{flex-shrink:0;width:24px;height:24px;border-radius:50%;border:none;background:var(--bg3);color:var(--text3);font-size:.65rem;cursor:pointer;display:flex;align-items:center;justify-content:center;}
/* ios install sheet */
.ios-install-sheet{position:fixed;inset:0;z-index:500;background:#00000085;display:flex;align-items:flex-end;justify-content:center;opacity:0;pointer-events:none;transition:opacity .25s;}
.ios-install-sheet.open{opacity:1;pointer-events:all;}
.ios-install-inner{width:100%;max-width:430px;background:var(--bg1);border-radius:24px 24px 0 0;padding:20px 22px calc(env(safe-area-inset-bottom,20px) + 20px);transform:translateY(100%);transition:transform .35s cubic-bezier(.32,0,.67,0);}
.ios-install-sheet.open .ios-install-inner{transform:translateY(0);}
.ios-step{display:flex;align-items:flex-start;gap:13px;margin-bottom:14px;}
.ios-step-num{width:26px;height:26px;border-radius:50%;background:var(--accent);color:var(--bg);font-size:.72rem;font-weight:900;display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:1px;}
.ios-step-text{font-size:.83rem;color:var(--text2);line-height:1.55;}
.ios-step-text strong{color:var(--text);}

/* ── RECURRING DUE PROMPT ── */
.recur-prompt-overlay{position:fixed;inset:0;z-index:600;background:#00000088;display:flex;align-items:flex-end;justify-content:center;opacity:0;pointer-events:none;transition:opacity .25s;}
.recur-prompt-overlay.open{opacity:1;pointer-events:all;}
.recur-prompt-sheet{width:100%;max-width:430px;background:var(--bg1);border-radius:24px 24px 0 0;padding:22px 22px calc(env(safe-area-inset-bottom,0px)+22px);transform:translateY(100%);transition:transform .32s cubic-bezier(.32,0,.67,0);}
.recur-prompt-overlay.open .recur-prompt-sheet{transform:translateY(0);}
.recur-prompt-icon{font-size:2.2rem;text-align:center;margin-bottom:8px;}
.recur-prompt-title{font-family:'Playfair Display',serif;font-size:1.15rem;font-weight:900;text-align:center;margin-bottom:6px;}
.recur-prompt-msg{font-size:.8rem;color:var(--text3);text-align:center;line-height:1.7;margin-bottom:16px;}
.recur-prompt-list{background:var(--bg2);border:1px solid var(--border);border-radius:14px;padding:4px 0;margin-bottom:18px;max-height:180px;overflow-y:auto;scrollbar-width:none;}
.recur-prompt-list::-webkit-scrollbar{display:none;}
.recur-prompt-item{display:flex;align-items:center;gap:10px;padding:9px 14px;border-bottom:1px solid var(--border);}
.recur-prompt-item:last-child{border-bottom:none;}
.recur-pi-icon{font-size:1.2rem;flex-shrink:0;}
.recur-pi-info{flex:1;min-width:0;}
.recur-pi-label{font-size:.82rem;font-weight:700;color:var(--text);}
.recur-pi-date{font-size:.65rem;color:var(--text3);margin-top:1px;}
.recur-pi-amt{font-family:'Playfair Display',serif;font-size:.9rem;font-weight:700;color:var(--accent);flex-shrink:0;}
.recur-btn-row{display:flex;gap:8px;}
.recur-btn{flex:1;padding:14px;border:none;border-radius:13px;font-family:'Plus Jakarta Sans',sans-serif;font-size:.88rem;font-weight:700;cursor:pointer;transition:all .15s;}
.recur-btn:active{transform:scale(.97);}
.recur-btn-skip{background:var(--bg2);color:var(--text3);}
.recur-btn-add{background:var(--accent);color:var(--bg);}
/* ── BACKUP REMINDER MODAL ── */
.backup-overlay{position:fixed;inset:0;z-index:600;background:#00000088;display:flex;align-items:flex-end;justify-content:center;opacity:0;pointer-events:none;transition:opacity .25s;}
.backup-overlay.open{opacity:1;pointer-events:all;}
.backup-sheet{width:100%;max-width:430px;background:var(--bg1);border-radius:24px 24px 0 0;padding:22px 22px calc(env(safe-area-inset-bottom,20px)+22px);transform:translateY(100%);transition:transform .32s cubic-bezier(.32,0,.67,0);}
.backup-overlay.open .backup-sheet{transform:translateY(0);}
.backup-icon{font-size:2.4rem;text-align:center;margin-bottom:8px;}
.backup-title{font-family:'Playfair Display',serif;font-size:1.25rem;font-weight:900;text-align:center;margin-bottom:6px;}
.backup-msg{font-size:.8rem;color:var(--text3);text-align:center;line-height:1.7;margin-bottom:20px;}
.backup-btn-row{display:flex;gap:8px;}
.backup-btn{flex:1;padding:14px;border:none;border-radius:13px;font-family:'Plus Jakarta Sans',sans-serif;font-size:.88rem;font-weight:700;cursor:pointer;transition:all .15s;}
.backup-btn:active{transform:scale(.97);}
.backup-btn-skip{background:var(--bg2);color:var(--text3);}
.backup-btn-now{background:var(--accent);color:var(--bg);}
.backup-since{font-size:.72rem;font-weight:700;color:var(--accent);text-align:center;margin:-10px 0 16px;min-height:18px;}
.backup-auto-row{display:flex;align-items:center;gap:12px;background:var(--bg2);border:1.5px solid var(--border2);border-radius:13px;padding:11px 13px;margin-bottom:16px;}
/* Backup interval row in settings */
.backup-interval-row{display:flex;align-items:center;gap:8px;background:var(--bg2);border:1.5px solid var(--border2);border-radius:11px;padding:10px 13px;margin-top:8px;}
.bir-label{flex:1;font-size:.82rem;font-weight:600;color:var(--text2);}
.bir-input{width:54px;background:var(--bg1);border:1.5px solid var(--border2);border-radius:8px;padding:5px 8px;color:var(--text);font-family:'Playfair Display',serif;font-size:.95rem;font-weight:700;text-align:center;outline:none;}
.bir-input:focus{border-color:var(--accent);}
.bir-unit{font-size:.75rem;color:var(--text3);font-weight:600;}
/* ══════════════════════════════════════════
   RESPONSIVE — DYNAMIC PHONE LAYOUT
   All spacing scales with viewport width.
   Target: 320px – 430px phones
══════════════════════════════════════════ */

/* ── Fluid spacing tokens ──────────────── */
:root{
  /* Horizontal page padding: 14px @ 320px → 20px @ 430px+ */
  --pad:   clamp(14px, 4.2vw, 20px);
  /* Inner card/sheet padding */
  --pad-i: clamp(14px, 4vw, 20px);
  /* Small gaps */
  --gap:   clamp(6px, 1.8vw, 8px);
  /* Large border-radius (cards, sheets) */
  --r-lg:  clamp(16px, 5vw, 22px);
  /* Medium border-radius */
  --r-md:  clamp(14px, 4vw, 18px);
  /* Small border-radius */
  --r-sm:  clamp(10px, 3vw, 14px);
}

/* ── Layout ───────────────────────────── */
#app{ width:100%; }

/* ── Topbar ───────────────────────────── */
.topbar{ padding:calc(env(safe-area-inset-top,0px) + 14px) var(--pad) 0; }
.top-title{ font-size:clamp(1.25rem, 4.8vw, 1.55rem); }

/* ── Cycle nav ────────────────────────── */
.cycle-nav{ padding:0 var(--pad) 10px; }

/* ── Hero card ────────────────────────── */
.hero-card{ margin:0 var(--pad) 12px; padding:clamp(14px,3.8vw,20px) clamp(15px,4vw,22px) clamp(13px,3.5vw,18px); border-radius:var(--r-lg); }
.hero-amount{ font-size:clamp(1.85rem, 7vw, 2.4rem); }
.hero-amount .sign{ font-size:clamp(1rem, 3.8vw, 1.3rem); }
.hero-stat{ padding:clamp(8px,2.4vw,10px) clamp(9px,2.8vw,12px); }
.hs-val{ font-size:clamp(.78rem, 2.5vw, .88rem); }

/* ── Feed balance bar ─────────────────── */
.feed-balance-bar{ margin:0 var(--pad) 10px; padding:clamp(9px,2.8vw,12px) clamp(12px,3.5vw,16px); border-radius:clamp(12px,4vw,16px); }
.fbb-amount{ font-size:clamp(1.1rem, 4.2vw, 1.5rem); }

/* ── Budget section ───────────────────── */
.budget-section{ margin:0 var(--pad) 12px; }
.bm-inner{ padding:clamp(14px,4vw,18px) var(--pad-i) 40px; }

/* ── Search / filter / quick-add rows ── */
.search-wrap{ padding:0 var(--pad) 8px; }
.filter-wrap{ padding:0 var(--pad) 10px; gap:clamp(5px,1.5vw,6px); }
.quick-add-row{ padding:0 var(--pad) 10px; }
.qa-chip{ min-width:clamp(88px, 26vw, 110px); padding:6px clamp(9px,2.8vw,12px); }

/* ── Transactions ─────────────────────── */
.tx{ gap:clamp(9px,2.8vw,12px); padding:clamp(10px,3vw,13px) clamp(12px,3.5vw,15px); border-radius:clamp(14px,4.5vw,18px); }
.tx-icon{ width:clamp(36px,10.5vw,42px); height:clamp(36px,10.5vw,42px); border-radius:clamp(10px,3vw,13px); font-size:clamp(1.05rem,3.2vw,1.25rem); }
.tx-amt{ font-size:clamp(.85rem,2.8vw,.98rem); }
.tx-name{ font-size:clamp(.8rem,2.6vw,.87rem); }

/* ── Dashboard sections ───────────────── */
.section{ padding:0 var(--pad); margin-bottom:clamp(18px,5vw,24px); }
.section-title{ font-size:clamp(.95rem,3.2vw,1.1rem); }
.hl-mini{ width:clamp(120px,34vw,140px); }
.ring-pct{ font-size:clamp(1.35rem,5.5vw,1.7rem); }

/* SBS comparison table — fluid columns */
.sbs-header,
.sbs-row{ grid-template-columns:clamp(72px,22vw,100px) 1fr 1fr clamp(60px,18vw,80px); padding:clamp(8px,2.4vw,11px) clamp(10px,3vw,14px); }
.sbs-val,.sbs-delta{ font-size:clamp(.72rem,2.3vw,.82rem); }
.sbs-label{ font-size:clamp(.65rem,2vw,.72rem); }

/* ── Bottom sheet & modals ────────────── */
.sheet{ border-radius:clamp(18px,5vw,24px) clamp(18px,5vw,24px) 0 0; }
.sheet-header{ padding:13px var(--pad-i) 5px; }
.add-body{ padding:6px var(--pad-i) 28px; }
.confirm-inner{ border-radius:clamp(18px,5vw,22px) clamp(18px,5vw,22px) 0 0; padding:clamp(18px,4.5vw,22px) var(--pad-i) calc(env(safe-area-inset-bottom,20px)+20px); }
.pay-inner{ padding:var(--pad-i) var(--pad-i) 40px; }
.bm-inner{ border-radius:clamp(18px,5vw,22px) clamp(18px,5vw,22px) 0 0; }
.wn-header{ padding:4px var(--pad-i) 14px; }
.wn-body{ padding:0 var(--pad-i) 20px; }
.ob-page{ padding:clamp(16px,4.5vw,20px) var(--pad) 10px; }
.ob-footer{ padding:12px var(--pad) 6px; }
.ios-install-inner{ padding:var(--pad-i) var(--pad-i) calc(env(safe-area-inset-bottom,20px)+20px); }
.backup-sheet{ padding:var(--pad-i) var(--pad-i) calc(env(safe-area-inset-bottom,20px)+var(--pad-i)); }

/* ── Settings ─────────────────────────── */
.settings-card{ padding:clamp(14px,3.8vw,18px); gap:clamp(10px,3vw,14px); border-radius:clamp(14px,4.5vw,18px); }
.settings-icon{ width:clamp(38px,10vw,44px); height:clamp(38px,10vw,44px); }
.settings-title{ font-size:clamp(.88rem,2.9vw,.98rem); }

/* ── PIN keypad ───────────────────────── */
.pin-keypad{ max-width:clamp(240px,72vw,280px); gap:clamp(9px,2.8vw,12px); }
.pin-key{ height:clamp(54px,15vw,64px); font-size:clamp(1.25rem,4.5vw,1.5rem); border-radius:clamp(12px,4vw,16px); }

/* ── FAB / bottom nav ─────────────────── */
.bottom-nav{ padding:10px clamp(10px,3vw,16px) 0; }

/* ── Category grid (3-col) ─────────────── */
.cat-grid{ gap:clamp(5px,1.5vw,7px); }
.cat-tile{ padding:clamp(8px,2.4vw,10px) 4px clamp(6px,2vw,8px); border-radius:clamp(11px,3.5vw,14px); }
.cat-icon{ font-size:clamp(1.1rem,3.5vw,1.25rem); }
.cat-name{ font-size:clamp(.56rem,1.8vw,.6rem); }

/* ── Toast / undo toast ───────────────── */
.undo-toast{ width:calc(100% - calc(var(--pad)*2)); }
.pwa-banner{ width:calc(100% - calc(var(--pad)*2)); }

/* ══ EXTRA SMALL PHONES (≤ 360px) ══════ */
@media (max-width:360px){
  :root{ --pad:12px; --pad-i:13px; }
  .hero-amount{ font-size:1.7rem; }
  .top-title{ font-size:1.2rem; }
  .hero-grid{ gap:5px; }
  .hs-val{ font-size:.74rem; }
  .fbb-amount{ font-size:1rem; }
  .fab{ width:50px; height:50px; font-size:1.5rem; border-radius:14px; }
  .tx-icon{ width:34px; height:34px; }
  .amt-input{ font-size:2.1rem; }
  .sbs-th,.sbs-label{ font-size:.58rem; }
  .filter-chip{ font-size:.64rem; padding:5px 10px; }
  /* Compact budget cards on tiny screens */
  .budget-card{ padding:10px 11px; }
  .bc-name{ font-size:.76rem; }
}

/* ══ LARGE PHONES / small tablets (≥ 428px) ════ */
@media (min-width:428px){
  :root{ --pad:20px; --pad-i:20px; }
}

</style>
</head>
<body>
<div id="app">

<!-- ══ FEED VIEW ══ -->
<div class="view" id="view-feed">
  <div class="topbar">
    <div class="top-row">
      <div>
        <div class="top-title">Spend<span>oodle</span> <span style="font-family:'Plus Jakarta Sans',sans-serif;font-size:.55rem;font-weight:700;color:var(--text3);background:var(--bg2);border:1px solid var(--border2);border-radius:6px;padding:2px 6px;vertical-align:middle;letter-spacing:.3px;">v0.3</span></div>
        <div class="top-sub" id="cycle-mode-label">Pay-cycle tracker</div>
      </div>
      <div style="display:flex;align-items:center;gap:7px;">
        <div class="top-date" id="top-date-label"></div>
        <button class="icon-btn" id="whats-new-btn" onclick="openWhatsNew()" title="What's New" style="position:relative;">✨<span id="new-badge" style="position:absolute;top:-4px;right:-4px;width:8px;height:8px;background:var(--accent);border-radius:50%;border:1.5px solid var(--bg);display:block;"></span></button>
      </div>
    </div>
    <div class="cycle-nav">
      <button class="mnav-btn" id="mnav-prev" onclick="shiftCycle(-1)">‹</button>
      <div class="cycle-center">
        <div class="cycle-label" id="cycle-label"></div>
        <div class="cycle-range" id="cycle-range"></div>
      </div>
      <button class="mnav-btn" id="mnav-next" onclick="shiftCycle(1)">›</button>
    </div>

  </div>

  <div class="feed-balance-bar" id="feed-balance-bar">
    <div class="fbb-left">
      <div class="fbb-label">Balance Remaining</div>
      <div class="fbb-amount" id="fbb-amount">—</div>
      <div class="fbb-track"><div class="fbb-fill" id="fbb-fill" style="width:0%;"></div></div>
    </div>
    <div class="fbb-stats">
      <div class="fbb-stat"><div class="fbb-stat-dot" style="background:var(--green);"></div><span id="fbb-income" style="color:var(--text2);">—</span></div>
      <div class="fbb-stat"><div class="fbb-stat-dot" style="background:var(--red);"></div><span id="fbb-expense" style="color:var(--text2);">—</span></div>
      <div class="fbb-stat"><div class="fbb-stat-dot" style="background:var(--accent);"></div><span id="fbb-savings" style="color:var(--text2);">—</span></div>
    </div>
  </div>

  <div class="search-wrap">
    <span class="search-icon">🔍</span>
    <input type="text" class="search-input" id="search-input" placeholder="Search transactions…" oninput="onSearch()"/>
    <button class="search-clear" id="search-clear" onclick="clearSearch()" style="display:none;">✕</button>
  </div>
  <div class="filter-wrap" id="filter-chips"></div>
  <div class="feed-body" id="feed-list"></div>
</div>

<!-- ══ DASHBOARD VIEW ══ -->
<div class="view hidden" id="view-dashboard">
  <div class="topbar">
    <div class="top-row">
      <div>
        <div class="top-title">Spend<span>oodle</span> <span style="font-family:'Plus Jakarta Sans',sans-serif;font-size:.55rem;font-weight:700;color:var(--text3);background:var(--bg2);border:1px solid var(--border2);border-radius:6px;padding:2px 6px;vertical-align:middle;letter-spacing:.3px;">v0.3</span></div>
        <div class="top-sub">Trends & insights</div>
      </div>
      <div style="display:flex;align-items:center;gap:7px;">
        <div class="top-date" id="dash-date-label"></div>
        <button class="icon-btn" onclick="openWhatsNew()" title="What's New" style="position:relative;">✨</button>
      </div>
    </div>
    <div class="cycle-nav">
      <button class="mnav-btn" id="dash-mnav-prev" onclick="shiftCycle(-1);renderDash()">‹</button>
      <div class="cycle-center">
        <div class="cycle-label" id="dash-cycle-label"></div>
        <div class="cycle-range" id="dash-cycle-range"></div>
      </div>
      <button class="mnav-btn" id="dash-mnav-next" onclick="shiftCycle(1);renderDash()">›</button>
    </div>
  </div>
  <div style="padding:0 20px 10px;">
    <div id="dash-streak-area"></div>
    <div class="hero-card">
      <div class="hero-label" id="hero-label">Remaining this cycle</div>
      <div class="hero-amount" id="hero-net">
        <span class="sign" id="hero-sign"></span><span id="hero-net-val">0</span>
      </div>
      <div class="hero-grid">
        <div class="hero-stat"><div class="hs-label">Income</div><div class="hs-val c-inc" id="hero-income">0</div></div>
        <div class="hero-stat"><div class="hs-label">Spent</div><div class="hs-val c-exp" id="hero-expense">0</div></div>
        <div class="hero-stat"><div class="hs-label">Saved</div><div class="hs-val c-sav" id="hero-savings">0</div></div>
      </div>
      <div id="projection-inline" style="display:none;" class="projection-inline"></div>
    </div>
  </div>
  <div class="dash-body" id="dash-content"></div>
</div>

<!-- ══ CALENDAR VIEW ══ -->
<div class="view hidden" id="view-calendar">
  <div class="topbar">
    <div class="top-row">
      <div>
        <div class="top-title">Spend<span>oodle</span> <span style="font-family:'Plus Jakarta Sans',sans-serif;font-size:.55rem;font-weight:700;color:var(--text3);background:var(--bg2);border:1px solid var(--border2);border-radius:6px;padding:2px 6px;vertical-align:middle;letter-spacing:.3px;">v0.3</span></div>
        <div class="top-sub">Bill calendar</div>
      </div>
      <div style="display:flex;align-items:center;gap:7px;">
        <button class="icon-btn" onclick="openWhatsNew()" style="position:relative;">✨</button>
      </div>
    </div>
  </div>
  <div id="cal-body"></div>
</div>

<!-- ══ SETTINGS VIEW ══ -->
<div class="view hidden" id="view-settings">
  <div class="topbar" style="padding-bottom:14px;">
    <div class="top-row">
      <div>
        <div class="top-title">Spend<span>oodle</span> <span style="font-family:'Plus Jakarta Sans',sans-serif;font-size:.55rem;font-weight:700;color:var(--text3);background:var(--bg2);border:1px solid var(--border2);border-radius:6px;padding:2px 6px;vertical-align:middle;letter-spacing:.3px;">v0.3</span></div>
        <div class="top-sub">Preferences & backup</div>
      </div>
      <div style="display:flex;align-items:center;gap:7px;">
        <button class="icon-btn" onclick="openWhatsNew()" title="What's New" style="position:relative;">✨</button>
      </div>
    </div>
  </div>
  <div style="padding:0 20px 100px;">

    <!-- SHOW GUIDE -->
    <div class="settings-card" id="sc-guide">
      <div class="settings-icon" style="background:var(--accent-dim)">📖</div>
      <div class="settings-body">
        <div class="settings-title">User Guide</div>
        <div class="settings-desc">New to Spendoodle? Revisit the setup guide anytime to learn how everything works and how to customise it for your situation.</div>
        <button class="settings-btn btn-accent" onclick="obOpen();nav('feed')">📖 Open Guide</button>
      </div>
    </div>

    <!-- THEME -->
    <div class="settings-card" id="sc-theme">
      <div class="settings-icon" style="background:var(--accent-dim)">🎨</div>
      <div class="settings-body">
        <div class="settings-title">Theme</div>
        <div class="settings-desc">Choose your app look.</div>
        <div class="theme-row">
          <button class="theme-btn dark" onclick="setTheme('dark')" id="theme-dark">🌑 Noir</button>
          <button class="theme-btn pink" onclick="setTheme('pink')" id="theme-pink">🌸 Rose</button>
          <button class="theme-btn white" onclick="setTheme('white')" id="theme-white">🤍 Pearl</button>
          <button class="theme-btn navy" onclick="setTheme('navy')" id="theme-navy">🌊 Navy</button>
          <button class="theme-btn ice" onclick="setTheme('ice')" id="theme-ice">🧊 Ice</button>
          <button class="theme-btn forest" onclick="setTheme('forest')" id="theme-forest">🌿 Forest</button>
          <button class="theme-btn sunset" onclick="setTheme('sunset')" id="theme-sunset">🌅 Sunset</button>
          <button class="theme-btn midnight" onclick="setTheme('midnight')" id="theme-midnight">🔮 Midnight</button>
        </div>
      </div>
    </div>

    <!-- HAPTIC FEEDBACK -->
    <div class="settings-card" id="sc-haptic">
      <div class="settings-icon" style="background:var(--blue-dim)">📳</div>
      <div class="settings-body">
        <div class="settings-title">Haptic Feedback</div>
        <div class="settings-desc">Vibration on swipes, actions, PIN and navigation. <strong>Android Chrome only</strong> — iOS does not support vibration via browser.</div>
        <div class="toggle-row" onclick="toggleHaptic()" style="cursor:pointer;margin-bottom:10px;">
          <div>
            <div class="toggle-label">Vibration</div>
            <div class="toggle-sub" id="haptic-toggle-sub">On — feel every action</div>
          </div>
          <div class="toggle on" id="haptic-toggle"></div>
        </div>
        <button class="settings-btn btn-blue" onclick="testHaptic(this)" style="margin:0;">📳 Test Vibration</button>
        <div id="haptic-support-note" style="margin-top:8px;font-size:.68rem;color:var(--text3);display:none;"></div>
      </div>
    </div>

    <!-- BILL NOTIFICATIONS -->
    <div class="settings-card" id="sc-notifications">
      <div class="settings-icon" style="background:var(--green-dim)">🔔</div>
      <div class="settings-body">
        <div class="settings-title">Bill Reminders</div>
        <div class="settings-desc">Get notified before recurring bills are due. Requires notification permission.</div>
        <div class="toggle-row" onclick="toggleNotifications()" style="cursor:pointer;margin-bottom:10px;">
          <div>
            <div class="toggle-label">Bill Reminders</div>
            <div class="toggle-sub" id="notif-toggle-sub">Off — tap to enable</div>
          </div>
          <div class="toggle" id="notif-toggle"></div>
        </div>
        <div id="notif-advance-wrap" style="display:none;margin-bottom:10px;">
          <div style="font-size:.72rem;font-weight:600;color:var(--text2);margin-bottom:6px;">Remind me how many days before?</div>
          <div style="display:flex;gap:7px;">
            <button class="settings-btn btn-blue notif-days-btn" id="ndb-1" onclick="setNotifDays(1)" style="margin:0;flex:1;padding:9px 4px;">1 day</button>
            <button class="settings-btn btn-blue notif-days-btn" id="ndb-2" onclick="setNotifDays(2)" style="margin:0;flex:1;padding:9px 4px;">2 days</button>
            <button class="settings-btn btn-blue notif-days-btn" id="ndb-3" onclick="setNotifDays(3)" style="margin:0;flex:1;padding:9px 4px;">3 days</button>
          </div>
        </div>
        <div id="notif-status" style="font-size:.68rem;color:var(--text3);margin-top:4px;line-height:1.6;"></div>
        <button class="settings-btn btn-green" id="notif-permission-btn" onclick="requestNotifPermission()" style="margin:0;display:none;">🔔 Grant Permission</button>
        <button class="settings-btn btn-blue" id="notif-test-btn" onclick="testNotification()" style="margin:8px 0 0;display:none;">🔔 Send Test Notification</button>
      </div>
    </div>

    <!-- PAY CYCLE -->
    <div class="settings-card" id="sc-cycle">
      <div class="settings-icon" style="background:var(--accent-dim)">📅</div>
      <div class="settings-body">
        <div class="settings-title">Pay Cycle Setup</div>
        <div class="settings-desc">Choose how your pay cycle works. All data stays intact when you change this.</div>
        <div class="cycle-mode-row">
          <div class="cycle-mode-opt" id="cmo-monthly" onclick="selectCycleMode('monthly')">
            <div class="cmo-radio"><div class="cmo-radio-dot"></div></div>
            <div class="cmo-text"><div class="cmo-title">Once a month</div><div class="cmo-sub">e.g. every 25th → 24th of next month</div></div>
          </div>
          <div class="cycle-mode-opt" id="cmo-bimonthly" onclick="selectCycleMode('bimonthly')">
            <div class="cmo-radio"><div class="cmo-radio-dot"></div></div>
            <div class="cmo-text"><div class="cmo-title">Twice a month</div><div class="cmo-sub">e.g. 1st–15th and 16th–end of month</div></div>
          </div>
          <div class="cycle-mode-opt" id="cmo-custom" onclick="selectCycleMode('custom')">
            <div class="cmo-radio"><div class="cmo-radio-dot"></div></div>
            <div class="cmo-text"><div class="cmo-title">Custom days</div><div class="cmo-sub">Set any start and end day you want</div></div>
          </div>
          <div class="cycle-mode-opt" id="cmo-weekly" onclick="selectCycleMode('weekly')">
            <div class="cmo-radio"><div class="cmo-radio-dot"></div></div>
            <div class="cmo-text"><div class="cmo-title">Weekly</div><div class="cmo-sub">Paid every week — pick which day your week starts</div></div>
          </div>
        </div>

        <!-- Monthly fields -->
        <div class="cycle-fields" id="fields-monthly" style="display:none;">
          <div class="cf-row"><span class="cf-label">Pay day (day of month)</span><input class="cf-input" id="pay-day" type="number" min="1" max="28" value="25"/></div>
          <div class="cf-note">Cycle runs from your pay day to one day before next pay day.</div>
        </div>

        <!-- Bi-monthly fields -->
        <div class="cycle-fields" id="fields-bimonthly" style="display:none;">
          <div class="cf-note" style="margin-bottom:4px;">Works for same-month <em>and</em> cross-month splits (e.g. 25→10 next month).</div>
          <div class="cf-row"><span class="cf-label">Period A — start day</span><input class="cf-input" id="bi-s1" type="number" min="1" max="31" value="25" oninput="updateBiPreview()"/></div>
          <div class="cf-row"><span class="cf-label">Period A — end day</span><input class="cf-input" id="bi-e1" type="number" min="1" max="31" value="10" oninput="updateBiPreview()"/></div>
          <div class="cf-row"><span class="cf-label">Period B — start day</span><input class="cf-input" id="bi-s2" type="number" min="1" max="31" value="11" oninput="updateBiPreview()"/></div>
          <div class="cf-row"><span class="cf-label">Period B — end day</span><input class="cf-input" id="bi-e2" type="number" min="1" max="31" value="24" oninput="updateBiPreview()"/></div>
          <div class="cf-note" id="bi-preview" style="margin-top:4px;color:var(--accent);font-weight:600;"></div>
        </div>

        <!-- Custom fields -->
        <div class="cycle-fields" id="fields-custom" style="display:none;">
          <div class="cf-row"><span class="cf-label">Cycle start day</span><input class="cf-input" id="cust-start" type="number" min="1" max="28" value="1"/></div>
          <div class="cf-row"><span class="cf-label">Cycle length (days)</span><input class="cf-input" id="cust-len" type="number" min="7" max="90" value="30"/></div>
          <div class="cf-note">e.g. start=1, length=14 → fortnightly from 1st.</div>
        </div>

        <!-- Weekly fields -->
        <div class="cycle-fields" id="fields-weekly" style="display:none;">
          <div class="cf-row">
            <span class="cf-label">Which day do you get paid?</span>
            <select class="cf-input" id="pay-dow" style="font-family:'Plus Jakarta Sans',sans-serif;">
              <option value="0">Sunday</option>
              <option value="1" selected>Monday</option>
              <option value="2">Tuesday</option>
              <option value="3">Wednesday</option>
              <option value="4">Thursday</option>
              <option value="5">Friday</option>
              <option value="6">Saturday</option>
            </select>
          </div>
          <div class="cf-note">Your pay week runs 7 days starting from that day.</div>
        </div>

        <button class="settings-btn btn-accent" style="margin-top:10px;" onclick="saveCycleSettings()">Save Cycle Settings</button>
      </div>
    </div>

    <!-- CURRENCY -->
    <div class="settings-card" id="sc-currency">
      <div class="settings-icon" style="background:var(--blue-dim)">💱</div>
      <div class="settings-body">
        <div class="settings-title">Currency Symbol</div>
        <div class="settings-desc">Shown everywhere across the app.</div>
        <div style="display:flex;gap:8px;">
          <input class="cf-input" id="currency-input" type="text" maxlength="4" placeholder="₱" style="width:70px;"/>
          <button class="settings-btn btn-blue" style="flex:1;margin:0;" onclick="saveCurrency()">Apply</button>
        </div>
      </div>
    </div>

    <!-- CYCLE HISTORY LIMIT -->
    <div class="settings-card" id="sc-history">
      <div class="settings-icon" style="background:var(--blue-dim)">🗂</div>
      <div class="settings-body">
        <div class="settings-title">History Limit</div>
        <div class="settings-desc">
          Max number of <strong>months</strong> of history to keep. Cycles older than this are <strong>automatically deleted</strong> — the current cycle is always kept.<br/>
          <span style="color:var(--text3);font-size:.68rem;">Min: 3 · Max: 60 · Default: 12 months</span>
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          <input class="cf-input" id="cycle-limit-input" type="number" min="3" max="60" value="12" style="width:76px;"/>
          <span style="font-size:.75rem;color:var(--text3);flex:1;">months stored</span>
          <button class="settings-btn btn-blue" style="margin:0;padding:11px 16px;" onclick="saveCycleLimit()">Apply</button>
        </div>
        <div id="cycle-limit-preview" style="margin-top:8px;font-size:.7rem;color:var(--text3);line-height:1.6;"></div>
      </div>
    </div>

    <!-- EXPORT -->
    <div class="settings-card" id="sc-export">
      <div class="settings-icon" style="background:var(--accent-dim)">📤</div>
      <div class="settings-body">
        <div class="settings-title">Export &amp; Backup</div>
        <div class="settings-desc">Exports <strong>everything</strong>: all transactions, budgets, currency, theme, and cycle settings — as a single <code>.json</code> backup file.<br/><br/>Your data auto-saves in the browser after every change. Use Export when switching devices or clearing your browser.</div>
        <button class="settings-btn btn-accent" onclick="exportData()">📤 Download Full Backup (.json)</button>
        <button class="settings-btn" style="background:var(--green-dim);color:var(--green);border:1.5px solid var(--green);margin-top:7px;" onclick="exportCSV()">📊 Export Transactions (.csv)</button>
        <button class="settings-btn" style="background:#10b98118;color:#10b981;border:1.5px solid #10b98140;margin-top:7px;" onclick="exportExcel()">🟢 Export Transactions (.xlsx)</button>
        <button class="settings-btn" style="background:#f0646418;color:#f06464;border:1.5px solid #f0646440;margin-top:7px;" onclick="exportPDF()">🔴 Export Transactions (.pdf)</button>
        <div class="backup-interval-row">
          <span class="bir-label">🔔 Remind me to back up every</span>
          <input class="bir-input" type="number" id="backup-interval-input" min="1" max="365" value="30" onchange="saveBackupInterval(this.value)"/>
          <span class="bir-unit">days</span>
        </div>
        <div class="toggle-row" onclick="toggleAutoBackup()" style="cursor:pointer;margin-top:8px;">
          <div class="toggle-info">
            <div class="toggle-label">🤖 Auto-download when due</div>
            <div class="toggle-sub" id="auto-backup-sub">Off — downloads backup silently when reminder fires</div>
          </div>
          <div class="toggle" id="auto-backup-toggle-settings"></div>
        </div>
        <div class="toggle-row" onclick="toggleBackupPushNotif()" style="cursor:pointer;margin-top:6px;">
          <div class="toggle-info">
            <div class="toggle-label">🔔 Push notification when due</div>
            <div class="toggle-sub" id="backup-push-sub">Off — sends a push reminder even when app is closed</div>
          </div>
          <div class="toggle" id="backup-push-toggle"></div>
        </div>
        <div style="font-size:.68rem;color:var(--text3);margin-top:6px;" id="last-backup-label"></div>
      </div>
    </div>

    <!-- IMPORT -->
    <div class="settings-card" id="sc-import">
      <div class="settings-icon" style="background:var(--green-dim)">📥</div>
      <div class="settings-body">
        <div class="settings-title">Import Data</div>
        <div class="settings-desc">Load a backup file. Merges with current data — no duplicates.</div>
        <label class="settings-btn btn-green" style="cursor:pointer;">
          Choose ledger-data.json
          <input type="file" accept=".json" style="display:none;" onchange="importData(event)"/>
        </label>
        <div style="font-size:.68rem;color:var(--text3);margin-top:6px;line-height:1.6;" id="last-import-label"></div>
      </div>
    </div>

    <!-- BUDGETS -->
    <div class="settings-card" id="sc-budgets">
      <div class="settings-icon" style="background:var(--green-dim)">💰</div>
      <div class="settings-body">
        <div class="settings-title">Spending Budgets</div>
        <div class="settings-desc">Set monthly limits per expense category. The app will warn you when you're overspending — right on the dashboard. Set once and they stay forever.</div>
        <div id="settings-budget-summary" style="margin:8px 0 10px;font-size:.75rem;color:var(--text3);line-height:1.7;"></div>
        <button class="settings-btn btn-accent" onclick="openBudgetModal()">💰 Edit Budgets</button>
      </div>
    </div>

    <!-- PIN LOCK -->
    <div class="settings-card" id="sc-pin">
      <div class="settings-icon" style="background:var(--blue-dim)">🔐</div>
      <div class="settings-body">
        <div class="settings-title">PIN Lock</div>
        <div class="settings-desc" id="pin-settings-desc">Protect your data with a 4-digit PIN. Required every time you open the app.</div>
        <div id="pin-settings-btns"></div>
      </div>
    </div>

    <!-- CLEAR -->
    <div class="settings-card" id="sc-clear">
      <div class="settings-icon" style="background:var(--red-dim)">🗑</div>
      <div class="settings-body">
        <div class="settings-title">Clear All Data</div>
        <div class="settings-desc">Permanently delete everything. Export a backup first!</div>
        <button class="settings-btn btn-red" onclick="clearAllData()">Delete Everything</button>
      </div>
    </div>

    <!-- PWA INSTALL -->
    <div class="settings-card" id="sc-pwa" style="display:none;">
      <div class="settings-icon" style="background:var(--blue-dim)" id="pwa-sc-icon">📲</div>
      <div class="settings-body">
        <div class="settings-title" id="pwa-sc-title">Install App</div>
        <div class="settings-desc" id="pwa-sc-desc">Install Spendoodle on your device for a faster, offline-ready experience.</div>
        <button class="settings-btn btn-blue" id="pwa-sc-btn" onclick="pwaSettingsInstall()">📲 Install Now</button>
      </div>
    </div>

    <!-- CREDIT CARDS -->
    <div class="settings-card" id="sc-cards">
      <div class="settings-icon" style="background:#a855f718">💳</div>
      <div class="settings-body">
        <div class="settings-title">Credit Cards</div>
        <div class="settings-desc">Add your credit cards. When adding an expense, you can choose to charge it to a card instead of your cash balance. Pay the bill later to restore the card's available credit.</div>
        <div id="cc-settings-list" style="margin-bottom:10px;"></div>
        <div style="display:flex;gap:8px;margin-bottom:8px;">
          <input class="cf-input" id="cc-name-input" type="text" maxlength="20" placeholder="Card name" style="flex:1;width:auto;text-align:left;font-family:'Plus Jakarta Sans',sans-serif;font-size:.82rem;"/>
          <input class="cf-input" id="cc-limit-input" type="number" min="1" placeholder="Limit" style="width:90px;"/>
        </div>
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
          <input class="cf-input" id="cc-interest-input" type="number" min="0" step="0.01" placeholder="Fixed billing fee e.g. 50 (optional)" style="flex:1;width:auto;text-align:left;font-family:'Plus Jakarta Sans',sans-serif;font-size:.82rem;"/>
          <div style="font-size:.65rem;color:var(--text3);line-height:1.4;flex-shrink:0;max-width:90px;">charged each billing cycle</div>
        </div>
        <button class="settings-btn btn-blue" style="background:#a855f718;color:#a855f7;border-color:#a855f730;" onclick="addCreditCard()">+ Add Card</button>
      </div>
    </div>

    <div style="margin-top:10px;background:var(--bg1);border:1px solid var(--border);border-radius:16px;padding:15px 17px;">
      <div style="font-size:.62rem;text-transform:uppercase;letter-spacing:1px;color:var(--text3);font-weight:700;margin-bottom:8px;">Your data summary</div>
      <div id="settings-stats" style="font-size:.82rem;color:var(--text2);line-height:1.9;"></div>
    </div>
  </div>
</div>

<!-- ══ BOTTOM NAV ══ -->
<div class="bottom-nav">
  <button class="nav-btn active" id="nav-feed" onclick="nav('feed')">
    <span class="nav-icon">🏠</span><span class="nav-lbl">Feed</span>
  </button>
  <button class="nav-btn" id="nav-calendar" onclick="onBillsNavTap()">
    <span class="nav-icon-wrap">
      <span class="nav-icon">📅</span>
      <span class="nav-badge" id="recur-due-badge"></span>
    </span>
    <span class="nav-lbl">Bills</span>
  </button>
  <div class="fab-wrap">
    <div class="fab-dial" id="fab-dial">
      <button class="fab-dial-btn fab-dial-income" onclick="openSheetType('income')"><span class="fab-dial-icon">💼</span><span class="fab-dial-lbl" style="color:var(--bg)">Income</span></button>
      <button class="fab-dial-btn fab-dial-expense" onclick="openSheetType('expense')"><span class="fab-dial-icon">🛒</span><span class="fab-dial-lbl" style="color:#fff">Expense</span></button>
      <button class="fab-dial-btn fab-dial-savings" onclick="openSheetType('savings')"><span class="fab-dial-icon">🏦</span><span class="fab-dial-lbl" style="color:var(--bg)">Savings</span></button>
    </div>
    <button class="fab" id="fab-main" onclick="toggleFabDial()">＋</button>
  </div>
  <div class="fab-backdrop" id="fab-backdrop" onclick="closeFabDial()"></div>
  <button class="nav-btn" id="nav-dashboard" onclick="nav('dashboard')">
    <span class="nav-icon">📊</span><span class="nav-lbl">Dashboard</span>
  </button>
  <button class="nav-btn" id="nav-settings-tab" onclick="nav('settings')">
    <span class="nav-icon">⚙️</span><span class="nav-lbl">Settings</span>
  </button>
</div>

<!-- ══ PWA INSTALL BANNER ══ -->
<div class="pwa-banner" id="pwa-banner" style="display:none;">
  <div class="pwa-banner-icon" id="pwa-banner-icon"></div>
  <div class="pwa-banner-text">
    <div class="pwa-banner-title">Install Spendoodle</div>
    <div class="pwa-banner-sub" id="pwa-banner-sub">Add to home screen for the best experience</div>
  </div>
  <button class="pwa-banner-install" id="pwa-banner-btn" onclick="pwaInstall()">Install</button>
  <button class="pwa-banner-close" onclick="pwaDismiss()">✕</button>
</div>

<!-- ══ iOS INSTALL SHEET ══ -->
<div class="ios-install-sheet" id="ios-install-sheet" onclick="closeIosSheet(event)">
  <div class="ios-install-inner">
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:18px;">
      <div id="ios-sheet-icon" style="width:52px;height:52px;border-radius:13px;flex-shrink:0;"></div>
      <div>
        <div style="font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:900;">Install Spendoodle</div>
        <div style="font-size:.72rem;color:var(--text3);margin-top:2px;">Add to your Home Screen</div>
      </div>
      <button style="margin-left:auto;background:var(--bg2);border:1.5px solid var(--border2);border-radius:8px;padding:5px 10px;font-size:.7rem;font-weight:700;color:var(--text3);cursor:pointer;" onclick="closeIosSheet()">Done</button>
    </div>
    <div class="ios-step">
      <div class="ios-step-num">1</div>
      <div class="ios-step-text">Tap the <strong>Share button</strong> <span style="font-size:1.1rem;">⬆️</span> at the bottom of your Safari browser bar</div>
    </div>
    <div class="ios-step">
      <div class="ios-step-num">2</div>
      <div class="ios-step-text">Scroll down and tap <strong>"Add to Home Screen"</strong> <span style="font-size:1rem;">➕</span></div>
    </div>
    <div class="ios-step">
      <div class="ios-step-num">3</div>
      <div class="ios-step-text">Tap <strong>"Add"</strong> in the top-right corner — Spendoodle will appear on your home screen like a native app ✅</div>
    </div>
    <div style="background:var(--accent-dim);border:1px solid var(--border2);border-radius:12px;padding:10px 14px;font-size:.72rem;color:var(--text2);margin-top:4px;line-height:1.6;">
      💡 <strong style="color:var(--accent)">Works offline</strong> — your data is stored on your device, not the cloud. No login needed.
    </div>
  </div>
</div>
</div>

<!-- ══ BACKUP REMINDER ══ -->
<!-- ── RECURRING DUE PROMPT ── -->
<div class="recur-prompt-overlay" id="recur-prompt-overlay" onclick="stopRecurringPrompt(event)">
  <div class="recur-prompt-sheet" onclick="event.stopPropagation()">
    <div class="recur-prompt-icon">🔁</div>
    <div class="recur-prompt-title" id="recur-prompt-title">Recurring Items Due</div>
    <div class="recur-prompt-msg" id="recur-prompt-msg">These recurring entries are due. Add them now to keep your ledger up to date.</div>
    <div class="recur-prompt-list" id="recur-prompt-list"></div>
    <div class="recur-btn-row">
      <button class="recur-btn recur-btn-skip" onclick="stopRecurringPrompt(null)">🚫 Stop Recurring</button>
      <button class="recur-btn recur-btn-add" onclick="addRecurringNow()">✅ Add Now</button>
    </div>
  </div>
</div>
<div class="backup-overlay" id="backup-overlay" onclick="dismissBackupReminder(event)">
  <div class="backup-sheet" onclick="event.stopPropagation()">
    <div class="backup-icon" id="backup-icon">💾</div>
    <div class="backup-title" id="backup-title">Time to Back Up</div>
    <div class="backup-msg" id="backup-msg">It's been a while since your last backup.</div>
    <div class="backup-since" id="backup-since"></div>
    <div class="backup-auto-row" id="backup-auto-row">
      <div style="flex:1;">
        <div style="font-size:.8rem;font-weight:700;color:var(--text);margin-bottom:2px;">🤖 Auto-download on open</div>
        <div style="font-size:.68rem;color:var(--text3);line-height:1.5;">Silently saves a backup file every time the reminder fires. No pop-up needed.</div>
      </div>
      <div class="toggle" id="auto-backup-toggle" onclick="toggleAutoBackup()" style="flex-shrink:0;"></div>
    </div>
    <div class="backup-btn-row">
      <button class="backup-btn backup-btn-skip" onclick="snoozeBackup()">Snooze 1 day</button>
      <button class="backup-btn backup-btn-now" onclick="backupNow()">📤 Back Up Now</button>
    </div>
    <div style="text-align:center;margin-top:10px;">
      <button onclick="dismissBackupReminder()" style="background:none;border:none;color:var(--text3);font-size:.72rem;cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;">Dismiss</button>
    </div>
  </div>
</div>
<div class="ob-overlay" id="ob-overlay">
  <div class="ob-sheet">
    <div class="ob-handle"></div>
    <div class="ob-progress-track"><div class="ob-progress-fill" id="ob-progress"></div></div>
    <div class="ob-pages" id="ob-pages">

      <!-- ══ SLIDE 0: What Is This Thing? (Intro / Hype) ══ -->
      <div class="ob-page">
        <div style="height:2px;"></div>
        <div class="ob-page-tag">Welcome · Buckle Up</div>

        <!-- Hero -->
        <div style="text-align:center;margin-bottom:16px;">
          <div style="font-size:2.8rem;line-height:1;margin-bottom:8px;">💸</div>
          <div class="ob-title" style="margin-bottom:5px;">Meet <em>Spendoodle.</em></div>
          <div style="font-size:.76rem;color:var(--text3);line-height:1.55;">Your money's new best friend.<br/>Or therapist. Depends how bad it is.</div>
        </div>

        <!-- 2-column feature grid -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px;" id="ob-intro-grid">

          <div class="ob-intro-card" style="background:var(--bg2);border:1.5px solid var(--border2);border-radius:14px;padding:13px 12px;">
            <div style="font-size:1.5rem;margin-bottom:6px;">📊</div>
            <div style="font-size:.76rem;font-weight:700;color:var(--text);margin-bottom:3px;">Track it all</div>
            <div style="font-size:.65rem;color:var(--text3);line-height:1.45;">Income, expenses, savings. Finally find out where your money "just disappeared" to.</div>
          </div>

          <div class="ob-intro-card" style="background:var(--bg2);border:1.5px solid var(--border2);border-radius:14px;padding:13px 12px;">
            <div style="font-size:1.5rem;margin-bottom:6px;">📅</div>
            <div style="font-size:.76rem;font-weight:700;color:var(--text);margin-bottom:3px;">Payday cycles</div>
            <div style="font-size:.65rem;color:var(--text3);line-height:1.45;">Resets on YOUR payday, not Jan 1st. Radical concept, we know.</div>
          </div>

          <div class="ob-intro-card" style="background:var(--bg2);border:1.5px solid var(--border2);border-radius:14px;padding:13px 12px;">
            <div style="font-size:1.5rem;margin-bottom:6px;">🔄</div>
            <div style="font-size:.76rem;font-weight:700;color:var(--text);margin-bottom:3px;">Recurring bills</div>
            <div style="font-size:.65rem;color:var(--text3);line-height:1.45;">That gym membership you'll cancel "next month" — logged automatically.</div>
          </div>

          <div class="ob-intro-card" style="background:var(--bg2);border:1.5px solid var(--border2);border-radius:14px;padding:13px 12px;">
            <div style="font-size:1.5rem;margin-bottom:6px;">🎯</div>
            <div style="font-size:.76rem;font-weight:700;color:var(--text);margin-bottom:3px;">Spending budgets</div>
            <div style="font-size:.65rem;color:var(--text3);line-height:1.45;">Turns red when you're overspending. Like a financial conscience, but louder.</div>
          </div>

          <div class="ob-intro-card" style="background:var(--bg2);border:1.5px solid var(--border2);border-radius:14px;padding:13px 12px;">
            <div style="font-size:1.5rem;margin-bottom:6px;">💳</div>
            <div style="font-size:.76rem;font-weight:700;color:var(--text);margin-bottom:3px;">Credit cards</div>
            <div style="font-size:.65rem;color:var(--text3);line-height:1.45;">Track balances & limits. So the bill at month-end is dramatic, not shocking.</div>
          </div>

          <div class="ob-intro-card" style="background:var(--bg2);border:1.5px solid var(--border2);border-radius:14px;padding:13px 12px;">
            <div style="font-size:1.5rem;margin-bottom:6px;">🔒</div>
            <div style="font-size:.76rem;font-weight:700;color:var(--text);margin-bottom:3px;">100% private</div>
            <div style="font-size:.65rem;color:var(--text3);line-height:1.45;">Lives on this device only. Nobody's judging the bubble tea budget. Probably.</div>
          </div>

        </div>

        <!-- Footer nudge -->
        <div style="background:var(--accent-dim);border:1px solid var(--border2);border-radius:12px;padding:10px 14px;text-align:center;">
          <span style="font-size:.72rem;font-weight:700;color:var(--accent);">Setup takes ~30 seconds. Your broke era ends here. 👇</span>
        </div>
      </div>

      <!-- ══ SLIDE 1: Make It Yours (Currency + Theme) ══ -->

      <div class="ob-page">
        <div style="height:2px;"></div>
        <div class="ob-page-tag">Step 2 of 4 · Make It Yours</div>
        <div style="text-align:center;margin-bottom:12px;">
          <div style="font-size:2.6rem;line-height:1.1;">🎨</div>
          <div class="ob-title" style="margin-bottom:4px;">Let's make it <em>feel like yours.</em></div>
          <div style="font-size:.78rem;color:var(--text3);line-height:1.5;">Pick your currency and a theme. This is the fun part — enjoy it before we ask you about your pay cycle.</div>
        </div>

        <!-- Currency -->
        <div class="ob-setup-block" style="margin-bottom:10px;">
          <div class="ob-setup-label">💱 Which symbol represents your suffering? <span style="font-weight:400;color:var(--text3);">(tap one)</span></div>
          <div style="display:grid;grid-template-columns:repeat(6,1fr);gap:6px;margin:8px 0 4px;">
            <button class="ob-currency-btn" onclick="gSetCurrency('₱')">₱<div style="font-size:.5rem;color:var(--text3);margin-top:2px;">PHP</div></button>
            <button class="ob-currency-btn" onclick="gSetCurrency('$')">$<div style="font-size:.5rem;color:var(--text3);margin-top:2px;">USD</div></button>
            <button class="ob-currency-btn" onclick="gSetCurrency('€')">€<div style="font-size:.5rem;color:var(--text3);margin-top:2px;">EUR</div></button>
            <button class="ob-currency-btn" onclick="gSetCurrency('£')">£<div style="font-size:.5rem;color:var(--text3);margin-top:2px;">GBP</div></button>
            <button class="ob-currency-btn" onclick="gSetCurrency('¥')">¥<div style="font-size:.5rem;color:var(--text3);margin-top:2px;">JPY</div></button>
            <button class="ob-currency-btn" onclick="gSetCurrency('₩')">₩<div style="font-size:.5rem;color:var(--text3);margin-top:2px;">KRW</div></button>
            <button class="ob-currency-btn" onclick="gSetCurrency('₹')">₹<div style="font-size:.5rem;color:var(--text3);margin-top:2px;">INR</div></button>
            <button class="ob-currency-btn" onclick="gSetCurrency('Rp')">Rp<div style="font-size:.5rem;color:var(--text3);margin-top:2px;">IDR</div></button>
            <button class="ob-currency-btn" onclick="gSetCurrency('RM')">RM<div style="font-size:.5rem;color:var(--text3);margin-top:2px;">MYR</div></button>
            <button class="ob-currency-btn" onclick="gSetCurrency('฿')">฿<div style="font-size:.5rem;color:var(--text3);margin-top:2px;">THB</div></button>
            <button class="ob-currency-btn" onclick="gSetCurrency('₫')">₫<div style="font-size:.5rem;color:var(--text3);margin-top:2px;">VND</div></button>
            <button class="ob-currency-btn" onclick="gSetCurrency('S$')">S$<div style="font-size:.5rem;color:var(--text3);margin-top:2px;">SGD</div></button>
          </div>
          <div id="g-currency-preview" class="ob-currency-quip"></div>
        </div>

        <!-- Theme -->
        <div class="ob-setup-block">
          <div class="ob-setup-label">🎨 Pick a vibe — <span style="font-weight:400;color:var(--text3);">the whole app transforms instantly. Very dramatic. 👇</span></div>
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-top:8px;">
            <div class="ob-theme-card" id="g-theme-dark" onclick="gSetTheme('dark')">
              <div class="ob-theme-preview" style="background:#141420;border-color:#252538;padding:9px 8px 7px;">
                <div class="ob-theme-prev-bar" style="background:#d4a853;margin-bottom:5px;"></div>
                <div style="display:flex;gap:4px;"><div class="ob-theme-prev-dot" style="background:#4fd87c;"></div><div class="ob-theme-prev-dot" style="background:#f06464;"></div></div>
              </div>
              <div class="ob-theme-name" style="font-size:.66rem;">🌑 Noir</div>
            </div>
            <div class="ob-theme-card" id="g-theme-pink" onclick="gSetTheme('pink')">
              <div class="ob-theme-preview" style="background:#2e1426;border-color:#5c2846;padding:9px 8px 7px;">
                <div class="ob-theme-prev-bar" style="background:#f472b6;margin-bottom:5px;"></div>
                <div style="display:flex;gap:4px;"><div class="ob-theme-prev-dot" style="background:#34d399;"></div><div class="ob-theme-prev-dot" style="background:#f87171;"></div></div>
              </div>
              <div class="ob-theme-name" style="font-size:.66rem;">🌸 Rose</div>
            </div>
            <div class="ob-theme-card" id="g-theme-white" onclick="gSetTheme('white')">
              <div class="ob-theme-preview" style="background:#f0ede8;border-color:#ccc8c0;padding:9px 8px 7px;">
                <div class="ob-theme-prev-bar" style="background:#b8860b;margin-bottom:5px;"></div>
                <div style="display:flex;gap:4px;"><div class="ob-theme-prev-dot" style="background:#16a34a;"></div><div class="ob-theme-prev-dot" style="background:#dc2626;"></div></div>
              </div>
              <div class="ob-theme-name" style="font-size:.66rem;">🤍 Pearl</div>
            </div>
            <div class="ob-theme-card" id="g-theme-navy" onclick="gSetTheme('navy')">
              <div class="ob-theme-preview" style="background:#0d1626;border-color:#1d2d55;padding:9px 8px 7px;">
                <div class="ob-theme-prev-bar" style="background:#3b82f6;margin-bottom:5px;"></div>
                <div style="display:flex;gap:4px;"><div class="ob-theme-prev-dot" style="background:#22d3a5;"></div><div class="ob-theme-prev-dot" style="background:#f87171;"></div></div>
              </div>
              <div class="ob-theme-name" style="font-size:.66rem;">🌊 Navy</div>
            </div>
            <div class="ob-theme-card" id="g-theme-ice" onclick="gSetTheme('ice')">
              <div class="ob-theme-preview" style="background:#102535;border-color:#234560;padding:9px 8px 7px;">
                <div class="ob-theme-prev-bar" style="background:#06b6d4;margin-bottom:5px;"></div>
                <div style="display:flex;gap:4px;"><div class="ob-theme-prev-dot" style="background:#34d399;"></div><div class="ob-theme-prev-dot" style="background:#fb7185;"></div></div>
              </div>
              <div class="ob-theme-name" style="font-size:.66rem;">🧊 Ice</div>
            </div>
            <div class="ob-theme-card" id="g-theme-forest" onclick="gSetTheme('forest')">
              <div class="ob-theme-preview" style="background:#0b1c15;border-color:#1c3a28;padding:9px 8px 7px;">
                <div class="ob-theme-prev-bar" style="background:#10b981;margin-bottom:5px;"></div>
                <div style="display:flex;gap:4px;"><div class="ob-theme-prev-dot" style="background:#4ade80;"></div><div class="ob-theme-prev-dot" style="background:#f87171;"></div></div>
              </div>
              <div class="ob-theme-name" style="font-size:.66rem;">🌿 Forest</div>
            </div>
            <div class="ob-theme-card" id="g-theme-sunset" onclick="gSetTheme('sunset')">
              <div class="ob-theme-preview" style="background:#221500;border-color:#503400;padding:9px 8px 7px;">
                <div class="ob-theme-prev-bar" style="background:#f97316;margin-bottom:5px;"></div>
                <div style="display:flex;gap:4px;"><div class="ob-theme-prev-dot" style="background:#4ade80;"></div><div class="ob-theme-prev-dot" style="background:#f87171;"></div></div>
              </div>
              <div class="ob-theme-name" style="font-size:.66rem;">🌅 Sunset</div>
            </div>
            <div class="ob-theme-card" id="g-theme-midnight" onclick="gSetTheme('midnight')">
              <div class="ob-theme-preview" style="background:#120c2c;border-color:#2e2460;padding:9px 8px 7px;">
                <div class="ob-theme-prev-bar" style="background:#a855f7;margin-bottom:5px;"></div>
                <div style="display:flex;gap:4px;"><div class="ob-theme-prev-dot" style="background:#34d399;"></div><div class="ob-theme-prev-dot" style="background:#f87171;"></div></div>
              </div>
              <div class="ob-theme-name" style="font-size:.66rem;">🌙 Midnight</div>
            </div>
          </div>
        </div>
      </div>

      <!-- ══ SLIDE 1: Pay Cycle ══ -->
      <div class="ob-page">
        <div style="height:4px;"></div>
        <div class="ob-page-tag">Step 3 of 4 · The Important Bit</div>
        <div class="ob-emoji">📅</div>
        <div class="ob-title">When does the <em>money drop?</em></div>
        <div class="ob-sub">Every budget app resets on Jan 1st like some kind of financial New Year's resolution. <strong style="color:var(--accent)">We reset on YOUR payday.</strong> Radical concept, we know.</div>
        <div class="ob-setup-block">
          <div class="ob-setup-label">How often does your wallet get refilled?</div>
          <div class="cycle-mode-row" style="gap:7px;">
            <div class="cycle-mode-opt" id="g-cmo-monthly" onclick="gSelectCycleMode('monthly')">
              <div class="cmo-radio"><div class="cmo-radio-dot"></div></div>
              <div class="cmo-text"><div class="cmo-title">Once a month</div><div class="cmo-sub">e.g. 25th of every month — the day you feel rich 🗓</div></div>
            </div>
            <div class="cycle-mode-opt" id="g-cmo-bimonthly" onclick="gSelectCycleMode('bimonthly')">
              <div class="cmo-radio"><div class="cmo-radio-dot"></div></div>
              <div class="cmo-text"><div class="cmo-title">Twice a month</div><div class="cmo-sub">e.g. 10th & 25th — two chances to overspend</div></div>
            </div>
            <div class="cycle-mode-opt" id="g-cmo-weekly" onclick="gSelectCycleMode('weekly')">
              <div class="cmo-radio"><div class="cmo-radio-dot"></div></div>
              <div class="cmo-text"><div class="cmo-title">Every week</div><div class="cmo-sub">Living that YOLO lifestyle 💸</div></div>
            </div>
            <div class="cycle-mode-opt" id="g-cmo-custom" onclick="gSelectCycleMode('custom')">
              <div class="cmo-radio"><div class="cmo-radio-dot"></div></div>
              <div class="cmo-text"><div class="cmo-title">Custom interval</div><div class="cmo-sub">Fortnightly, 10-day, whatever chaos works</div></div>
            </div>
          </div>
          <div class="cycle-fields" id="g-fields-monthly" style="display:none;">
            <div class="cf-row"><span class="cf-label">Which day do you get paid?</span><input class="cf-input" id="g-pay-day" type="number" min="1" max="28" value="25"/></div>
            <div class="cf-note">💡 Enter 25 → your cycle runs 25th → 24th next month.</div>
          </div>
          <div class="cycle-fields" id="g-fields-bimonthly" style="display:none;">
            <div class="cf-note" style="margin-bottom:6px;">💡 Handles cross-month splits perfectly (e.g. 25th → 10th).</div>
            <div class="cf-row"><span class="cf-label">Period A — starts day</span><input class="cf-input" id="g-bi-s1" type="number" min="1" max="31" value="25"/></div>
            <div class="cf-row"><span class="cf-label">Period A — ends day</span><input class="cf-input" id="g-bi-e1" type="number" min="1" max="31" value="10"/></div>
            <div class="cf-row"><span class="cf-label">Period B — starts day</span><input class="cf-input" id="g-bi-s2" type="number" min="1" max="31" value="11"/></div>
            <div class="cf-row"><span class="cf-label">Period B — ends day</span><input class="cf-input" id="g-bi-e2" type="number" min="1" max="31" value="24"/></div>
          </div>
          <div class="cycle-fields" id="g-fields-weekly" style="display:none;">
            <div class="cf-note" style="margin-bottom:6px;">💡 7-day window starting from your payday.</div>
            <div class="cf-row"><span class="cf-label">Payday of the week?</span>
              <select class="cf-input" id="g-pay-dow" style="font-family:'Plus Jakarta Sans',sans-serif;">
                <option value="0">Sunday</option><option value="1" selected>Monday</option>
                <option value="2">Tuesday</option><option value="3">Wednesday</option>
                <option value="4">Thursday</option><option value="5">Friday</option><option value="6">Saturday</option>
              </select>
            </div>
          </div>
          <div class="cycle-fields" id="g-fields-custom" style="display:none;">
            <div class="cf-note" style="margin-bottom:6px;">💡 e.g. start = 1, length = 14 → fortnightly from the 1st.</div>
            <div class="cf-row"><span class="cf-label">Cycle starts which day of month?</span><input class="cf-input" id="g-cust-start" type="number" min="1" max="28" value="1"/></div>
            <div class="cf-row"><span class="cf-label">Days per cycle?</span><input class="cf-input" id="g-cust-len" type="number" min="7" max="90" value="30"/></div>
          </div>
        </div>
        <div class="ob-inline-tip">Saved when you tap <strong>Next →</strong> · Changed your mind? ⚙️ Settings exists for a reason.</div>
      </div>

      <!-- ══ SLIDE 2: Done + Customize prompts ══ -->
      <div class="ob-page">
        <div style="height:6px;"></div>
        <div class="ob-page-tag">Step 4 of 4 · You're Dangerous Now</div>
        <div class="ob-emoji" style="font-size:3rem;animation:quipPop .5s cubic-bezier(.34,1.56,.64,1);">🎉</div>
        <div class="ob-title" style="margin-bottom:5px;"><em>You're in.</em> Welcome to adulting.</div>
        <div class="ob-sub" style="margin-bottom:14px;">The app is armed and ready. Your finances don't know what's coming. If you want to go full <em>responsible adult mode,</em> these are worth setting up — but zero pressure right now:</div>

        <div style="display:flex;flex-direction:column;gap:7px;">
          <div style="background:var(--bg2);border:1.5px solid var(--border2);border-radius:14px;padding:11px 13px;display:flex;gap:11px;align-items:center;">
            <span style="font-size:1.15rem;flex-shrink:0;">🎯</span>
            <div style="flex:1;">
              <div style="font-size:.8rem;font-weight:700;color:var(--text);margin-bottom:1px;">Savings Goal</div>
              <div style="font-size:.66rem;color:var(--text3);line-height:1.4;">Tell the app what you're actually saving for. Emergency fund? Vacation? New sneakers? No judgment.</div>
            </div>
            <button onclick="obClose();setTimeout(()=>{nav('feed');openSheetType('savings');},300)" style="background:var(--accent);color:#000;border:none;border-radius:8px;padding:6px 10px;font-size:.68rem;font-weight:700;cursor:pointer;white-space:nowrap;font-family:'Plus Jakarta Sans',sans-serif;flex-shrink:0;">Set up →</button>
          </div>
          <div style="background:var(--bg2);border:1.5px solid var(--border2);border-radius:14px;padding:11px 13px;display:flex;gap:11px;align-items:center;">
            <span style="font-size:1.15rem;flex-shrink:0;">💰</span>
            <div style="flex:1;">
              <div style="font-size:.8rem;font-weight:700;color:var(--text);margin-bottom:1px;">Spending Budgets</div>
              <div style="font-size:.66rem;color:var(--text3);line-height:1.4;">Set per-category limits. The app will yell at you (politely) before you blow past them.</div>
            </div>
            <button onclick="obClose();setTimeout(()=>{nav('settings');document.getElementById('sc-budgets')?.scrollIntoView({behavior:'smooth',block:'center'});openBudgetModal();},400)" style="background:var(--accent);color:#000;border:none;border-radius:8px;padding:6px 10px;font-size:.68rem;font-weight:700;cursor:pointer;white-space:nowrap;font-family:'Plus Jakarta Sans',sans-serif;flex-shrink:0;">Set up →</button>
          </div>
          <div style="background:var(--bg2);border:1.5px solid var(--border2);border-radius:14px;padding:11px 13px;display:flex;gap:11px;align-items:center;">
            <span style="font-size:1.15rem;flex-shrink:0;">💳</span>
            <div style="flex:1;">
              <div style="font-size:.8rem;font-weight:700;color:var(--text);margin-bottom:1px;">Credit Cards</div>
              <div style="font-size:.66rem;color:var(--text3);line-height:1.4;">Track limits and balances. Charge expenses to the card, pay the bill later. Like real life but organised.</div>
            </div>
            <button onclick="obClose();setTimeout(()=>{nav('settings');document.getElementById('sc-cards')?.scrollIntoView({behavior:'smooth',block:'center'});},400)" style="background:var(--accent);color:#000;border:none;border-radius:8px;padding:6px 10px;font-size:.68rem;font-weight:700;cursor:pointer;white-space:nowrap;font-family:'Plus Jakarta Sans',sans-serif;flex-shrink:0;">Set up →</button>
          </div>
          <div style="background:var(--bg2);border:1.5px solid var(--border2);border-radius:14px;padding:11px 13px;display:flex;gap:11px;align-items:center;">
            <span style="font-size:1.15rem;flex-shrink:0;">🔐</span>
            <div style="flex:1;">
              <div style="font-size:.8rem;font-weight:700;color:var(--text);margin-bottom:1px;">PIN Lock</div>
              <div style="font-size:.66rem;color:var(--text3);line-height:1.4;">Stop your nosy relatives from seeing how much you spent on bubble tea. We see you.</div>
            </div>
            <button onclick="obClose();setTimeout(()=>{nav('settings');document.getElementById('sc-pin')?.scrollIntoView({behavior:'smooth',block:'center'});},400)" style="background:var(--accent);color:#000;border:none;border-radius:8px;padding:6px 10px;font-size:.68rem;font-weight:700;cursor:pointer;white-space:nowrap;font-family:'Plus Jakarta Sans',sans-serif;flex-shrink:0;">Set up →</button>
          </div>
        </div>
        <div class="ob-tip" style="margin-top:12px;">💾 <strong>Heads up:</strong> data lives on this device only — no cloud, no backup, no crying. Export regularly from ⚙️ Settings.</div>
      </div>

    </div><!-- end ob-pages -->

    <div class="ob-footer">
      <div class="ob-dots" id="ob-dots"></div>
      <div class="ob-btn-row">
        <button class="ob-btn ob-btn-secondary" id="ob-back" onclick="obNav(-1)" style="display:none;">← Back</button>
        <button class="ob-btn ob-btn-primary" id="ob-next" onclick="obNav(1)">Let's Go →</button>
      </div>
      <button class="ob-btn ob-btn-ghost" id="ob-skip" onclick="obClose()">I'll figure it out myself →</button>
    </div>
  </div>
</div>

<!-- ══ PIN LOCK OVERLAY ══ -->
<div class="pin-overlay hidden" id="pin-overlay">
  <div style="font-size:3rem;margin-bottom:16px;">🔐</div>
  <div class="pin-title">Spend<span style="color:var(--accent)">oodle</span></div>
  <div class="pin-sub" id="pin-sub">Enter your PIN to unlock</div>
  <div class="pin-dots" id="pin-dots">
    <div class="pin-dot" id="pd0"></div>
    <div class="pin-dot" id="pd1"></div>
    <div class="pin-dot" id="pd2"></div>
    <div class="pin-dot" id="pd3"></div>
  </div>
  <div class="pin-error" id="pin-error"></div>
  <div class="pin-keypad">
    <button class="pin-key" onclick="pinKey('1')">1</button>
    <button class="pin-key" onclick="pinKey('2')">2</button>
    <button class="pin-key" onclick="pinKey('3')">3</button>
    <button class="pin-key" onclick="pinKey('4')">4</button>
    <button class="pin-key" onclick="pinKey('5')">5</button>
    <button class="pin-key" onclick="pinKey('6')">6</button>
    <button class="pin-key" onclick="pinKey('7')">7</button>
    <button class="pin-key" onclick="pinKey('8')">8</button>
    <button class="pin-key" onclick="pinKey('9')">9</button>
    <button class="pin-key empty"></button>
    <button class="pin-key" onclick="pinKey('0')">0</button>
    <button class="pin-key del" onclick="pinDel()">⌫</button>
  </div>
  <button id="pin-skip-btn" style="margin-top:24px;background:transparent;border:none;font-size:.78rem;color:var(--text3);cursor:pointer;font-family:'Plus Jakarta Sans',sans-serif;" onclick="pinSkip()">Forgot PIN? Reset App</button>
</div>

<!-- ══ CUSTOM CONFIRM MODAL ══ -->
<div class="confirm-overlay" id="confirm-overlay">
  <div class="confirm-inner">
    <div class="confirm-icon" id="confirm-icon">🗑</div>
    <div class="confirm-title" id="confirm-title">Are you sure?</div>
    <div class="confirm-msg" id="confirm-msg">This action cannot be undone.</div>
    <div class="confirm-btns" id="confirm-btns">
      <button class="confirm-btn confirm-cancel" id="confirm-cancel-btn" onclick="cancelConfirm()">Cancel</button>
      <button class="confirm-btn confirm-ok" id="confirm-ok-btn" onclick="confirmOk()">Delete</button>
    </div>
  </div>
</div>

<!-- ══ WHAT'S NEW SHEET ══ -->
<div class="wn-overlay" id="wn-overlay" onclick="closeWhatsNew()">
  <div class="wn-sheet" id="wn-sheet" onclick="event.stopPropagation()">
    <div class="wn-handle" id="wn-handle" style="cursor:grab;touch-action:none;"></div>
    <div class="wn-header">
      <div class="wn-title">What's New ✨</div>
      <div class="wn-sub">Spendoodle v0.3 — latest updates</div>
    </div>
    <div class="wn-body">

      <!-- v0.3 items -->
      <div class="wn-item">
        <div class="wn-icon" style="background:var(--red-dim)">💰</div>
        <div class="wn-info">
          <div class="wn-name">Smarter Budget Alerts <span class="wn-new-pill">v0.3</span></div>
          <div class="wn-desc">Budget Tracker removed from the feed — no clutter. A single alert line appears on the dashboard when you're overspending: total amount over + which categories. Tap to expand the full breakdown.</div>
        </div>
      </div>
      <div class="wn-item">
        <div class="wn-icon" style="background:var(--green-dim)">🔁</div>
        <div class="wn-info">
          <div class="wn-name">Weekly Recurring Backfill <span class="wn-new-pill">v0.3</span></div>
          <div class="wn-desc">Weekly recurring transactions now backfill all missed weeks in one go — even across cycle boundaries. No gaps even if you haven't opened the app in weeks.</div>
        </div>
      </div>
      <div class="wn-item">
        <div class="wn-icon" style="background:var(--accent-dim)">⚙️</div>
        <div class="wn-info">
          <div class="wn-name">Budgets in Settings & Guide <span class="wn-new-pill">v0.3</span></div>
          <div class="wn-desc">Set spending limits once from Settings → Spending Budgets. Also added as Step 5 in the onboarding guide so you can configure it from the very start.</div>
        </div>
      </div>

      <div style="padding:10px 0 6px;font-size:.58rem;text-transform:uppercase;letter-spacing:1.2px;color:var(--text3);font-weight:700;">Earlier Updates</div>
      <div class="wn-item" style="padding:10px 0;">
        <div class="wn-info" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
          <div style="display:flex;gap:8px;align-items:flex-start;"><span style="font-size:1rem;">➕</span><div><div style="font-size:.78rem;font-weight:700;color:var(--text);margin-bottom:1px;">Circular FAB</div><div style="font-size:.68rem;color:var(--text3);">Floating speed-dial for Income, Expense, Savings.</div></div></div>
          <div style="display:flex;gap:8px;align-items:flex-start;"><span style="font-size:1rem;">💳</span><div><div style="font-size:.78rem;font-weight:700;color:var(--text);margin-bottom:1px;">Payment Method</div><div style="font-size:.68rem;color:var(--text3);">Cash or Credit Card selector on expenses.</div></div></div>
          <div style="display:flex;gap:8px;align-items:flex-start;"><span style="font-size:1rem;">🎨</span><div><div style="font-size:.78rem;font-weight:700;color:var(--text);margin-bottom:1px;">8 Themes</div><div style="font-size:.68rem;color:var(--text3);">Navy, Ice, Forest, Sunset, Midnight & more.</div></div></div>
          <div style="display:flex;gap:8px;align-items:flex-start;"><span style="font-size:1rem;">👆</span><div><div style="font-size:.78rem;font-weight:700;color:var(--text);margin-bottom:1px;">Swipe to Delete</div><div style="font-size:.68rem;color:var(--text3);">Swipe left on any transaction.</div></div></div>
          <div style="display:flex;gap:8px;align-items:flex-start;"><span style="font-size:1rem;">⚡</span><div><div style="font-size:.78rem;font-weight:700;color:var(--text);margin-bottom:1px;">Quick Add</div><div style="font-size:.68rem;color:var(--text3);">One-tap recurring templates.</div></div></div>
          <div style="display:flex;gap:8px;align-items:flex-start;"><span style="font-size:1rem;">🔁</span><div><div style="font-size:.78rem;font-weight:700;color:var(--text);margin-bottom:1px;">Recurring</div><div style="font-size:.68rem;color:var(--text3);">Weekly or monthly, auto-logged.</div></div></div>
          <div style="display:flex;gap:8px;align-items:flex-start;"><span style="font-size:1rem;">📈</span><div><div style="font-size:.78rem;font-weight:700;color:var(--text);margin-bottom:1px;">Cash Flow Forecast</div><div style="font-size:.68rem;color:var(--text3);">Projected balance by end of cycle.</div></div></div>
          <div style="display:flex;gap:8px;align-items:flex-start;"><span style="font-size:1rem;">🎯</span><div><div style="font-size:.78rem;font-weight:700;color:var(--text);margin-bottom:1px;">Savings Goals</div><div style="font-size:.68rem;color:var(--text3);">Set targets, track progress.</div></div></div>
          <div style="display:flex;gap:8px;align-items:flex-start;"><span style="font-size:1rem;">🔐</span><div><div style="font-size:.78rem;font-weight:700;color:var(--text);margin-bottom:1px;">PIN Lock</div><div style="font-size:.68rem;color:var(--text3);">SHA-256 secured, set in Settings.</div></div></div>
          <div style="display:flex;gap:8px;align-items:flex-start;"><span style="font-size:1rem;">💾</span><div><div style="font-size:.78rem;font-weight:700;color:var(--text);margin-bottom:1px;">Backup Reminder</div><div style="font-size:.68rem;color:var(--text3);">Prompts you every 30 days.</div></div></div>
          <div style="display:flex;gap:8px;align-items:flex-start;"><span style="font-size:1rem;">💬</span><div><div style="font-size:.78rem;font-weight:700;color:var(--text);margin-bottom:1px;">Undo Delete</div><div style="font-size:.68rem;color:var(--text3);">5-second undo toast on delete.</div></div></div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="sheet-overlay" id="sheet-overlay" onclick="closeSheet()"></div>
<div class="sheet" id="add-sheet">
  <div class="sheet-handle" id="sheet-handle" style="cursor:grab;touch-action:none;"></div>
  <div class="sheet-header">
    <div class="sheet-title" id="sheet-title">Log a <em>Transaction</em></div>
    <button class="sheet-close" onclick="closeSheet()">✕</button>
  </div>
  <div class="add-body">
    <div id="add-toast" class="toast" style="display:none;">✓ Saved!</div>
    <div id="date-err" class="date-err">⛔ Future dates not allowed.</div>
    <div class="form-section"><div class="form-lbl">Date</div><input type="date" class="date-field" id="f-date" onchange="const ck=getCycleKey(this.value||todayStr());_sheetAvailable=getCycleAvailable(ck,editingId||null);updateRemainingHint();updateSaveBtn();"/></div>
    <div class="form-section"><div class="form-lbl">Category</div><div class="cat-grid" id="cat-grid"></div></div>
    <div class="form-section"><div class="form-lbl">Amount</div>
      <div class="amt-wrap"><span class="amt-sym" id="amt-sym">₱</span><input type="number" inputmode="decimal" class="amt-input" id="f-amount" placeholder="0" min="0" oninput="this.value=this.value.replace(/[^0-9.]/g,'');if(parseFloat(this.value)<0)this.value='';onAmountInput()"/></div>
      <div class="amt-remaining" id="amt-remaining" style="display:none;"></div>
      <div class="amt-err" id="amt-err">⛔ Not enough remaining balance.</div>
    </div>
    <div class="form-section"><div class="form-lbl">Note <span style="color:var(--text3);font-size:.6rem;font-weight:400;text-transform:none;letter-spacing:0;">(optional)</span></div>
      <textarea class="note-field" id="f-note" rows="2" placeholder="e.g. Grab to work, groceries…"></textarea>
    </div>
    <!-- SAVINGS GOAL — shown only when Savings category is selected -->
    <div class="form-section" id="savings-goal-section" style="display:none;">
      <div class="form-lbl">Savings Goal <span id="goal-lbl-hint" style="color:var(--accent);font-size:.6rem;font-weight:600;text-transform:none;letter-spacing:0;">What are you saving for?</span></div>
      <div class="goal-wrap">
        <input type="text" class="goal-input" id="f-savings-goal" placeholder="Defaults to Emergency Fund if left blank"
          autocomplete="off"
          oninput="onGoalInput()"
          onfocus="onGoalFocus()"
          onblur="onGoalBlur()"/>
        <div class="goal-suggestions" id="goal-suggestions"></div>
      </div>
      <div id="goal-first-hint" style="display:none;margin-top:6px;font-size:.72rem;color:var(--accent);font-weight:600;">
        🎯 First savings entry! Give it a goal name or leave blank for "Emergency Fund".
      </div>
      <!-- Target amount -->
      <div style="margin-top:8px;display:flex;align-items:center;gap:8px;">
        <div style="flex:1;background:var(--bg2);border:1.5px solid var(--border2);border-radius:11px;padding:8px 12px;display:flex;align-items:center;gap:6px;transition:border-color .2s;" id="goal-target-wrap">
          <span style="font-size:.72rem;color:var(--text3);white-space:nowrap;">🎯 Target:</span>
          <span style="font-size:.85rem;color:var(--text3);" id="goal-target-sym"></span>
          <input type="number" id="f-goal-target" placeholder="optional"
            style="flex:1;background:transparent;border:none;outline:none;font-family:'Playfair Display',serif;font-size:.95rem;font-weight:700;color:var(--text);width:100%;"
            oninput="onGoalTargetInput()" min="0"/>
        </div>
      </div>
      <div id="goal-progress-hint" style="display:none;margin-top:5px;font-size:.7rem;color:var(--text3);line-height:1.5;"></div>
    </div>
    <div class="form-section">
      <div class="toggle-row">
        <div><div class="toggle-label">🔄 Recurring</div><div class="toggle-sub" id="recur-sub">Repeats every cycle</div></div>
        <div class="toggle" id="recur-toggle" onclick="toggleRecur()"></div>
      </div>
      <div class="recur-freq-wrap" id="recur-freq-wrap" style="display:none;">
        <button class="recur-freq-btn active" id="recur-freq-weekly" onclick="setRecurFreq('weekly')">📅 Weekly</button>
        <button class="recur-freq-btn" id="recur-freq-monthly" onclick="setRecurFreq('monthly')">🗓 Monthly</button>
      </div>
    </div>
    <div class="form-section" id="credit-toggle-section" style="display:none;">
      <div class="form-lbl">Payment Method</div>
      <div class="pay-method-row">
        <button class="pay-method-btn active" id="pay-method-cash" onclick="setPayMethod('cash')">
          <span class="pay-method-icon">💵</span>
          <span class="pay-method-label">Cash</span>
        </button>
        <button class="pay-method-btn" id="pay-method-credit" onclick="setPayMethod('credit')">
          <span class="pay-method-icon">💳</span>
          <span class="pay-method-label">Credit Card</span>
        </button>
      </div>
      <div class="cc-picker-wrap" id="cc-picker-wrap">
        <select class="cc-picker" id="f-credit-card"></select>
        <div class="cc-hint" id="cc-hint"></div>
      </div>
    </div>
    <button class="save-btn" id="save-btn" onclick="saveTransaction()">Save</button>
  </div>
</div>

<!-- ══ BUDGET MODAL ══ -->
<div class="budget-modal" id="budget-modal" onclick="closeBudgetModal(event)">
  <div class="bm-inner" onclick="event.stopPropagation()">
    <div class="sheet-handle" style="margin:0 auto 14px;"></div>
    <div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:4px;">
      <div>
        <div class="bm-title">💰 Set Budgets</div>
        <div class="bm-sub">Enter a limit per category. Leave empty for no limit.<br/>Tap ✕ next to a field to clear that budget.</div>
      </div>
      <button onclick="document.getElementById('budget-modal').classList.remove('open')" style="background:var(--bg2);border:1.5px solid var(--border2);border-radius:10px;width:30px;height:30px;font-size:.85rem;cursor:pointer;color:var(--text2);display:flex;align-items:center;justify-content:center;flex-shrink:0;">✕</button>
    </div>
    <div class="bm-section-label">Expense Categories</div>
    <div id="budget-inputs"></div>
    <button class="bm-save" onclick="saveBudgets()">Save Budgets ✓</button>
  </div>
</div>

<!-- ══ CREDIT PAY MODAL ══ -->
<div class="pay-modal" id="pay-modal" onclick="closePayModal(event)">
  <div class="pay-inner" onclick="e=>e.stopPropagation()">
    <div class="sheet-handle" style="margin:0 auto 14px;"></div>
    <div class="pay-title">💳 Pay Credit Card Bill</div>
    <div class="pay-sub" id="pay-modal-sub">Paying this will deduct from your balance and restore your card's available credit.</div>
    <div class="pay-balance">
      <span class="pay-balance-lbl">Card Outstanding</span>
      <span class="pay-balance-val" id="pay-modal-owed">₱0</span>
    </div>
    <div class="pay-balance" style="border:1.5px solid var(--green);background:var(--green-dim);margin-top:-4px;">
      <span class="pay-balance-lbl" style="color:var(--green);">Your Cash Available</span>
      <span class="pay-balance-val" style="color:var(--green);" id="pay-cash-avail">₱0</span>
    </div>
    <div style="margin-bottom:8px;">
      <div class="form-lbl" style="margin-bottom:8px;">Payment Amount <span style="font-size:.65rem;color:var(--text3);font-weight:400;">(principal only)</span></div>
      <div class="amt-wrap"><span class="amt-sym" id="pay-sym">₱</span><input type="number" inputmode="decimal" class="amt-input" id="pay-amount" placeholder="0" min="0" style="font-size:2rem;padding:8px 0;" oninput="updatePayHint()"/></div>
      <div style="display:flex;gap:7px;margin-top:8px;">
        <button style="flex:1;padding:7px;border-radius:9px;font-size:.7rem;font-weight:700;cursor:pointer;border:1.5px solid var(--border2);background:var(--bg2);color:var(--text2);" onclick="setPayQuick('full')">Pay Full Bill</button>
        <button style="flex:1;padding:7px;border-radius:9px;font-size:.7rem;font-weight:700;cursor:pointer;border:1.5px solid var(--green);background:var(--green-dim);color:var(--green);" onclick="setPayQuick('max')">Max I Can Pay</button>
      </div>
    </div>
    <!-- Billing fee section -->
    <div style="background:var(--bg2);border:1px solid #a855f730;border-radius:13px;padding:12px 13px;margin-bottom:12px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <span style="font-size:.75rem;font-weight:700;color:#a855f7;">📊 Billing Fee / Interest</span>
        <span id="pay-fee-hint-lbl" style="font-size:.62rem;color:var(--text3);">added as separate expense</span>
      </div>
      <div class="amt-wrap" style="border-color:#a855f730;background:var(--bg1);">
        <span class="amt-sym" id="pay-fee-sym" style="color:#a855f7;">₱</span>
        <input type="number" inputmode="decimal" class="amt-input" id="pay-fee-amount" placeholder="0" min="0"
          style="font-size:1.6rem;padding:6px 0;color:#a855f7;" oninput="updatePayHint()"/>
      </div>
      <div id="pay-fee-prefill-row" style="display:none;margin-top:7px;">
        <button id="pay-fee-prefill-btn" style="width:100%;padding:7px;border-radius:9px;font-size:.7rem;font-weight:700;cursor:pointer;border:1.5px solid #a855f750;background:#a855f712;color:#a855f7;" onclick="prefillBillingFee()"></button>
      </div>
      <div style="margin-top:6px;font-size:.68rem;color:var(--text3);line-height:1.5;">Leave at 0 if no fee this cycle. Fee logs as an expense in your feed.</div>
    </div>
    <!-- Summary row -->
    <div id="pay-summary-row" style="display:none;background:var(--bg2);border:1px solid var(--border2);border-radius:11px;padding:9px 13px;margin-bottom:10px;">
      <div style="display:flex;justify-content:space-between;font-size:.72rem;color:var(--text3);margin-bottom:3px;">
        <span>Principal payment</span><span id="pay-sum-principal" style="font-weight:700;color:var(--text);">₱0</span>
      </div>
      <div style="display:flex;justify-content:space-between;font-size:.72rem;color:var(--text3);margin-bottom:5px;">
        <span>Billing fee</span><span id="pay-sum-fee" style="font-weight:700;color:#a855f7;">₱0</span>
      </div>
      <div style="height:1px;background:var(--border);margin-bottom:5px;"></div>
      <div style="display:flex;justify-content:space-between;font-size:.8rem;font-weight:700;">
        <span style="color:var(--text);">Total out of pocket</span><span id="pay-sum-total" style="color:var(--accent);">₱0</span>
      </div>
    </div>
    <div id="pay-hint" style="margin-bottom:8px;font-size:.7rem;color:var(--text3);line-height:1.5;"></div>
    <div id="pay-error-toast" style="display:none;background:var(--red-dim);color:var(--red);border:1px solid var(--red);border-radius:10px;padding:9px 13px;font-size:.78rem;font-weight:700;margin-bottom:10px;text-align:center;"></div>
    <input type="hidden" id="pay-card-id"/>
    <button class="pay-save" onclick="submitCreditPayment()">Pay Now ✓</button>
  </div>
</div>

<script>
// ╔══════════════════════════════════════════════════════╗
// ║  Built with ☕ & questionable life choices by        ║
// ║            W r a l f f f f                          ║
// ║  "If it works, don't touch it."                      ║
// ║  "If it breaks, it was like that when I got here."   ║
// ╚══════════════════════════════════════════════════════╝

// ════════════════════════════════════════════════════════════
//  CONSTANTS
// ════════════════════════════════════════════════════════════
const CATS = [
  {k:'salary',      l:'Salary',      i:'💼', t:'income'},
  {k:'freelance',   l:'Freelance',   i:'🛠️', t:'income'},
  {k:'side_income', l:'Side Income', i:'✨',  t:'income'},
  {k:'gift',        l:'Gift/Bonus',  i:'🎁', t:'income'},
  {k:'transport',   l:'Transport',   i:'🚌', t:'expense'},
  {k:'food',        l:'Food',        i:'🍜', t:'expense'},
  {k:'shopping',    l:'Shopping',    i:'🛍️', t:'expense'},
  {k:'rent',        l:'Rent',        i:'🏠', t:'expense'},
  {k:'utilities',   l:'Bills',       i:'💡', t:'expense'},
  {k:'health',      l:'Health',      i:'💊', t:'expense'},
  {k:'entertain',   l:'Fun',         i:'🎬', t:'expense'},
  {k:'savings',     l:'Savings',     i:'🏦', t:'savings'},
  {k:'other',       l:'Other',       i:'📦', t:'expense'},
];
const EXPENSE_CATS = CATS.filter(c=>c.t==='expense');
const FULL_M  = ['January','February','March','April','May','June','July','August','September','October','November','December'];
const SHORT_M = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
const DONUT_COLORS = ['#f06464','#d4a853','#7b8fff','#4fd87c','#f0a864','#c084fc','#64c8f0','#f0d464','#84f064'];

// ════════════════════════════════════════════════════════════
//  LOAD STATE — everything persists to localStorage
// ════════════════════════════════════════════════════════════
let transactions   = JSON.parse(localStorage.getItem('ledger_txs')     || '[]');
let budgets        = JSON.parse(localStorage.getItem('ledger_budgets')  || '{}');
let currencySymbol = localStorage.getItem('ledger_currency')            || '₱';
let activeTheme    = localStorage.getItem('ledger_theme')               || 'dark';
let creditCards    = JSON.parse(localStorage.getItem('ledger_cc')       || '[]');
let goalTargets    = JSON.parse(localStorage.getItem('ledger_goalTargets') || '{}'); // {goalName: amount}
let recurringStops = JSON.parse(localStorage.getItem('ledger_recur_stops') || '{}'); // {seriesKey: cutoffDate}
let pinHash        = localStorage.getItem('ledger_pin')                 || '';  // SHA-256 hex of PIN

// Cycle config
let cycleMode      = localStorage.getItem('ledger_cycleMode')           || 'monthly';
let cycleConfig    = JSON.parse(localStorage.getItem('ledger_cycleConfig') || JSON.stringify({
  monthly:   { payDay: 25 },
  bimonthly: { s1:25, e1:10, s2:11, e2:24 },
  weekly:    { payDow: 1 },
  custom:    { start:1, len:30 }
}));
// Ensure weekly key exists for old saves
if(!cycleConfig.weekly) cycleConfig.weekly = { payDow: 1 };
let cycleLimit     = Math.max(3, parseInt(localStorage.getItem('ledger_cycleLimit') || '12'));
let hapticEnabled  = localStorage.getItem('ledger_haptic') !== 'off'; // on by default
let notifEnabled   = localStorage.getItem('ledger_notif') === 'on';
let notifDaysAhead = parseInt(localStorage.getItem('ledger_notif_days') || '1');
let calViewMonth   = null; // {year, month} currently shown in calendar

// UI state
let currentView  = 'feed';
let activeCycleKey = null;
let selectedCat  = 'transport';
let editingId    = null;
let expandedTx   = null;
let deleteConfirm= null;
let dashMetric   = 'income';
let searchQuery  = '';
let activeFilter = 'all';
let isRecurring  = false;
let recurFreq    = 'weekly'; // 'weekly' | 'monthly'
let isCreditPay  = false;
let sheetOpen    = false;

// ════════════════════════════════════════════════════════════
//  PERSIST HELPERS — called after every mutation
// ════════════════════════════════════════════════════════════
function persist(){
  localStorage.setItem('ledger_txs',        JSON.stringify(transactions));
  localStorage.setItem('ledger_budgets',     JSON.stringify(budgets));
  localStorage.setItem('ledger_currency',    currencySymbol);
  localStorage.setItem('ledger_theme',       activeTheme);
  localStorage.setItem('ledger_cycleMode',   cycleMode);
  localStorage.setItem('ledger_cycleConfig', JSON.stringify(cycleConfig));
  localStorage.setItem('ledger_cycleLimit',  String(cycleLimit));
  localStorage.setItem('ledger_cc',          JSON.stringify(creditCards));
  localStorage.setItem('ledger_goalTargets', JSON.stringify(goalTargets));
  localStorage.setItem('ledger_haptic',      hapticEnabled ? 'on' : 'off');
  localStorage.setItem('ledger_recur_stops', JSON.stringify(recurringStops));
}

// ════════════════════════════════════════════════════════════
//  HAPTIC FEEDBACK
// ════════════════════════════════════════════════════════════
function haptic(pattern){
  if(!hapticEnabled) return;
  if(!navigator.vibrate) return;
  try{ navigator.vibrate(0); navigator.vibrate(pattern); }catch(e){}
}
// Preset patterns
const HX = {
  tap:      15,           // subtle tick — nav, PIN digit
  soft:     25,           // light confirm — undo, save
  success:  [15,30,40],   // add transaction
  warning:  [30,20,30],   // swipe threshold reached
  delete:   [20,10,20,10,40], // delete confirm
  error:    [40,20,40],   // wrong PIN
};

// ════════════════════════════════════════════════════════════
//  CYCLE LIMIT — trim oldest cycles, keep newest N
// ════════════════════════════════════════════════════════════
function enforceCycleLimit(){
  // cycleLimit is now in MONTHS — delete cycles whose start date is older than N months ago
  const cutoff = new Date();
  cutoff.setMonth(cutoff.getMonth() - cycleLimit);
  const cutoffStr = ymd(cutoff.getFullYear(), cutoff.getMonth()+1, cutoff.getDate());

  const curKey = currentCycleKey();
  const cycleKeys = [...new Set(transactions.map(t => getCycleKey(t.date)))]
    .sort((a,b) => cycleRange(b).start.localeCompare(cycleRange(a).start));

  const keepSet = new Set();
  cycleKeys.forEach(k => {
    const { start } = cycleRange(k);
    if(start >= cutoffStr || k === curKey) keepSet.add(k);
  });

  const before = transactions.length;
  transactions = transactions.filter(t => keepSet.has(getCycleKey(t.date)));
  return before - transactions.length;
}
// ════════════════════════════════════════════════════════════
function ymd(y,m,d){ return `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`; }
function todayStr(){ const d=new Date(); return ymd(d.getFullYear(),d.getMonth()+1,d.getDate()); }
function daysInMonth(y,m){ return new Date(y,m,0).getDate(); }

// ════════════════════════════════════════════════════════════
//  CYCLE ENGINE
//  A cycle key is an arbitrary string that uniquely identifies
//  one pay period. We use different formats per mode:
//   monthly:   "YYYY-MM"        (the month the cycle starts)
//   bimonthly: "YYYY-MM-A"/"YYYY-MM-B"  (A=first half, B=second)
//   custom:    "YYYY-MM-DD"     (the start date of the custom cycle)
// ════════════════════════════════════════════════════════════

/** Returns {start:"YYYY-MM-DD", end:"YYYY-MM-DD"} for a given cycle key */
function cycleRange(ck){
  if(cycleMode==='monthly'){
    const [y,m]  = ck.split('-').map(Number);
    const pd     = cycleConfig.monthly.payDay;
    const nm     = m===12?1:m+1, ny=m===12?y+1:y;
    return { start: ymd(y,m,pd), end: ymd(ny,nm,pd-1) };
  }
  if(cycleMode==='bimonthly'){
    const parts = ck.split('-');
    const y=parseInt(parts[0]), m=parseInt(parts[1]), half=parts[2];
    const {s1,e1,s2,e2} = cycleConfig.bimonthly;
    if(half==='A'){
      // Cross-month when start > end (e.g. 25->10 next month)
      const crossMonth = s1 > e1;
      const endM = crossMonth ? (m===12?1:m+1) : m;
      const endY = (crossMonth && m===12) ? y+1 : y;
      return { start:ymd(y,m,s1), end:ymd(endY,endM,e1) };
    }
    // Period B: same month, explicit end day
    return { start:ymd(y,m,s2), end:ymd(y,m,e2||daysInMonth(y,m)) };
  }
  if(cycleMode==='weekly'){
    // ck is "YYYY-MM-DD" — the Monday (or configured dow) start of the week
    const startD = new Date(ck+'T00:00:00');
    const endD   = new Date(startD); endD.setDate(startD.getDate()+6);
    return { start:ck, end:ymd(endD.getFullYear(),endD.getMonth()+1,endD.getDate()) };
  }
  // custom: ck is start date "YYYY-MM-DD"
  const {len} = cycleConfig.custom;
  const startD = new Date(ck+'T00:00:00');
  const endD   = new Date(startD); endD.setDate(startD.getDate()+len-1);
  return { start:ck, end:ymd(endD.getFullYear(),endD.getMonth()+1,endD.getDate()) };
}

/** Return cycle key for a given date string */
function getCycleKey(dateStr){
  const [y,m,d] = dateStr.split('-').map(Number);
  if(cycleMode==='monthly'){
    const pd = cycleConfig.monthly.payDay;
    if(d>=pd) return `${y}-${String(m).padStart(2,'0')}`;
    const pm=m===1?12:m-1, py=m===1?y-1:y;
    return `${py}-${String(pm).padStart(2,'0')}`;
  }
  if(cycleMode==='bimonthly'){
    const {s1,e1,s2,e2} = cycleConfig.bimonthly;
    const crossMonth = s1 > e1; // e.g. 25->10
    if(crossMonth){
      // Period A spans two months: starts on s1, ends on e1 of NEXT month
      // A date belongs to period A if:
      //   day >= s1  (in the start month)  → key = that month
      //   day <= e1  (in the end month)    → key = previous month
      // Period B: s2..e2 within same month
      if(d >= s2 && d <= e2) return `${y}-${String(m).padStart(2,'0')}-B`;
      if(d >= s1) return `${y}-${String(m).padStart(2,'0')}-A`;
      // day < s2 and day <= e1 → belongs to prev month's period A
      const pm=m===1?12:m-1, py=m===1?y-1:y;
      return `${py}-${String(pm).padStart(2,'0')}-A`;
    } else {
      // Same-month split (e.g. 1-15, 16-31)
      const half = d >= s2 ? 'B' : 'A';
      return `${y}-${String(m).padStart(2,'0')}-${half}`;
    }
  }
  if(cycleMode==='weekly'){
    // Find the start of the week (payDow) that contains this date
    const dow = cycleConfig.weekly.payDow; // 0=Sun … 6=Sat
    const target = new Date(dateStr+'T00:00:00');
    let dayOfWeek = target.getDay();
    // Days since last payDow
    let diff = (dayOfWeek - dow + 7) % 7;
    const weekStart = new Date(target);
    weekStart.setDate(target.getDate() - diff);
    return ymd(weekStart.getFullYear(), weekStart.getMonth()+1, weekStart.getDate());
  }
  // custom: find which cycle start this date falls in
  const {start,len} = cycleConfig.custom;
  const epoch = new Date('2020-01-01T00:00:00');
  const target= new Date(dateStr+'T00:00:00');
  const diff  = Math.floor((target-epoch)/(86400000));
  const cycleN= Math.floor(diff/len);
  const cs    = new Date(epoch); cs.setDate(epoch.getDate()+cycleN*len);
  return ymd(cs.getFullYear(),cs.getMonth()+1,cs.getDate());
}

/** Current cycle key (where today falls) */
function currentCycleKey(){ return getCycleKey(todayStr()); }

/** Shift a cycle key by delta (-1=prev, +1=next) */
function shiftKey(ck, delta){
  if(cycleMode==='monthly'){
    const [y,m]=ck.split('-').map(Number);
    let nm=m+delta, ny=y;
    if(nm>12){nm-=12;ny++;} if(nm<1){nm+=12;ny--;}
    return `${ny}-${String(nm).padStart(2,'0')}`;
  }
  if(cycleMode==='bimonthly'){
    const parts=ck.split('-'), y=parseInt(parts[0]),m=parseInt(parts[1]),half=parts[2];
    const crossMonth = cycleConfig.bimonthly.s1 > cycleConfig.bimonthly.e1;
    if(delta===1){
      if(half==='B'){
        // B(m) → A(m) for both modes
        return `${y}-${String(m).padStart(2,'0')}-A`;
      } else {
        // A(m) → B(m+1) cross-month | A(m) → B(m) same-month
        if(crossMonth){ const nm=m===12?1:m+1, ny=m===12?y+1:y; return `${ny}-${String(nm).padStart(2,'0')}-B`; }
        return `${y}-${String(m).padStart(2,'0')}-B`;
      }
    } else {
      if(half==='A'){
        // A(m) → B(m) cross-month | A(m) → B(m-1) same-month
        if(crossMonth) return `${y}-${String(m).padStart(2,'0')}-B`;
        const pm=m===1?12:m-1, py=m===1?y-1:y; return `${py}-${String(pm).padStart(2,'0')}-B`;
      } else {
        // B(m) → A(m-1) cross-month | B(m) → A(m) same-month
        if(crossMonth){ const pm=m===1?12:m-1, py=m===1?y-1:y; return `${py}-${String(pm).padStart(2,'0')}-A`; }
        return `${y}-${String(m).padStart(2,'0')}-A`;
      }
    }
  }
  // weekly: ck is "YYYY-MM-DD" start of week — shift by 7*delta days
  if(cycleMode==='weekly'){
    const wd=new Date(ck+'T00:00:00'); wd.setDate(wd.getDate()+delta*7);
    return ymd(wd.getFullYear(),wd.getMonth()+1,wd.getDate());
  }
  // custom
  const {len}=cycleConfig.custom;
  const d=new Date(ck+'T00:00:00'); d.setDate(d.getDate()+delta*len);
  return ymd(d.getFullYear(),d.getMonth()+1,d.getDate());
}
function cycleLabel(ck, short=false){
  if(cycleMode==='monthly'){
    const [y,m]=ck.split('-').map(Number);
    return `${(short?SHORT_M:FULL_M)[m-1]} ${y}`;
  }
  if(cycleMode==='bimonthly'){
    // Use the actual start/end dates from cycleRange for a clear label
    const r=cycleRange(ck);
    const [sy,sm,sd]=r.start.split('-').map(Number);
    const [ey,em,ed]=r.end.split('-').map(Number);
    if(short){
      // e.g. "Dec 25–Jan 10" or "Jan 11–24"
      const sameMonth=sm===em&&sy===ey;
      return sameMonth
        ? `${SHORT_M[sm-1]} ${sd}–${ed}`
        : `${SHORT_M[sm-1]} ${sd}–${SHORT_M[em-1]} ${ed}`;
    }
    return `${SHORT_M[sm-1]} ${sd} – ${SHORT_M[em-1]} ${ed}, ${ey}`;
  }
  if(cycleMode==='weekly'){
    const r=cycleRange(ck);
    const [sy,sm,sd]=r.start.split('-').map(Number);
    const [ey,em,ed]=r.end.split('-').map(Number);
    if(short) return `${SHORT_M[sm-1]} ${sd}`;
    const sameMonth=sm===em&&sy===ey;
    return sameMonth
      ? `Week of ${SHORT_M[sm-1]} ${sd}–${ed}, ${sy}`
      : `Week of ${SHORT_M[sm-1]} ${sd}–${SHORT_M[em-1]} ${ed}, ${ey}`;
  }
  const r=cycleRange(ck);
  const [,sm,sd]=r.start.split('-').map(Number);
  const [,em,ed]=r.end.split('-').map(Number);
  return `${SHORT_M[sm-1]} ${sd}–${SHORT_M[em-1]} ${ed}`;
}

/** Range string shown under the cycle label */
function cycleRangeStr(ck){
  const r=cycleRange(ck);
  const [sy,sm,sd]=r.start.split('-').map(Number);
  const [ey,em,ed]=r.end.split('-').map(Number);
  return `${SHORT_M[sm-1]} ${sd}, ${sy} → ${SHORT_M[em-1]} ${ed}, ${ey}`;
}

/** All unique cycle keys from stored transactions — only cycles with data, capped by cycleLimit */
function allCycleKeys(){
  const keys=[...new Set(transactions.map(t=>getCycleKey(t.date)))];
  const cur=currentCycleKey();
  if(!keys.includes(cur)) keys.push(cur);
  // Sort by actual start date (newest first), NOT by key string
  const sorted = keys.sort((a,b)=>cycleRange(b).start.localeCompare(cycleRange(a).start));
  const limited = sorted.slice(0, cycleLimit);
  if(!limited.includes(cur)) limited[limited.length-1] = cur;
  return limited;
}

/** Transactions belonging to a specific cycle */
function cycleTxs(ck){
  const {start,end}=cycleRange(ck);
  return transactions.filter(t=>t.date>=start&&t.date<=end);
}

// ════════════════════════════════════════════════════════════
//  STATS
// ════════════════════════════════════════════════════════════
function cycleStats(ck){
  const txs=cycleTxs(ck);
  const income  = txs.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
  // Cash expenses = regular non-credit expenses + credit bill payments
  const expense = txs.filter(t=>(t.type==='expense' && !t.creditCardId) || t.type==='credit_payment').reduce((s,t)=>s+t.amount,0);
  const creditExp = txs.filter(t=>t.type==='expense' && t.creditCardId).reduce((s,t)=>s+t.amount,0);
  const savings = txs.filter(t=>t.type==='savings').reduce((s,t)=>s+t.amount,0);
  return {income,expense,creditExp,savings,net:income-expense-savings,rate:income>0?(savings/income)*100:0};
}

/** Available balance for current cycle — used to cap new entries */
function getCycleAvailable(ck, excludeId=null){
  const txs = cycleTxs(ck).filter(t => excludeId ? t.id !== excludeId : true);
  const income  = txs.filter(t=>t.type==='income').reduce((s,t)=>s+t.amount,0);
  // Cash expenses: regular expenses NOT paid by credit card + credit card bill payments
  const expense = txs.filter(t=>(t.type==='expense' && !t.creditCardId) || t.type==='credit_payment').reduce((s,t)=>s+t.amount,0);
  const savings = txs.filter(t=>t.type==='savings').reduce((s,t)=>s+t.amount,0);
  return income - expense - savings;
}

// ════════════════════════════════════════════════════════════
//  FORMATTERS
// ════════════════════════════════════════════════════════════
function fmt(n,dec=2){ return Math.abs(n).toLocaleString('en-US',{minimumFractionDigits:dec,maximumFractionDigits:dec}); }
function fmtS(n){ return Math.abs(n)>=1000?`${currencySymbol}${(Math.abs(n)/1000).toFixed(1)}k`:`${currencySymbol}${fmt(n,0)}`; }
function c$(n){ return `${currencySymbol}${fmt(n,0)}`; }
function formatDate(ds){
  const [y,m,d]=ds.split('-').map(Number);
  const dt=new Date(y,m-1,d),tod=new Date(); tod.setHours(0,0,0,0);
  const yes=new Date(tod); yes.setDate(tod.getDate()-1);
  if(dt.getTime()===tod.getTime()) return 'Today';
  if(dt.getTime()===yes.getTime()) return 'Yesterday';
  return `${SHORT_M[m-1]} ${d}`;
}

// ════════════════════════════════════════════════════════════
//  SAVINGS GOALS
// ════════════════════════════════════════════════════════════
/** Normalize goal name: trim + Title Case */
function normGoal(s){
  return s.trim().toLowerCase().replace(/\b\w/g,c=>c.toUpperCase());
}

/** All unique goal names across all transactions + any goal with a set target (case-insensitive deduped) */
function getSavingsGoals(){
  const seen=new Map();
  transactions.filter(t=>t.type==='savings'&&t.savingsGoal)
    .forEach(t=>{ const k=t.savingsGoal.toLowerCase(); if(!seen.has(k)) seen.set(k,t.savingsGoal); });
  // Also include goals that have a target set but no deposits yet
  Object.keys(goalTargets).forEach(k=>{ if(!seen.has(k)) seen.set(k, k.replace(/\b\w/g,c=>c.toUpperCase())); });
  return [...seen.values()].sort((a,b)=>a.localeCompare(b));
}

/** Goals data: total saved per goal across ALL stored transactions, including target-only goals */
function goalsData(){
  const map=new Map();
  transactions.filter(t=>t.type==='savings'&&t.savingsGoal).forEach(t=>{
    const k=t.savingsGoal.toLowerCase();
    if(!map.has(k)) map.set(k,{name:t.savingsGoal,total:0,count:0,last:t.date});
    const g=map.get(k);
    g.total+=t.amount;
    g.count++;
    if(t.date>g.last) g.last=t.date;
  });
  // Add goals that have a target but no deposits yet
  Object.keys(goalTargets).forEach(k=>{
    if(!map.has(k)){
      // Try to get a nicely-capitalised display name from ledger_defaultGoal or title-case the key
      const stored=localStorage.getItem('ledger_defaultGoal')||'';
      const displayName = stored.toLowerCase()===k ? stored : k.replace(/\b\w/g,c=>c.toUpperCase());
      map.set(k,{name:displayName,total:0,count:0,last:''});
    }
  });
  return [...map.values()].sort((a,b)=>b.total-a.total);
}

/** Generate missed recurring transactions.
 *
 *  Works independently of cycle mode — a "weekly" recurring fires every
 *  7 days no matter whether the user's pay cycle is monthly, bimonthly,
 *  weekly, or custom.  A "monthly" recurring fires once per pay cycle.
 *
 *  On each call the function:
 *  • Monthly → adds one entry at the current cycle's start date (payday)
 *              if none exists yet for this cycle and ≥28 days have passed.
 *  • Weekly  → backfills EVERY missed 7-day interval from the last known
 *              occurrence up to (and including) today across ALL cycles,
 *              so no gaps appear when the user navigates between cycles.
 */
function autoGenerateRecurring(){
  const curKey = currentCycleKey();
  const today  = todayStr();

  // Collect the "canonical" template for each unique recurring item.
  // Sort ascending so the last occurrence wins (most up-to-date amount/note).
  const templates = new Map();
  [...transactions]
    .sort((a,b) => a.date.localeCompare(b.date))
    .filter(t => t.recurring)
    .forEach(t => {
      const key = `${t.category}::${t.label}::${t.recurFreq||'monthly'}`;
      templates.set(key, t);
    });

  let added = 0;

  templates.forEach(tmpl => {
    const freq = tmpl.recurFreq || 'monthly';

    // All dates that already have an entry for this recurring item
    const existingDates = new Set(
      transactions
        .filter(t => t.category===tmpl.category && t.label===tmpl.label && t.recurring)
        .map(t => t.date)
    );

    // Latest date among existing entries
    const sortedExisting = [...existingDates].sort((a,b) => b.localeCompare(a));
    const lastDate = sortedExisting.length > 0 ? sortedExisting[0] : null;

    // ─────────────────────────────────────────────
    //  MONTHLY — once per pay cycle
    // ─────────────────────────────────────────────
    if(freq === 'monthly'){
      // Already logged for this cycle → nothing to do
      const inThisCycle = cycleTxs(curKey).some(t =>
        t.category===tmpl.category && t.label===tmpl.label && t.recurring
      );
      if(inThisCycle) return;

      // Check if this series was stopped
      const monthlyKey = `${tmpl.category}::${tmpl.label}::monthly`;
      if(recurringStops[monthlyKey]) return;

      // Require at least 28 days since the last occurrence
      if(lastDate){
        const daysSince = Math.floor(
          (new Date(today+'T00:00:00') - new Date(lastDate+'T00:00:00')) / 86400000
        );
        if(daysSince < 28) return;
      }

      // Date the entry on the cycle's actual start (payday), capped to today
      const {start: cStart} = cycleRange(curKey);
      const dateToUse = cStart <= today ? cStart : null;
      if(!dateToUse) return; // cycle hasn't started yet

      transactions.push({
        ...tmpl,
        id: Date.now() + Math.random(),
        date: dateToUse,
        autoGenerated: true
      });
      added++;

    // ─────────────────────────────────────────────
    //  WEEKLY — every 7 days from the first manual entry.
    //  The anchor is always the earliest NON-auto-generated entry.
    //  Generates every weekly date from anchor up to today (inclusive).
    //  Never adds dates in the future.
    // ─────────────────────────────────────────────
    } else if(freq === 'weekly'){
      const allEntries = transactions.filter(
        t => t.category===tmpl.category && t.label===tmpl.label && t.recurring
      );

      // Anchor = earliest manually-entered date
      const manualEntries = allEntries.filter(t => !t.autoGenerated).sort((a,b) => a.date.localeCompare(b.date));
      if(!manualEntries.length) return;
      const anchorDate = manualEntries[0].date; // e.g. "2025-02-08"

      // Walk forward from anchor+7 (first expected occurrence after anchor)
      // adding every date that has passed and doesn't already exist
      let cursor = new Date(anchorDate + 'T00:00:00');
      cursor.setDate(cursor.getDate() + 7); // first expected: Feb 8 → Feb 15

      // Build key to check stop
      const seriesKey = `${tmpl.category}::${tmpl.label}::weekly`;

      while(true){
        const dateStr = ymd(cursor.getFullYear(), cursor.getMonth()+1, cursor.getDate());
        if(dateStr > today) break; // future — stop

        // Stop if this series was stopped at or before this date
        if(recurringStops[seriesKey] && dateStr >= recurringStops[seriesKey]) break;

        if(!existingDates.has(dateStr)){
          transactions.push({
            ...tmpl,
            id: Date.now() + Math.random() + added,
            date: dateStr,
            autoGenerated: true
          });
          existingDates.add(dateStr);
          added++;
        }

        cursor.setDate(cursor.getDate() + 7);
      }
    }
  });

  if(added > 0){
    transactions.sort((a,b) => b.date.localeCompare(a.date) || b.id - a.id);
    persist();
  }
  return added;
}

/** Get recurring transaction templates for quick-add */
function getRecurringTemplates(){
  const seen=new Map();
  [...transactions].filter(t=>t.recurring).forEach(t=>{
    const key=`${t.category}::${t.amount}::${t.recurFreq||'monthly'}`;
    if(!seen.has(key)) seen.set(key,{...t});
  });
  return [...seen.values()].sort((a,b)=>b.amount-a.amount).slice(0,6);
}
function onGoalInput(){
  const q=document.getElementById('f-savings-goal').value.toLowerCase();
  const all=getSavingsGoals();
  const filtered=q ? all.filter(g=>g.toLowerCase().includes(q)) : all;
  renderGoalSuggestions(filtered);
  // Update target field with stored target for this goal
  setTimeout(refreshGoalTarget, 50);
}
function refreshGoalTarget(){
  const goalName=normGoal(document.getElementById('f-savings-goal').value||'Emergency Fund');
  const sym=document.getElementById('goal-target-sym');
  if(sym) sym.textContent=currencySymbol;
  const inp=document.getElementById('f-goal-target');
  if(!inp) return;
  const stored=goalTargets[goalName.toLowerCase()];
  if(stored && !inp.value) inp.value=stored;
  onGoalTargetInput();
}
function onGoalTargetInput(){
  const goalName=normGoal(document.getElementById('f-savings-goal').value||'Emergency Fund');
  const target=parseFloat(document.getElementById('f-goal-target').value)||0;
  const wrap=document.getElementById('goal-target-wrap');
  const hint=document.getElementById('goal-progress-hint');
  if(wrap) wrap.style.borderColor=target>0?'var(--accent)':'var(--border2)';
  if(!hint) return;
  if(target>0){
    const gd=goalsData();
    const gEntry=gd.find(g=>g.name.toLowerCase()===goalName.toLowerCase());
    const saved=gEntry?gEntry.total:0;
    const pct=Math.min(Math.round((saved/target)*100),100);
    const left=Math.max(target-saved,0);
    hint.style.display='block';
    hint.innerHTML=`<span style="color:var(--accent);font-weight:700;">${pct}% reached</span> · ${c$(saved)} of ${c$(target)} · <span style="color:var(--green);">${c$(left)} to go</span>`;
  } else {
    hint.style.display='none';
  }
}
function onGoalFocus(){
  const all=getSavingsGoals();
  renderGoalSuggestions(all);
  refreshGoalTarget();
}
function onGoalBlur(){
  // delay so click on suggestion registers first
  _goalBlurTimer=setTimeout(()=>closeGoalSuggestions(),200);
}
function renderGoalSuggestions(goals){
  const box=document.getElementById('goal-suggestions');
  if(!goals.length){ box.classList.remove('open'); return; }
  box.innerHTML=goals.map(g=>`
    <div class="goal-sug-item" onmousedown="pickGoal('${g.replace(/'/g,"\\'")}')">
      <div class="goal-sug-dot"></div>${g}
    </div>`).join('');
  box.classList.add('open');
}
function pickGoal(g){
  clearTimeout(_goalBlurTimer);
  document.getElementById('f-savings-goal').value=g;
  closeGoalSuggestions();
  refreshGoalTarget();
}
function closeGoalSuggestions(){
  document.getElementById('goal-suggestions')?.classList.remove('open');
}
// ════════════════════════════════════════════════════════════
function calcStreak(){
  if(!transactions.length) return 0;
  const dates=new Set(transactions.map(t=>t.date));
  let streak=0, check=new Date();
  if(!dates.has(todayStr())) check.setDate(check.getDate()-1);
  while(true){
    const d=ymd(check.getFullYear(),check.getMonth()+1,check.getDate());
    if(dates.has(d)){streak++;check.setDate(check.getDate()-1);}else break;
  }
  return streak;
}

// ════════════════════════════════════════════════════════════
//  THEME
// ════════════════════════════════════════════════════════════
function setTheme(t){
  activeTheme=t;
  document.body.className=[...document.body.classList].filter(c=>!c.startsWith('theme-')).concat('theme-'+t).join(' ');
  const allThemes=['dark','pink','white','navy','ice','forest','sunset','midnight'];
  allThemes.forEach(x=>{
    document.getElementById('theme-'+x)?.classList.toggle('active-theme',x===t);
  });
  const tc={
    'dark':'#080810','pink':'#1a0a14','white':'#f5f4f0',
    'navy':'#04080f','ice':'#06111a','forest':'#030f08',
    'sunset':'#0f0800','midnight':'#060410'
  };
  document.getElementById('theme-color-meta').content=tc[t]||'#080810';
  persist();
}

// ════════════════════════════════════════════════════════════
//  CYCLE SETTINGS UI
// ════════════════════════════════════════════════════════════
function selectCycleMode(mode){
  ['monthly','bimonthly','custom','weekly'].forEach(m=>{
    document.getElementById('cmo-'+m)?.classList.toggle('selected',m===mode);
    const f=document.getElementById('fields-'+m);
    if(f){ f.style.display=m===mode?'flex':'none'; f.style.flexDirection='column'; }
  });
  if(mode==='bimonthly') updateBiPreview();
}
/** Live preview of bi-monthly cycle dates shown in settings */
function updateBiPreview(){
  const s1=parseInt(document.getElementById('bi-s1')?.value)||25;
  const e1=parseInt(document.getElementById('bi-e1')?.value)||10;
  const s2=parseInt(document.getElementById('bi-s2')?.value)||11;
  const e2=parseInt(document.getElementById('bi-e2')?.value)||24;
  const cross=s1>e1;
  const preview=document.getElementById('bi-preview');
  if(!preview) return;
  const aRange=cross
    ? `Period A: ${s1}th → ${e1}th of next month`
    : `Period A: ${s1}th → ${e1}th (same month)`;
  const bRange=`Period B: ${s2}th → ${e2}th (same month)`;
  preview.innerHTML=`📅 ${aRange}<br/>📅 ${bRange}`;
}
function saveCycleSettings(){
  const prevMode=cycleMode;
  cycleMode=document.querySelector('.cycle-mode-opt.selected')?.id.replace('cmo-','')||'monthly';
  let detail='';
  if(cycleMode==='monthly'){
    cycleConfig.monthly.payDay=Math.min(28,Math.max(1,parseInt(document.getElementById('pay-day').value)||25));
    detail=`Monthly · pay day ${cycleConfig.monthly.payDay}`;
  } else if(cycleMode==='bimonthly'){
    cycleConfig.bimonthly.s1=parseInt(document.getElementById('bi-s1').value)||25;
    cycleConfig.bimonthly.e1=parseInt(document.getElementById('bi-e1').value)||10;
    cycleConfig.bimonthly.s2=parseInt(document.getElementById('bi-s2').value)||11;
    cycleConfig.bimonthly.e2=parseInt(document.getElementById('bi-e2').value)||24;
    detail=`Bi-monthly · ${cycleConfig.bimonthly.s1}–${cycleConfig.bimonthly.e1} & ${cycleConfig.bimonthly.s2}–${cycleConfig.bimonthly.e2}`;
  } else if(cycleMode==='weekly'){
    cycleConfig.weekly.payDow=parseInt(document.getElementById('pay-dow').value)||1;
    const days=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    detail=`Weekly · every ${days[cycleConfig.weekly.payDow]}`;
  } else {
    cycleConfig.custom.start=parseInt(document.getElementById('cust-start').value)||1;
    cycleConfig.custom.len  =Math.max(7,parseInt(document.getElementById('cust-len').value)||30);
    detail=`Custom · ${cycleConfig.custom.len}-day cycle from the ${cycleConfig.custom.start}${['st','nd','rd'][cycleConfig.custom.start-1]||'th'}`;
  }
  persist();
  activeCycleKey=currentCycleKey();
  showSettingsToast('📅 Pay cycle saved — ' + detail, 4000, 'sc-cycle');
  renderFeed();
}
function renderSettingsInputs(){
  // restore fields
  selectCycleMode(cycleMode);
  document.getElementById('pay-day').value   = cycleConfig.monthly.payDay;
  document.getElementById('bi-s1').value     = cycleConfig.bimonthly.s1;
  document.getElementById('bi-e1').value     = cycleConfig.bimonthly.e1;
  document.getElementById('bi-s2').value     = cycleConfig.bimonthly.s2;
  document.getElementById('bi-e2').value     = cycleConfig.bimonthly.e2||24;
  updateBiPreview();
  document.getElementById('cust-start').value= cycleConfig.custom.start;
  document.getElementById('cust-len').value  = cycleConfig.custom.len;
  document.getElementById('pay-dow').value   = cycleConfig.weekly?.payDow ?? 1;
  document.getElementById('currency-input').value = currencySymbol;
  document.getElementById('cycle-limit-input').value = cycleLimit;
  updateCycleLimitPreview();
  const inp = document.getElementById('cycle-limit-input');
  inp.oninput = updateCycleLimitPreview;
  ['dark','pink','white'].forEach(x=>{
    document.getElementById('theme-'+x)?.classList.toggle('active-theme',x===activeTheme);
  });
}
function updateCycleLimitPreview(){
  const raw = parseInt(document.getElementById('cycle-limit-input')?.value);
  const val = isNaN(raw)?cycleLimit:Math.max(3,Math.min(60,raw));

  // Calculate cutoff date for this many months
  const cutoff = new Date();
  cutoff.setMonth(cutoff.getMonth() - val);
  const cutoffStr = ymd(cutoff.getFullYear(), cutoff.getMonth()+1, cutoff.getDate());

  const existingKeys = [...new Set(transactions.map(t=>getCycleKey(t.date)))]
    .sort((a,b)=>cycleRange(b).start.localeCompare(cycleRange(a).start));
  const curKey = currentCycleKey();

  const willKeep = existingKeys.filter(k => cycleRange(k).start >= cutoffStr || k === curKey);
  const willRemove = existingKeys.filter(k => cycleRange(k).start < cutoffStr && k !== curKey);

  const preview = document.getElementById('cycle-limit-preview');
  if(!preview) return;
  if(existingKeys.length === 0){
    preview.innerHTML = `Currently no cycles stored.`;
    preview.style.color = 'var(--text3)';
    return;
  }
  if(willRemove.length === 0){
    const years = val >= 12 ? ` (${(val/12).toFixed(1)} yr${val!==12?'s':''})` : '';
    preview.innerHTML = `All <strong>${willKeep.length}</strong> cycle${willKeep.length!==1?'s':''} stored fall within the last <strong>${val} months</strong>${years} — nothing will be deleted.`;
    preview.style.color = 'var(--text3)';
    return;
  }
  const oldestKept = willKeep.length ? cycleLabel(willKeep[willKeep.length-1]) : '—';
  preview.innerHTML = `⚠️ <strong>${willRemove.length}</strong> old cycle${willRemove.length!==1?'s':''} will be deleted (older than ${val} months). Oldest kept: <strong>${oldestKept}</strong>.`;
  preview.style.color = 'var(--red)';
}

// ════════════════════════════════════════════════════════════
//  NAV
// ════════════════════════════════════════════════════════════
function nav(v){
  haptic(HX.tap);
  currentView=v;
  document.querySelectorAll('.view').forEach(el=>el.classList.add('hidden'));
  document.querySelectorAll('.nav-btn').forEach(el=>el.classList.remove('active'));
  const viewEl=document.getElementById(`view-${v}`);
  viewEl.classList.remove('hidden');
  viewEl.scrollTop=0;
  const nb=document.getElementById(`nav-${v}`);
  if(nb) nb.classList.add('active');
  // settings tab button alias
  if(v==='settings'){ const st=document.getElementById('nav-settings-tab'); if(st) st.classList.add('active'); }
  if(v==='feed')      renderFeed();
  if(v==='dashboard') renderDash();
  if(v==='calendar')  { const t=new Date(); calViewMonth={year:t.getFullYear(),month:t.getMonth()}; renderCalendar(); }
  if(v==='settings')  renderSettings();
}

// ════════════════════════════════════════════════════════════
//  BOTTOM SHEET
// ════════════════════════════════════════════════════════════
// ════════════════════════════════════════════════════════════
//  SPEED-DIAL FAB
// ════════════════════════════════════════════════════════════
function toggleFabDial(){
  const dial=document.getElementById('fab-dial');
  const backdrop=document.getElementById('fab-backdrop');
  const fab=document.getElementById('fab-main');
  const isOpen=dial.classList.contains('open');
  if(isOpen){ closeFabDial(); }
  else { dial.classList.add('open'); backdrop.classList.add('open'); fab.style.transform='rotate(45deg) scale(.92)'; fab.style.boxShadow='0 4px 24px var(--accent-dim)'; }
}
function closeFabDial(){
  const dial=document.getElementById('fab-dial');
  const backdrop=document.getElementById('fab-backdrop');
  const fab=document.getElementById('fab-main');
  dial.classList.remove('open'); backdrop.classList.remove('open'); fab.style.transform=''; fab.style.boxShadow='';
}
let sheetTypeFilter = null; // set when opening from FAB dial — null = show all
function openSheetType(type){
  closeFabDial();
  sheetTypeFilter = type;
  const cat = CATS.find(c=>c.t===type);
  if(cat){ selectedCat = cat.k; }
  openSheet();
}

function openSheet(tx=null){
  editingId=null; isRecurring=false; isCreditPay=false; recurFreq='weekly';
  // Clear type filter unless we just set it via openSheetType
  if(!tx) { /* keep sheetTypeFilter if set by openSheetType */ }
  if(tx) sheetTypeFilter=null; // editing: always show all categories
  const df=document.getElementById('f-date');

  // Set date bounds based on which cycle we're adding to
  const targetCk = tx ? getCycleKey(tx.date) : activeCycleKey;
  const curKey   = currentCycleKey();
  const isCurCycle = targetCk === curKey;
  const {start:cStart, end:cEnd} = cycleRange(targetCk);

  if(isCurCycle){
    // Current cycle: min = cycle start, max = today
    df.min = cStart;
    df.max = todayStr();
    df.value = tx ? tx.date : todayStr();
  } else {
    // Past cycle: locked to cycle's start → end only
    df.min = cStart;
    df.max = cEnd;
    df.value = tx ? tx.date : cEnd; // default to last day of that cycle
  }

  document.getElementById('f-amount').value='';
  document.getElementById('f-note').value='';
  document.getElementById('f-savings-goal').value='';
  if(document.getElementById('f-goal-target')) document.getElementById('f-goal-target').value='';
  if(document.getElementById('goal-target-sym')) document.getElementById('goal-target-sym').textContent=currencySymbol;
  if(document.getElementById('goal-progress-hint')) document.getElementById('goal-progress-hint').style.display='none';
  document.getElementById('savings-goal-section').style.display = (sheetTypeFilter==='savings') ? 'block' : 'none';
  document.getElementById('add-toast').style.display='none';
  document.getElementById('date-err').style.display='none';
  if(sheetTypeFilter){
    const defaultCat=CATS.find(c=>c.t===sheetTypeFilter);
    selectedCat=defaultCat?defaultCat.k:'transport';
  } else {
    selectedCat='transport';
  }
  if(tx){
    editingId=tx.id; df.value=tx.date;
    document.getElementById('f-amount').value=tx.amount;
    document.getElementById('f-note').value=tx.note||'';
    document.getElementById('f-savings-goal').value=tx.savingsGoal||'';
    selectedCat=tx.category; isRecurring=!!tx.recurring; recurFreq=tx.recurFreq||'weekly';
    if(tx.category==='savings'){
      document.getElementById('savings-goal-section').style.display='block';
      const goalKey=(tx.savingsGoal||'Emergency Fund').toLowerCase();
      const storedTarget=goalTargets[goalKey]||'';
      if(document.getElementById('f-goal-target')) document.getElementById('f-goal-target').value=storedTarget||'';
      setTimeout(onGoalTargetInput,50);
    }
    document.getElementById('sheet-title').innerHTML='Edit <em>Transaction</em>';
  } else { document.getElementById('sheet-title').innerHTML='Log a <em>Transaction</em>'; }
  document.getElementById('amt-remaining').style.display='none';
  document.getElementById('amt-err').style.display='none';
  document.getElementById('amt-sym').textContent=currencySymbol;
  document.getElementById('recur-toggle').className='toggle'+(isRecurring?' on':'');
  document.getElementById('recur-freq-wrap').style.display=isRecurring?'flex':'none';
  updateRecurFreqUI();
  // Credit toggle
  document.getElementById('credit-toggle')&&(document.getElementById('credit-toggle').className='toggle');
  document.getElementById('cc-picker-wrap').classList.remove('open');
  // Reset payment method buttons
  const cashBtn=document.getElementById('pay-method-cash');
  const creditBtn=document.getElementById('pay-method-credit');
  if(cashBtn) cashBtn.classList.add('active');
  if(creditBtn) creditBtn.classList.remove('active');
  // Show credit toggle section only for expenses and if cards exist
  const hasCCs = creditCards.length > 0;
  // Compute available balance for the cycle
  _sheetAvailable = getCycleAvailable(targetCk, editingId||null);
  buildCatGrid(); updateSaveBtn(); updateRemainingHint();
  updateCreditToggleVisibility();
  populateCardPicker();
  document.getElementById('sheet-overlay').classList.add('active');
  document.getElementById('add-sheet').classList.add('open');
  sheetOpen=true;
}
function closeSheet(){
  document.getElementById('sheet-overlay').classList.remove('active');
  const sheet=document.getElementById('add-sheet');
  sheet.classList.remove('open');
  sheet.style.transition=''; sheet.style.transform='translateX(-50%) translateY(100%)';
  setTimeout(()=>{ sheet.style.transform=''; }, 350);
  sheetOpen=false; expandedTx=null; sheetTypeFilter=null;
}
function toggleRecur(){
  isRecurring=!isRecurring;
  document.getElementById('recur-toggle').className='toggle'+(isRecurring?' on':'');
  const wrap=document.getElementById('recur-freq-wrap');
  wrap.style.display=isRecurring?'flex':'none';
  if(isRecurring) updateRecurFreqUI();
}
function setRecurFreq(freq){
  recurFreq=freq;
  updateRecurFreqUI();
}
function updateRecurFreqUI(){
  ['weekly','monthly'].forEach(f=>{
    const btn=document.getElementById('recur-freq-'+f);
    if(btn) btn.classList.toggle('active', f===recurFreq);
  });
  const sub=document.getElementById('recur-sub');
  if(sub) sub.textContent=recurFreq==='weekly'?'Repeats every week':'Repeats every month';
}
function toggleCredit(){
  isCreditPay=!isCreditPay;
  document.getElementById('credit-toggle')&&(document.getElementById('credit-toggle').className='toggle'+(isCreditPay?' on':''));
  const wrap=document.getElementById('cc-picker-wrap');
  if(isCreditPay){ wrap.classList.add('open'); populateCardPicker(); }
  else { wrap.classList.remove('open'); }
  updateRemainingHint(); updateSaveBtn();
}
function setPayMethod(method){
  isCreditPay = (method==='credit');
  // Update button styles
  const cashBtn=document.getElementById('pay-method-cash');
  const creditBtn=document.getElementById('pay-method-credit');
  if(cashBtn) cashBtn.classList.toggle('active', !isCreditPay);
  if(creditBtn) creditBtn.classList.toggle('active', isCreditPay);
  const wrap=document.getElementById('cc-picker-wrap');
  if(isCreditPay){ wrap.classList.add('open'); populateCardPicker(); }
  else { wrap.classList.remove('open'); }
  updateRemainingHint(); updateSaveBtn();
}
function updateCreditToggleVisibility(){
  const cat=CATS.find(c=>c.k===selectedCat);
  const isExp = cat && cat.t==='expense';
  const sec=document.getElementById('credit-toggle-section');
  if(isExp && creditCards.length>0){
    sec.style.display='block';
    // Reset to cash method when showing
    if(!isCreditPay){
      const cashBtn=document.getElementById('pay-method-cash');
      const creditBtn=document.getElementById('pay-method-credit');
      if(cashBtn) cashBtn.classList.add('active');
      if(creditBtn) creditBtn.classList.remove('active');
    }
  }
  else {
    sec.style.display='none'; isCreditPay=false;
    document.getElementById('credit-toggle')&&(document.getElementById('credit-toggle').className='toggle');
    document.getElementById('cc-picker-wrap').classList.remove('open');
  }
}
function populateCardPicker(){
  const sel=document.getElementById('f-credit-card');
  sel.innerHTML=creditCards.map(c=>{
    const info=getCardInfo(c.id);
    return `<option value="${c.id}">${c.name} — ${currencySymbol}${fmt(info.available,0)} available</option>`;
  }).join('');
  updateCCHint();
}
function updateCCHint(){
  if(!isCreditPay) return;
  const cardId=document.getElementById('f-credit-card')?.value;
  if(!cardId) return;
  const info=getCardInfo(cardId);
  const hint=document.getElementById('cc-hint');
  const amt=parseFloat(document.getElementById('f-amount').value)||0;
  const after=info.available-amt;
  if(after<0){
    hint.textContent=`⛔ Exceeds available credit by ${currencySymbol}${fmt(Math.abs(after),0)}`;
    hint.style.color='var(--red)';
  } else {
    hint.textContent=`💳 ${currencySymbol}${fmt(after,0)} will remain available on this card`;
    hint.style.color='#a855f7';
  }
}

// ════════════════════════════════════════════════════════════
//  CATEGORIES
// ════════════════════════════════════════════════════════════
function buildCatGrid(){
  const catSection = document.getElementById('cat-grid')?.closest('.form-section');
  if(sheetTypeFilter==='savings'){
    if(catSection) catSection.style.display='none';
    return;
  }
  if(catSection) catSection.style.display='';
  const cats = sheetTypeFilter ? CATS.filter(c=>c.t===sheetTypeFilter) : CATS;
  document.getElementById('cat-grid').innerHTML=cats.map(c=>`
    <div class="cat-tile ${selectedCat===c.k?`sel-${c.t}`:''}\" onclick=\"selectCat('${c.k}')">
      <span class="cat-icon">${c.i}</span><span class="cat-name">${c.l}</span>
    </div>`).join('');
  updateSaveBtn();
}
let _sheetAvailable = Infinity; // available balance when sheet opens

function onAmountInput(){
  updateSaveBtn();
  updateRemainingHint();
}

function updateRemainingHint(){
  const cat = CATS.find(c=>c.k===selectedCat);
  const hintEl = document.getElementById('amt-remaining');
  const errEl  = document.getElementById('amt-err');
  // Income has no cap; credit card expense has no balance cap
  if(!cat || cat.t==='income' || isCreditPay){
    hintEl.style.display='none';
    errEl.style.display='none';
    if(isCreditPay) updateCCHint();
    return;
  }
  const val = parseFloat(document.getElementById('f-amount').value)||0;
  const avail = _sheetAvailable;
  const left = avail - val;
  hintEl.style.display = 'flex';
  if(val <= 0){
    hintEl.className='amt-remaining ok';
    hintEl.textContent = `Available: ${c$(avail)}`;
  } else if(left >= 0){
    const cls = left < avail*0.2 ? 'warn' : 'ok';
    hintEl.className=`amt-remaining ${cls}`;
    hintEl.textContent = `${c$(left)} remaining after this`;
    errEl.style.display='none';
  } else {
    hintEl.className='amt-remaining over';
    hintEl.textContent = `Exceeds available balance by ${c$(Math.abs(left))}`;
    errEl.style.display='block';
  }
}
function selectCat(k){
  selectedCat=k;
  buildCatGrid();
  const goalSection=document.getElementById('savings-goal-section');
  if(goalSection) goalSection.style.display = k==='savings' ? 'block' : 'none';
  if(k==='savings'){
    const firstHint=document.getElementById('goal-first-hint');
    if(firstHint) firstHint.style.display = getSavingsGoals().length===0 ? 'block':'none';
  }
  updateCreditToggleVisibility();
  updateRemainingHint();
}
function updateSaveBtn(){
  const cat=CATS.find(c=>c.k===selectedCat);
  const btn=document.getElementById('save-btn');
  btn.className=`save-btn btn-${cat?.t||'expense'}`;
  btn.textContent=editingId?'Update Entry':`Save ${cat?.i||''} ${cat?.l||''}`;
  const amt=parseFloat(document.getElementById('f-amount').value);
  // Over-balance check is skipped if paying with credit card
  const overBudget = cat && cat.t!=='income' && !isCreditPay && amt > 0 && amt > _sheetAvailable;
  // Check credit limit if paying with credit
  let overCredit=false;
  if(isCreditPay && amt>0){
    const cardId=document.getElementById('f-credit-card')?.value;
    if(cardId){ const info=getCardInfo(cardId); overCredit=amt>info.available; }
  }
  btn.disabled=!amt||isNaN(amt)||amt<=0||overBudget||overCredit;
}

// ════════════════════════════════════════════════════════════
//  SAVE / DELETE
// ════════════════════════════════════════════════════════════
function saveTransaction(){
  const amount=parseFloat(document.getElementById('f-amount').value);
  if(!amount||isNaN(amount)||amount<=0) return;
  const chosenDate=document.getElementById('f-date').value;
  const errEl=document.getElementById('date-err');
  if(chosenDate>todayStr()){errEl.style.display='block';setTimeout(()=>errEl.style.display='none',3000);return;}
  errEl.style.display='none';
  const cat=CATS.find(c=>c.k===selectedCat);
  // Hard guard: block going negative for expense/savings (unless using credit card)
  if(cat.t!=='income' && !isCreditPay && amount > _sheetAvailable){
    document.getElementById('amt-err').style.display='block';
    return;
  }
  const id=editingId||Date.now();
  const rawGoal=document.getElementById('f-savings-goal').value.trim();
  // Default savings goal: "Emergency Fund" if none typed and no prior goals exist
  let savingsGoal='';
  if(cat.t==='savings'){
    if(rawGoal){
      savingsGoal=normGoal(rawGoal);
    } else {
      const existingGoals=getSavingsGoals();
      savingsGoal=existingGoals.length>0?'Emergency Fund':'Emergency Fund';
    }
    // Save target if provided
    const targetAmt=parseFloat(document.getElementById('f-goal-target')?.value)||0;
    if(targetAmt>0) goalTargets[savingsGoal.toLowerCase()]=targetAmt;
  }
  // Credit card
  let creditCardId=null;
  if(isCreditPay && cat.t==='expense'){
    creditCardId=document.getElementById('f-credit-card')?.value||null;
  }
  const tx={id,date:chosenDate,category:selectedCat,label:cat.l,icon:cat.i,type:cat.t,amount,note:document.getElementById('f-note').value.trim(),recurring:isRecurring,recurFreq:isRecurring?recurFreq:null,savingsGoal,creditCardId};
  if(editingId) transactions=transactions.filter(t=>t.id!==editingId);
  // If user manually adds a recurring entry, clear any stop for that series (they're resuming it)
  if(tx.recurring){
    const freq = tx.recurFreq || 'monthly';
    const seriesKey = `${tx.category}::${tx.label}::${freq}`;
    if(recurringStops[seriesKey]){
      delete recurringStops[seriesKey];
      localStorage.setItem('ledger_recur_stops', JSON.stringify(recurringStops));
    }
  }
  transactions.push(tx);
  transactions.sort((a,b)=>b.date.localeCompare(a.date)||b.id-a.id);
  enforceCycleLimit();
  if(tx.recurring) autoGenerateRecurring(); // immediately generate any due occurrences
  persist();
  activeCycleKey=getCycleKey(tx.date);
  expandedTx=null; deleteConfirm=null;
  haptic(HX.success);
  document.getElementById('add-toast').style.display='flex';
  setTimeout(()=>{closeSheet();renderFeed();renderDash();},900);
}
let _undoTimer = null;
let _undoTx = null;

function deleteTx(id){
  const tx = transactions.find(t => t.id === id);
  if(!tx) return;

  // If deleting a recurring entry, check if it's the most recent in its series
  // If so, record a stop so future auto-generation won't re-add it or go further
  if(tx.recurring){
    const freq = tx.recurFreq || 'monthly';
    const seriesKey = `${tx.category}::${tx.label}::${freq}`;
    const seriesEntries = transactions.filter(
      t => t.id !== id && t.category===tx.category && t.label===tx.label && t.recurring
    );
    const latestRemaining = seriesEntries
      .map(t => t.date)
      .sort((a,b) => b.localeCompare(a))[0] || null;

    // Deleted date is later than (or equal to) all remaining → it was the latest → stop
    if(!latestRemaining || tx.date >= latestRemaining){
      recurringStops[seriesKey] = tx.date;
      localStorage.setItem('ledger_recur_stops', JSON.stringify(recurringStops));
    }
  }

  // Remove from array immediately
  transactions = transactions.filter(t => t.id !== id);
  persist(); deleteConfirm=null; expandedTx=null;
  haptic(HX.delete);
  renderFeed(); renderDash();

  // Clear any existing undo toast
  if(_undoTimer){ clearTimeout(_undoTimer); _undoTimer=null; }
  const existing = document.getElementById('undo-toast');
  if(existing) existing.remove();

  // Store for undo
  _undoTx = tx;

  // Build toast
  const toast = document.createElement('div');
  toast.id = 'undo-toast';
  toast.className = 'undo-toast';
  toast.innerHTML = `
    <div style="font-size:1.3rem;">${tx.icon}</div>
    <div class="undo-toast-text">
      <div>${tx.label} deleted</div>
      <div class="undo-toast-sub">${tx.type.charAt(0).toUpperCase()+tx.type.slice(1)} · ${currencySymbol}${fmt(tx.amount,2)}</div>
    </div>
    <button class="undo-btn" onclick="undoDelete()">Undo</button>
    <div class="undo-progress" id="undo-progress" style="width:100%;"></div>
  `;
  document.getElementById('app').appendChild(toast);

  // Animate progress bar shrinking over 5s
  const bar = document.getElementById('undo-progress');
  requestAnimationFrame(()=>{
    requestAnimationFrame(()=>{
      if(bar){ bar.style.transitionDuration='5000ms'; bar.style.width='0%'; }
    });
  });

  // Auto-dismiss after 5s
  _undoTimer = setTimeout(()=>{ dismissUndoToast(); }, 5000);
}

function undoDelete(){
  if(!_undoTx) return;
  clearTimeout(_undoTimer); _undoTimer=null;
  transactions.push(_undoTx);
  transactions.sort((a,b)=>b.date.localeCompare(a.date)||b.id-a.id);
  _undoTx=null;
  persist();
  haptic(HX.success);
  dismissUndoToast();
  renderFeed(); renderDash();
}

function dismissUndoToast(){
  const toast=document.getElementById('undo-toast');
  if(toast){
    toast.style.transition='opacity .25s, transform .25s';
    toast.style.opacity='0';
    toast.style.transform='translateX(-50%) translateY(16px)';
    setTimeout(()=>toast.remove(), 260);
  }
  _undoTx=null;
}

// ════════════════════════════════════════════════════════════
//  SEARCH & FILTER
// ════════════════════════════════════════════════════════════
function onSearch(){ searchQuery=document.getElementById('search-input').value.toLowerCase(); document.getElementById('search-clear').style.display=searchQuery?'flex':'none'; renderFeed(); }
function clearSearch(){ document.getElementById('search-input').value=''; searchQuery=''; document.getElementById('search-clear').style.display='none'; renderFeed(); }
function setFilter(f){ activeFilter=f; renderFilterChips(); renderFeed(); }
function renderFilterChips(){
  const fs=[{k:'all',l:'All'},{k:'income',l:'💼 Income'},{k:'expense',l:'💸 Spent'},{k:'savings',l:'🏦 Saved'},{k:'recurring',l:'🔄 Recurring'}];
  document.getElementById('filter-chips').innerHTML=fs.map(f=>`<button class="filter-chip ${activeFilter===f.k?`fc-${f.k}`:''}\" onclick=\"setFilter('${f.k}')">${f.l}</button>`).join('');
}

// ════════════════════════════════════════════════════════════
//  BUDGET
// ════════════════════════════════════════════════════════════
// ── Budget collapsed state ──
let budgetCollapsed = localStorage.getItem('ledger_budget_collapsed') === '1';

function openBudgetModal(focusCat){
  document.getElementById('budget-inputs').innerHTML = EXPENSE_CATS.map(c => {
    const val = budgets[c.k] || '';
    const hasVal = val > 0;
    return `<div class="bm-cat-card" id="bm-card-${c.k}">
      <div class="bm-icon">${c.i}</div>
      <div class="bm-name">${c.l}</div>
      <div class="bm-field-wrap">
        <span class="bm-sym">${currencySymbol}</span>
        <input class="bm-field" type="number" inputmode="decimal" id="bud-${c.k}"
          placeholder="no limit" value="${val}"
          oninput="onBudgetFieldInput('${c.k}')"/>
      </div>
      <button class="bm-clear" id="bm-clear-${c.k}" onclick="clearBudgetField('${c.k}')"
        style="opacity:${hasVal?1:0.3}"
        title="Remove budget">✕</button>
    </div>`;
  }).join('');
  document.getElementById('budget-modal').classList.add('open');
  if(focusCat){
    setTimeout(()=>{
      const inp = document.getElementById('bud-'+focusCat);
      if(inp){ inp.focus(); inp.select(); }
    }, 320);
  }
}
function onBudgetFieldInput(catKey){
  const val = parseFloat(document.getElementById('bud-'+catKey)?.value)||0;
  const clearBtn = document.getElementById('bm-clear-'+catKey);
  if(clearBtn) clearBtn.style.opacity = val > 0 ? '1' : '0.3';
}
function clearBudgetField(catKey){
  const inp = document.getElementById('bud-'+catKey);
  if(inp){ inp.value=''; inp.focus(); }
  const clearBtn = document.getElementById('bm-clear-'+catKey);
  if(clearBtn) clearBtn.style.opacity = '0.3';
}
function closeBudgetModal(e){
  // Called directly (no event) or via backdrop click
  if(e && e.target && e.target !== document.getElementById('budget-modal')) return;
  document.getElementById('budget-modal').classList.remove('open');
}
function saveBudgets(){
  EXPENSE_CATS.forEach(c=>{
    const v = parseFloat(document.getElementById(`bud-${c.k}`)?.value)||0;
    if(v > 0) budgets[c.k] = v; else delete budgets[c.k];
  });
  persist();
  document.getElementById('budget-modal').classList.remove('open');
  // Auto-expand after setting budgets
  if(Object.keys(budgets).length > 0) budgetCollapsed = false;
  renderFeed(); renderSettings();
  const activeCount = Object.keys(budgets).length;
  if(activeCount > 0){
    showSettingsToast(`💰 Budgets saved — ${activeCount} categor${activeCount!==1?'ies':'y'} with limits set`, 3500, 'sc-budgets');
  } else {
    showSettingsToast('💰 Budgets cleared — no limits active', 3000, 'sc-budgets');
  }
}
function toggleBudgetCollapse(){
  budgetCollapsed = !budgetCollapsed;
  localStorage.setItem('ledger_budget_collapsed', budgetCollapsed ? '1' : '0');
  const body  = document.getElementById('budget-body');
  const chev  = document.getElementById('budget-chevron');
  if(body) body.classList.toggle('open', !budgetCollapsed);
  if(chev) chev.classList.toggle('open', !budgetCollapsed);
}
// ════════════════════════════════════════════════════════════
//  CREDIT CARD HELPERS
// ════════════════════════════════════════════════════════════
/** Returns {limit, used, available, pct} for a card */
function getCardInfo(cardId){
  const card = creditCards.find(c=>c.id===cardId);
  if(!card) return {limit:0,used:0,available:0,pct:0};
  // Used = sum of all credit card expenses for this card
  const used = transactions
    .filter(t=>t.creditCardId===cardId && t.type==='expense')
    .reduce((s,t)=>s+t.amount,0);
  // Restored = sum of all credit payments for this card
  const paid = transactions
    .filter(t=>t.creditCardId===cardId && t.type==='credit_payment')
    .reduce((s,t)=>s+t.amount,0);
  const net = Math.max(0, used - paid);
  const available = Math.max(0, card.limit - net);
  const pct = card.limit > 0 ? Math.min((net/card.limit)*100,100) : 0;
  return {limit:card.limit, used:net, available, pct};
}
function addCreditCard(){
  const name=(document.getElementById('cc-name-input').value||'').trim();
  const limit=parseFloat(document.getElementById('cc-limit-input').value)||0;
  const interest=parseFloat(document.getElementById('cc-interest-input').value)||0;
  if(!name||limit<=0){ showSettingsToast('⚠️ Enter a card name and limit.', 3000, 'sc-cards'); return; }
  creditCards.push({id:String(Date.now()), name, limit, billingFee: interest||0});
  document.getElementById('cc-name-input').value='';
  document.getElementById('cc-limit-input').value='';
  document.getElementById('cc-interest-input').value='';
  persist(); renderSettingsCCList(); showSettingsToast('💳 Card added!', 3000, 'sc-cards');
}
function removeCreditCard(id){
  const info=getCardInfo(id);
  const card=creditCards.find(c=>c.id===id);
  if(!card) return;

  const hasBalance=info.used>0;
  showConfirm({
    icon: hasBalance ? '⚠️' : '💳',
    title: hasBalance ? `${card.name} has unpaid balance!` : `Remove ${card.name}?`,
    msg: hasBalance
      ? `There's still ${currencySymbol}${fmt(info.used,2)} outstanding. Delete the card and all its transactions, or just remove the card and keep transaction history?`
      : `Delete the card and all its transactions, or just remove the card and keep the transaction history?`,
    okLabel: 'Delete Card + Transactions',
    secondaryLabel: 'Remove Card Only',
    cancelLabel: 'Cancel',
    onOk:()=>{
      creditCards=creditCards.filter(c=>c.id!==id);
      transactions=transactions.filter(t=>t.creditCardId!==id);
      persist(); renderSettingsCCList(); renderFeed(); renderDash();
      showSettingsToast('Card and all transactions removed.', 3000, 'sc-cards');
    },
    onSecondary:()=>{
      creditCards=creditCards.filter(c=>c.id!==id);
      transactions=transactions.map(t=>t.creditCardId===id?{...t,creditCardId:null}:t);
      persist(); renderSettingsCCList(); renderFeed(); renderDash();
      showSettingsToast('Card removed. Transactions kept.', 3000, 'sc-cards');
    }
  });
}
function renderSettingsCCList(){
  const el=document.getElementById('cc-settings-list');
  if(!el) return;
  if(!creditCards.length){ el.innerHTML='<div style="font-size:.75rem;color:var(--text3);margin-bottom:6px;">No cards added yet.</div>'; return; }
  el.innerHTML=creditCards.map(c=>{
    const info=getCardInfo(c.id);
    const color=info.pct>=90?'var(--red)':info.pct>=70?'var(--accent)':'var(--green)';
    return `<div style="background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:10px 12px;margin-bottom:6px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
        <span style="font-size:.85rem;font-weight:700;color:var(--text);">💳 ${c.name}</span>
        <div style="display:flex;align-items:center;gap:7px;">
          ${c.billingFee>0?`<span style="font-size:.65rem;font-weight:700;color:#a855f7;background:#a855f718;border:1px solid #a855f730;border-radius:6px;padding:2px 7px;">+${currencySymbol}${fmt(c.billingFee,0)} fee</span>`:''}
          <button class="cc-del-btn" onclick="removeCreditCard('${c.id}')">Remove</button>
        </div>
      </div>
      <div style="display:flex;justify-content:space-between;font-size:.7rem;color:var(--text3);margin-bottom:4px;">
        <span>Used: <strong style="color:${color}">${currencySymbol}${fmt(info.used,0)}</strong></span>
        <span>Available: <strong style="color:var(--green)">${currencySymbol}${fmt(info.available,0)}</strong></span>
        <span>Limit: <strong style="color:var(--text2)">${currencySymbol}${fmt(info.limit,0)}</strong></span>
      </div>
      <div style="height:4px;background:var(--bg3);border-radius:99px;overflow:hidden;">
        <div style="height:100%;width:${info.pct}%;background:${color};border-radius:99px;transition:width .6s;"></div>
      </div>
    </div>`;
  }).join('');
}
function openPayModal(cardId){
  const card=creditCards.find(c=>c.id===cardId); if(!card) return;
  const info=getCardInfo(cardId);
  const curKey=currentCycleKey();
  const cashAvail=Math.max(0, getCycleAvailable(curKey));

  document.getElementById('pay-card-id').value=cardId;
  document.getElementById('pay-modal-sub').textContent=`Payment deducts from your cash balance and restores ${card.name}'s credit.`;
  document.getElementById('pay-modal-owed').textContent=`${currencySymbol}${fmt(info.used,0)}`;
  document.getElementById('pay-cash-avail').textContent=`${currencySymbol}${fmt(cashAvail,0)}`;
  document.getElementById('pay-sym').textContent=currencySymbol;
  document.getElementById('pay-fee-sym').textContent=currencySymbol;

  // Pre-fill billing fee button if card has a default fee set
  const feeRow=document.getElementById('pay-fee-prefill-row');
  const feeBtn=document.getElementById('pay-fee-prefill-btn');
  if(card.billingFee>0){
    feeRow.style.display='block';
    feeBtn.textContent=`Use default fee: ${currencySymbol}${fmt(card.billingFee,0)}`;
  } else {
    feeRow.style.display='none';
  }

  const inp=document.getElementById('pay-amount');
  inp.value='';
  inp.max=String(info.used); // hard cap at outstanding balance
  document.getElementById('pay-fee-amount').value='';
  document.getElementById('pay-hint').textContent=cashAvail<=0?'⛔ No cash available this cycle to make a payment.':'';
  document.getElementById('pay-summary-row').style.display='none';
  const btn=document.querySelector('.pay-save');
  if(btn){ btn.disabled=cashAvail<=0||info.used<=0; btn.style.opacity=cashAvail<=0||info.used<=0?'0.3':'1'; }
  document.getElementById('pay-modal').classList.add('open');
  const errT=document.getElementById('pay-error-toast');
  if(errT) errT.style.display='none';
}
function closePayModal(e){ if(e&&e.target!==document.getElementById('pay-modal'))return; document.getElementById('pay-modal').classList.remove('open'); }
function showPayError(msg){
  const t=document.getElementById('pay-error-toast');
  if(!t) return;
  t.textContent=msg; t.style.display='block';
  setTimeout(()=>t.style.display='none', 3500);
}
function prefillBillingFee(){
  const cardId=document.getElementById('pay-card-id').value;
  const card=creditCards.find(c=>c.id===cardId);
  if(card?.billingFee>0){
    document.getElementById('pay-fee-amount').value=card.billingFee;
    updatePayHint();
  }
}
function setPayQuick(mode){
  const cardId=document.getElementById('pay-card-id').value;
  const info=getCardInfo(cardId);
  const curKey=currentCycleKey();
  const cashAvail=Math.max(0, getCycleAvailable(curKey));
  let val;
  if(mode==='full') val=info.used;
  else val=Math.min(info.used, cashAvail);
  document.getElementById('pay-amount').value=val>0?String(Math.round(val*100)/100):'';
  updatePayHint();
}
function updatePayHint(){
  const cardId=document.getElementById('pay-card-id').value;
  const info=getCardInfo(cardId);
  const curKey=currentCycleKey();
  const cashAvail=Math.max(0, getCycleAvailable(curKey));
  const principal=parseFloat(document.getElementById('pay-amount').value)||0;
  const fee=parseFloat(document.getElementById('pay-fee-amount').value)||0;
  const totalOut=principal+fee;
  const hint=document.getElementById('pay-hint');
  const btn=document.querySelector('.pay-save');
  const sumRow=document.getElementById('pay-summary-row');

  // Update summary if either field has a value
  if(principal>0||fee>0){
    sumRow.style.display='block';
    document.getElementById('pay-sum-principal').textContent=`${currencySymbol}${fmt(principal,2)}`;
    document.getElementById('pay-sum-fee').textContent=fee>0?`${currencySymbol}${fmt(fee,2)}`:'—';
    document.getElementById('pay-sum-total').textContent=`${currencySymbol}${fmt(totalOut,2)}`;
  } else {
    sumRow.style.display='none';
  }

  if(principal<=0 && fee<=0){ hint.textContent=''; if(btn){btn.disabled=false;btn.style.opacity='1';}return; }
  if(totalOut>cashAvail){
    hint.textContent=`⛔ Total (${currencySymbol}${fmt(totalOut,2)}) exceeds cash available (${currencySymbol}${fmt(cashAvail,2)})`;
    hint.style.color='var(--red)';
    if(btn){btn.disabled=true;btn.style.opacity='0.3';}
  } else if(principal>info.used){
    hint.textContent=`⛔ Payment exceeds outstanding balance by ${currencySymbol}${fmt(principal-info.used,2)}`;
    hint.style.color='var(--red)';
    if(btn){btn.disabled=true;btn.style.opacity='0.3';}
  } else {
    const newAvail=info.available+Math.min(principal,info.used);
    const cashLeft=cashAvail-totalOut;
    hint.textContent=`Card credit → ${currencySymbol}${fmt(newAvail,0)} · Cash left: ${currencySymbol}${fmt(cashLeft,0)}${fee>0?' · Fee logged as expense':''}`;
    hint.style.color='#a855f7';
    if(btn){btn.disabled=false;btn.style.opacity='1';}
  }
}
function submitCreditPayment(){
  const cardId=document.getElementById('pay-card-id').value;
  const principal=parseFloat(document.getElementById('pay-amount').value)||0;
  const fee=parseFloat(document.getElementById('pay-fee-amount').value)||0;
  if(principal<=0 && fee<=0) return;
  const card=creditCards.find(c=>c.id===cardId); if(!card) return;
  const info=getCardInfo(cardId);
  const curKey=currentCycleKey();
  const cashAvail=Math.max(0, getCycleAvailable(curKey));
  const totalOut=principal+fee;

  // Hard guards — never allow overpayment
  if(info.used<=0 && principal>0){
    showPayError('⚠️ No outstanding balance on this card.');
    return;
  }
  if(principal>info.used){
    showPayError(`⚠️ Max payable is ${currencySymbol}${fmt(info.used,2)} — amount corrected.`);
    document.getElementById('pay-amount').value=String(Math.round(info.used*100)/100);
    updatePayHint();
    return;
  }
  if(totalOut>cashAvail){
    showPayError(`⚠️ Not enough cash available (${currencySymbol}${fmt(cashAvail,2)})`);
    return;
  }

  const now=Date.now();

  // 1. Principal payment — restores card credit
  if(principal>0){
    transactions.push({
      id:now,
      date:todayStr(),
      category:'credit_payment',
      label:`${card.name} Payment`,
      icon:'💳',
      type:'credit_payment',
      amount:principal,
      note:`Credit card payment — ${card.name}`,
      recurring:false,
      savingsGoal:'',
      creditCardId:cardId
    });
  }

  // 2. Billing fee — logged as a separate expense (does NOT restore credit)
  if(fee>0){
    transactions.push({
      id:now+1,
      date:todayStr(),
      category:'other',
      label:`${card.name} Billing Fee`,
      icon:'📊',
      type:'expense',
      amount:fee,
      note:`Billing fee / interest — ${card.name}`,
      recurring:false,
      savingsGoal:'',
      creditCardId:null
    });
  }

  transactions.sort((a,b)=>b.date.localeCompare(a.date)||b.id-a.id);
  persist();
  document.getElementById('pay-modal').classList.remove('open');
  renderFeed();
  renderDash();
}
function renderCreditSection(){
  const el=document.getElementById('credit-area');
  if(!el||!creditCards.length){if(el)el.innerHTML='';return;}
  const pills=creditCards.map(c=>{
    const info=getCardInfo(c.id);
    const color=info.pct>=90?'var(--red)':info.pct>=70?'var(--accent)':'#a855f7';
    const hasDebt=info.used>0;
    return `<div style="flex-shrink:0;background:var(--bg1);border:1.5px solid ${hasDebt?color:'var(--border)'};border-radius:14px;padding:8px 12px;cursor:pointer;min-width:130px;" onclick="openPayModal('${c.id}')">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:5px;">
        <span style="font-size:.7rem;font-weight:700;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:80px;">&#x1F4B3; ${c.name}</span>
        ${hasDebt?`<span style="font-size:.58rem;font-weight:700;background:${color}20;color:${color};border-radius:5px;padding:1px 5px;">Pay</span>`:'<span style="font-size:.58rem;color:var(--green);font-weight:700;">&#x2713; Clear</span>'}
      </div>
      <div style="height:3px;background:var(--bg3);border-radius:99px;overflow:hidden;margin-bottom:4px;">
        <div style="height:100%;width:${info.pct}%;background:${color};border-radius:99px;"></div>
      </div>
      <div style="display:flex;justify-content:space-between;font-size:.62rem;">
        <span style="color:${color};font-weight:700;">${fmtS(info.used)} used</span>
        <span style="color:var(--text3);">${fmtS(info.available)} left</span>
      </div>
    </div>`;
  }).join('');
  el.innerHTML=`<div style="padding:0 20px 10px;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:7px;">
      <span style="font-size:.62rem;text-transform:uppercase;letter-spacing:1.2px;color:var(--text3);font-weight:700;">&#x1F4B3; Credit Cards</span>
      <span style="font-size:.67rem;color:var(--accent);cursor:pointer;font-weight:700;" onclick="nav('settings')">Manage</span>
    </div>
    <div style="display:flex;gap:8px;overflow-x:auto;scrollbar-width:none;padding-bottom:2px;-webkit-overflow-scrolling:touch;">${pills}</div>
  </div>`;
}

// ════════════════════════════════════════════════════════════
//  RENDER FEED
// ════════════════════════════════════════════════════════════
function renderFeed(){
  const now=new Date();
  document.getElementById('top-date-label').textContent=`${SHORT_M[now.getMonth()]} ${now.getDate()}, ${now.getFullYear()}`;
  const modeLabels={monthly:'Pay-cycle tracker',bimonthly:'Bi-monthly tracker',weekly:'Weekly pay tracker',custom:'Custom cycle tracker'};
  document.getElementById('cycle-mode-label').textContent=modeLabels[cycleMode]||'Pay-cycle tracker';

  const curKey=currentCycleKey();
  if(!activeCycleKey) activeCycleKey=curKey;

  const allKeys=allCycleKeys();
  const idx=allKeys.indexOf(activeCycleKey);
  document.getElementById('mnav-prev').disabled=idx>=allKeys.length-1;
  document.getElementById('mnav-next').disabled=idx<=0||cycleRange(allKeys[idx-1]).start>cycleRange(curKey).start;
  document.getElementById('cycle-label').textContent=cycleLabel(activeCycleKey);
  document.getElementById('cycle-range').textContent=cycleRangeStr(activeCycleKey);

  // ── Balance bar ──
  const bs = cycleStats(activeCycleKey);
  const balAvail = getCycleAvailable(activeCycleKey);
  const balPct = bs.income > 0 ? Math.min(100, Math.max(0, (balAvail / bs.income) * 100)) : 0;
  const balColor = balPct > 40 ? 'var(--green)' : balPct > 15 ? 'var(--accent)' : 'var(--red)';
  const amtEl = document.getElementById('fbb-amount');
  const fillEl = document.getElementById('fbb-fill');
  if(amtEl){
    amtEl.textContent = c$(Math.max(0, balAvail));
    amtEl.style.color = balColor;
  }
  if(fillEl){ fillEl.style.width = balPct+'%'; fillEl.style.background = balColor; }
  const incEl=document.getElementById('fbb-income');
  const expEl=document.getElementById('fbb-expense');
  const savEl=document.getElementById('fbb-savings');
  if(incEl) incEl.textContent = c$(bs.income);
  if(expEl) expEl.textContent = c$(bs.expense);
  if(savEl) savEl.textContent = c$(bs.savings);

  renderFilterChips();

  let txs=[...cycleTxs(activeCycleKey)];
  // When searching, expand to ALL transactions across all stored cycles
  if(searchQuery){
    txs=[...transactions];
  }
  if(searchQuery) txs=txs.filter(t=>(t.label+' '+(t.note||'')+' '+(t.savingsGoal||'')).toLowerCase().includes(searchQuery));
  if(activeFilter==='income')    txs=txs.filter(t=>t.type==='income');
  else if(activeFilter==='expense')  txs=txs.filter(t=>t.type==='expense');
  else if(activeFilter==='savings')  txs=txs.filter(t=>t.type==='savings');
  else if(activeFilter==='recurring') txs=txs.filter(t=>t.recurring);

  const grouped={};
  txs.forEach(t=>{(grouped[t.date]||(grouped[t.date]=[])).push(t);});
  const dates=Object.keys(grouped).sort((a,b)=>b.localeCompare(a));
  // Show "Searching all cycles" badge when global search active
  const feedList=document.getElementById('feed-list');
  const searchBanner=document.getElementById('search-all-banner');
  if(searchQuery){
    if(!searchBanner){
      const b=document.createElement('div');
      b.id='search-all-banner';
      b.style.cssText='margin:0 20px 8px;padding:7px 12px;background:var(--blue-dim);border:1px solid var(--blue);border-radius:10px;font-size:.72rem;color:var(--blue);font-weight:700;display:flex;align-items:center;gap:6px;';
      b.innerHTML=`🌐 <span id="search-all-count"></span>`;
      feedList.parentElement.insertBefore(b, feedList);
    }
    document.getElementById('search-all-count').textContent=`Searching all cycles · ${txs.length} result${txs.length!==1?'s':''}`;
  } else if(searchBanner){ searchBanner.remove(); }

  const list=feedList;

  if(!dates.length){
    list.innerHTML=`<div class="empty"><div class="empty-icon">${searchQuery?'🔍':'📭'}</div>
      <div class="empty-txt">${searchQuery?`No results for "<strong>${searchQuery}</strong>"<br/><span style="font-size:.72rem;color:var(--text3);">Searched all cycles</span>`:`Nothing logged yet for<br/><strong>${cycleLabel(activeCycleKey)}</strong>.<br/>Tap + to add your first entry!`}</div></div>`;
    return;
  }

  list.innerHTML = dates.map(date=>{
    const dt=grouped[date];
    const dn=dt.reduce((s,t)=>s+(t.type==='income'?t.amount:-t.amount),0);
    return `<div class="date-group">
      <div class="date-hdr">
        <span class="date-hdr-label">${formatDate(date)}</span>
        <span class="date-hdr-line"></span>
        <span class="date-hdr-total" style="color:${dn>=0?'var(--green)':'var(--red)'}">${dn>=0?'+':'-'}${currencySymbol}${fmt(Math.abs(dn),0)}</span>
      </div>
      ${dt.map(tx=>renderTxCard(tx)).join('')}
    </div>`;
  }).join('');
  list.querySelectorAll('.tx[data-id]').forEach(el=>{ /* tap-to-expand only */ });
}

function renderTxCard(tx){
  const isOpen=expandedTx===tx.id, isDel=deleteConfirm===tx.id;
  const glowC=tx.type==='income'?'var(--green-dim)':tx.type==='savings'?'var(--accent-dim)':tx.type==='credit_payment'?'#a855f718':'var(--red-dim)';
  const amtC=tx.type==='income'?'var(--green)':tx.type==='savings'?'var(--accent)':tx.type==='credit_payment'?'#a855f7':'var(--red)';
  const sign=tx.type==='income'?'+':'-';
  // Credit card tag
  let ccTag='';
  if(tx.creditCardId){
    const card=creditCards.find(c=>c.id===tx.creditCardId);
    if(card) ccTag=`<span class="cc-tag">💳 ${card.name}</span>`;
  }
  if(tx.type==='credit_payment'){
    const card=creditCards.find(c=>c.id===tx.creditCardId);
    ccTag=`<span class="cc-tag">💳 ${card?card.name:'Card'} Payment</span>`;
  }
  let actions='';
  return `<div class="tx-wrap" data-id="${tx.id}">
    <div class="tx-swipe-bg-right">✏️</div>
    <div class="tx-swipe-bg-left">🗑</div>
    <div class="tx ${isOpen?'open':''}" data-id="${tx.id}" onclick="toggleTx(${tx.id})">
      <div class="tx-glow" style="background:radial-gradient(circle,${glowC},transparent 70%)"></div>
      <div class="tx-icon ${tx.type==='credit_payment'?'expense':tx.type}">${tx.icon}</div>
      <div class="tx-body">
        <div class="tx-name">${tx.recurring?'<span class="recur-dot"></span>':''} ${tx.label}${tx.savingsGoal?`<span class="goal-tag">🎯 ${tx.savingsGoal}</span>`:''}${ccTag}</div>
        ${tx.note?`<div class="tx-note">${tx.note}</div>`:''}
      </div>
      <div class="tx-right">
        <div class="tx-amt" style="color:${amtC}">${sign}${currencySymbol}${fmt(tx.amount)}</div>
        ${tx.recurring?`<div class="tx-recur-tag">🔄 ${tx.recurFreq==='monthly'?'monthly':'weekly'}</div>`:''}
      </div>
    </div>
    ${actions}
  </div>`;
}

function getTx(id){ return transactions.find(t=>t.id===id); }
function toggleTx(id){
  if(deleteConfirm) return;
  expandedTx = expandedTx===id ? null : id;
  // Update only the affected card for performance
  const wrap=document.querySelector(`.tx-wrap[data-id="${id}"]`);
  if(wrap){ const tx=getTx(id); if(tx){ wrap.outerHTML=renderTxCard(tx); return; } }
  renderFeed();
}
function setDel(id){
  deleteConfirm=id;
  // Update only the affected card for performance
  if(id){
    const wrap=document.querySelector(`.tx-wrap[data-id="${id}"]`);
    if(wrap){ const tx=getTx(id); if(tx){ wrap.outerHTML=renderTxCard(tx); return; } }
  } else {
    // Cancel — find any card in delete state and re-render it
    const prev=document.querySelector('.tx-wrap .act-confirm');
    if(prev){ const wrap=prev.closest('.tx-wrap'); if(wrap){ const tx=getTx(parseInt(wrap.dataset.id)); if(tx){ wrap.outerHTML=renderTxCard(tx); return; } } }
  }
  renderFeed();
}
function setCycle(ck){ 
  activeCycleKey=ck; expandedTx=null; deleteConfirm=null; 
  if(ck===currentCycleKey()) autoGenerateRecurring();
  renderFeed(); 
}

function shiftCycle(dir){
  const all=allCycleKeys(), idx=all.indexOf(activeCycleKey);
  const nidx=idx-dir;
  if(nidx>=0&&nidx<all.length&&cycleRange(all[nidx]).start<=cycleRange(currentCycleKey()).start){ setCycle(all[nidx]); return; }
  if(dir===-1){ const p=shiftKey(activeCycleKey,-1); if(cycleRange(p).start>='2020-01-01') setCycle(p); }
}



// ════════════════════════════════════════════════════════════
//  RENDER DASHBOARD
// ════════════════════════════════════════════════════════════
function renderDash(){
  const dash=document.getElementById('dash-content');
  const curKey=currentCycleKey();
  const now=new Date();

  // ── Update hero (now lives on dashboard) ──
  const s=cycleStats(activeCycleKey);
  const isCur=activeCycleKey===curKey;
  document.getElementById('dash-date-label').textContent=`${SHORT_M[now.getMonth()]} ${now.getDate()}, ${now.getFullYear()}`;
  document.getElementById('dash-cycle-label').textContent=cycleLabel(activeCycleKey);
  document.getElementById('dash-cycle-range').textContent=cycleRangeStr(activeCycleKey);
  const allKeys=allCycleKeys(), idx=allKeys.indexOf(activeCycleKey);
  const dashPrev=document.getElementById('dash-mnav-prev'), dashNext=document.getElementById('dash-mnav-next');
  if(dashPrev) dashPrev.disabled=idx>=allKeys.length-1;
  if(dashNext) dashNext.disabled=idx<=0||cycleRange(allKeys[idx-1]).start>cycleRange(curKey).start;
  document.getElementById('hero-label').textContent=isCur?'Remaining this cycle':`Total for ${cycleLabel(activeCycleKey,true)}`;
  document.getElementById('hero-sign').textContent=currencySymbol;
  document.getElementById('hero-net-val').textContent=fmt(s.net,0);
  document.getElementById('hero-net').style.color=s.net>=0?'var(--green)':'var(--red)';
  document.getElementById('hero-income').textContent=c$(s.income);
  document.getElementById('hero-expense').textContent=c$(s.expense);
  document.getElementById('hero-savings').textContent=c$(s.savings);
  const streak=calcStreak();
  document.getElementById('dash-streak-area').innerHTML=streak>=2?`<div class="streak-badge">🔥 ${streak}-day streak</div>`:'';
  renderProjection();
  renderSpendAlerts();

  if(!transactions.length){
    dash.innerHTML=`<div class="empty" style="padding-top:80px;"><div class="empty-icon">📊</div><div class="empty-txt">No data yet.<br/>Add transactions first!</div></div>`;
    return;
  }

  const prevKey=shiftKey(curKey,-1);
  const curS=cycleStats(curKey), prevS=cycleStats(prevKey);

  // ── Collect only cycles that have actual transaction data ──
  const dataKeys=allCycleKeys().filter(ck=>{
    const {start,end}=cycleRange(ck);
    return transactions.some(t=>t.date>=start&&t.date<=end);
  });
  // For trend: up to 12, sorted oldest→newest
  const trendKeys=dataKeys.slice().sort((a,b)=>cycleRange(a).start.localeCompare(cycleRange(b).start)).slice(-12);
  const trendData=trendKeys.map(ck=>({ck,...cycleStats(ck)}));

  // ── HIGHLIGHTS row (horizontal scroll cards) ──
  const nonEmpty=trendData.filter(d=>d.income>0||d.expense>0||d.savings>0);
  let hlHtml='';
  if(nonEmpty.length>=1){
    const best    =[...nonEmpty].sort((a,b)=>b.savings-a.savings)[0];
    const lowest  =[...nonEmpty].filter(d=>d.expense>0).sort((a,b)=>a.expense-b.expense)[0]||nonEmpty[0];
    const topInc  =[...nonEmpty].sort((a,b)=>b.income-a.income)[0];
    const bestRate=[...nonEmpty].filter(d=>d.income>0).sort((a,b)=>b.rate-a.rate)[0]||nonEmpty[0];
    const avgIncome =nonEmpty.reduce((s,d)=>s+d.income,0)/nonEmpty.length;
    const avgExpense=nonEmpty.reduce((s,d)=>s+d.expense,0)/nonEmpty.length;
    const avgSavings=nonEmpty.reduce((s,d)=>s+d.savings,0)/nonEmpty.length;
    hlHtml=`<div class="section">
      <div class="section-title">🏆 Highlights</div>
      <div class="section-sub">Personal bests · ${nonEmpty.length} cycle${nonEmpty.length!==1?'s':''} with data</div>
      <div class="hl-row">
        ${[
          {icon:'🏆',label:'Best Savings',val:fmtS(best.savings),          sub:cycleLabel(best.ck,true),       c:'var(--accent)'},
          {icon:'📈',label:'Best Income', val:fmtS(topInc.income),          sub:cycleLabel(topInc.ck,true),     c:'var(--green)'},
          {icon:'🎯',label:'Low Spend',   val:fmtS(lowest.expense),         sub:cycleLabel(lowest.ck,true),     c:'var(--blue)'},
          {icon:'💡',label:'Best Rate',   val:bestRate.rate.toFixed(0)+'%', sub:cycleLabel(bestRate.ck,true),   c:'var(--accent)'},
        ].map(h=>`<div class="hl-mini">
          <div class="hl-mini-icon">${h.icon}</div>
          <div class="hl-mini-label">${h.label}</div>
          <div class="hl-mini-val" style="color:${h.c}">${h.val}</div>
          <div class="hl-mini-sub">${h.sub}</div>
        </div>`).join('')}
      </div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-top:8px;">
        ${[
          {l:'Avg Income',v:avgIncome, c:'var(--green)'},
          {l:'Avg Spent', v:avgExpense,c:'var(--red)'},
          {l:'Avg Saved', v:avgSavings,c:'var(--accent)'},
        ].map(a=>`<div style="background:var(--bg2);border-radius:10px;padding:8px 6px;text-align:center;">
          <div style="font-size:.54rem;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);font-weight:700;margin-bottom:3px;">${a.l}</div>
          <div style="font-family:'Playfair Display',serif;font-size:.85rem;font-weight:700;color:${a.c};">${fmtS(a.v)}</div>
        </div>`).join('')}
      </div>
    </div>`;
  }

  // ── CREDIT CARDS — horizontal pill scroll (same style as feed) ──
  let creditHtml='';
  if(creditCards.length){
    const totalUsed =creditCards.reduce((s,c)=>s+getCardInfo(c.id).used,0);
    const totalLimit=creditCards.reduce((s,c)=>s+c.limit,0);
    const totalPct  =totalLimit>0?Math.min((totalUsed/totalLimit)*100,100):0;
    const totalColor=totalPct>=90?'var(--red)':totalPct>=70?'var(--accent)':'var(--green)';
    const pills=creditCards.map(c=>{
      const info=getCardInfo(c.id);
      const col=info.pct>=90?'var(--red)':info.pct>=70?'var(--accent)':'var(--blue)';
      const hasDebt=info.used>0;
      return `<div onclick="openPayModal('${c.id}')" style="flex-shrink:0;min-width:140px;background:var(--bg2);border:1.5px solid ${hasDebt?col:'var(--border)'};border-radius:14px;padding:10px 12px;cursor:pointer;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
          <span style="font-size:.72rem;font-weight:700;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:85px;">💳 ${c.name}</span>
          <span style="font-size:.58rem;font-weight:700;padding:2px 6px;border-radius:5px;background:${hasDebt?col+'20':'var(--green-dim)'};color:${hasDebt?col:'var(--green)'};">${hasDebt?'Pay':'✓ Clear'}</span>
        </div>
        <div style="height:3px;background:var(--bg3);border-radius:99px;overflow:hidden;margin-bottom:5px;">
          <div style="height:100%;width:${info.pct}%;background:${col};border-radius:99px;"></div>
        </div>
        <div style="display:flex;justify-content:space-between;font-size:.62rem;">
          <span style="color:${col};font-weight:700;">${fmtS(info.used)} used</span>
          <span style="color:var(--text3);">${fmtS(info.available)} left</span>
        </div>
      </div>`;
    }).join('');
    creditHtml=`<div class="section">
      <div style="display:flex;align-items:baseline;justify-content:space-between;margin-bottom:4px;">
        <div class="section-title" style="margin-bottom:0;">💳 Credit Cards</div>
        <div style="font-size:.65rem;color:${totalColor};font-weight:700;">${Math.round(totalPct)}% used · ${totalPct<30?'Healthy':totalPct<70?'Moderate':'High'}</div>
      </div>
      <div class="section-sub" style="margin-bottom:8px;">${fmtS(totalUsed)} of ${fmtS(totalLimit)} limit</div>
      <div style="display:flex;gap:8px;overflow-x:auto;scrollbar-width:none;padding-bottom:2px;-webkit-overflow-scrolling:touch;">${pills}</div>
    </div>`;
  }

  // ── LAST vs THIS — compact pill comparison ──
  const sbsRows2=[
    {label:'Income', cur:curS.income,  prev:prevS.income,  col:'var(--green)',  low:false},
    {label:'Spent',  cur:curS.expense, prev:prevS.expense, col:'var(--red)',    low:true},
    {label:'Saved',  cur:curS.savings, prev:prevS.savings, col:'var(--accent)', low:false},
    {label:'Rate',   cur:curS.rate,    prev:prevS.rate,    col:'var(--blue)',   low:false, isPct:true},
    {label:'Left',   cur:curS.net,     prev:prevS.net,     col:curS.net>=0?'var(--green)':'var(--red)', isNet:true},
  ];
  const fmtV2=(v,r)=>r.isPct?v.toFixed(0)+'%':r.isNet?(v<0?'–':'')+fmtS(Math.abs(v)):fmtS(v);
  const arrow=(cur,prev,low=false)=>{ const d=cur-prev; if(!d) return ''; const good=low?d<0:d>0; return `<span style="color:${good?'var(--green)':'var(--red)'};">${d>0?'↑':'↓'}</span>`; };
  const sbsHtml=`<div class="section">
    <div style="display:flex;align-items:baseline;justify-content:space-between;margin-bottom:2px;">
      <div class="section-title" style="margin-bottom:0;">Last vs This</div>
      <div style="font-size:.65rem;color:var(--text3);">${cycleLabel(prevKey,true)} → <span style="color:var(--accent);">${cycleLabel(curKey,true)}</span></div>
    </div>
    <div class="section-sub" style="margin-bottom:8px;">How this cycle compares</div>
    <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:5px;">
      ${sbsRows2.map(r=>`<div style="background:var(--bg2);border-radius:10px;padding:8px 5px;text-align:center;">
        <div style="font-size:.54rem;text-transform:uppercase;letter-spacing:.4px;color:var(--text3);font-weight:700;margin-bottom:3px;">${r.label}</div>
        <div style="font-family:'Playfair Display',serif;font-size:.75rem;font-weight:700;color:${r.col};line-height:1.2;">${fmtV2(r.cur,r)} ${arrow(r.cur,r.prev,r.low)}</div>
        <div style="font-size:.58rem;color:var(--text3);margin-top:2px;">${fmtV2(r.prev,r)}</div>
      </div>`).join('')}
    </div>
  </div>`;

  // ── SAVINGS RING (compact) ──
  const rate=Math.min(curS.rate,100), r2=34, circ2=2*Math.PI*r2;
  const ringHtml=`<div class="section">
    <div class="section-title">Savings Rate</div>
    <div class="section-sub">${cycleLabel(curKey,true)} · ${c$(curS.savings)} of ${c$(curS.income)}</div>
    <div class="ring-card">
      <svg width="84" height="84" viewBox="0 0 100 100" style="flex-shrink:0;">
        <circle cx="50" cy="50" r="${r2}" fill="none" stroke="var(--bg3)" stroke-width="10"/>
        <circle cx="50" cy="50" r="${r2}" fill="none" stroke="var(--accent)" stroke-width="10"
          stroke-dasharray="${circ2*(rate/100)} ${circ2}" stroke-dashoffset="${circ2/4}" stroke-linecap="round"/>
        <text x="50" y="50" text-anchor="middle" dominant-baseline="central"
          style="font-family:'Playfair Display',serif;font-size:15px;font-weight:900;fill:var(--accent)">${Math.round(rate)}%</text>
      </svg>
      <div>
        <div class="ring-label">Saved this cycle</div>
        <div class="ring-pct" style="color:var(--accent);font-size:1.3rem;">${curS.rate.toFixed(1)}%</div>
        <div class="ring-sub">${c$(curS.savings)} saved<br/>${c$(curS.income)} earned</div>
      </div>
    </div>
  </div>`;

  // ── SAVINGS GOALS ──
  const gData=goalsData();
  let goalsHtml='';
  if(gData.length){
    const topTotal=gData[0].total||1;
    const rows=gData.map((g,i)=>{
      const barPct=Math.round((g.total/topTotal)*100);
      const medals=['🥇','🥈','🥉'];
      const rank=i<3?medals[i]:`${i+1}`;
      const target=goalTargets[g.name.toLowerCase()]||0;
      const targetPct=target>0?Math.min(Math.round((g.total/target)*100),100):0;
      const targetBar=target>0?`<div style="margin-top:5px;">
        <div style="display:flex;justify-content:space-between;font-size:.6rem;color:var(--text3);margin-bottom:2px;">
          <span>Target: ${c$(target)}</span><span style="color:${targetPct>=100?'var(--green)':'var(--accent)'};">${targetPct}%</span>
        </div>
        <div style="height:4px;background:var(--bg3);border-radius:99px;overflow:hidden;">
          <div style="height:100%;width:${targetPct}%;background:${targetPct>=100?'var(--green)':'var(--accent)'};border-radius:99px;transition:width .6s;"></div>
        </div>
        ${targetPct>=100?'<div style="font-size:.6rem;color:var(--green);font-weight:700;margin-top:2px;">🎉 Goal reached!</div>':''}
      </div>`:'';
      const metaLine = g.count>0
        ? `${g.count} deposit${g.count!==1?'s':''} · last ${formatDate(g.last)}`
        : `<span style="color:var(--text3);font-style:italic;">No deposits yet — start saving!</span>`;
      return `<div class="goal-card">
        <div class="goal-card-rank">${rank}</div>
        <div class="goal-card-body">
          <div class="goal-card-name">🎯 ${g.name}</div>
          <div class="goal-card-meta">${metaLine}</div>
          <div class="goal-bar-track"><div class="goal-bar-fill" style="width:${barPct}%"></div></div>
          ${targetBar}
        </div>
        <div class="goal-card-amt">${g.total>0?c$(g.total):`<span style="color:var(--text3);font-size:.8rem;">${c$(0)}</span>`}</div>
      </div>`;
    }).join('');
    const grandTotal=gData.reduce((s,g)=>s+g.total,0);
    const totalGoalsWithTarget=gData.filter(g=>goalTargets[g.name.toLowerCase()]>0).length;
    goalsHtml=`<div class="section">
      <div class="section-title">🎯 Savings Goals</div>
      <div class="section-sub">All-time · ${gData.length} goal${gData.length!==1?'s':''}${grandTotal>0?' · '+c$(grandTotal)+' total':''}</div>
      <div class="goals-grid">${rows}</div>
    </div>`;
  }

  // ── DONUT ──
  const expTxs=cycleTxs(curKey).filter(t=>t.type==='expense');
  const catSpend={};
  expTxs.forEach(t=>{catSpend[t.category]=(catSpend[t.category]||0)+t.amount;});
  const totalSpend=Object.values(catSpend).reduce((a,b)=>a+b,0)||1;
  const catEntries=Object.entries(catSpend).sort((a,b)=>b[1]-a[1]).slice(0,8);
  let donutHtml='';
  if(catEntries.length){
    const r=40,cx=50,cy=50; let off=0; const circ=2*Math.PI*r;
    const paths=catEntries.map(([k,v],i)=>{ const d=circ*(v/totalSpend),g=circ-d; const p=`<circle cx="${cx}" cy="${cy}" r="${r}" fill="none" stroke="${DONUT_COLORS[i]}" stroke-width="18" stroke-dasharray="${d} ${g}" stroke-dashoffset="${-off}" transform="rotate(-90 ${cx} ${cy})" opacity=".85"/>`; off+=d; return p; }).join('');
    const catMap=Object.fromEntries(CATS.map(c=>[c.k,c]));
    const items=catEntries.slice(0,5).map(([k,v],i)=>`
      <div class="donut-item"><div class="donut-dot" style="background:${DONUT_COLORS[i]}"></div>
        <span class="donut-name">${catMap[k]?.i||''} ${catMap[k]?.l||k}</span>
        <span class="donut-val" style="color:${DONUT_COLORS[i]}">${fmtS(v)}</span>
        <span class="donut-pct">${Math.round((v/totalSpend)*100)}%</span>
      </div>`).join('');
    donutHtml=`<div class="section">
      <div class="section-title">Spending Breakdown</div>
      <div class="section-sub">${cycleLabel(curKey,true)} · Where the money went</div>
      <div class="donut-card">
        <div class="donut-row">
          <svg width="88" height="88" viewBox="0 0 100 100" style="flex-shrink:0;">
            <circle cx="50" cy="50" r="40" fill="none" stroke="var(--bg3)" stroke-width="18"/>
            ${paths}
            <text x="50" y="50" text-anchor="middle" dominant-baseline="central" style="font-family:'Playfair Display',serif;font-size:10px;font-weight:900;fill:var(--red)">${fmtS(totalSpend)}</text>
          </svg>
          <div class="donut-legend">${items}</div>
        </div>
      </div>
    </div>`;
  }

  // ── TREND ──
  const metricColor={income:'var(--green)',expense:'var(--red)',savings:'var(--accent)',net:'var(--blue)'};
  const metricClass={income:'mt-inc',expense:'mt-exp',savings:'mt-sav',net:'mt-net'};
  const maxVal=Math.max(...trendData.map(d=>Math.abs(d[dashMetric])),1);
  // Past-bar colour: a fixed dim neutral so every metric clearly contrasts with current
  const pastBarColor='var(--border2)';
  const barsHtml=trendData.length?trendData.map(d=>{
    const val=d[dashMetric], pct=Math.max((Math.abs(val)/maxVal)*100,3);
    const col=metricColor[dashMetric], isCur=d.ck===curKey;
    // Use explicit pixel height (track is 68px) so bars always render correctly
    const barPx=Math.max(Math.round(pct*0.68),3);
    const barBg=isCur?col:pastBarColor;
    const barOpacity=isCur?1:0.55;
    return `<div class="bar-col ${isCur?'is-cur':''}">
      <div class="bar-col-val" style="color:${isCur?col:'var(--text3)'};">${fmtS(val)}</div>
      <div class="bar-col-track"><div class="bar-rect" style="height:${barPx}px;background:${barBg};opacity:${barOpacity};${isCur?'border-radius:6px 6px 2px 2px;filter:brightness(1.15);':''}"></div></div>
      <div class="bar-col-name" style="color:${isCur?col:'var(--text3)'};opacity:${isCur?1:.7};">${cycleLabel(d.ck,true).split(' ')[0]}</div>
    </div>`;
  }).join(''):'<div style="color:var(--text3);font-size:.8rem;padding:20px;text-align:center;">Log more cycles to see the trend</div>';
  const trendHtml=`<div class="section">
    <div class="section-title">${trendData.length}-Cycle Trend</div>
    <div class="section-sub">Only cycles with data · <span style="color:var(--accent)">★ current</span></div>
    <div class="metric-tabs">
      ${[{k:'income',l:'💼 Income'},{k:'expense',l:'💸 Spent'},{k:'savings',l:'🏦 Saved'},{k:'net',l:'📊 Net'}]
        .map(m=>`<button class="metric-tab ${dashMetric===m.k?metricClass[m.k]:''}" onclick="setMetric('${m.k}')">${m.l}</button>`).join('')}
    </div>
    <div class="chart-card"><div class="bars">${barsHtml}</div></div>
  </div>`;

  dash.innerHTML=`<div style="height:8px;"></div>
  ${creditHtml}
  ${hlHtml}
  ${sbsHtml}
  ${ringHtml}
  ${goalsHtml}
  ${donutHtml}
  ${trendHtml}
  <div style="height:20px;"></div>`;
}

// ════════════════════════════════════════════════════════════
//  SETTINGS RENDER
// ════════════════════════════════════════════════════════════
function setMetric(m){ dashMetric=m; renderDash(); }
function renderSettings(){
  renderSettingsInputs();
  renderSettingsCCList();
  syncHapticToggle();
  syncNotifUI();
  document.getElementById('cycle-limit-input').value = cycleLimit;
  // Backup interval
  const bii=document.getElementById('backup-interval-input');
  if(bii) bii.value=getBackupInterval();
  updateLastBackupLabel();
  updateLastImportLabel();
  syncBackupToggles();
  const cycleKeys=[...new Set(transactions.map(t=>getCycleKey(t.date)))];
  const cycleCount=cycleKeys.length;
  const recur=transactions.filter(t=>t.recurring).length;
  const size=new Blob([JSON.stringify(transactions)]).size;
  const limitNote = cycleCount >= cycleLimit
    ? `<span style="color:var(--accent)">⚠️ At limit (${cycleLimit} mo)</span>`
    : `<span style="color:var(--text3)">${cycleCount} cycles / ${cycleLimit} mo limit</span>`;
  document.getElementById('settings-stats').innerHTML=
    `📊 <strong>${transactions.length}</strong> transactions<br/>
     🔄 <strong>${recur}</strong> recurring<br/>
     📅 <strong>${cycleCount}</strong> cycles stored ${limitNote}<br/>
     💾 <strong>${(size/1024).toFixed(1)} KB</strong> stored in browser`;
  // Budget summary in settings
  const bss = document.getElementById('settings-budget-summary');
  if(bss){
    const active = EXPENSE_CATS.filter(c=>budgets[c.k]);
    if(!active.length){
      bss.innerHTML = '<span style="color:var(--text3)">No budgets set yet.</span>';
    } else {
      const curKey = currentCycleKey();
      const txs = cycleTxs(curKey).filter(t=>t.type==='expense');
      bss.innerHTML = active.map(c=>{
        const spent = txs.filter(t=>t.category===c.k).reduce((s,t)=>s+t.amount,0);
        const limit = budgets[c.k];
        const pct   = Math.round((spent/limit)*100);
        const color = spent>limit?'var(--red)':pct>=80?'var(--accent)':'var(--green)';
        return `<span>${c.i} ${c.l}: <strong style="color:${color}">${c$(spent)}</strong> / ${c$(limit)}</span>`;
      }).join(' &nbsp;·&nbsp; ');
    }
  }

  // PIN card
  const pinBtns=document.getElementById('pin-settings-btns');
  if(pinBtns){
    if(pinHash){
      pinBtns.innerHTML=`
        <div style="font-size:.72rem;color:var(--green);font-weight:700;margin-bottom:8px;">✅ PIN is active — your app is protected</div>
        <div style="display:flex;gap:8px;">
          <button class="settings-btn btn-blue" style="flex:1;margin:0;" onclick="openPinSetup(()=>renderSettings())">🔄 Change PIN</button>
          <button class="settings-btn btn-red" style="flex:1;margin:0;" onclick="removePin()">🔓 Remove PIN</button>
        </div>
        <div style="font-size:.67rem;color:var(--text3);margin-top:7px;">Change PIN: you'll be asked to verify your current PIN first. Remove PIN: same deal — confirm before it's gone.</div>`;
      document.getElementById('pin-settings-desc').textContent='PIN is active. Required every time you open the app.';
    } else {
      pinBtns.innerHTML=`<button class="settings-btn btn-blue" onclick="openPinSetup(()=>renderSettings())">🔐 Set PIN Lock</button>`;
      document.getElementById('pin-settings-desc').textContent='No PIN set. Tap below to protect your data with a 4-digit PIN.';
    }
  }
}
function saveCurrency(){
  const v=document.getElementById('currency-input').value.trim(); if(!v)return;
  const prev=currencySymbol;
  currencySymbol=v; persist();
  showSettingsToast(`💱 Currency changed${prev!==v?' from '+prev+' to '+v:''} — applied everywhere!`, 4000, 'sc-currency');
  renderFeed(); renderDash();
}
function toggleHaptic(){
  hapticEnabled = !hapticEnabled;
  localStorage.setItem('ledger_haptic', hapticEnabled ? 'on' : 'off');
  const toggle = document.getElementById('haptic-toggle');
  const sub    = document.getElementById('haptic-toggle-sub');
  if(toggle) toggle.classList.toggle('on', hapticEnabled);
  if(sub)    sub.textContent = hapticEnabled ? 'On — feel every action' : 'Off — silent mode';
  if(hapticEnabled) haptic(HX.soft);
}
function testHaptic(btn){
  const note = document.getElementById('haptic-support-note');
  if(!navigator.vibrate){
    if(note){ note.style.display='block'; note.style.color='var(--red)'; note.textContent='❌ Vibration API not supported on this device/browser. Requires Android Chrome.'; }
    return;
  }
  // Fire a strong test pattern
  navigator.vibrate(0);
  const result = navigator.vibrate([50,80,50,80,100]);
  if(note){
    note.style.display='block';
    if(result){
      note.style.color='var(--green)';
      note.textContent='✅ Vibration fired! If you felt nothing, check your phone\'s vibration is not muted in system settings.';
    } else {
      note.style.color='var(--accent)';
      note.textContent='⚠️ Vibrate returned false — your browser may be blocking it. Try opening as a PWA (Add to Home Screen).';
    }
  }
  if(btn){ btn.textContent='📳 Fired!'; setTimeout(()=>{ btn.textContent='📳 Test Vibration'; },1500); }
}
function syncHapticToggle(){
  const toggle = document.getElementById('haptic-toggle');
  const sub    = document.getElementById('haptic-toggle-sub');
  if(toggle) toggle.classList.toggle('on', hapticEnabled);
  if(sub)    sub.textContent = hapticEnabled ? 'On — feel every action' : 'Off — silent mode';
}
function saveCycleLimit(){
  const raw = parseInt(document.getElementById('cycle-limit-input').value);
  const val = Math.max(3, Math.min(60, isNaN(raw)?12:raw));
  document.getElementById('cycle-limit-input').value = val;
  cycleLimit = val;
  const removed = enforceCycleLimit();
  persist();
  activeCycleKey = currentCycleKey();
  renderSettings(); renderFeed();
  const monthLabel = val >= 12 ? `${(val/12).toFixed(1).replace(/\.0$/,'')} year${val!==12?'s':''}` : `${val} months`;
  if(removed > 0){
    showSettingsToast(`🗂 History limit set to ${monthLabel} — ${removed} old record${removed!==1?'s':''} pruned`, 4000, 'sc-history');
  } else {
    showSettingsToast(`🗂 History limit saved — keeping up to ${monthLabel} of history`, 3500, 'sc-history');
  }
}

// ════════════════════════════════════════════════════════════
//  EXPORT / IMPORT — saves EVERYTHING
// ════════════════════════════════════════════════════════════
function exportData(){
  const data={
    version:8, exportedAt:new Date().toISOString(),
    transactions, budgets, currencySymbol, activeTheme,
    cycleMode, cycleConfig, cycleLimit, creditCards, goalTargets,
    pinHash: pinHash || '',
    defaultGoal: localStorage.getItem('ledger_defaultGoal') || ''
  };
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  const dateStr=new Date().toISOString().slice(0,10);
  a.href=url; a.download=`spendoodle-backup-${dateStr}.json`; a.click();
  URL.revokeObjectURL(url);
  // Stamp last backup time
  localStorage.setItem('ledger_lastBackup', Date.now().toString());
  updateLastBackupLabel();
  showSettingsToast('📤 Full backup exported!', 3000, 'sc-export');
}
function exportCSV(){
  const headers=['Date','Label','Type','Category','Amount','Currency','Note','Recurring','Savings Goal','Cycle'];
  const rows=transactions.map(t=>{
    const ck=getCycleKey(t.date);
    return [
      t.date,
      `"${(t.label||'').replace(/"/g,'""')}"`,
      t.type,
      t.category||'',
      t.amount,
      currencySymbol,
      `"${(t.note||'').replace(/"/g,'""')}"`,
      t.recurring?'yes':'no',
      `"${(t.savingsGoal||'').replace(/"/g,'""')}"`,
      cycleLabel(ck,true)
    ].join(',');
  });
  const csv=[headers.join(','),...rows].join('\n');
  const blob=new Blob([csv],{type:'text/csv'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  const dateStr=new Date().toISOString().slice(0,10);
  a.href=url; a.download=`spendoodle-transactions-${dateStr}.csv`; a.click();
  URL.revokeObjectURL(url);
  showSettingsToast('📊 CSV exported!', 3000, 'sc-export');
}

async function exportExcel(){
  showSettingsToast('🟢 Preparing Excel…', 60000, 'sc-export');
  try {
    const sym=currencySymbol;
    const symSafe=(()=>{const m={'₱':'PHP','$':'$','€':'EUR','£':'GBP','¥':'JPY','₩':'KRW','฿':'THB','₫':'VND','₹':'INR'};return m[sym]||sym.replace(/[^\x20-\x7E]/g,'?');})();
    const dateStr=new Date().toISOString().slice(0,10);
    const esc=s=>String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');

    const inc=transactions.filter(t=>t.type==='income' ).reduce((a,t)=>a+(parseFloat(t.amount)||0),0);
    const exp=transactions.filter(t=>t.type==='expense').reduce((a,t)=>a+(parseFloat(t.amount)||0),0);
    const sav=transactions.filter(t=>t.type==='savings').reduce((a,t)=>a+(parseFloat(t.amount)||0),0);
    const net=inc-exp-sav;

    // ── Shared strings ──
    const strings=[];
    const si=v=>{const i=strings.length;strings.push(String(v));return i;};

    // ── Style IDs (index into styles array) ──
    // We define fills, fonts, borders, then cellXfs
    // Format: we'll build the styles XML manually

    // Cell ref helper
    const col=c=>{let s='';c++;while(c>0){s=String.fromCharCode(64+(c%26||26))+s;c=Math.floor((c-1)/26);}return s;};
    const ref=(r,c)=>col(c)+(r+1);

    // ── Build worksheet rows ──
    // styleId map (matches cellXfs order defined below)
    const ST={
      title:0, subtitle:1, blank:2,
      sumLblInc:3, sumLblExp:4, sumLblSav:5, sumLblNet:6, sumLblNetNeg:7,
      sumValInc:8, sumValExp:9, sumValSav:10, sumValNet:11, sumValNetNeg:12,
      hdr:13,  hdrAmt:14,
      cellNorm:15, cellAlt:16, cellMuted:17, cellMutedAlt:18,
      cellBold:19, cellBoldAlt:20,
      amtInc:21, amtExp:22, amtSav:23,
      amtIncAlt:24, amtExpAlt:25, amtSavAlt:26,
    };

    const wsRows=[];
    const addRow=(cells)=>wsRows.push(cells); // each cell: {r,c,v,s,t,z}

    let r=0;
    // Row 0 — Title
    addRow([{r,c:0,v:si('Spendoodle'),s:ST.title,t:'s'}]);
    r++;
    // Row 1 — Subtitle
    addRow([{r,c:0,v:si(`Transaction Report  ·  Exported ${dateStr}  ·  Currency: ${symSafe}`),s:ST.subtitle,t:'s'}]);
    r++;
    // Row 2 — blank
    addRow([]);
    r++;
    // Row 3 — Summary labels
    addRow([
      {r,c:0,v:si('INCOME'),  s:ST.sumLblInc,t:'s'},
      {r,c:1,v:si('EXPENSES'),s:ST.sumLblExp,t:'s'},
      {r,c:2,v:si('SAVINGS'), s:ST.sumLblSav,t:'s'},
      {r,c:3,v:si(`NET (${symSafe})`),s:net>=0?ST.sumLblNet:ST.sumLblNetNeg,t:'s'},
    ]);
    r++;
    // Row 4 — Summary values
    addRow([
      {r,c:0,v:inc, s:ST.sumValInc,t:'n',z:'#,##0.00'},
      {r,c:1,v:exp, s:ST.sumValExp,t:'n',z:'#,##0.00'},
      {r,c:2,v:sav, s:ST.sumValSav,t:'n',z:'#,##0.00'},
      {r,c:3,v:Math.abs(net),s:net>=0?ST.sumValNet:ST.sumValNetNeg,t:'n',z:'#,##0.00'},
    ]);
    r++;
    // Row 5 — blank
    addRow([]);
    r++;
    // Row 6 — Column headers
    const hdrs=['Date','Label','Type','Category',`Amount (${symSafe})`,'Note','Recurring'];
    addRow(hdrs.map((h,c)=>({r,c,v:si(h),s:c===4?ST.hdrAmt:ST.hdr,t:'s'})));
    r++;
    // Data rows
    transactions.forEach((t,i)=>{
      const alt=i%2===1;
      const amt=parseFloat(t.amount)||0;
      const tp=t.type;
      const amtS=tp==='income'?(alt?ST.amtIncAlt:ST.amtInc):tp==='savings'?(alt?ST.amtSavAlt:ST.amtSav):(alt?ST.amtExpAlt:ST.amtExp);
      addRow([
        {r,c:0,v:si(t.date),            s:alt?ST.cellMutedAlt:ST.cellMuted,  t:'s'},
        {r,c:1,v:si(t.label||''),        s:alt?ST.cellBoldAlt:ST.cellBold,    t:'s'},
        {r,c:2,v:si(t.type.charAt(0).toUpperCase()+t.type.slice(1)),s:alt?ST.cellAlt:ST.cellNorm,t:'s'},
        {r,c:3,v:si(t.category||''),     s:alt?ST.cellMutedAlt:ST.cellMuted,  t:'s'},
        {r,c:4,v:amt,                    s:amtS,t:'n',z:'#,##0.00'},
        {r,c:5,v:si(t.note||''),         s:alt?ST.cellMutedAlt:ST.cellMuted,  t:'s'},
        {r,c:6,v:si(t.recurring?'Yes':'No'),s:alt?ST.cellAlt:ST.cellNorm,   t:'s'},
      ]);
      r++;
    });

    // ── Shared strings XML ──
    const ssXml=`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<sst xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main" count="${strings.length}" uniqueCount="${strings.length}">
${strings.map(s=>`<si><t xml:space="preserve">${esc(s)}</t></si>`).join('\n')}
</sst>`;

    // ── Number formats ──
    const numFmts=`<numFmts count="1"><numFmt numFmtId="164" formatCode="#,##0.00"/></numFmts>`;

    // ── Fonts ──
    const fonts=`<fonts count="8">
<font><sz val="18"/><b/><color rgb="FFD4A853"/><name val="Calibri"/></font>
<font><sz val="9"/><color rgb="FF8A8598"/><name val="Calibri"/></font>
<font><sz val="10"/><color rgb="FFEDE8E0"/><name val="Calibri"/></font>
<font><sz val="9"/><b/><color rgb="FF4FD87C"/><name val="Calibri"/></font>
<font><sz val="9"/><b/><color rgb="FFF06464"/><name val="Calibri"/></font>
<font><sz val="9"/><b/><color rgb="FFD4A853"/><name val="Calibri"/></font>
<font><sz val="14"/><b/><color rgb="FF4FD87C"/><name val="Calibri"/></font>
<font><sz val="14"/><b/><color rgb="FFF06464"/><name val="Calibri"/></font>
</fonts>`;
    // font ids: 0=title,1=sub,2=normal,3=incLbl,4=expLbl,5=savLbl,6=incVal,7=expVal

    // ── Fills ──
    // 0,1 reserved by Excel
    const fills=`<fills count="16">
<fill><patternFill patternType="none"/></fill>
<fill><patternFill patternType="gray125"/></fill>
<fill><patternFill patternType="solid"><fgColor rgb="FF080810"/></patternFill></fill>
<fill><patternFill patternType="solid"><fgColor rgb="FF0F0F1A"/></patternFill></fill>
<fill><patternFill patternType="solid"><fgColor rgb="FF14141C"/></patternFill></fill>
<fill><patternFill patternType="solid"><fgColor rgb="FF0A1F10"/></patternFill></fill>
<fill><patternFill patternType="solid"><fgColor rgb="FF200808"/></patternFill></fill>
<fill><patternFill patternType="solid"><fgColor rgb="FF181208"/></patternFill></fill>
<fill><patternFill patternType="solid"><fgColor rgb="FF0D1A0A"/></patternFill></fill>
<fill><patternFill patternType="solid"><fgColor rgb="FF280A0A"/></patternFill></fill>
<fill><patternFill patternType="solid"><fgColor rgb="FF1C160A"/></patternFill></fill>
</fills>`;
    // fill ids: 2=dark,3=alt,4=hdr,5=incBg,6=expBg,7=savBg,8=incBgAlt,9=expBgAlt,10=savBgAlt

    // ── Borders ──
    const borders=`<borders count="2">
<border><left/><right/><top/><bottom/><diagonal/></border>
<border><left style="thin"><color rgb="FF1E1E30"/></left><right style="thin"><color rgb="FF1E1E30"/></right><top style="thin"><color rgb="FF1E1E30"/></top><bottom style="thin"><color rgb="FF1E1E30"/></bottom><diagonal/></border>
</borders>`;

    // ── Cell styles (cellXfs) ──
    // Each: fontId, fillId, borderId, numFmtId, alignment
    const xf=(fi,filli,bi,nfi,halign,bold)=>{
      const applyN=nfi?'applyNumberFormat="1"':'';
      const applyA=halign?'applyAlignment="1"':'';
      const applyB=bold?'applyFont="1"':'applyFont="1"';
      return `<xf numFmtId="${nfi||0}" fontId="${fi}" fillId="${filli}" borderId="${bi}" applyFill="1" ${applyN} ${applyB} ${applyA}>${halign?`<alignment horizontal="${halign}" vertical="center"/>`:'<alignment vertical="center"/>'}</xf>`;
    };
    const cellXfs=`<cellXfs count="27">
${xf(0,2,0,0,'left')}
${xf(1,2,0,0,'left')}
${xf(2,2,0,0,'left')}
${xf(3,2,0,0,'left')}
${xf(4,2,0,0,'left')}
${xf(5,2,0,0,'left')}
${xf(2,2,0,0,'left')}
${xf(2,2,0,0,'left')}
${xf(6,5,0,164,'left',1)}
${xf(7,6,0,164,'left',1)}
${xf(5,7,0,164,'left',1)}
${xf(6,5,0,164,'left',1)}
${xf(7,6,0,164,'left',1)}
${xf(2,4,1,0,'center',1)}
${xf(2,4,1,0,'right',1)}
${xf(2,2,1,0,'left')}
${xf(2,3,1,0,'left')}
${xf(1,2,1,0,'left')}
${xf(1,3,1,0,'left')}
${xf(2,2,1,0,'left',1)}
${xf(2,3,1,0,'left',1)}
${xf(6,5,1,164,'right',1)}
${xf(4,6,1,164,'right',1)}
${xf(5,7,1,164,'right',1)}
${xf(6,8,1,164,'right',1)}
${xf(4,9,1,164,'right',1)}
${xf(5,10,1,164,'right',1)}
</cellXfs>`;

    const stylesXml=`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<styleSheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main">
${numFmts}${fonts}${fills}${borders}
<cellStyleXfs count="1"><xf numFmtId="0" fontId="0" fillId="0" borderId="0"/></cellStyleXfs>
${cellXfs}
</styleSheet>`;

    // ── Worksheet XML ──
    const rowsXml=wsRows.map((cells,ri)=>{
      if(!cells.length) return `<row r="${ri+1}" ht="15" customHeight="1"/>`;
      const ht=ri===0?32:ri===1?14:ri===3?14:ri===4?24:ri===6?20:15;
      const cellsXml=cells.map(({r,c,v,s,t,z})=>{
        const cr=ref(r,c);
        const nfi=z?` s="${s}"`:` s="${s}"`;
        if(t==='n') return `<c r="${cr}" s="${s}" t="n"><v>${v}</v></c>`;
        return `<c r="${cr}" s="${s}" t="s"><v>${v}</v></c>`;
      }).join('');
      return `<row r="${ri+1}" ht="${ht}" customHeight="1">${cellsXml}</row>`;
    }).join('\n');

    // Merge cells for title/subtitle rows
    const lastDataRow=r;
    const merges=`<mergeCells count="3">
<mergeCell ref="A1:G1"/>
<mergeCell ref="A2:G2"/>
<mergeCell ref="A3:G3"/>
</mergeCells>`;

    const colsXml=`<cols>
<col min="1" max="1" width="13" customWidth="1"/>
<col min="2" max="2" width="28" customWidth="1"/>
<col min="3" max="3" width="12" customWidth="1"/>
<col min="4" max="4" width="18" customWidth="1"/>
<col min="5" max="5" width="16" customWidth="1"/>
<col min="6" max="6" width="32" customWidth="1"/>
<col min="7" max="7" width="11" customWidth="1"/>
</cols>`;

    const wsXml=`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<worksheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main">
<sheetView workbookViewId="0"><selection activeCell="A1"/></sheetView>
<sheetFormatPr defaultRowHeight="15"/>
${colsXml}
<sheetData>
${rowsXml}
</sheetData>
${merges}
<pageSetup orientation="portrait"/>
</worksheet>`;

    // ── Workbook XML ──
    const wbXml=`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<workbook xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main"
  xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships">
<sheets><sheet name="Transactions" sheetId="1" r:id="rId1"/></sheets>
</workbook>`;

    const wbRels=`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
<Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/worksheet" Target="worksheets/sheet1.xml"/>
<Relationship Id="rId2" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/sharedStrings" Target="sharedStrings.xml"/>
<Relationship Id="rId3" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/styles" Target="styles.xml"/>
</Relationships>`;

    const relsXml=`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
<Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="xl/workbook.xml"/>
</Relationships>`;

    const contentTypes=`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
<Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
<Default Extension="xml" ContentType="application/xml"/>
<Override PartName="/xl/workbook.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet.main+xml"/>
<Override PartName="/xl/worksheets/sheet1.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml"/>
<Override PartName="/xl/sharedStrings.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.sharedStrings+xml"/>
<Override PartName="/xl/styles.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.styles+xml"/>
</Types>`;

    // ── ZIP it using JSZip (load on demand from cdnjs) ──
    if(!window.JSZip){
      await new Promise((res,rej)=>{
        const s=document.createElement('script');
        s.src='https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
        s.onload=res; s.onerror=()=>rej(new Error('No internet — Excel export requires a one-time download.'));
        document.head.appendChild(s);
      });
    }
    const zip=new JSZip();
    zip.file('[Content_Types].xml', contentTypes);
    zip.file('_rels/.rels', relsXml);
    zip.file('xl/workbook.xml', wbXml);
    zip.file('xl/_rels/workbook.xml.rels', wbRels);
    zip.file('xl/worksheets/sheet1.xml', wsXml);
    zip.file('xl/sharedStrings.xml', ssXml);
    zip.file('xl/styles.xml', stylesXml);

    const blob=await zip.generateAsync({type:'blob',mimeType:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url; a.download=`spendoodle-transactions-${dateStr}.xlsx`; a.click();
    URL.revokeObjectURL(url);
    showSettingsToast('🟢 Excel exported!', 3000, 'sc-export');
  } catch(err){
    console.error('[Excel export]', err);
    const isOffline=!navigator.onLine||err.message.includes('internet');
    showSettingsToast(isOffline?'⚠️ No internet — connect once to enable Excel export.':'⚠️ Excel export failed. Try again.', 5000, 'sc-export');
  }
}

async function exportPDF(){
  showSettingsToast('🔴 Preparing PDF…', 60000, 'sc-export');
  try {
    if(!window.jspdf){
      await new Promise((res,rej)=>{
        const s=document.createElement('script');
        s.src='https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
        s.onload=res; s.onerror=()=>rej(new Error('Failed to load jsPDF'));
        document.head.appendChild(s);
      });
    }
    if(typeof window.jspdf.jsPDF.prototype.autoTable==='undefined'){
      await new Promise((res,rej)=>{
        const s=document.createElement('script');
        s.src='https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js';
        s.onload=res; s.onerror=()=>rej(new Error('Failed to load AutoTable'));
        document.head.appendChild(s);
      });
    }

    const {jsPDF}=window.jspdf;
    const doc=new jsPDF({orientation:'portrait',unit:'mm',format:'a4'});
    const dateStr=new Date().toISOString().slice(0,10);
    const pageW=doc.internal.pageSize.getWidth();

    // jsPDF built-in fonts only support latin — encode symbol as ASCII fallback
    const symRaw=currencySymbol;
    // Try to encode to latin; if it fails or has weird chars use the code name
    const symSafe=(()=>{
      // Common symbols mapped to safe ASCII equivalents for PDF
      const map={'₱':'PHP','$':'$','€':'EUR','£':'GBP','¥':'JPY','₩':'KRW','฿':'THB','₫':'VND','Rp':'Rp','RM':'RM','₹':'INR'};
      return map[symRaw] || symRaw.replace(/[^\x20-\x7E]/g,'?');
    })();

    // ── Header ──
    doc.setFillColor(8,8,16);
    doc.rect(0,0,pageW,28,'F');
    doc.setTextColor(212,168,83);
    doc.setFontSize(20); doc.setFont('helvetica','bold');
    doc.text('Spendoodle',14,12);
    doc.setFontSize(9); doc.setFont('helvetica','normal');
    doc.setTextColor(138,133,152);
    doc.text('Transaction Report  -  Exported '+dateStr+'  -  Currency: '+symSafe, 14, 20);

    // ── Summary strip ──
    const inc=transactions.filter(t=>t.type==='income').reduce((s,t)=>s+(parseFloat(t.amount)||0),0);
    const exp=transactions.filter(t=>t.type==='expense').reduce((s,t)=>s+(parseFloat(t.amount)||0),0);
    const sav=transactions.filter(t=>t.type==='savings').reduce((s,t)=>s+(parseFloat(t.amount)||0),0);
    const net=inc-exp-sav;

    const summaryY=34;
    const colW=pageW/4;
    [
      ['INCOME',      fmt(inc,2), [79,216,124]],
      ['EXPENSES',    fmt(exp,2), [240,100,100]],
      ['SAVINGS',     fmt(sav,2), [212,168,83]],
      ['NET ('+symSafe+')', fmt(Math.abs(net),2)+(net<0?' (-)':''), net>=0?[79,216,124]:[240,100,100]]
    ].forEach(([lbl,val,rgb],i)=>{
      const x=colW*i+14;
      doc.setFontSize(7); doc.setFont('helvetica','bold');
      doc.setTextColor(100,100,120);
      doc.text(lbl,x,summaryY);
      doc.setFontSize(11); doc.setFont('helvetica','bold');
      doc.setTextColor(...rgb);
      doc.text(symSafe+' '+val,x,summaryY+7);
    });

    // ── Transactions table ──
    const tableRows=transactions.map(t=>[
      t.date,
      (t.label||'').slice(0,30),
      t.type.charAt(0).toUpperCase()+t.type.slice(1),
      (t.category||'-').slice(0,18),
      fmt(parseFloat(t.amount)||0, 2),   // plain number string — no symbol
      (t.note||'').slice(0,28)
    ]);

    doc.autoTable({
      startY: summaryY+16,
      head:[[`Date`,`Label`,`Type`,`Category`,`Amount (${symSafe})`,`Note`]],
      body: tableRows,
      theme:'grid',
      headStyles:{fillColor:[20,20,32],textColor:[212,168,83],fontStyle:'bold',fontSize:8},
      bodyStyles:{fontSize:7.5,textColor:[40,38,60]},
      alternateRowStyles:{fillColor:[245,244,248]},
      columnStyles:{
        0:{cellWidth:22},
        1:{cellWidth:46},
        2:{cellWidth:22},
        3:{cellWidth:28},
        4:{cellWidth:26,halign:'right'},
        5:{cellWidth:'auto'}
      },
      margin:{left:14,right:14},
      didDrawPage:()=>{
        const pg=doc.internal.getCurrentPageInfo().pageNumber;
        const total=doc.internal.getNumberOfPages();
        doc.setFontSize(7); doc.setTextColor(160,158,180);
        doc.text(`Page ${pg} of ${total}`,pageW/2,doc.internal.pageSize.getHeight()-6,{align:'center'});
        doc.text('Spendoodle',14,doc.internal.pageSize.getHeight()-6);
      }
    });

    doc.save(`spendoodle-transactions-${dateStr}.pdf`);
    showSettingsToast('🔴 PDF exported!', 3000, 'sc-export');
  } catch(err) {
    console.error('[PDF export]', err);
    showSettingsToast('⚠️ PDF export failed — check connection.', 4000, 'sc-export');
  }
}
function importData(e){
  const file=e.target.files[0]; if(!file)return;
  const reader=new FileReader();
  reader.onload=ev=>{
    try{
      const data=JSON.parse(ev.target.result);
      let imported=[];
      if(Array.isArray(data)) imported=data;
      else if(data.transactions&&Array.isArray(data.transactions)) imported=data.transactions;
      else throw new Error('bad');
      // ── Merge settings (don't overwrite if local has value) ──
      if(data.budgets&&typeof data.budgets==='object')
        budgets={...data.budgets,...budgets}; // local takes priority on overlap
      if(data.currencySymbol) currencySymbol=data.currencySymbol;
      if(data.activeTheme)    { activeTheme=data.activeTheme; setTheme(activeTheme); }
      if(data.cycleMode)      cycleMode=data.cycleMode;
      if(data.cycleConfig)    cycleConfig={...cycleConfig,...data.cycleConfig};
      if(data.cycleLimit)     cycleLimit=Math.max(3,parseInt(data.cycleLimit)||12);
      // Merge credit cards by ID — don't duplicate
      if(data.creditCards&&Array.isArray(data.creditCards)){
        const existingCCIds=new Set(creditCards.map(c=>c.id));
        const newCCs=data.creditCards.filter(c=>c.id&&!existingCCIds.has(c.id));
        creditCards=[...creditCards,...newCCs];
      }
      // Merge goal targets — local takes priority on overlap
      if(data.goalTargets&&typeof data.goalTargets==='object')
        goalTargets={...data.goalTargets,...goalTargets};
      if(data.pinHash!==undefined&&!pinHash){ pinHash=data.pinHash; if(pinHash) localStorage.setItem('ledger_pin',pinHash); }
      if(data.defaultGoal&&!localStorage.getItem('ledger_defaultGoal'))
        localStorage.setItem('ledger_defaultGoal', data.defaultGoal);
      // ── Merge transactions by ID — no duplicates ──
      const existing=new Set(transactions.map(t=>t.id));
      const newOnes=imported.filter(t=>t.id&&t.date&&t.amount&&!existing.has(t.id));
      transactions=[...transactions,...newOnes];
      transactions.sort((a,b)=>b.date.localeCompare(a.date)||b.id-a.id);
      persist(); activeCycleKey=currentCycleKey();
      // ── Save import metadata ──
      const incCount=newOnes.filter(t=>t.type==='income').length;
      const expCount=newOnes.filter(t=>t.type==='expense').length;
      const savCount=newOnes.filter(t=>t.type==='savings').length;
      localStorage.setItem('ledger_lastImport',JSON.stringify({ts:Date.now(),total:newOnes.length,inc:incCount,exp:expCount,sav:savCount,file:file.name}));
      renderSettings(); renderFeed(); renderDash();
      // ── Rich toast with time + breakdown ──
      const _now=new Date();
      const _time=_now.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
      const _parts=[];
      if(incCount) _parts.push(`${incCount} income`);
      if(expCount) _parts.push(`${expCount} expense`);
      if(savCount) _parts.push(`${savCount} savings`);
      const _detail=_parts.length?` · ${_parts.join(', ')}`:'';
      showSettingsToast(`✅ Imported ${newOnes.length} new record${newOnes.length!==1?'s':''}${_detail} at ${_time}`, 5000, 'sc-import');
    }catch{
      showSettingsToast('⚠️ Invalid file.', 3500, 'sc-import');
    }
    e.target.value='';
  };
  reader.readAsText(file);
}

// ════════════════════════════════════════════════════════════
//  BACKUP REMINDER
// ════════════════════════════════════════════════════════════
function getBackupInterval(){
  return Math.max(1, parseInt(localStorage.getItem('ledger_backupInterval')||'30'));
}
function saveBackupInterval(val){
  const days=Math.max(1,Math.min(365,parseInt(val)||30));
  localStorage.setItem('ledger_backupInterval', days.toString());
  const inp=document.getElementById('backup-interval-input');
  if(inp) inp.value=days;
  showSettingsToast(`🔔 Backup reminder set to every ${days} days`, 3000, 'sc-export');
}
function updateLastBackupLabel(){
  const el=document.getElementById('last-backup-label');
  if(!el) return;
  const last=localStorage.getItem('ledger_lastBackup');
  if(!last){ el.textContent='⚠️ No backup recorded yet'; return; }
  const days=Math.floor((Date.now()-parseInt(last))/(86400000));
  el.textContent = days===0 ? '✅ Last backup: today' : `📅 Last backup: ${days} day${days!==1?'s':''} ago`;
}
function updateLastImportLabel(){
  const el=document.getElementById('last-import-label');
  if(!el) return;
  const raw=localStorage.getItem('ledger_lastImport');
  if(!raw){ el.innerHTML=''; return; }
  try{
    const m=JSON.parse(raw);
    const d=new Date(m.ts);
    const dateStr=d.toLocaleDateString([],{month:'short',day:'numeric',year:'numeric'});
    const timeStr=d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
    const parts=[];
    if(m.inc) parts.push(m.inc+' income');
    if(m.exp) parts.push(m.exp+' expense');
    if(m.sav) parts.push(m.sav+' savings');
    const detail=parts.length?' <span style="color:var(--text3)">· '+parts.join(', ')+'</span>':'';
    const fileName=m.file?' <span style="color:var(--text3);font-style:italic;">'+m.file+'</span>':'';
    el.innerHTML='📥 Last import: <strong>'+dateStr+'</strong> at '+timeStr+' — <strong>'+m.total+'</strong> record'+(m.total!==1?'s':'')+detail+fileName;
  }catch{ el.innerHTML=''; }
}

/* Auto-backup toggle */
function isAutoBackupOn(){ return localStorage.getItem('ledger_autoBackup')==='on'; }
function toggleAutoBackup(){
  const on = !isAutoBackupOn();
  localStorage.setItem('ledger_autoBackup', on?'on':'off');
  syncBackupToggles();
  showSettingsToast(on?'🤖 Auto-download enabled':'🤖 Auto-download disabled', 2500, 'sc-export');
}
/* Backup push notification toggle */
function isBackupPushOn(){ return localStorage.getItem('ledger_backupPush')==='on'; }
async function toggleBackupPushNotif(){
  if(!isBackupPushOn()){
    // Need permission first
    if(Notification?.permission !== 'granted'){
      const perm = await Notification?.requestPermission?.();
      if(perm !== 'granted'){
        showSettingsToast('⚠️ Notification permission denied', 3000, 'sc-export');
        return;
      }
    }
    localStorage.setItem('ledger_backupPush','on');
    showSettingsToast('🔔 Push backup reminders enabled', 2500, 'sc-export');
  } else {
    localStorage.setItem('ledger_backupPush','off');
    showSettingsToast('🔔 Push backup reminders disabled', 2500, 'sc-export');
  }
  syncBackupToggles();
}
function syncBackupToggles(){
  const autoOn = isAutoBackupOn();
  const pushOn = isBackupPushOn();
  // settings toggles
  ['auto-backup-toggle','auto-backup-toggle-settings'].forEach(id=>{
    const el=document.getElementById(id);
    if(el) el.classList.toggle('on', autoOn);
  });
  const autoSub=document.getElementById('auto-backup-sub');
  if(autoSub) autoSub.textContent = autoOn ? 'On — backup downloads automatically when due' : 'Off — downloads backup silently when reminder fires';
  const pushTog=document.getElementById('backup-push-toggle');
  if(pushTog) pushTog.classList.toggle('on', pushOn);
  const pushSub=document.getElementById('backup-push-sub');
  if(pushSub) pushSub.textContent = pushOn ? 'On — you\'ll get a push reminder even when app is closed' : 'Off — sends a push reminder even when app is closed';
}

async function checkBackupReminder(){
  // Don't nag on first use (no transactions yet)
  if(!transactions.length) return;
  const interval=getBackupInterval();
  const last=parseInt(localStorage.getItem('ledger_lastBackup')||'0');
  const snoozed=parseInt(localStorage.getItem('ledger_backupSnoozed')||'0');
  const now=Date.now();
  if(snoozed && now - snoozed < 86400000) return;
  const daysSince=last ? Math.floor((now-last)/86400000) : Infinity;
  if(daysSince < interval) return;

  // Auto-download mode — skip popup, just download
  if(isAutoBackupOn()){
    exportData();
    // Still fire push if enabled so user knows it happened
    if(isBackupPushOn() && Notification?.permission==='granted'){
      const label = daysSince===Infinity ? 'First backup saved!' : `Backup saved — ${daysSince} days since last`;
      await fireNotification('💾 Spendoodle Auto-Backup', label, 'backup-auto');
    }
    return;
  }

  // Push notification (fires even if app is backgrounded next open)
  if(isBackupPushOn() && Notification?.permission==='granted'){
    const pushMsg = daysSince===Infinity
      ? "You've never backed up — your data could vanish if you clear the browser."
      : `It's been ${daysSince} day${daysSince!==1?'s':''} since your last backup. Tap to back up now.`;
    await fireNotification('💾 Spendoodle Backup Due', pushMsg, 'backup-reminder');
  }

  // Show popup
  setTimeout(()=>openBackupReminder(daysSince), 1500);
}

function openBackupReminder(days){
  const isFirst = days===Infinity;
  const icon  = document.getElementById('backup-icon');
  const title = document.getElementById('backup-title');
  const msg   = document.getElementById('backup-msg');
  const since = document.getElementById('backup-since');

  if(icon)  icon.textContent  = isFirst ? '⚠️' : '💾';
  if(title) title.textContent = isFirst ? 'No Backup on Record!' : 'Time to Back Up';
  if(msg)   msg.textContent   = isFirst
    ? "You've never downloaded a backup. One cleared browser cache and your data is gone forever. Dramatic? Yes. True? Also yes."
    : `It's been ${days} day${days!==1?'s':''} since your last backup. One wrong tap in browser settings and it's all gone.`;
  if(since) since.textContent = isFirst
    ? '⚠️ Never backed up'
    : `📅 Last backup: ${days} day${days!==1?'s':''} ago`;

  // Sync auto-download toggle state in popup
  syncBackupToggles();
  document.getElementById('backup-overlay').classList.add('open');
}
function dismissBackupReminder(e){
  if(e && e.target!==document.getElementById('backup-overlay') && e.type==='click' && e.currentTarget===document.getElementById('backup-overlay')) return;
  document.getElementById('backup-overlay').classList.remove('open');
}
function snoozeBackup(){
  localStorage.setItem('ledger_backupSnoozed', Date.now().toString());
  document.getElementById('backup-overlay').classList.remove('open');
}
function backupNow(){
  document.getElementById('backup-overlay').classList.remove('open');
  exportData();
}
function clearAllData(){
  // Step 1: first confirm
  showConfirm({
    icon:'🗑',
    title:'Delete Everything?',
    msg:'This will permanently erase all your transactions, budgets, credit cards, goals and settings. There is no undo. Export a backup first if you need to keep anything.',
    okLabel:'Yes, continue →',
    cancelLabel:'Cancel',
    onOk:()=>{
      // Step 2: second confirm (harder to tap accidentally)
      showConfirm({
        icon:'⚠️',
        title:'Last Chance — Are You Sure?',
        msg:'Seriously, everything will be gone. Like it never happened. 💀 This is the point of no return.',
        okLabel:'🗑 Delete Everything',
        cancelLabel:'← No, go back',
        onOk:()=>{
          // Step 3: if PIN is set, verify it first
          if(pinHash){
            _pinMode='verify-delete'; _pinBuffer=''; updatePinDots();
            document.getElementById('pin-sub').textContent='Enter your PIN to confirm deletion';
            document.getElementById('pin-error').textContent='';
            document.getElementById('pin-skip-btn').style.display='none';
            document.getElementById('pin-overlay').classList.remove('hidden');
          } else {
            doDeleteEverything();
          }
        }
      });
    }
  });
}
function doDeleteEverything(){
  transactions=[]; budgets={}; creditCards=[]; goalTargets={};
  persist(); activeCycleKey=currentCycleKey();
  renderSettings(); renderFeed(); renderDash();
  showSettingsToast('🗑 All data cleared. Fresh start!', 4000, 'sc-clear');
}
function showSettingsToast(msg, dur, cardId){
  // Determine card: use provided cardId or fall back to a sensible default
  const card = cardId ? document.getElementById(cardId) : null;
  const body = card ? card.querySelector('.settings-body') : null;
  if(!body){ return; } // no target, silently skip

  // Remove any existing inline toast in this card
  const existing = body.querySelector('.sc-inline-toast');
  if(existing) existing.remove();

  const t = document.createElement('div');
  t.className = 'sc-inline-toast ' + (msg.startsWith('⚠️') || msg.startsWith('❌') ? 'err' : 'ok');
  t.textContent = msg;
  body.appendChild(t);

  clearTimeout(t._timer);
  t._timer = setTimeout(()=>{ t.style.transition='opacity .3s'; t.style.opacity='0'; setTimeout(()=>t.remove(),320); }, dur||3000);
}

// ════════════════════════════════════════════════════════════
//  ONBOARDING — 5 slides: Welcome · Theme · Pay Cycle · History+Goal · Done
// ════════════════════════════════════════════════════════════
const OB_TOTAL = 4;
let obPage = 0;
let gCycleMode = cycleMode;
let gLimitVal  = cycleLimit;

function obOpen(){
  obPage = 0;
  obRender();
  gSyncGuideState();
  document.getElementById('ob-overlay').classList.add('active');
}
function obClose(){
  document.getElementById('ob-overlay').classList.remove('active');
  localStorage.setItem('ledger_onboarded','1');
}
function obNav(dir){
  if(dir > 0) obSaveCurrentPage(); // save before advancing
  obPage = Math.max(0, Math.min(OB_TOTAL-1, obPage+dir));
  obRender();
  // scroll page back to top
  const pages = document.getElementById('ob-pages');
  if(pages) pages.querySelectorAll('.ob-page')[obPage]?.scrollTo(0,0);
}
function obRender(){
  document.querySelectorAll('.ob-page').forEach((p,i)=>p.classList.toggle('active', i===obPage));
  document.getElementById('ob-dots').innerHTML=[...Array(OB_TOTAL)].map((_,i)=>
    `<div class="ob-dot ${i===obPage?'active':''}"></div>`).join('');

  // Progress bar
  const prog = document.getElementById('ob-progress');
  if(prog) prog.style.width = `${((obPage+1)/OB_TOTAL)*100}%`;

  document.getElementById('ob-back').style.display = obPage>0 ? 'block':'none';
  const nextBtn = document.getElementById('ob-next');
  if(obPage===OB_TOTAL-1){
    nextBtn.textContent = "Let's Go 🚀";
    nextBtn.onclick = ()=>{ obSaveCurrentPage(); obClose(); };
  } else {
    nextBtn.textContent = 'Next →';
    nextBtn.onclick = ()=>obNav(1);
  }
  document.getElementById('ob-skip').style.display = obPage===OB_TOTAL-1 ? 'none':'block';

  // Slide 0: staggered intro card animation
  if(obPage===0){
    const cards = document.querySelectorAll('#ob-intro-grid .ob-intro-card');
    cards.forEach((c,i)=>{ c.classList.remove('visible'); setTimeout(()=>c.classList.add('visible'), 120 + i*90); });
  }
  // Slide 1: Currency — sync preview
  if(obPage===1){ gUpdateCurrencyPreview(); }
  // Final slide: confetti burst
  if(obPage===OB_TOTAL-1){ setTimeout(obFireConfetti, 200); }
}

function obFireConfetti(){
  const page = document.querySelectorAll('.ob-page')[OB_TOTAL-1];
  if(!page) return;
  // Remove old wrapper if re-triggered
  const old = page.querySelector('.ob-confetti-wrap');
  if(old) old.remove();
  const wrap = document.createElement('div');
  wrap.className = 'ob-confetti-wrap';
  const colors = ['var(--accent)','var(--green)','var(--blue)','var(--red)','var(--accent2)'];
  for(let i=0;i<38;i++){
    const p = document.createElement('div');
    p.className = 'ob-confetti-piece';
    p.style.cssText = `left:${Math.random()*100}%;top:${-10-Math.random()*20}px;background:${colors[i%colors.length]};width:${6+Math.random()*6}px;height:${6+Math.random()*6}px;border-radius:${Math.random()>0.5?'50%':'2px'};animation-delay:${Math.random()*0.6}s;animation-duration:${1.4+Math.random()*0.8}s;`;
    wrap.appendChild(p);
  }
  page.prepend(wrap);
  setTimeout(()=>wrap.remove(), 3000);
}

function obSaveCurrentPage(){
  switch(obPage){
    case 0: // Intro slide — nothing to save
      break;
    case 1: // Currency + Theme — theme already applied live; save currency
      currencySymbol = (document.getElementById('g-currency-custom')?.value.trim()) || currencySymbol;
      persist(); renderFeed();
      break;
    case 2: // Pay Cycle
      cycleMode = gCycleMode;
      if(cycleMode==='monthly'){
        const pd = parseInt(document.getElementById('g-pay-day')?.value)||25;
        cycleConfig.monthly.payDay = Math.min(28,Math.max(1,pd));
        const si=document.getElementById('pay-day'); if(si) si.value=cycleConfig.monthly.payDay;
      } else if(cycleMode==='bimonthly'){
        const f=k=>parseInt(document.getElementById(`g-bi-${k}`)?.value)||0;
        cycleConfig.bimonthly={s1:f('s1')||25, e1:f('e1')||10, s2:f('s2')||11, e2:f('e2')||24};
        ['s1','e1','s2','e2'].forEach(k=>{const e=document.getElementById(`bi-${k}`);if(e)e.value=cycleConfig.bimonthly[k];});
      } else if(cycleMode==='weekly'){
        const dow=parseInt(document.getElementById('g-pay-dow')?.value)||1;
        cycleConfig.weekly={payDow:dow};
        const pdow=document.getElementById('pay-dow');if(pdow)pdow.value=dow;
      } else {
        const st=parseInt(document.getElementById('g-cust-start')?.value)||1;
        const ln=parseInt(document.getElementById('g-cust-len')?.value)||30;
        cycleConfig.custom={start:Math.min(28,Math.max(1,st)),len:Math.min(90,Math.max(7,ln))};
        const s2=document.getElementById('cust-start');if(s2)s2.value=cycleConfig.custom.start;
        const l2=document.getElementById('cust-len');if(l2)l2.value=cycleConfig.custom.len;
      }
      const pdS=document.getElementById('pay-day');if(pdS)pdS.value=cycleConfig.monthly.payDay;
      persist(); activeCycleKey=currentCycleKey(); renderFeed(); renderSettings();
      break;
    case 3: // Done slide — nothing to save
      break;
  }
}

/* Guide helpers */
function gSelectCycleMode(mode){
  gCycleMode = mode;
  ['monthly','bimonthly','custom','weekly'].forEach(m=>{
    const el=document.getElementById(`g-cmo-${m}`);
    if(el) el.classList.toggle('selected', m===mode);
    const f=document.getElementById(`g-fields-${m}`);
    if(f){ f.style.display = m===mode ? 'flex':'none'; f.style.flexDirection='column'; }
  });
}
function gSetTheme(t){
  setTheme(t); persist();
  ['dark','pink','white','navy','ice','forest','sunset','midnight'].forEach(n=>{
    const c=document.getElementById(`g-theme-${n}`);
    if(c) c.classList.toggle('active-g', n===t);
  });
}
function gAdjLimit(delta){
  gLimitVal = Math.min(60, Math.max(3, gLimitVal+delta));
  gUpdateLimitDisplay();
}
function gSetLimit(val){
  gLimitVal = val;
  document.querySelectorAll('.ob-limit-presets .ob-chip').forEach(b=>{
    b.classList.toggle('ob-chip-sel', b.onclick && b.onclick.toString().includes(String(val)));
  });
  gUpdateLimitDisplay();
}
function gUpdateLimitDisplay(){
  const el=document.getElementById('g-limit-num'); if(el) el.textContent=gLimitVal;
  const hint=document.getElementById('g-limit-hint');
  if(!hint) return;
  const val = gLimitVal;
  const years = val >= 12 ? ` — about ${(val/12).toFixed(1).replace(/\.0$/,'')} year${val!==12?'s':''}` : '';
  hint.textContent = `Keeping ${val} months of history${years}. Enough to spot trends and seasonal patterns.`;
}
function gPickGoal(name){
  const inp=document.getElementById('g-savings-goal-input');
  if(inp) inp.value=name;
  document.querySelectorAll('.ob-goal-chips .ob-chip').forEach(b=>{
    b.classList.toggle('ob-chip-sel', b.textContent.trim().replace(/^[^\w]+/,'').toLowerCase().startsWith(name.split(' ')[0].toLowerCase()));
  });
  gOnGoalType();
}
function gOnGoalType(){
  const v=(document.getElementById('g-savings-goal-input')?.value||'').trim();
  const preview=document.getElementById('g-goal-preview');
  const targetWrap=document.getElementById('g-goal-target-wrap');
  const symEl=document.getElementById('g-goal-currency-sym');
  if(symEl) symEl.textContent=currencySymbol;
  if(targetWrap) targetWrap.style.display = v ? 'block' : 'none';
  if(preview) preview.textContent = v
    ? `🎯 "${v}" will be your first savings goal`
    : '🛡 Defaults to "Emergency Fund" if left blank';
  gOnGoalTargetType();
}
function gOnGoalTargetType(){
  const v=(document.getElementById('g-savings-goal-input')?.value||'').trim();
  const amt=parseFloat(document.getElementById('g-savings-goal-target')?.value)||0;
  const hint=document.getElementById('g-goal-target-hint');
  if(!hint) return;
  if(!v||amt<=0){ hint.textContent=''; return; }
  hint.textContent=`✓ You'll aim to save ${currencySymbol}${fmt(amt,0)} for "${v}"`;
  hint.style.color='var(--green)';
}
function gUpdateCCHint(){
  const limit=parseFloat(document.getElementById('g-cc-limit')?.value)||0;
  const owe=parseFloat(document.getElementById('g-cc-balance')?.value)||0;
  const hint=document.getElementById('g-cc-form-hint');
  if(!hint) return;
  if(limit<=0){ hint.style.display='none'; return; }
  const avail=limit-owe;
  if(owe>limit){
    hint.textContent='\u26a0\ufe0f Outstanding balance can\'t exceed the credit limit.';
    hint.style.color='var(--red)'; hint.style.display='block'; return;
  }
  hint.style.color='#a855f7';
  hint.style.display='block';
  hint.textContent=`\u2713 Limit: ${currencySymbol}${fmt(limit,0)} \u00b7 Owe: ${currencySymbol}${fmt(owe,0)} \u00b7 Available from day one: ${currencySymbol}${fmt(avail,0)}`;
}
/* ── Guide: credit card step ── */
function gAddCreditCard(){
  const name=(document.getElementById('g-cc-name')?.value||'').trim();
  const limit=parseFloat(document.getElementById('g-cc-limit')?.value)||0;
  const owe=parseFloat(document.getElementById('g-cc-balance')?.value)||0;
  const interest=parseFloat(document.getElementById('g-cc-interest')?.value)||0;
  const hint=document.getElementById('g-cc-form-hint');

  if(!name){
    hint.textContent='⚠️ Please enter a card name.';
    hint.style.color='var(--red)'; hint.style.display='block'; return;
  }
  if(limit<=0){
    hint.textContent='⚠️ Please enter a valid credit limit.';
    hint.style.color='var(--red)'; hint.style.display='block'; return;
  }
  if(owe>limit){
    hint.textContent=`⚠️ Outstanding balance can't exceed the credit limit (${currencySymbol}${fmt(limit,0)}).`;
    hint.style.color='var(--red)'; hint.style.display='block'; return;
  }

  const cardId=String(Date.now());
  creditCards.push({id:cardId, name, limit, billingFee: interest||0});

  // If they already owe money, create an "opening balance" expense transaction
  if(owe>0){
    const openingTx={
      id:Date.now()+1,
      date:todayStr(),
      category:'other',
      label:`${name} — Opening Balance`,
      icon:'💳',
      type:'expense',
      amount:owe,
      note:`Opening balance on ${name} — set during setup`,
      recurring:false,
      savingsGoal:'',
      creditCardId:cardId
    };
    transactions.push(openingTx);
    transactions.sort((a,b)=>b.date.localeCompare(a.date)||b.id-a.id);
  }

  persist();

  // Clear form
  document.getElementById('g-cc-name').value='';
  document.getElementById('g-cc-limit').value='';
  document.getElementById('g-cc-balance').value='';
  if(document.getElementById('g-cc-interest')) document.getElementById('g-cc-interest').value='';
  hint.style.display='none';

  gRenderGuideCards();
  // Sync currency slide
  const ci=document.getElementById('g-currency-custom');
  if(ci) ci.value=currencySymbol;
  gUpdateCurrencyPreview();
}
function gRenderGuideCards(){
  const el=document.getElementById('g-cc-list'); if(!el) return;
  if(!creditCards.length){ el.innerHTML=''; return; }
  el.innerHTML=creditCards.map(c=>{
    const info=getCardInfo(c.id);
    const pct=Math.round(info.pct);
    const color=info.pct>=90?'var(--red)':info.pct>=70?'var(--accent)':'#a855f7';
    const avail=info.available;
    return `<div style="background:var(--bg1);border:1.5px solid #a855f730;border-radius:14px;padding:12px 14px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
        <div style="display:flex;align-items:center;gap:7px;">
          <span style="font-size:1.1rem;">💳</span>
          <div>
            <div style="font-size:.85rem;font-weight:700;color:var(--text);">${c.name}</div>
            <div style="font-size:.62rem;color:var(--text3);">Limit: ${currencySymbol}${fmt(c.limit,0)}</div>
          </div>
        </div>
        <button style="font-size:.65rem;color:var(--red);cursor:pointer;font-weight:600;padding:4px 9px;border-radius:7px;background:var(--red-dim);border:none;" onclick="gRemoveGuideCard('${c.id}')">Remove</button>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:8px;">
        <div style="background:var(--bg2);border-radius:9px;padding:7px 10px;">
          <div style="font-size:.55rem;text-transform:uppercase;letter-spacing:.7px;color:var(--text3);font-weight:700;margin-bottom:2px;">Owe Now</div>
          <div style="font-family:'Playfair Display',serif;font-size:.9rem;font-weight:700;color:${color};">${currencySymbol}${fmt(info.used,0)}</div>
        </div>
        <div style="background:var(--bg2);border-radius:9px;padding:7px 10px;">
          <div style="font-size:.55rem;text-transform:uppercase;letter-spacing:.7px;color:var(--text3);font-weight:700;margin-bottom:2px;">Available</div>
          <div style="font-family:'Playfair Display',serif;font-size:.9rem;font-weight:700;color:var(--green);">${currencySymbol}${fmt(avail,0)}</div>
        </div>
      </div>
      <div style="height:4px;background:var(--bg3);border-radius:99px;overflow:hidden;">
        <div style="height:100%;width:${pct}%;background:${color};border-radius:99px;transition:width .5s;"></div>
      </div>
      <div style="display:flex;justify-content:space-between;margin-top:4px;font-size:.62rem;color:var(--text3);">
        <span>${pct}% used</span>
        <span style="color:${info.used>0?color:'var(--green)'}">${info.used>0?'Has outstanding balance':'✓ Clear'}</span>
      </div>
    </div>`;
  }).join('');
}
function gRemoveGuideCard(id){
  // Also remove any opening balance transactions for this card
  transactions=transactions.filter(t=>!(t.creditCardId===id && t.note && t.note.includes('Opening balance')));
  creditCards=creditCards.filter(c=>c.id!==id);
  persist(); gRenderGuideCards();
}

const _currencyQuips = {
  '₱': "₱ — payday hits different. Mabuhay! 🇵🇭",
  '$': "$ — the universal symbol of dreams. And debt. 🇺🇸",
  '€': "€ — très chic. Even your expenses sound fancy. 🇪🇺",
  '£': "£ — old money energy. Very respectable. 🇬🇧",
  '¥': "¥ — precision currency for a precise spender. 🇯🇵",
  '₩': "₩ — big numbers, bigger ambitions. 🇰🇷",
  '₹': "₹ — chai money managed properly. 🇮🇳",
  'Rp': "Rp — millions in the account feels good. 🇮🇩",
  'RM': "RM — ringgit & responsible. That's the vibe. 🇲🇾",
  '฿': "฿ — land of smiles, land of savings. 🇹🇭",
  '₫': "₫ — more zeros, more character. 🇻🇳",
  'S$': "S$ — Singapore dollars. Overachiever detected. 🇸🇬",
};
function gSetCurrency(sym){
  if(!sym) return;
  currencySymbol = sym;
  // Update custom input to match
  const ci = document.getElementById('g-currency-custom');
  if(ci && !['₱','$','€','£','¥','₩','₹','Rp','RM','฿','₫','S$'].includes(sym)) ci.value = sym;
  // Highlight active button with bounce
  document.querySelectorAll('.ob-currency-btn').forEach(b=>{
    const wasActive = b.classList.contains('active-cur');
    const isActive = b.textContent.trim().startsWith(sym);
    b.classList.toggle('active-cur', isActive);
    // Re-trigger animation by removing and re-adding class
    if(isActive && !wasActive){ b.classList.remove('active-cur'); void b.offsetWidth; b.classList.add('active-cur'); }
  });
  gUpdateCurrencyPreview();
  // update currency input in settings too
  const si = document.getElementById('currency-input'); if(si) si.value = sym;
  // update amount sym in add sheet
  const amtSym = document.getElementById('amt-sym'); if(amtSym) amtSym.textContent = sym;
  persist();
}
function gUpdateCurrencyPreview(){
  const el = document.getElementById('g-currency-preview');
  if(!el) return;
  const sym = currencySymbol || '₱';
  const quip = _currencyQuips[sym] || `✓ Amounts will show as ${sym}1,234`;
  // Re-trigger animation
  el.style.animation = 'none'; void el.offsetWidth; el.style.animation = '';
  el.textContent = quip;
  // also highlight the matching button
  document.querySelectorAll('.ob-currency-btn').forEach(b=>{
    b.classList.toggle('active-cur', b.textContent.trim().startsWith(sym));
  });
}
function gSyncGuideState(){
  gCycleMode = cycleMode;
  gLimitVal  = cycleLimit;
  // Theme highlight
  ['dark','pink','white','navy','ice','forest','sunset','midnight'].forEach(n=>{
    const c=document.getElementById(`g-theme-${n}`);
    if(c) c.classList.toggle('active-g', n===activeTheme);
  });
  // Cycle mode + fields
  gSelectCycleMode(cycleMode);
  if(cycleMode==='monthly'){const e=document.getElementById('g-pay-day');if(e)e.value=cycleConfig.monthly.payDay;}
  if(cycleMode==='bimonthly'){['s1','e1','s2','e2'].forEach(k=>{const e=document.getElementById(`g-bi-${k}`);if(e)e.value=cycleConfig.bimonthly[k];});}
  if(cycleMode==='custom'){
    const s=document.getElementById('g-cust-start');if(s)s.value=cycleConfig.custom.start;
    const l=document.getElementById('g-cust-len');if(l)l.value=cycleConfig.custom.len;
  }
  if(cycleMode==='weekly'){const e=document.getElementById('g-pay-dow');if(e)e.value=cycleConfig.weekly?.payDow??1;}
  gUpdateLimitDisplay();
  const stored=localStorage.getItem('ledger_defaultGoal')||'';
  const inp=document.getElementById('g-savings-goal-input');
  if(inp) inp.value=stored;
  // Restore target amount if already set for this goal
  if(stored){
    const existingTarget=goalTargets[stored.toLowerCase()]||0;
    const tInp=document.getElementById('g-savings-goal-target');
    if(tInp && existingTarget>0) tInp.value=existingTarget;
  }
  gOnGoalType();
  // Render any already-added credit cards in the guide list
  gRenderGuideCards();
  // Sync currency slide
  const ci=document.getElementById('g-currency-custom');
  if(ci) ci.value=currencySymbol;
  gUpdateCurrencyPreview();
}

// ════════════════════════════════════════════════════════════
//  INIT
// ════════════════════════════════════════════════════════════

// ════════════════════════════════════════════════════════════
//  DYNAMIC VIEWPORT — adapts to real phone dimensions
// ════════════════════════════════════════════════════════════
function applyViewport(){
  const r = document.documentElement;
  const vw = window.innerWidth;
  const vh = window.innerHeight;

  // True viewport height (handles mobile browser chrome)
  const trueVh = window.visualViewport ? window.visualViewport.height : vh;
  r.style.setProperty('--vh', trueVh * 0.01 + 'px');

  // Dynamic nav height — taller on very small screens to keep tap targets
  const safeBottom = parseInt(getComputedStyle(document.documentElement)
    .getPropertyValue('--sab') || '0') || 0;
  const navH = Math.min(74, Math.max(58, Math.round(trueVh * 0.094))) + safeBottom;
  r.style.setProperty('--nav-h', navH + 'px');

  // Fluid horizontal padding (14px–20px across 320–430px)
  const pad = Math.max(14, Math.min(20, Math.round(vw * 0.047)));
  r.style.setProperty('--pad', pad + 'px');
  r.style.setProperty('--pad-i', pad + 'px');
}

applyViewport();

// Re-apply on resize and orientation change
window.addEventListener('resize', applyViewport, {passive:true});
window.addEventListener('orientationchange', () => setTimeout(applyViewport, 100), {passive:true});
if(window.visualViewport){
  window.visualViewport.addEventListener('resize', applyViewport, {passive:true});
}

window.addEventListener('DOMContentLoaded',()=>{
  setTheme(activeTheme);
  activeCycleKey = currentCycleKey();
  const df=document.getElementById('f-date'); df.value=todayStr(); df.max=todayStr();
  document.getElementById('f-amount').addEventListener('input',updateSaveBtn);
  buildCatGrid();
  renderFeed();
  setupSwipeToDelete();
  checkPinOnLoad();
  // Hide what's new badge if already seen
  if(localStorage.getItem('ledger_wn_seen')){
    const badge=document.getElementById('new-badge');
    if(badge) badge.style.display='none';
  }
  // Show onboarding for first-time users
  if(!localStorage.getItem('ledger_onboarded')){
    setTimeout(()=>obOpen(), 400);
  }
  // PWA setup
  pwaInit();
  // Backup reminder check
  checkBackupReminder();
  // Show badge on Bills nav if recurring items are due
  setTimeout(updateRecurBadge, 500);
  // Bill reminders check on load
  setTimeout(checkBillRemindersOnLoad, 1500);
});

// ════════════════════════════════════════════════════════════
//  PWA — manifest · service worker · install prompt
// ════════════════════════════════════════════════════════════
let _pwaPrompt = null;

function pwaGenIcon(size=512){
  const c=document.createElement('canvas');
  c.width=c.height=size; const ctx=c.getContext('2d');
  const r=size*0.18;
  // Background rounded rect
  ctx.beginPath();
  ctx.moveTo(r,0); ctx.lineTo(size-r,0); ctx.quadraticCurveTo(size,0,size,r);
  ctx.lineTo(size,size-r); ctx.quadraticCurveTo(size,size,size-r,size);
  ctx.lineTo(r,size); ctx.quadraticCurveTo(0,size,0,size-r);
  ctx.lineTo(0,r); ctx.quadraticCurveTo(0,0,r,0); ctx.closePath();
  ctx.fillStyle='#080810'; ctx.fill();
  // Book spine
  const sx=size*0.19, sy=size*0.18, sw=size*0.09, sh=size*0.64;
  ctx.beginPath(); ctx.roundRect(sx,sy,sw,sh,size*0.04);
  ctx.fillStyle='#d4a853'; ctx.fill();
  // Book body
  const bx=sx+sw*0.6, by=sy, bw=size*0.55, bh=sh;
  ctx.beginPath(); ctx.roundRect(bx,by,bw,bh,size*0.04);
  ctx.fillStyle='#1a1a28'; ctx.fill();
  ctx.strokeStyle='#d4a853'; ctx.lineWidth=size*0.018; ctx.stroke();
  // Lines
  const lx=bx+bw*0.15, lw=bw*0.72;
  [[0.26,'#d4a853',0.04],[0.40,'#8a8598',0.032],[0.52,'#8a8598',0.032],[0.64,'#8a8598',0.032],[0.76,'#8a8598',0.032]].forEach(([yp,col,lh])=>{
    ctx.beginPath(); ctx.roundRect(lx, sy+sh*yp, lw*(yp===0.26?1:0.82), size*lh, size*0.016);
    ctx.fillStyle=col; ctx.fill();
  });
  // Gold dot accent
  ctx.beginPath(); ctx.arc(size*0.72, size*0.78, size*0.055, 0, Math.PI*2);
  ctx.fillStyle='#d4a853'; ctx.fill();
  return c.toDataURL('image/png');
}

function pwaInit(){
  // Generate icon
  const icon512 = pwaGenIcon(512);
  const icon192 = pwaGenIcon(192);

  // Apple touch icon
  const appleLink = document.getElementById('pwa-apple-icon');
  if(appleLink) appleLink.href = icon192;

  // Render icon in banners
  ['pwa-banner-icon','ios-sheet-icon'].forEach(id=>{
    const el=document.getElementById(id);
    if(el){ const img=document.createElement('img'); img.src=icon192; img.style.cssText='width:100%;height:100%;border-radius:inherit;'; el.appendChild(img); }
  });

  // Build & inject manifest
  const manifest={
    name:'Spendoodle',
    short_name:'Spendoodle',
    description:'Spendoodle — personal pay-cycle money tracker — income, expenses, savings & credit cards.',
    start_url:location.href,
    scope:location.href,
    display:'standalone',
    orientation:'portrait',
    background_color:'#080810',
    theme_color:'#080810',
    categories:['finance','productivity'],
    icons:[
      {src:icon192,sizes:'192x192',type:'image/png',purpose:'any maskable'},
      {src:icon512,sizes:'512x512',type:'image/png',purpose:'any maskable'}
    ]
  };
  const manifestLink=document.getElementById('pwa-manifest-link');
  if(manifestLink){
    const blob=new Blob([JSON.stringify(manifest)],{type:'application/json'});
    manifestLink.href=URL.createObjectURL(blob);
  }

  // Register real service worker (sw.js must be at root)
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('/sw.js', {scope: '/'})
      .then(reg => {
        console.log('[PWA] Service worker registered ✓', reg.scope);
        // Tell SW to update if a new version is available
        reg.addEventListener('updatefound', () => {
          const newSW = reg.installing;
          newSW.addEventListener('statechange', () => {
            if(newSW.state === 'installed' && navigator.serviceWorker.controller){
              console.log('[PWA] New version cached — reload to update');
            }
          });
        });
      })
      .catch(e => console.warn('[PWA] SW registration failed:', e));
  }

  // Install prompt — Android Chrome
  const dismissed = localStorage.getItem('pwa_dismissed');
  const isInstalled = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
  if(isInstalled){ document.getElementById('pwa-banner').style.display='none'; return; }

  // Show settings card since not installed; update state once prompt fires
  setTimeout(pwaUpdateSettingsCard, 200);

  window.addEventListener('beforeinstallprompt', e=>{
    e.preventDefault();
    _pwaPrompt = e;
    pwaUpdateSettingsCard();
    if(!dismissed){
      setTimeout(()=>{
        document.getElementById('pwa-banner').style.display='flex';
        document.getElementById('pwa-banner-sub').textContent='Tap Install — works offline, no app store needed';
      }, 3000);
    }
  });

  // iOS Safari — show manual instructions banner
  const isIos = /iphone|ipad|ipod/i.test(navigator.userAgent);
  const isSafari = /safari/i.test(navigator.userAgent) && !/chrome|crios|fxios/i.test(navigator.userAgent);
  if(isIos && isSafari && !dismissed){
    setTimeout(()=>{
      const banner=document.getElementById('pwa-banner');
      banner.style.display='flex';
      document.getElementById('pwa-banner-sub').textContent='Tap to see how to add to Home Screen';
      document.getElementById('pwa-banner-btn').textContent='How to Install';
    }, 3000);
  }
}

function pwaUpdateSettingsCard(){
  const card  = document.getElementById('sc-pwa');
  const icon  = document.getElementById('pwa-sc-icon');
  const title = document.getElementById('pwa-sc-title');
  const desc  = document.getElementById('pwa-sc-desc');
  const btn   = document.getElementById('pwa-sc-btn');
  if(!card) return;

  const isInstalled = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
  const isIos = /iphone|ipad|ipod/i.test(navigator.userAgent);
  const isSafari = /safari/i.test(navigator.userAgent) && !/chrome|crios|fxios/i.test(navigator.userAgent);

  if(isInstalled){
    // Already a PWA — hide card entirely, no clutter
    card.style.display = 'none';
  } else if(_pwaPrompt){
    card.style.display = '';
    if(icon){ icon.textContent='📲'; icon.style.background='var(--blue-dim)'; }
    title.textContent = 'Install App';
    desc.textContent  = 'Install Spendoodle on your device for a faster, offline-ready experience — no App Store needed.';
    btn.textContent   = '📲 Install Now';
    btn.style.display = 'block';
  } else if(isIos && isSafari){
    card.style.display = '';
    if(icon){ icon.textContent='📲'; icon.style.background='var(--blue-dim)'; }
    title.textContent = 'Install on iPhone / iPad';
    desc.textContent  = 'Not running as an app yet. Tap the button below for step-by-step instructions to add Spendoodle to your Home Screen.';
    btn.textContent   = '📲 How to Install';
    btn.style.display = 'block';
  } else {
    // Other browser — can't install, hide card
    card.style.display = 'none';
  }
}

function pwaSettingsInstall(){
  const isIos = /iphone|ipad|ipod/i.test(navigator.userAgent);
  if(_pwaPrompt){
    _pwaPrompt.prompt();
    _pwaPrompt.userChoice.then(r=>{
      if(r.outcome==='accepted'){ pwaDismiss(); pwaUpdateSettingsCard(); }
      _pwaPrompt=null;
    });
  } else if(isIos){
    document.getElementById('ios-install-sheet').classList.add('open');
  }
}

function pwaInstall(){
  const isIos = /iphone|ipad|ipod/i.test(navigator.userAgent);
  if(_pwaPrompt){
    _pwaPrompt.prompt();
    _pwaPrompt.userChoice.then(r=>{
      if(r.outcome==='accepted'){ pwaDismiss(); pwaUpdateSettingsCard(); }
      _pwaPrompt=null;
    });
  } else if(isIos){
    document.getElementById('pwa-banner').style.display='none';
    document.getElementById('ios-install-sheet').classList.add('open');
  }
}
function pwaDismiss(){
  document.getElementById('pwa-banner').style.display='none';
  localStorage.setItem('pwa_dismissed','1');
}
function closeIosSheet(e){
  if(e && e.target!==document.getElementById('ios-install-sheet')) return;
  document.getElementById('ios-install-sheet').classList.remove('open');
}

// ════════════════════════════════════════════════════════════
let _pinBuffer='';
let _pinMode='unlock'; // 'unlock' | 'set' | 'confirm' | 'verify-delete' | 'verify-change'
let _pinFirst='';
let _pinCallback=null;

async function sha256(str){
  const buf=await crypto.subtle.digest('SHA-256',new TextEncoder().encode(str));
  return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
}
function pinKey(d){
  if(_pinBuffer.length>=4) return;
  haptic(HX.tap);
  _pinBuffer+=d;
  updatePinDots();
  if(_pinBuffer.length===4) setTimeout(pinSubmit,120);
}
function pinDel(){ if(_pinBuffer.length) { _pinBuffer=_pinBuffer.slice(0,-1); updatePinDots(); } }
function updatePinDots(){
  for(let i=0;i<4;i++){
    document.getElementById('pd'+i)?.classList.toggle('filled',i<_pinBuffer.length);
  }
}
async function pinSubmit(){
  const hash=await sha256(_pinBuffer);
  if(_pinMode==='unlock'){
    if(hash===pinHash){ pinUnlock(); }
    else { haptic(HX.error); document.getElementById('pin-error').textContent='Wrong PIN. Try again.'; _pinBuffer=''; updatePinDots(); setTimeout(()=>{ const e=document.getElementById('pin-error');if(e)e.textContent=''; },1500); }
  } else if(_pinMode==='verify-remove'){
    if(hash===pinHash){
      pinHash=''; localStorage.removeItem('ledger_pin');
      document.getElementById('pin-overlay').classList.add('hidden');
      _pinBuffer=''; _pinMode='unlock'; updatePinDots();
      showSettingsToast('🔓 PIN removed — app is now unlocked.', 3500, 'sc-pin');
      renderSettings();
    } else {
      document.getElementById('pin-error').textContent='Wrong PIN. Removal cancelled.';
      _pinBuffer=''; updatePinDots();
      setTimeout(()=>{
        document.getElementById('pin-overlay').classList.add('hidden');
        _pinMode='unlock';
        const e=document.getElementById('pin-error');if(e)e.textContent='';
      },1800);
    }
  } else if(_pinMode==='verify-delete'){
    if(hash===pinHash){
      document.getElementById('pin-overlay').classList.add('hidden');
      _pinBuffer=''; _pinMode='unlock'; updatePinDots();
      doDeleteEverything();
    } else {
      document.getElementById('pin-error').textContent='Wrong PIN. Deletion cancelled.';
      _pinBuffer=''; updatePinDots();
      setTimeout(()=>{
        document.getElementById('pin-overlay').classList.add('hidden');
        _pinMode='unlock';
        const e=document.getElementById('pin-error');if(e)e.textContent='';
      },1800);
    }
  } else if(_pinMode==='verify-change'){
    if(hash===pinHash){
      // Current PIN verified — now set new one
      _pinBuffer=''; _pinFirst=''; _pinMode='set';
      document.getElementById('pin-sub').textContent='Choose your new PIN';
      document.getElementById('pin-error').textContent='';
      updatePinDots();
    } else {
      document.getElementById('pin-error').textContent='Wrong current PIN. Try again.';
      _pinBuffer=''; updatePinDots();
      setTimeout(()=>{ const e=document.getElementById('pin-error');if(e)e.textContent=''; },1800);
    }
  } else if(_pinMode==='set'){
    _pinFirst=_pinBuffer; _pinBuffer='';
    _pinMode='confirm';
    document.getElementById('pin-sub').textContent='Confirm your new PIN';
    updatePinDots();
  } else if(_pinMode==='confirm'){
    if(_pinBuffer===_pinFirst){
      pinHash=hash;
      localStorage.setItem('ledger_pin',hash);
      _pinBuffer=''; _pinFirst=''; _pinMode='unlock';
      document.getElementById('pin-overlay').classList.add('hidden');
      showSettingsToast('🔐 PIN changed successfully!', 3000, 'sc-pin');
      if(_pinCallback){ _pinCallback(); _pinCallback=null; }
    } else {
      document.getElementById('pin-error').textContent='PINs don\'t match. Start again.';
      _pinBuffer=''; _pinFirst=''; _pinMode='set';
      document.getElementById('pin-sub').textContent='Choose your new PIN';
      updatePinDots();
      setTimeout(()=>{ const e=document.getElementById('pin-error');if(e)e.textContent=''; },1800);
    }
  }
}
function pinUnlock(){
  _pinBuffer=''; updatePinDots();
  document.getElementById('pin-overlay').classList.add('hidden');
  document.getElementById('pin-error').textContent='';
}
function pinSkip(){
  showConfirm({
    icon:'⚠️',
    title:'Reset & Clear All Data?',
    msg:'This will erase ALL transactions and settings to remove the PIN. This cannot be undone.',
    okLabel:'Clear Everything',
    onOk:()=>{
      pinHash=''; localStorage.removeItem('ledger_pin');
      transactions=[]; budgets={}; creditCards=[]; goalTargets=[];
      persist(); activeCycleKey=currentCycleKey();
      document.getElementById('pin-overlay').classList.add('hidden');
      renderFeed();
    }
  });
}
function openPinSetup(cb){
  _pinBuffer=''; _pinFirst=''; _pinCallback=cb||null;
  updatePinDots();
  document.getElementById('pin-error').textContent='';
  document.getElementById('pin-skip-btn').style.display='none';
  if(pinHash){
    // Has existing PIN — verify it first before allowing change
    _pinMode='verify-change';
    document.getElementById('pin-sub').textContent='Enter your current PIN first';
  } else {
    _pinMode='set';
    document.getElementById('pin-sub').textContent='Choose a 4-digit PIN';
  }
  document.getElementById('pin-overlay').classList.remove('hidden');
}
/* ── Guide inline PIN pad ── */
let _obPinBuf='', _obPinFirst='', _obPinStep='set'; // 'set' | 'confirm'
function obPinKey(d){
  if(_obPinBuf.length>=4) return;
  _obPinBuf+=d;
  obUpdatePinDots();
  if(_obPinBuf.length===4){
    setTimeout(async()=>{
      const h=await sha256(_obPinBuf);
      if(_obPinStep==='set'){
        _obPinFirst=h; _obPinBuf=''; _obPinStep='confirm';
        document.getElementById('ob-pin-status').textContent='Confirm your PIN';
        obUpdatePinDots();
      } else {
        if(h===_obPinFirst){
          pinHash=h; localStorage.setItem('ledger_pin',h);
          document.getElementById('ob-pin-set-msg').textContent='✅ PIN set! Your ledger is protected.';
          document.getElementById('ob-pin-status').textContent='PIN confirmed ✓';
          _obPinBuf=''; _obPinFirst=''; _obPinStep='set';
          obUpdatePinDots();
          // grey out the pad to show done
          document.querySelectorAll('.ob-pin-key').forEach(b=>b.disabled=true);
        } else {
          document.getElementById('ob-pin-set-msg').textContent='❌ PINs didn\'t match. Try again.';
          _obPinBuf=''; _obPinFirst=''; _obPinStep='set';
          document.getElementById('ob-pin-status').textContent='Enter a 4-digit PIN to activate lock';
          obUpdatePinDots();
        }
      }
    },80);
  }
}
function obPinDel(){
  _obPinBuf=_obPinBuf.slice(0,-1);
  obUpdatePinDots();
}
function obUpdatePinDots(){
  for(let i=0;i<4;i++){
    const d=document.getElementById(`ob-pin-d${i}`);
    if(d){ d.style.background=i<_obPinBuf.length?'var(--accent)':'transparent';
           d.style.borderColor=i<_obPinBuf.length?'var(--accent)':'var(--border2)'; }
  }
}

function removePin(){
  if(!pinHash){ renderSettings(); return; }
  _pinBuffer=''; _pinFirst=''; _pinMode='verify-delete';
  _pinCallback=()=>{
    // After doDeleteEverything is called — but for remove we just want to clear the PIN
    // Override: we handle this via a special flag
  };
  // Use a dedicated remove flow — hijack verify-delete to just remove PIN
  // We'll use a custom mode
  _pinMode='verify-remove';
  updatePinDots();
  document.getElementById('pin-sub').textContent='Enter your current PIN to remove it';
  document.getElementById('pin-error').textContent='';
  document.getElementById('pin-skip-btn').style.display='none';
  document.getElementById('pin-overlay').classList.remove('hidden');
}
function checkPinOnLoad(){
  if(pinHash){
    _pinMode='unlock'; _pinBuffer=''; updatePinDots();
    document.getElementById('pin-sub').textContent='Enter your PIN to unlock';
    document.getElementById('pin-skip-btn').style.display='block';
    document.getElementById('pin-overlay').classList.remove('hidden');
  }
}

// ════════════════════════════════════════════════════════════
//  CUSTOM CONFIRM MODAL
// ════════════════════════════════════════════════════════════
function openWhatsNew(){
  document.getElementById('wn-overlay').classList.add('active');
  const badge=document.getElementById('new-badge');
  if(badge) badge.style.display='none';
  localStorage.setItem('ledger_wn_seen','1');
}
function closeWhatsNew(){
  const sheet=document.getElementById('wn-sheet');
  if(sheet){ sheet.style.transition='transform .3s cubic-bezier(.32,0,.67,0)'; sheet.style.transform=''; }
  document.getElementById('wn-overlay').classList.remove('active');
}

// ── Drag-to-dismiss for What's New ──
(function(){
  let startY=0, currentY=0, dragging=false;
  function onStart(e){
    dragging=true;
    startY=e.touches?e.touches[0].clientY:e.clientY;
    const sheet=document.getElementById('wn-sheet');
    if(sheet) sheet.style.transition='none';
  }
  function onMove(e){
    if(!dragging) return;
    currentY=e.touches?e.touches[0].clientY:e.clientY;
    const dy=Math.max(0, currentY-startY);
    const sheet=document.getElementById('wn-sheet');
    if(sheet) sheet.style.transform=`translateY(${dy}px)`;
    if(e.cancelable) e.preventDefault();
  }
  function onEnd(){
    if(!dragging) return;
    dragging=false;
    const dy=Math.max(0, currentY-startY);
    const sheet=document.getElementById('wn-sheet');
    if(dy>80){
      closeWhatsNew();
    } else {
      if(sheet){ sheet.style.transition='transform .3s cubic-bezier(.34,1.56,.64,1)'; sheet.style.transform='translateY(0)'; }
    }
  }
  window.addEventListener('DOMContentLoaded',()=>{
    const handle=document.getElementById('wn-handle');
    if(!handle) return;
    handle.addEventListener('touchstart', onStart, {passive:true});
    handle.addEventListener('touchmove', onMove, {passive:false});
    handle.addEventListener('touchend', onEnd, {passive:true});
    handle.addEventListener('mousedown', onStart);
    window.addEventListener('mousemove', onMove);
    window.addEventListener('mouseup', onEnd);
  });
})();

// ── Drag-to-dismiss for Transaction Sheet ──
(function(){
  let startY=0, currentY=0, dragging=false;
  function onStart(e){
    dragging=true;
    startY=e.touches?e.touches[0].clientY:e.clientY;
    const sheet=document.getElementById('add-sheet');
    if(sheet) sheet.style.transition='none';
  }
  function onMove(e){
    if(!dragging) return;
    currentY=e.touches?e.touches[0].clientY:e.clientY;
    const dy=Math.max(0, currentY-startY);
    const sheet=document.getElementById('add-sheet');
    if(sheet) sheet.style.transform=`translateX(-50%) translateY(${dy}px)`;
    if(e.cancelable) e.preventDefault();
  }
  function onEnd(){
    if(!dragging) return;
    dragging=false;
    const dy=Math.max(0, currentY-startY);
    const sheet=document.getElementById('add-sheet');
    if(dy>80){
      if(sheet){ sheet.style.transition='transform .3s cubic-bezier(.32,0,.67,0)'; sheet.style.transform='translateX(-50%) translateY(100%)'; }
      closeSheet();
    } else {
      if(sheet){ sheet.style.transition='transform .3s cubic-bezier(.34,1.56,.64,1)'; sheet.style.transform='translateX(-50%) translateY(0)'; }
    }
  }
  window.addEventListener('DOMContentLoaded',()=>{
    const handle=document.getElementById('sheet-handle');
    if(!handle) return;
    handle.addEventListener('touchstart', onStart, {passive:true});
    handle.addEventListener('touchmove', onMove, {passive:false});
    handle.addEventListener('touchend', onEnd, {passive:true});
    handle.addEventListener('mousedown', onStart);
    window.addEventListener('mousemove', onMove);
    window.addEventListener('mouseup', onEnd);
  });
})();

let _confirmCallback=null, _confirmCancelCallback=null, _confirmSecondaryCallback=null;
function showConfirm({icon='⚠️',title='Are you sure?',msg='This cannot be undone.',okLabel='Confirm',cancelLabel='Cancel',secondaryLabel=null,onOk,onCancel,onSecondary}={}){
  document.getElementById('confirm-icon').textContent=icon;
  document.getElementById('confirm-title').textContent=title;
  document.getElementById('confirm-msg').textContent=msg;
  document.getElementById('confirm-ok-btn').textContent=okLabel;
  document.getElementById('confirm-cancel-btn').textContent=cancelLabel;
  _confirmCallback=onOk||null;
  _confirmCancelCallback=onCancel||null;
  _confirmSecondaryCallback=onSecondary||null;

  // Build buttons layout
  const btnsEl=document.getElementById('confirm-btns');
  if(secondaryLabel){
    // Three-button layout: [OK full width] [Secondary full width] [Cancel full width]
    btnsEl.innerHTML=`
      <button class="confirm-btn confirm-ok" id="confirm-ok-btn" onclick="confirmOk()">${okLabel}</button>
      <button class="confirm-btn confirm-secondary" id="confirm-secondary-btn" onclick="confirmSecondary()">${secondaryLabel}</button>
      <button class="confirm-btn confirm-cancel" id="confirm-cancel-btn" onclick="cancelConfirm()">${cancelLabel}</button>`;
  } else {
    // Standard two-button layout side by side
    btnsEl.innerHTML=`
      <div class="confirm-btn-row">
        <button class="confirm-btn confirm-cancel" id="confirm-cancel-btn" onclick="cancelConfirm()">${cancelLabel}</button>
        <button class="confirm-btn confirm-ok" id="confirm-ok-btn" onclick="confirmOk()">${okLabel}</button>
      </div>`;
  }
  document.getElementById('confirm-overlay').classList.add('open');
}
function closeConfirm(){ document.getElementById('confirm-overlay').classList.remove('open'); _confirmCallback=null; _confirmCancelCallback=null; _confirmSecondaryCallback=null; }
function confirmOk(){ const cb=_confirmCallback; closeConfirm(); if(cb) cb(); }
function cancelConfirm(){ const cb=_confirmCancelCallback; closeConfirm(); if(cb) cb(); }
function confirmSecondary(){ const cb=_confirmSecondaryCallback; closeConfirm(); if(cb) cb(); }

// ════════════════════════════════════════════════════════════
//  QUICK-ADD RECURRING TEMPLATES
// ════════════════════════════════════════════════════════════
function renderQuickAddRow(){
  const templates=getRecurringTemplates();
  const area=document.getElementById('quick-add-area');
  if(!area) return;
  if(!templates.length){ area.innerHTML=''; return; }
  area.innerHTML=`<div style="padding:0 20px 4px;font-size:.6rem;text-transform:uppercase;letter-spacing:1px;color:var(--text3);font-weight:700;">⚡ Quick Add Recurring</div>
  <div class="quick-add-row">${templates.map(t=>`
    <div class="qa-chip" onclick="quickAdd(${t.id})">
      <span style="font-size:1rem;">${t.icon}</span>
      <span class="qa-chip-label">${t.label}</span>
      <span class="qa-chip-amt">${currencySymbol}${fmt(t.amount,0)}</span>
      <span class="qa-chip-freq">${t.recurFreq==='weekly'?'weekly':'monthly'}</span>
    </div>`).join('')}
  </div>`;
}
function quickAdd(templateId){
  const tmpl=transactions.find(t=>t.id===templateId); if(!tmpl) return;
  const newTx={...tmpl,id:Date.now(),date:todayStr(),autoGenerated:false};
  transactions.push(newTx);
  transactions.sort((a,b)=>b.date.localeCompare(a.date)||b.id-a.id);
  enforceCycleLimit(); persist();
  haptic(HX.success);
  // Show brief toast
  const list=document.getElementById('feed-list');
  const toast=document.createElement('div');
  toast.className='toast'; toast.textContent=`✓ ${tmpl.label} added!`;
  toast.style.cssText='margin:0 20px 10px;animation:fadeUp .3s ease;';
  list.parentElement.insertBefore(toast, list);
  setTimeout(()=>{ toast.remove(); renderFeed(); },1200);
}

// ════════════════════════════════════════════════════════════
//  COMBINED PROJECTION + BUDGET ALERT (single row, tap to expand)
// ════════════════════════════════════════════════════════════
let spendAlertOpen = false;
function toggleSpendAlert(){ spendAlertOpen = !spendAlertOpen; renderProjection(); }
// Keep renderSpendAlerts as a no-op alias so existing call sites don't break
function renderSpendAlerts(){ /* merged into renderProjection */ }

function renderProjection(){
  const el = document.getElementById('projection-inline');
  if(!el) return;
  const curKey = currentCycleKey();
  if(activeCycleKey !== curKey){ el.style.display='none'; return; }

  const {start, end} = cycleRange(curKey);
  const today = todayStr();
  const s = cycleStats(curKey);
  const startD = new Date(start+'T00:00:00'), endD = new Date(end+'T00:00:00'), todayD = new Date(today+'T00:00:00');
  const totalDays   = Math.round((endD - startD)/86400000) + 1;
  const elapsedDays = Math.min(Math.round((todayD - startD)/86400000) + 1, totalDays);
  const remainingDays = totalDays - elapsedDays;

  // ── Projection numbers ──
  const hasEnoughData = elapsedDays >= 2 && s.income > 0;
  let projIcon, projColor, projMsg;
  if(hasEnoughData){
    const dailySpend = s.expense / elapsedDays;
    const projectedLeft = s.income - dailySpend * totalDays - s.savings;
    if(projectedLeft < 0){
      projIcon='⚠️'; projColor='var(--red)';
      projMsg=`On track to overspend ${c$(Math.abs(projectedLeft))}`;
    } else if(projectedLeft < s.income * 0.1){
      projIcon='😬'; projColor='var(--accent)';
      projMsg=`Tight — ${c$(projectedLeft)} projected left`;
    } else {
      projIcon='📈'; projColor='var(--green)';
      projMsg=`${c$(projectedLeft)} projected remaining`;
    }
  }

  // ── Budget alerts ──
  const alerts = [];
  if(Object.keys(budgets).length && elapsedDays >= 1){
    const txs = cycleTxs(curKey).filter(t => t.type==='expense');
    EXPENSE_CATS.forEach(c => {
      if(!budgets[c.k]) return;
      const spent = txs.filter(t=>t.category===c.k).reduce((a,t)=>a+t.amount, 0);
      const limit = budgets[c.k];
      const pct = spent / limit;
      if(spent > limit){
        alerts.push({cat:c, spent, limit, pct, isOver:true, projected:null});
      } else if(elapsedDays >= 3){
        const projected = (spent / elapsedDays) * totalDays;
        if(projected > limit * 1.05)
          alerts.push({cat:c, spent, limit, pct, isOver:false, projected});
      }
    });
  }

  // Nothing to show at all
  if(!hasEnoughData && !alerts.length){ el.style.display='none'; return; }

  // ── Decide final color & message ──
  // Budget alerts take priority on color when there's an overspend
  const hasOver  = alerts.some(a=>a.isOver);
  const hasPace  = alerts.some(a=>!a.isOver);
  const hasBudgetAlert = alerts.length > 0;

  // Budget tag appended to projection line (or standalone if no projection data)
  let budgetTag = '';
  if(hasBudgetAlert){
    const tagColor = hasOver ? 'var(--red)' : 'var(--accent)';
    const tagIcon  = hasOver ? '⚠️' : '📊';
    const count = alerts.length;
    budgetTag = ` <span style="display:inline-flex;align-items:center;gap:3px;background:${hasOver?'var(--red-dim)':'var(--accent-dim)'};color:${tagColor};border-radius:99px;padding:1px 7px;font-size:.6rem;font-weight:800;cursor:pointer;vertical-align:middle;" onclick="event.stopPropagation();toggleSpendAlert()">${tagIcon} ${count} budget${count>1?'s':''} ${spendAlertOpen?'▴':'▾'}</span>`;
  }

  // ── Expanded budget category rows ──
  let detail = '';
  if(spendAlertOpen && hasBudgetAlert){
    const catRows = alerts.map(a => {
      const barPct  = Math.min(Math.round(a.pct*100), 100);
      const barColor = a.isOver ? 'var(--red)' : 'var(--accent)';
      const badge = a.isOver
        ? `<span style="color:var(--red);font-weight:700;font-size:.6rem;">+${c$(a.spent-a.limit)} over</span>`
        : `<span style="color:var(--accent);font-weight:700;font-size:.6rem;">~${c$(a.projected)} proj.</span>`;
      return `<div style="display:flex;flex-direction:column;gap:3px;padding:5px 0;border-top:1px solid var(--border);">
        <div style="display:flex;align-items:center;gap:5px;font-size:.67rem;font-weight:600;">
          <span>${a.cat.i}</span>
          <span style="flex:1;color:var(--text2);">${a.cat.l}</span>
          <span style="color:var(--text3);font-size:.6rem;">${c$(a.spent)} / ${c$(a.limit)}</span>
          ${badge}
        </div>
        <div style="height:3px;background:var(--bg3);border-radius:99px;overflow:hidden;">
          <div style="height:100%;width:${barPct}%;background:${barColor};border-radius:99px;transition:width .4s;"></div>
        </div>
      </div>`;
    }).join('');
    detail = `<div style="padding-top:2px;">${catRows}</div>`;
  }

  // ── Render ──
  el.style.display = 'block';
  el.style.borderTop = '1px solid var(--border)';
  el.style.marginTop = '10px';
  el.style.paddingTop = '8px';
  el.style.color = projColor || (hasOver ? 'var(--red)' : 'var(--accent)');

  const mainLine = hasEnoughData
    ? `<span>${projIcon}</span><span style="flex:1;">${projMsg} · ${remainingDays}d left${budgetTag}</span>`
    : `<span>${hasOver?'⚠️':'📊'}</span><span style="flex:1;">${hasOver?alerts.filter(a=>a.isOver).length+' budget':alerts.length+' budget'} alert${alerts.length>1?'s':''} this cycle${budgetTag}</span>`;

  el.innerHTML = `<div style="display:flex;align-items:center;gap:5px;font-size:.67rem;font-weight:600;">${mainLine}</div>${detail}`;
}

// ════════════════════════════════════════════════════════════
//  SWIPE GESTURES — left: delete · right: edit
// ════════════════════════════════════════════════════════════
function setupSwipeToDelete(){
  const list = document.getElementById('feed-list');
  let startX=0, startY=0, activeWrap=null, swipeDist=0, dirLocked=false, thresholdFired=false;
  const THRESHOLD = 72;

  list.addEventListener('touchstart', e=>{
    const wrap = e.target.closest('.tx-wrap');
    if(!wrap) return;
    startX=e.touches[0].clientX; startY=e.touches[0].clientY;
    activeWrap=wrap; swipeDist=0; dirLocked=false; thresholdFired=false;
  },{passive:true});

  list.addEventListener('touchmove', e=>{
    if(!activeWrap) return;
    const dx = e.touches[0].clientX - startX;
    const dy = e.touches[0].clientY - startY;

    if(!dirLocked){
      if(Math.abs(dx)<4 && Math.abs(dy)<4) return;
      if(Math.abs(dy) > Math.abs(dx)){ activeWrap=null; return; }
      dirLocked=true;
    }

    swipeDist=dx;
    const txEl = activeWrap.querySelector('.tx');
    if(!txEl) return;

    if(dx < 0){
      // ── Swipe LEFT → delete (red) ──
      const clamped = Math.max(dx, -THRESHOLD-10);
      activeWrap.classList.add('swiping');
      activeWrap.classList.remove('swiping-edit');
      txEl.style.transform = `translateX(${clamped}px)`;
      // Haptic pulse when threshold hit
      if(!thresholdFired && dx < -THRESHOLD){ thresholdFired=true; haptic(HX.warning); }
    } else if(dx > 0){
      // ── Swipe RIGHT → edit (accent) ──
      const clamped = Math.min(dx, THRESHOLD+10);
      activeWrap.classList.add('swiping-edit');
      activeWrap.classList.remove('swiping');
      txEl.style.transform = `translateX(${clamped}px)`;
      if(!thresholdFired && dx > THRESHOLD){ thresholdFired=true; haptic(HX.tap); }
    }
    e.preventDefault();
  },{passive:false});

  list.addEventListener('touchend', ()=>{
    if(!activeWrap) return;
    const txEl = activeWrap.querySelector('.tx');
    const id   = parseInt(activeWrap.dataset.id);

    if(swipeDist < -THRESHOLD){
      // Confirmed delete
      haptic(HX.delete);
      if(txEl){ txEl.style.transition='transform .15s ease'; txEl.style.transform='translateX(-110%)'; }
      activeWrap.classList.remove('swiping');
      setTimeout(()=>{ if(id) deleteTx(id); }, 150);
    } else if(swipeDist > THRESHOLD){
      // Confirmed edit
      haptic(HX.soft);
      if(txEl){ txEl.style.transition='transform .2s ease'; txEl.style.transform=''; setTimeout(()=>{ if(txEl) txEl.style.transition=''; },200); }
      activeWrap.classList.remove('swiping-edit');
      const tx = getTx(id);
      if(tx) openSheet(tx);
    } else {
      // Snap back
      if(txEl){ txEl.style.transition='transform .2s ease'; txEl.style.transform=''; setTimeout(()=>{ if(txEl) txEl.style.transition=''; },200); }
      activeWrap.classList.remove('swiping','swiping-edit');
    }
    activeWrap=null; swipeDist=0; dirLocked=false; thresholdFired=false;
  },{passive:true});
}


// ════════════════════════════════════════════════════════════
//  BILL CALENDAR
// ════════════════════════════════════════════════════════════
function renderCalendar(){
  const today = new Date();
  if(!calViewMonth) calViewMonth = {year: today.getFullYear(), month: today.getMonth()};
  const {year, month} = calViewMonth;
  const el = document.getElementById('cal-body');
  if(!el) return;

  // Get all recurring templates
  const templates = [];
  const seen = new Map();
  [...transactions].filter(t=>t.recurring).forEach(t=>{
    const key = `${t.category}::${t.label}::${t.recurFreq||'monthly'}`;
    if(!seen.has(key)){ seen.set(key,true); templates.push(t); }
  });

  // Build a map of date → [bills due]
  const billMap = {}; // 'YYYY-MM-DD' → [{...tx}]
  const daysInM = new Date(year, month+1, 0).getDate();
  const todayStr2 = ymd(today.getFullYear(), today.getMonth()+1, today.getDate());

  templates.forEach(tmpl => {
    const freq = tmpl.recurFreq || 'monthly';
    const seriesKey = `${tmpl.category}::${tmpl.label}::${freq}`;
    // Skip stopped series entirely
    if(recurringStops[seriesKey]) return;

    if(freq === 'monthly'){
      // Find the day of month this bill usually fires — use the day from its last occurrence
      const lastTx = [...transactions]
        .filter(t=>t.recurring && t.category===tmpl.category && t.label===tmpl.label)
        .sort((a,b)=>b.date.localeCompare(a.date))[0];
      if(!lastTx) return;
      const dayOfMonth = parseInt(lastTx.date.split('-')[2]);
      const d = Math.min(dayOfMonth, daysInM);
      const dateKey = ymd(year, month+1, d);
      if(!billMap[dateKey]) billMap[dateKey]=[];
      billMap[dateKey].push({...tmpl, _dueDate: dateKey});
    } else if(freq === 'weekly'){
      // Use earliest manual entry as anchor, project forward in 7-day steps
      const anchorTx = [...transactions]
        .filter(t=>t.recurring && t.category===tmpl.category && t.label===tmpl.label && !t.autoGenerated)
        .sort((a,b)=>a.date.localeCompare(b.date))[0];
      if(!anchorTx) return;
      // Start from anchor+7 (first occurrence after the original entry)
      let cursor = new Date(anchorTx.date+'T00:00:00');
      cursor.setDate(cursor.getDate()+7);
      const monthEnd = new Date(year, month+1, 0);
      while(cursor <= monthEnd){
        if(cursor.getFullYear()===year && cursor.getMonth()===month){
          const dateKey = ymd(cursor.getFullYear(), cursor.getMonth()+1, cursor.getDate());
          if(!billMap[dateKey]) billMap[dateKey]=[];
          billMap[dateKey].push({...tmpl, _dueDate: dateKey});
        }
        cursor.setDate(cursor.getDate()+7);
      }
    }
  });

  // Calendar grid
  const firstDay = new Date(year, month, 1).getDay(); // 0=Sun
  const prevDays = firstDay;
  const totalCells = Math.ceil((prevDays + daysInM) / 7) * 7;
  const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
  const dowLabels = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

  // Color pool for bill types
  const typeColor = t => t.type==='income'?'var(--green)':t.type==='savings'?'var(--accent)':'var(--red)';

  let gridHTML = '';
  dowLabels.forEach(d => { gridHTML += `<div class="cal-dow">${d}</div>`; });

  for(let i=0; i<totalCells; i++){
    const dayNum = i - prevDays + 1;
    const isThisMonth = dayNum >= 1 && dayNum <= daysInM;
    const dateKey = isThisMonth ? ymd(year, month+1, dayNum) : '';
    const isToday = dateKey === todayStr2;
    const bills = billMap[dateKey] || [];
    const isPast = dateKey && dateKey < todayStr2;

    const isFuture = dateKey && dateKey > todayStr2;

    const dots = bills.slice(0,3).map(b =>
      `<div class="cal-dot" style="background:${typeColor(b)};opacity:${isFuture?0.4:1};"></div>`
    ).join('');

    gridHTML += `<div class="cal-day${!isThisMonth?' other-month':''}${isToday?' today':''}${isFuture?' future':''}"
      onclick="${isThisMonth && bills.length ? `scrollToBillDay('${dateKey}')` : ''}">
      <div class="cal-day-num">${isThisMonth ? dayNum : ''}</div>
      ${dots ? `<div class="cal-dots">${dots}</div>` : ''}
    </div>`;
  }

  // Bill list below calendar — grouped by date
  const allDates = Object.keys(billMap).filter(d=>{
    const [y,m] = d.split('-').map(Number);
    return y===year && m-1===month;
  }).sort();

  let listHTML = '';
  if(allDates.length === 0){
    listHTML = `<div class="cal-empty">📅 No recurring bills found.<br/>Add a recurring transaction from the feed to see it here.</div>`;
  } else {
    allDates.forEach(dateKey => {
      const bills = billMap[dateKey];
      const d = new Date(dateKey+'T00:00:00');
      const isPast = dateKey < todayStr2;
      const isFuture = dateKey > todayStr2;
      const isToday2 = dateKey === todayStr2;
      const daysUntil = Math.round((d - new Date(todayStr2+'T00:00:00'))/86400000);
      let badge = '';
      if(isToday2) badge = `<span class="cal-bill-badge" style="background:var(--accent-dim);color:var(--accent);">Today</span>`;
      else if(daysUntil > 0 && daysUntil <= 3) badge = `<span class="cal-bill-badge" style="background:var(--red-dim);color:var(--red);">In ${daysUntil}d</span>`;
      else if(isPast) badge = `<span class="cal-bill-badge" style="background:var(--bg3);color:var(--text3);">Done</span>`;

      listHTML += `<div class="cal-bill-day-header" id="bill-day-${dateKey}" style="opacity:${isFuture?0.42:1}">${d.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'})} ${badge}</div>`;
      bills.forEach(b => {
        const bgC = b.type==='income'?'var(--green-dim)':b.type==='savings'?'var(--accent-dim)':'var(--red-dim)';
        const amtC = b.type==='income'?'var(--green)':b.type==='savings'?'var(--accent)':'var(--red)';
        const sign = b.type==='income'?'+':'-';
        listHTML += `<div class="cal-bill-row" style="opacity:${isFuture?0.38:1}">
          <div class="cal-bill-icon" style="background:${bgC}">${b.icon}</div>
          <div class="cal-bill-info">
            <div class="cal-bill-name">${b.label}</div>
            <div class="cal-bill-meta">${b.recurFreq==='weekly'?'Every week':'Every month'} · ${b.type}</div>
          </div>
          <div class="cal-bill-amt" style="color:${amtC}">${sign}${currencySymbol}${fmt(b.amount)}</div>
        </div>`;
      });
    });
  }

  // Monthly total of bills due
  let totalDue = 0, totalIncome = 0;
  allDates.forEach(d => {
    billMap[d].forEach(b => {
      if(b.type==='expense'||b.type==='savings') totalDue += b.amount;
      else if(b.type==='income') totalIncome += b.amount;
    });
  });

  const prevMonth = new Date(year, month-1, 1);
  const nextMonth = new Date(year, month+1, 1);

  el.innerHTML = `
    <div class="cal-header">
      <button class="mnav-btn" onclick="calShiftMonth(-1)">‹</button>
      <div style="text-align:center;">
        <div class="cal-month-label">${monthNames[month]} ${year}</div>
        <div style="font-size:.62rem;color:var(--text3);margin-top:2px;">
          ${totalDue>0?`<span style="color:var(--red)">−${currencySymbol}${fmt(totalDue)} due</span>`:''}
          ${totalDue>0&&totalIncome>0?' · ':''}
          ${totalIncome>0?`<span style="color:var(--green)">+${currencySymbol}${fmt(totalIncome)} income</span>`:''}
          ${totalDue===0&&totalIncome===0?'No recurring bills':''}
        </div>
      </div>
      <button class="mnav-btn" onclick="calShiftMonth(1)">›</button>
    </div>
    <div class="cal-grid">${gridHTML}</div>
    <div class="cal-bill-list">${listHTML}</div>
  `;
}

function calShiftMonth(delta){
  haptic(HX.tap);
  if(!calViewMonth){ const t=new Date(); calViewMonth={year:t.getFullYear(),month:t.getMonth()}; }
  calViewMonth.month += delta;
  if(calViewMonth.month > 11){ calViewMonth.month=0; calViewMonth.year++; }
  if(calViewMonth.month < 0){  calViewMonth.month=11; calViewMonth.year--; }
  renderCalendar();
}
function scrollToBillDay(dateKey){
  haptic(HX.tap);
  const el = document.getElementById(`bill-day-${dateKey}`);
  if(el) el.scrollIntoView({behavior:'smooth', block:'center'});
}

// ════════════════════════════════════════════════════════════
//  BILL NOTIFICATIONS
//  Fires on app open via SW showNotification (reliable mobile).
//  setTimeout scheduling removed — killed when app backgrounds.
// ════════════════════════════════════════════════════════════

/** Fire via SW showNotification if available (works on mobile PWA), else direct Notification API */
async function fireNotification(title, body, tag){
  try{
    if('serviceWorker' in navigator){
      const reg = await navigator.serviceWorker.getRegistration();
      if(reg && reg.showNotification){
        await reg.showNotification(title, { body, tag, icon:'/icon-192.png', badge:'/icon-192.png', renotify:true });
        return;
      }
    }
    new Notification(title, { body, tag, icon:'/icon-192.png' });
  }catch(e){ console.warn('Notification error:',e); }
}

function syncNotifUI(){
  const toggle  = document.getElementById('notif-toggle');
  const sub     = document.getElementById('notif-toggle-sub');
  const wrap    = document.getElementById('notif-advance-wrap');
  const status  = document.getElementById('notif-status');
  const permBtn = document.getElementById('notif-permission-btn');
  const testBtn = document.getElementById('notif-test-btn');
  if(!toggle) return;

  const perm = Notification?.permission || 'default';
  toggle.classList.toggle('on', notifEnabled && perm==='granted');

  if(perm === 'denied'){
    if(sub)     sub.textContent     = 'Blocked — check phone Settings';
    if(status)  status.textContent  = '⚠️ Permission denied. Go to phone Settings → find this browser/app → allow Notifications.';
    if(wrap)    wrap.style.display  = 'none';
    if(permBtn) permBtn.style.display = 'none';
    if(testBtn) testBtn.style.display = 'none';
    return;
  }
  if(perm === 'default'){
    if(sub)    sub.textContent    = 'Tap to enable bill reminders';
    if(status) status.textContent = '';
    if(wrap)   wrap.style.display = 'none';
    if(permBtn){ permBtn.style.display='block'; permBtn.textContent='🔔 Grant Permission'; }
    if(testBtn) testBtn.style.display = 'none';
    return;
  }
  // Granted
  if(permBtn) permBtn.style.display = 'none';
  if(notifEnabled){
    if(sub)    sub.textContent    = `On — ${notifDaysAhead} day${notifDaysAhead>1?'s':''} before due`;
    if(wrap)   wrap.style.display = 'block';
    if(status) status.textContent = getBillReminderStatusText();
    if(testBtn) testBtn.style.display = 'block';
  } else {
    if(sub)    sub.textContent    = 'Off — tap to enable';
    if(wrap)   wrap.style.display = 'none';
    if(status) status.textContent = '';
    if(testBtn) testBtn.style.display = 'none';
  }
  [1,2,3].forEach(n=>{
    const b = document.getElementById(`ndb-${n}`);
    if(b) b.style.opacity = n===notifDaysAhead ? '1' : '0.45';
  });
}

function getBillReminderStatusText(){
  const upcoming = getUpcomingBills(7);
  if(!upcoming.length) return '✅ No bills due in the next 7 days.';
  return `📋 ${upcoming.length} bill${upcoming.length>1?'s':''} due in the next 7 days — you\'ll be notified when you open the app.`;
}

async function requestNotifPermission(){
  if(!('Notification' in window)){ showSettingsToast('❌ Notifications not supported on this device.', 3000, 'sc-notifications'); return; }
  const result = await Notification.requestPermission();
  if(result === 'granted'){
    notifEnabled = true;
    localStorage.setItem('ledger_notif','on');
    showSettingsToast('🔔 Notifications enabled!', 3000, 'sc-notifications');
  } else {
    showSettingsToast('❌ Permission denied — check phone Settings.', 4000, 'sc-notifications');
  }
  syncNotifUI();
}

function toggleNotifications(){
  haptic(HX.tap);
  if(!('Notification' in window)){ showSettingsToast('❌ Notifications not supported on this device.', 3000, 'sc-notifications'); return; }
  if(Notification.permission === 'denied'){ showSettingsToast('⚠️ Blocked — go to phone Settings to allow notifications.', 4000, 'sc-notifications'); return; }
  if(Notification.permission === 'default'){ requestNotifPermission(); return; }
  notifEnabled = !notifEnabled;
  localStorage.setItem('ledger_notif', notifEnabled?'on':'off');
  haptic(HX.soft);
  syncNotifUI();
}

function setNotifDays(n){
  haptic(HX.tap);
  notifDaysAhead = n;
  localStorage.setItem('ledger_notif_days', String(n));
  syncNotifUI();
  showSettingsToast(`🔔 Reminders set to ${n} day${n>1?'s':''} before due`, 2500, 'sc-notifications');
}

/** Test button — fires an immediate notification to verify it works */
async function testNotification(){
  haptic(HX.tap);
  if(!notifEnabled || Notification?.permission !== 'granted'){
    showSettingsToast('⚠️ Enable bill reminders first.', 2500, 'sc-notifications'); return;
  }
  const upcoming = getUpcomingBills(30);
  if(upcoming.length){
    const bill = upcoming[0];
    const when = bill.daysUntil===0?'today':bill.daysUntil===1?'tomorrow':`in ${bill.daysUntil} days`;
    await fireNotification(`${bill.icon} ${bill.label} due ${when}`, `${currencySymbol}${fmt(bill.amount)} — due on ${bill.nextDate}`, 'notif-test');
  } else {
    await fireNotification('🔔 Spendoodle', 'Test notification — reminders are working! No bills due in 30 days.', 'notif-test');
  }
  showSettingsToast('🔔 Test sent! Check your notifications bar.', 3000, 'sc-notifications');
}

/** Get bills due within N days from today */
function getUpcomingBills(withinDays){
  const today = new Date(); today.setHours(0,0,0,0);
  const results = [];
  const seen = new Map();
  [...transactions].filter(t=>t.recurring).forEach(t=>{
    const key=`${t.category}::${t.label}::${t.recurFreq||'monthly'}`;
    if(!seen.has(key)) seen.set(key,t);
  });
  seen.forEach(tmpl => {
    const freq = tmpl.recurFreq || 'monthly';
    const seriesKey = `${tmpl.category}::${tmpl.label}::${freq}`;
    if(recurringStops[seriesKey]) return;
    const lastTx = [...transactions]
      .filter(t=>t.recurring && t.category===tmpl.category && t.label===tmpl.label)
      .sort((a,b)=>b.date.localeCompare(a.date))[0];
    if(!lastTx) return;
    let nextDate;
    if(freq==='monthly'){
      const dayOfMonth = parseInt(lastTx.date.split('-')[2]);
      const candidate = new Date(today.getFullYear(), today.getMonth(), dayOfMonth);
      if(candidate <= today) candidate.setMonth(candidate.getMonth()+1);
      nextDate = candidate;
    } else {
      const anchorTx = [...transactions]
        .filter(t=>t.recurring && t.category===tmpl.category && t.label===tmpl.label && !t.autoGenerated)
        .sort((a,b)=>a.date.localeCompare(b.date))[0];
      if(!anchorTx) return;
      nextDate = new Date(anchorTx.date+'T00:00:00');
      nextDate.setDate(nextDate.getDate()+7);
      while(nextDate <= today) nextDate.setDate(nextDate.getDate()+7);
    }
    const daysUntil = Math.round((nextDate-today)/86400000);
    if(daysUntil >= 0 && daysUntil <= withinDays){
      results.push({...tmpl, nextDate: ymd(nextDate.getFullYear(),nextDate.getMonth()+1,nextDate.getDate()), daysUntil});
    }
  });
  return results;
}

/** No-op stub — setTimeout scheduling removed (unreliable when app is backgrounded) */
function scheduleAllBillReminders(){}

// ════════════════════════════════════════════════════════════
//  RECURRING DUE PROMPT — shown on app open when items are due
// ════════════════════════════════════════════════════════════

/** Computes what autoGenerateRecurring WOULD add, without adding anything. */
function computePendingRecurring(){
  const curKey = currentCycleKey();
  const today  = todayStr();
  const pending = [];

  const templates = new Map();
  [...transactions]
    .sort((a,b) => a.date.localeCompare(b.date))
    .filter(t => t.recurring)
    .forEach(t => {
      const key = `${t.category}::${t.label}::${t.recurFreq||'monthly'}`;
      templates.set(key, t);
    });

  templates.forEach(tmpl => {
    const freq = tmpl.recurFreq || 'monthly';
    const seriesKey = `${tmpl.category}::${tmpl.label}::${freq}`;

    const existingDates = new Set(
      transactions
        .filter(t => t.category===tmpl.category && t.label===tmpl.label && t.recurring)
        .map(t => t.date)
    );

    if(freq === 'monthly'){
      const inThisCycle = cycleTxs(curKey).some(t =>
        t.category===tmpl.category && t.label===tmpl.label && t.recurring
      );
      if(inThisCycle) return;
      if(recurringStops[seriesKey]) return;

      const sortedExisting = [...existingDates].sort((a,b)=>b.localeCompare(a));
      const lastDate = sortedExisting[0]||null;
      if(lastDate){
        const daysSince = Math.floor((new Date(today+'T00:00:00') - new Date(lastDate+'T00:00:00'))/86400000);
        if(daysSince < 28) return;
      }
      const {start: cStart} = cycleRange(curKey);
      if(cStart <= today){
        pending.push({...tmpl, dueDate: today, lastDate, seriesKey});
      }

    } else if(freq === 'weekly'){
      const manualEntries = transactions
        .filter(t => t.category===tmpl.category && t.label===tmpl.label && t.recurring && !t.autoGenerated)
        .sort((a,b)=>a.date.localeCompare(b.date));
      if(!manualEntries.length) return;
      const anchorDate = manualEntries[0].date;

      const sortedExisting = [...existingDates].sort((a,b)=>b.localeCompare(a));
      const lastDate = sortedExisting[0]||null;

      let cursor = new Date(anchorDate + 'T00:00:00');
      cursor.setDate(cursor.getDate() + 7);
      let addedForSeries = false;
      while(true){
        const dateStr = ymd(cursor.getFullYear(), cursor.getMonth()+1, cursor.getDate());
        if(dateStr > today) break;
        if(recurringStops[seriesKey] && dateStr >= recurringStops[seriesKey]) break;
        if(!existingDates.has(dateStr)){
          if(!addedForSeries){
            // One row per series — show earliest missing date
            pending.push({...tmpl, dueDate: dateStr, lastDate, seriesKey});
            addedForSeries = true;
          }
          existingDates.add(dateStr);
        }
        cursor.setDate(cursor.getDate() + 7);
      }
    }
  });
  return pending;
}

/** On app open — compute due items and show badge on Bills nav. No popup. */
function checkAndPromptRecurring(){
  updateRecurBadge();
}

/** Recomputes pending and updates the Bills nav badge */
function updateRecurBadge(){
  const todayS = todayStr();
  const lastPrompt = localStorage.getItem('ledger_recur_prompted') || '';
  const badge = document.getElementById('recur-due-badge');
  if(!badge) return;

  // User already acted today (Added or Stopped) — no badge
  if(lastPrompt === todayS){
    badge.textContent = '';
    badge.classList.remove('visible');
    localStorage.removeItem('ledger_recur_pending');
    return;
  }

  // New day — clear yesterday's state so fresh check runs
  if(lastPrompt && lastPrompt !== todayS){
    localStorage.removeItem('ledger_recur_pending');
  }

  const pending = computePendingRecurring();
  if(!pending.length){
    badge.textContent = '';
    badge.classList.remove('visible');
    return;
  }

  // Store for when user taps Bills
  localStorage.setItem('ledger_recur_pending', JSON.stringify(
    pending.map(p => ({ icon:p.icon, label:p.label, amount:p.amount,
                         recurFreq:p.recurFreq, dueDate:p.dueDate,
                         lastDate:p.lastDate, seriesKey:p.seriesKey }))
  ));

  badge.textContent = String(pending.length);
  badge.classList.add('visible');
}

/** Called when user taps the Bills nav — show due prompt if badge is active */
function onBillsNavTap(){
  nav('calendar');
  const todayS = todayStr();
  const lastPrompt = localStorage.getItem('ledger_recur_prompted') || '';
  if(lastPrompt === todayS) return;

  const raw = localStorage.getItem('ledger_recur_pending');
  if(!raw) return;
  try{
    const pending = JSON.parse(raw);
    if(pending.length) setTimeout(()=> _showRecurringSheet(pending), 250);
  }catch(e){}
}

/** Builds and opens the recurring due sheet */
function _showRecurringSheet(pending){
  const overlay = document.getElementById('recur-prompt-overlay');
  const titleEl = document.getElementById('recur-prompt-title');
  const msgEl   = document.getElementById('recur-prompt-msg');
  const listEl  = document.getElementById('recur-prompt-list');

  const count = pending.length;
  titleEl.textContent = `${count} Recurring Item${count!==1?'s':''} Due`;
  msgEl.textContent   = `${count} recurring entr${count!==1?'ies':'y'} ${count!==1?'are':'is'} due today.`;

  listEl.innerHTML = pending.map(p => {
    const lastLabel = p.lastDate ? `Last: ${p.lastDate}` : 'First occurrence';
    return `
    <div class="recur-prompt-item">
      <span class="recur-pi-icon">${p.icon}</span>
      <div class="recur-pi-info">
        <div class="recur-pi-label">${p.label}</div>
        <div class="recur-pi-date">📅 Due <strong style="color:var(--text2)">${p.dueDate}</strong> &nbsp;·&nbsp; ${lastLabel} &nbsp;·&nbsp; ${p.recurFreq||'monthly'}</div>
      </div>
      <span class="recur-pi-amt">${currencySymbol}${fmt(p.amount,2)}</span>
    </div>`;
  }).join('');

  overlay._pendingRecurring = pending;
  overlay.classList.add('open');
}

function stopRecurringPrompt(e){
  if(e && e.target !== document.getElementById('recur-prompt-overlay')) return;
  const overlay = document.getElementById('recur-prompt-overlay');
  const pending = overlay._pendingRecurring || [];

  // Stop every series shown in the prompt
  pending.forEach(p => {
    recurringStops[p.seriesKey] = p.dueDate;
  });
  localStorage.setItem('ledger_recur_stops', JSON.stringify(recurringStops));
  localStorage.setItem('ledger_recur_prompted', todayStr());
  localStorage.removeItem('ledger_recur_pending');

  overlay.classList.remove('open');
  overlay._pendingRecurring = null;
  haptic(HX.tap);
  updateRecurBadge();
  renderCalendar();
}

function addRecurringNow(){
  const overlay = document.getElementById('recur-prompt-overlay');
  overlay.classList.remove('open');
  overlay._pendingRecurring = null;
  localStorage.setItem('ledger_recur_prompted', todayStr());
  localStorage.removeItem('ledger_recur_pending');
  const added = autoGenerateRecurring();
  if(added > 0){ renderFeed(); renderDash(); haptic(HX.success); }
  updateRecurBadge();
}

/** Check daily on app open — fire reminders for bills due within notifDaysAhead days */
async function checkBillRemindersOnLoad(){
  if(!notifEnabled || Notification?.permission !== 'granted') return;
  const todayS    = todayStr();
  const lastCheck = localStorage.getItem('ledger_notif_lastcheck') || '';
  if(lastCheck === todayS) return; // already fired today
  localStorage.setItem('ledger_notif_lastcheck', todayS);

  const bills = getUpcomingBills(notifDaysAhead);
  for(const bill of bills){
    const when  = bill.daysUntil===0 ? 'today' : bill.daysUntil===1 ? 'tomorrow' : `in ${bill.daysUntil} days`;
    const title = `${bill.icon} ${bill.label} due ${when}`;
    const body  = `${currencySymbol}${fmt(bill.amount)} — due on ${bill.nextDate}`;
    await fireNotification(title, body, `bill-${bill.label}-${bill.nextDate}`);
  }
}

</script>
</body>
</html>
